<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <link rel="manifest" href="manifest.json"/>
    <meta name="theme-color" content="#007bff"/>
    <link rel="icon" href="icon-192.png"/>
    <title>Buku Tamu Digital</title>
    <!-- Tambahkan SheetJS CDN untuk export Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* ... (semua style sebelumnya tetap sama) ... */

        /* Perbaikan posisi bingkai foto agar tombol selalu terlihat */
        #photoModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: flex-start; /* Ubah dari center ke flex-start */
            align-items: center;
            flex-direction: column;
            padding: 20px 10px; /* Tambah padding atas agar ada ruang */
            overflow-y: auto; /* Scroll jika konten terlalu panjang */
        }

        #modalContent {
            position: relative;
            background-color: #fefefe;
            margin: 10px auto; /* Margin atas agar tidak menempel ke atas layar */
            padding: 15px;
            border: 1px solid #888;
            width: 95%;
            max-width: 550px;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        #dualCameraFrame {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 500px;
            margin: 15px auto;
        }

        .camera-view {
            width: 100%;
            border: 2px solid #007bff;
            aspect-ratio: 4/3;
            overflow: hidden;
            position: relative;
            border-radius: 8px;
        }

        #modalButtons {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap; /* Agar tombol wrap jika layar kecil */
            padding: 10px 0;
            position: sticky; /* Tombol tetap terlihat saat scroll */
            bottom: 0;
            background: #fefefe;
        }

        /* ... (style lainnya tetap sama) ... */
    </style>
</head>
<body>
    <!-- ... (header dan form tetap sama) ... -->

    <div style="margin-bottom: 20px;">
        <button type="button" onclick="showForm()" id="btnForm" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">üìù Form Input</button>
        <button type="button" onclick="showData()" id="btnData" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">üìä Lihat Data (<span id="dataCount">0</span>)</button>
        <!-- Ganti tombol Export menjadi Excel -->
        <button type="button" onclick="exportToExcel()" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üíæ Export Excel</button>
    </div>

    <!-- ... (bagian lain tetap sama) ... -->

    <script>
        // ... (semua script sebelumnya tetap sama hingga akhir) ...

        // Ganti fungsi exportData() menjadi exportToExcel() dengan SheetJS
        function exportToExcel() {
            if (dataBukuTamu.length === 0) {
                alert('Tidak ada data untuk di-export!');
                return;
            }

            const wb = XLSX.utils.book_new();

            // Siapkan data tanpa gambar terlebih dahulu
            const data = dataBukuTamu.map((item, index) => ({
                No: index + 1,
                Nama: item.nama,
                Asal: item.asal,
                Instansi: item.instansi || '',
                Kecamatan: item.kecamatan || '',
                Desa: item.desa || '',
                'Pihak Ditemui': item.pihakDitemui,
                'Jenis Layanan': item.jenisLayanan,
                Uraian: item.uraian,
                'Nomor HP': item.nomorHp,
                Waktu: item.timestamp
            }));

            const ws = XLSX.utils.json_to_sheet(data);

            // Styling header: background kuning, teks bold, center
            const range = XLSX.utils.decode_range(ws["!ref"]);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cell_addr = XLSX.utils.encode_cell({r: 0, c: C});
                if (!ws[cell_addr].s) ws[cell_addr].s = {};
                ws[cell_addr].s = {
                    fill: { fgColor: { rgb: "FFFF00" } },
                    font: { bold: true },
                    alignment: { horizontal: "center", vertical: "center", wrapText: true }
                };
            }

            // Auto-fit lebar kolom
            const colWidths = [
                { wch: 5 },  // No
                { wch: 20 }, // Nama
                { wch: 15 }, // Asal
                { wch: 40 }, // Instansi
                { wch: 25 }, // Kecamatan
                { wch: 25 }, // Desa
                { wch: 20 }, // Pihak Ditemui
                { wch: 30 }, // Jenis Layanan
                { wch: 50 }, // Uraian
                { wch: 15 }, // Nomor HP
                { wch: 22 }  // Waktu
            ];
            ws["!cols"] = colWidths;

            // Tambahkan gambar (tanda tangan & foto) - SheetJS mendukung !images sejak versi terbaru
            const imgWidth = 180;  // px
            const imgHeight = 120; // px

            ws["!images"] = ws["!images"] || [];

            dataBukuTamu.forEach((item, idx) => {
                const rowIdx = idx + 1; // karena header di row 0

                // Tanda Tangan
                if (item.tandaTangan) {
                    const b64 = item.tandaTangan.split(',')[1];
                    ws["!images"].push({
                        base64: b64,
                        type: "base64",
                        "!pos": { c: 11, r: rowIdx }, // kolom setelah Waktu (index 11 jika mulai dari 0)
                        "!dims": { width: imgWidth, height: imgHeight }
                    });
                }

                // Foto Depan
                if (item.fotoFront) {
                    const b64 = item.fotoFront.split(',')[1];
                    ws["!images"].push({
                        base64: b64,
                        type: "base64",
                        "!pos": { c: 12, r: rowIdx },
                        "!dims": { width: imgWidth, height: imgHeight }
                    });
                }

                // Foto Belakang
                if (item.fotoBack) {
                    const b64 = item.fotoBack.split(',')[1];
                    ws["!images"].push({
                        base64: b64,
                        type: "base64",
                        "!pos": { c: 13, r: rowIdx },
                        "!dims": { width: imgWidth, height: imgHeight }
                    });
                }
            });

            // Tambah kolom kosong untuk gambar
            ws["!cols"].push({ wpx: imgWidth + 20 }); // Tanda Tangan
            ws["!cols"].push({ wpx: imgWidth + 20 }); // Foto Depan
            ws["!cols"].push({ wpx: imgWidth + 20 }); // Foto Belakang

            XLSX.utils.book_append_sheet(wb, ws, "Buku Tamu");

            const filename = `buku_tamu_inspektorat_tubaba_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);

            alert('Data berhasil di-export ke file Excel (.xlsx) dengan gambar!');
        }

        // ... (script lainnya tetap sama) ...
    </script>
</body>
</html>
