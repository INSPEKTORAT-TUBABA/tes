function exportData() {
    if (dataBukuTamu.length === 0) {
        alert('Tidak ada data untuk di-export!');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4

    // Header dokumen
    doc.setFontSize(14);
    doc.text('BUKU TAMU DIGITAL INSPEKTORAT KABUPATEN TULANG BAWANG BARAT', 148, 15, { align: 'center' });
    doc.setFontSize(10);
    doc.text('Tanggal Export: ' + new Date().toLocaleDateString('id-ID'), 148, 22, { align: 'center' });

    // Definisi kolom header (tanpa "Asal")
    const head = [[
        'No',
        'Nama',
        'Instansi',
        'Kecamatan',
        'Desa/Tiyuh',
        'Pihak Ditemui',
        'Jenis Layanan',
        'Uraian',
        'No HP',
        'Tanggal Kunjungan',
        'Tanda Tangan',
        'Foto Depan',
        'Foto Belakang'
    ]];

    // Isi data baris
    const body = dataBukuTamu.map((d, i) => [
        i + 1,
        d.nama || '-',
        d.asal === 'INSTANSI' ? (d.instansi || '-') : '-',
        d.asal === 'MASYARAKAT' ? (d.kecamatan || '-') : '-',
        d.desa || '-',
        d.pihakDitemui || '-',
        d.jenisLayanan || '-',
        d.uraian ? (d.uraian.length > 70 ? d.uraian.substring(0, 67) + '...' : d.uraian) : '-',
        d.nomorHp || '-',
        d.timestamp ? d.timestamp.split(', ')[0] : '-',  // hanya tanggal
        '', '', ''  // placeholder gambar
    ]);

    // Konfigurasi tabel autoTable
    doc.autoTable({
        head: head,
        body: body,
        startY: 30,
        theme: 'grid',
        headStyles: {
            fillColor: [0, 123, 255],
            textColor: 255,
            fontSize: 8.5,
            fontStyle: 'bold',
            halign: 'center',
            lineWidth: 0.1
        },
        bodyStyles: {
            fontSize: 7.2,
            cellPadding: 3,
            valign: 'middle',
            overflow: 'linebreak'
        },
        alternateRowStyles: { fillColor: [248, 249, 250] },
        columnStyles: {
            0:  { cellWidth: 10,  halign: 'center' },   // No
            1:  { cellWidth: 34 },                      // Nama
            2:  { cellWidth: 36 },                      // Instansi
            3:  { cellWidth: 30 },                      // Kecamatan
            4:  { cellWidth: 28 },                      // Desa/Tiyuh
            5:  { cellWidth: 26 },                      // Pihak Ditemui
            6:  { cellWidth: 28 },                      // Jenis Layanan
            7:  { cellWidth: 52 },                      // Uraian ← paling lebar
            8:  { cellWidth: 22 },                      // No HP
            9:  { cellWidth: 24 },                      // Tanggal Kunjungan
            10: { cellWidth: 18 },                      // Tanda Tangan
            11: { cellWidth: 18 },                      // Foto Depan
            12: { cellWidth: 18 }                       // Foto Belakang
        },
        didDrawCell: function(data) {
            if (data.section === 'body' && data.column.index >= 10 && data.column.index <= 12) {
                const item = dataBukuTamu[data.row.index];
                let imgData = null;
                if (data.column.index === 10) imgData = item.tandaTangan;
                if (data.column.index === 11) imgData = item.fotoFront;
                if (data.column.index === 12) imgData = item.fotoBack;

                if (imgData) {
                    try {
                        doc.addImage(imgData, 'PNG', data.cell.x + 1, data.cell.y + 1, 16, 12, undefined, 'FAST');
                    } catch (e) {
                        // Jika gambar error, skip tanpa crash
                    }
                }
            }
        },
        margin: { top: 30, left: 7, right: 7 },
        pageBreak: 'auto',
        rowPageBreak: 'avoid',
        styles: { overflow: 'linebreak' }
    });

    // Nama file & simpan
    const filename = 'Buku_Tamu_Inspektorat_Tubaba_' + new Date().toISOString().slice(0,10) + '.pdf';
    doc.save(filename);
    
    alert('PDF berhasil diekspor!\nPerubahan:\n• Kolom "Asal" sudah dihapus\n• Instansi & Kecamatan tetap terpisah\nFile: ' + filename);
}
