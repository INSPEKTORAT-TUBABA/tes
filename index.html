<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buku Tamu Digital - Inspektorat Tubaba</title>
    
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
            overflow-x: hidden;
        }
        body { min-height: 100vh; padding: 15px; }

        /* Intro Page */
        #introPage {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10000;
            transition: opacity 0.6s ease;
        }
        #introPage.hidden { opacity: 0; pointer-events: none; }

        .intro-content { text-align: center; padding: 20px; max-width: 90%; }
        .intro-title {
            font-size: 2.8rem;
            font-weight: 900;
            margin: 0.3em 0;
            text-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .intro-subtitle {
            font-size: 1.6rem;
            margin: 0.8em 0 1.5em;
            line-height: 1.3;
        }
        .btn-start {
            padding: 16px 48px;
            font-size: 1.3rem;
            background: white;
            color: #4a6ee0;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-start:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        /* Logo Glow */
        .logo-glow {
            width: 110px;
            height: auto;
            margin-bottom: 25px;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.8)) drop-shadow(0 0 35px rgba(255,215,0,0.6));
            animation: fadeInUp 1s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* Main Content */
        #mainApp { display: none; max-width: 720px; margin: 0 auto; }
        #mainApp.visible { display: block; }

        .header-gambar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .foto-kepala, .logo { width: 90px; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        h1 { text-align: center; color: #2c3e50; margin: 0.4em 0; font-size: 1.9rem; }
        h2 { color: #34495e; text-align: center; margin-bottom: 1.2em; }

        form > div {
            margin-bottom: 1.2em;
            background: white;
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #2c3e50;
        }
        .required { color: #e74c3c; }
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
        }
        textarea { min-height: 80px; resize: vertical; }
        button {
            padding: 12px 24px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        .hidden { display: none !important; }

        /* Signature Canvas */
        #signature-pad {
            width: 100%;
            height: 180px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            touch-action: none;
        }

        /* Camera Modal */
        #photoModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 15px;
        }
        .camera-view {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 4/3;
            border: 4px solid #3498db;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            background: black;
        }
        .camera-view video, .camera-view img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .modal-buttons { margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }

        @media (max-width: 600px) {
            .intro-title { font-size: 2.2rem; }
            .intro-subtitle { font-size: 1.3rem; }
            h1 { font-size: 1.7rem; }
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- Intro Page -->
<div id="introPage">
    <img src="Kabupaten Tulang Bawang Barat.png" class="logo-glow" alt="Logo Tubaba" onerror="this.src='https://via.placeholder.com/110?text=Logo';">
    <div class="intro-content">
        <h2 class="intro-title">SELAMAT DATANG</h2>
        <h1 class="intro-subtitle">DI INSPEKTORAT DAERAH<br>KABUPATEN TULANG BAWANG BARAT</h1>
        <button class="btn-start" onclick="startApp()">üìù ISI BUKU TAMU</button>
    </div>
</div>

<!-- Main App -->
<div id="mainApp">
    <div class="header-gambar">
        <img src="bupati.png" class="foto-kepala" alt="Bupati" onerror="this.style.display='none'">
        <img src="logo-tubaba.png" class="logo" alt="Logo Tubaba" onerror="this.style.display='none'">
        <img src="wakil-bupati.png" class="foto-kepala" alt="Wakil Bupati" onerror="this.style.display='none'">
    </div>

    <h1>BUKU TAMU DIGITAL<br>INSPEKTORAT KABUPATEN TULANG BAWANG BARAT</h1>

    <form id="bukuTamuForm">
        <div>
            <label>Nama Lengkap <span class="required">*</span></label>
            <input type="text" id="nama" required placeholder="Nama lengkap anda" minlength="3">
        </div>

        <div>
            <label>Asal <span class="required">*</span></label>
            <select id="asal" required onchange="handleAsalChange()">
                <option value="">-- Pilih Asal --</option>
                <option value="INSTANSI">Instansi / Unit Kerja</option>
                <option value="MASYARAKAT">Masyarakat Umum</option>
            </select>
        </div>

        <!-- INSTANSI -->
        <div id="field-instansi" class="hidden">
            <label>Nama Instansi / Unit Kerja <span class="required">*</span></label>
            <select id="instansi" required>
                <option value="">-- Pilih Instansi --</option>
                <option>SEKRETARIAT DAERAH</option>
                <option>SEKRETARIAT DPRD</option>
                <option>BADAN PERENCANAAN PEMBANGUNAN DAERAH</option>
                <option>BADAN PENGELOLAAN KEUANGAN DAN ASET DAERAH</option>
                <option>BADAN PENGELOLAAN PAJAK DAN RETRIBUSI DAERAH</option>
                <option>BADAN KEPEGAWAIAN DAN PENGEMBANGAN SUMBER DAYA MANUSIA</option>
                <option>BADAN KESATUAN BANGSA DAN POLITIK DAERAH</option>
                <option>BADAN PENANGGULANGAN BENCANA DAERAH</option>
                <option>DINAS LINGKUNGAN HIDUP</option>
                <option>DINAS KESEHATAN</option>
                <option>DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                <option>DINAS KOPERASI, UMKM, PERINDUSTRIAN DAN PERDAGANGAN</option>
                <option>DINAS SOSIAL</option>
                <option>DINAS PEMUDA, OLAHRAGA DAN PARIWISATA</option>
                <option>DINAS KOMUNIKASI DAN INFORMATIKA</option>
                <option>DINAS PERUMAHAN, KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                <option>DINAS PENANAMAN MODAL DAN PELAYANAN PERIZINAN TERPADU SATU PINTU</option>
                <option>DINAS PENDIDIKAN DAN KEBUDAYAAN</option>
                <option>DINAS KETAHANAN PANGAN</option>
                <option>DINAS PEMBERDAYAAN MASYARAKAT DAN TIYUH</option>
                <option>DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                <option>DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                <option>DINAS PERHUBUNGAN</option>
                <option>DINAS PERTANIAN</option>
                <option>DINAS PETERNAKAN DAN KESEHATAN HEWAN</option>
                <option>DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                <option>DINAS TENAGA KERJA DAN TRANSMIGRASI</option>
                <option>DINAS PERIKANAN</option>
                <option>DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                <option>DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</option>
                <option>SATUAN POLISI PAMONG PRAJA</option>
                <option>BADAN PENGAWASAN KEUANGAN DAN PEMBANGUNAN</option>
                <option>INSPEKTORAT KABUPATEN TULANG BAWANG BARAT</option>
                <option>LAIN-LAIN</option>
            </select>
        </div>

        <!-- MASYARAKAT -->
        <div id="field-masyarakat" class="hidden">
            <div>
                <label>Kecamatan <span class="required">*</span></label>
                <select id="kecamatan" required onchange="updateDesa()">
                    <option value="">-- Pilih Kecamatan --</option>
                    <option>Tulang Bawang Tengah</option>
                    <option>Tulang Bawang Udik</option>
                    <option>Gunung Terang</option>
                    <option>Gunung Agung</option>
                    <option>Lambu Kibang</option>
                    <option>Way Kenanga</option>
                    <option>Tumijajar</option>
                    <option>Pagar Dewa</option>
                    <option>Batu Putih</option>
                </select>
            </div>

            <div id="field-desa" class="hidden">
                <label>Desa / Tiyuh <span class="required">*</span></label>
                <select id="desa" required></select>
            </div>
        </div>

        <div id="field-pihakDitemui" class="hidden">
            <label>Pihak yang Ditemui <span class="required">*</span></label>
            <select id="pihakDitemui" required>
                <option value="">-- Pilih --</option>
                <option>Inspektur</option>
                <option>Sekretaris</option>
                <option>Irban Sus</option>
                <option>Irban 1</option>
                <option>Irban 2</option>
                <option>Irban 3</option>
                <option>Irban 4</option>
            </select>
        </div>

        <div id="field-jenisLayanan" class="hidden">
            <label>Jenis Layanan <span class="required">*</span></label>
            <select id="jenisLayanan" required>
                <option value="">-- Pilih Jenis Layanan --</option>
                <option>Permintaan Audit / Klarifikasi Khusus</option>
                <option>Penanganan Pengaduan Masyarakat</option>
                <option>Layanan Informasi Publik</option>
                <option>Pembinaan & Konsultasi</option>
                <option>Audit Kinerja / Keuangan</option>
                <option>Review LKPD</option>
                <option>Evaluasi / Monitoring</option>
                <option>Tindak Lanjut Temuan</option>
            </select>
        </div>

        <div id="field-uraian" class="hidden">
            <label>Uraian Keperluan <span class="required">*</span></label>
            <textarea id="uraian" required rows="4" placeholder=" Jelaskan secara singkat maksud dan tujuan kunjungan..."></textarea>
        </div>

        <div id="field-nomorHp" class="hidden">
            <label>Nomor HP / WhatsApp <span class="required">*</span></label>
            <input type="tel" id="nomorHp" required placeholder="08xx xxxx xxxx" pattern="08[0-9]{8,12}" inputmode="numeric">
        </div>

        <div id="field-tandaTangan" class="hidden">
            <label>Tanda Tangan Digital <span class="required">*</span></label>
            <canvas id="signature-pad"></canvas>
            <div style="margin-top:10px;">
                <button type="button" onclick="clearSignature()" class="btn-warning">üßπ Bersihkan</button>
            </div>
        </div>

        <div style="text-align:center; margin: 30px 0;">
            <button type="button" onclick="bukaKamera()" class="btn-primary">üì∏ Ambil Foto (Wajib)</button>
            <p id="photoStatus" style="margin-top:10px; color:#e67e22; font-weight:bold;"></p>
        </div>

        <div style="text-align:center;">
            <button type="button" onclick="simpanData()" class="btn-success" style="padding:16px 60px; font-size:1.3rem;">
                üíæ SIMPAN DATA
            </button>
        </div>
    </form>

    <!-- Modal Kamera -->
    <div id="photoModal">
        <div class="camera-view">
            <video id="video" autoplay playsinline></video>
            <img id="preview" style="display:none;">
        </div>
        <div class="modal-buttons">
            <button class="btn-warning" onclick="switchCamera()">üîÑ Ganti Kamera</button>
            <button class="btn-success" onclick="capturePhoto()">üì∏ Ambil Foto</button>
            <button class="btn-danger" onclick="tutupKamera()">‚úñ Tutup</button>
        </div>
    </div>
</div>

<script>
// ==================== Variabel Global ====================
let dataBukuTamu = JSON.parse(localStorage.getItem('dataBukuTamu')) || [];
let signaturePad;
let videoStream = null;
let currentCamera = 'user'; // 'user' atau 'environment'
let fotoFront = null;
let fotoBack = null;
let hasPhoto = false;

// ==================== Inisialisasi ====================
document.addEventListener('DOMContentLoaded', () => {
    // Signature Pad
    const canvas = document.getElementById('signature-pad');
    signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255,255,255)',
        penColor: 'rgb(0,0,0)'
    });

    updateDataCounter();
});

// ==================== Fungsi Utama ====================
function startApp() {
    document.getElementById('introPage').classList.add('hidden');
    setTimeout(() => {
        document.getElementById('mainApp').classList.add('visible');
    }, 600);
}

function handleAsalChange() {
    const asal = document.getElementById('asal').value;
    
    document.getElementById('field-instansi').classList.toggle('hidden', asal !== 'INSTANSI');
    document.getElementById('field-masyarakat').classList.toggle('hidden', asal !== 'MASYARAKAT');

    // Tampilkan field selanjutnya setelah asal dipilih
    if (asal) {
        document.getElementById('field-pihakDitemui').classList.remove('hidden');
    }
}

function updateDesa() {
    const kec = document.getElementById('kecamatan').value;
    const desaSelect = document.getElementById('desa');
    desaSelect.innerHTML = '<option value="">-- Pilih Desa/Tiyuh --</option>';

    if (!kec) {
        document.getElementById('field-desa').classList.add('hidden');
        return;
    }

    const daftarDesa = {
        "Tulang Bawang Tengah": ["Banjar Agung", "Banjar Baru", "Banjar Jaya", "Bumi Jaya", "Bumi Sari", "Catur Mulyo", "Karta", "Mekar Jaya", "Mulyo Asri", "Pematang Sari", "Sumber Agung", "Sumber Jaya", "Talang Padang", "Tulang Bawang Tengah"],
        "Tulang Bawang Udik": ["Batu Ampar", "Batu Putih", "Bumi Asri", "Gunung Agung", "Gunung Terang", "Karya Jaya", "Marga Jaya", "Negara Batin", "Negara Sakti", "Pematang Raman", "Sumber Rahayu", "Tulang Bawang Udik"],
        "Gunung Terang": ["Bumi Jaya", "Gunung Terang", "Karya Makmur", "Mekar Jaya", "Sumber Rejo", "Talang Jaya"],
        "Gunung Agung": ["Gunung Agung", "Marga Jaya", "Sumber Agung", "Sumber Makmur"],
        "Lambu Kibang": ["Bumi Agung", "Kibang", "Lambu Kibang", "Marga Cinta", "Negeri Pandan"],
        "Way Kenanga": ["Bumi Asri", "Karya Jaya", "Sumber Rahayu", "Way Kenanga"],
        "Tumijajar": ["Bumi Jaya", "Tumijajar"],
        "Pagar Dewa": ["Pagar Dewa", "Sumber Jaya"],
        "Batu Putih": ["Batu Putih", "Mekar Sari"]
    };

    if (daftarDesa[kec]) {
        daftarDesa[kec].forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            desaSelect.appendChild(opt);
        });
        document.getElementById('field-desa').classList.remove('hidden');
    }
}

// ==================== Signature ====================
function clearSignature() {
    signaturePad.clear();
}

// ==================== Kamera ====================
function bukaKamera() {
    const modal = document.getElementById('photoModal');
    modal.style.display = 'flex';
    startCamera();
}

function tutupKamera() {
    document.getElementById('photoModal').style.display = 'none';
    stopCamera();
}

async function startCamera() {
    stopCamera();
    try {
        const constraints = {
            video: { facingMode: currentCamera }
        };
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        document.getElementById('video').srcObject = videoStream;
    } catch (err) {
        alert('Gagal membuka kamera: ' + err.message);
    }
}

function stopCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
}

function switchCamera() {
    currentCamera = currentCamera === 'user' ? 'environment' : 'user';
    startCamera();
}

function capturePhoto() {
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);

    if (!fotoFront) {
        fotoFront = dataUrl;
        document.getElementById('photoStatus').textContent = "Foto depan sudah diambil ‚úì";
    } else if (!fotoBack) {
        fotoBack = dataUrl;
        document.getElementById('photoStatus').textContent = "Foto depan & belakang sudah diambil ‚úì‚úì";
        hasPhoto = true;
    }

    if (fotoFront && fotoBack) {
        tutupKamera();
    } else {
        alert("Silakan ambil foto " + (fotoFront ? "belakang" : "depan") + " juga.");
    }
}

// ==================== Simpan Data ====================
function simpanData() {
    // Validasi minimal
    if (!document.getElementById('nama').value.trim()) return alert("Nama wajib diisi");
    if (!document.getElementById('asal').value) return alert("Asal wajib dipilih");

    const asal = document.getElementById('asal').value;
    if (asal === 'INSTANSI' && !document.getElementById('instansi').value) return alert("Nama instansi wajib dipilih");
    if (asal === 'MASYARAKAT') {
        if (!document.getElementById('kecamatan').value) return alert("Kecamatan wajib dipilih");
        if (!document.getElementById('desa').value) return alert("Desa/Tiyuh wajib dipilih");
    }

    if (!document.getElementById('pihakDitemui').value) return alert("Pihak yang ditemui wajib dipilih");
    if (!document.getElementById('jenisLayanan').value) return alert("Jenis layanan wajib dipilih");
    if (!document.getElementById('uraian').value.trim().length < 10) return alert("Uraian terlalu singkat (minimal 10 karakter)");
    if (!document.getElementById('nomorHp').value.match(/^08[0-9]{8,12}$/)) return alert("Nomor HP tidak valid (mulai dengan 08, 10-13 digit)");

    if (signaturePad.isEmpty()) return alert("Tanda tangan wajib diisi!");
    if (!hasPhoto) return alert("Foto depan & belakang wajib diambil!");

    const data = {
        nama: document.getElementById('nama').value.trim(),
        asal: asal,
        instansi: asal === 'INSTANSI' ? document.getElementById('instansi').value : '',
        kecamatan: asal === 'MASYARAKAT' ? document.getElementById('kecamatan').value : '',
        desa: asal === 'MASYARAKAT' ? document.getElementById('desa').value : '',
        pihakDitemui: document.getElementById('pihakDitemui').value,
        jenisLayanan: document.getElementById('jenisLayanan').value,
        uraian: document.getElementById('uraian').value.trim(),
        nomorHp: document.getElementById('nomorHp').value,
        tandaTangan: signaturePad.toDataURL('image/png'),
        fotoFront: fotoFront,
        fotoBack: fotoBack,
        timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })
    };

    dataBukuTamu.push(data);
    localStorage.setItem('dataBukuTamu', JSON.stringify(dataBukuTamu));

    alert("‚úÖ Data berhasil disimpan!\nTerima kasih telah mengisi buku tamu.");
    resetForm();
    updateDataCounter();
}

function resetForm() {
    document.getElementById('bukuTamuForm').reset();
    signaturePad.clear();
    fotoFront = null;
    fotoBack = null;
    hasPhoto = false;
    document.getElementById('photoStatus').textContent = '';
    document.querySelectorAll('.hidden').forEach(el => el.classList.add('hidden'));
}

function updateDataCounter() {
    // Bisa ditambahkan tampilan jumlah data jika diinginkan
    console.log(`Total tamu: ${dataBukuTamu.length}`);
}

// ==================== Export PDF Ringkas (contoh sederhana) ====================
function exportPDF() {
    if (dataBukuTamu.length === 0) return alert("Belum ada data untuk diekspor");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');

    doc.setFontSize(16);
    doc.text("BUKU TAMU DIGITAL INSPEKTORAT KAB. TULANG BAWANG BARAT", 148.5, 15, { align: 'center' });

    doc.autoTable({
        startY: 25,
        head: [['No', 'Nama', 'Asal/Instansi', 'Pihak Ditemui', 'Layanan', 'Uraian', 'HP', 'Waktu']],
        body: dataBukuTamu.map((d, i) => [
            i+1,
            d.nama,
            d.asal === 'INSTANSI' ? d.instansi : `${d.kecamatan} - ${d.desa}`,
            d.pihakDitemui,
            d.jenisLayanan,
            d.uraian.substring(0,60) + (d.uraian.length > 60 ? '...' : ''),
            d.nomorHp,
            d.timestamp
        ]),
        theme: 'grid',
        styles: { fontSize: 8, cellPadding: 3 },
        headStyles: { fillColor: [52, 152, 219] }
    });

    doc.save(`buku-tamu-tubaba-${new Date().toISOString().slice(0,10)}.pdf`);
}
</script>

<!-- Tombol Export (bisa ditaruh di bawah form jika diinginkan) -->
<!-- <button onclick="exportPDF()" style="margin:30px auto; display:block;">üìÑ Export PDF Ringkasan</button> -->

</body>
</html>
