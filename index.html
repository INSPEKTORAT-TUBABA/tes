// === Element refs ===
const signatureCanvas = document.getElementById('signature-pad');
const canvas = signatureCanvas;
const ctx = canvas.getContext('2d');

const namaWarning = document.getElementById('namaWarning');
const signatureWarning = document.getElementById('signatureWarning');
const photoWarning = document.getElementById('photoWarning');

// Inisialisasi canvas ukuran dan style
function resizeCanvas() {
    const originalWidth = 700;
    const originalHeight = 200;
    const newWidth = Math.min(window.innerWidth - 40, originalWidth);
    const tempData = canvas.toDataURL();
    canvas.width = newWidth;
    canvas.height = Math.round(originalHeight * (newWidth / originalWidth));
    const img = new Image();
    img.onload = function () {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = tempData;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Konfigurasi tanda tangan dengan efek goresan pena
ctx.strokeStyle = '#0000FF'; // Warna biru cerah
ctx.lineWidth = 2;
ctx.lineCap = 'round';
ctx.lineJoin = 'round';
ctx.globalAlpha = 0.8; // Sedikit transparansi untuk realisme
let lastVelocity = 0;
let lastTime = 0;

let drawing = false;
let hasSignature = false;

function getCanvasPos(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches && e.touches[0]) {
        return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
        };
    }
    return {
        x: (e.clientX !== undefined ? e.clientX : e.offsetX) - rect.left,
        y: (e.clientY !== undefined ? e.clientY : e.offsetY) - rect.top
    };
}

function startDrawing(e) {
    drawing = true;
    hasSignature = true;
    ctx.beginPath();
    const pos = getCanvasPos(e);
    ctx.moveTo(pos.x, pos.y);
    lastTime = Date.now();
}

function draw(e) {
    if (!drawing) return;
    const pos = getCanvasPos(e);
    const currentTime = Date.now();
    const deltaTime = (currentTime - lastTime) / 1000;
    const prevPos = getCanvasPos(e);
    const distance = Math.sqrt((pos.x - prevPos.x) ** 2 + (pos.y - prevPos.y) ** 2);
    const velocity = distance / (deltaTime || 1);
    const smoothedVelocity = lastVelocity * 0.7 + velocity * 0.3;
    ctx.lineWidth = Math.max(1, Math.min(3, 2 - smoothedVelocity / 100));
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastVelocity = smoothedVelocity;
    lastTime = currentTime;
}

function stopDrawing() {
    if (!drawing) return;
    drawing = false;
    checkAndShowNext('signature-pad', 'field-aksi');
}

canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('mouseout', stopDrawing);

canvas.addEventListener('touchstart', function(e) {
    e.preventDefault();
    startDrawing(e);
}, {passive:false});
canvas.addEventListener('touchmove', function(e) {
    e.preventDefault();
    draw(e);
}, {passive:false});
canvas.addEventListener('touchend', function(e) {
    e.preventDefault();
    stopDrawing(e);
}, {passive:false});

function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    hasSignature = false;
    canvas.classList.remove('error', 'success');
    document.getElementById('field-aksi').style.display = 'none';
}

// === Daftar & logika asal / desa ===
const asal = document.getElementById("asal");
const daftarInstansi = document.getElementById("daftarInstansi");
const daftarMasyarakat = document.getElementById("daftarMasyarakat");
const kecamatan = document.getElementById("kecamatan");
const desa = document.getElementById("desa");
const instansi = document.getElementById("instansi");
const fieldDesa = document.getElementById("field-desa");

const dataDesa = {
    "Lambu Kibang": ["Kibang Budi Jaya", "Lesung Bhakti Jaya", "Mekar Sari Jaya", "Pagar Jaya", "Gunung Sari", "Sumber Rejo", "Kibang Yekti Jaya", "Kibang Tri Jaya", "Gilang Tunggal Makarta", "Kibang Mulya Jaya"],
    // ... tambahkan data desa lainnya sesuai kode asli ...
};

asal.addEventListener("change", function () {
    daftarInstansi.classList.add("hidden");
    daftarMasyarakat.classList.add("hidden");
    fieldDesa.classList.add("hidden");
    instansi.removeAttribute('required');
    kecamatan.removeAttribute('required');
    desa.removeAttribute('required');
    if (this.value === "INSTANSI") {
        daftarInstansi.classList.remove("hidden");
        instansi.setAttribute('required', '');
    } else if (this.value === "MASYARAKAT") {
        daftarMasyarakat.classList.remove("hidden");
        kecamatan.setAttribute('required', '');
    }
    checkAndShowNext('asal', 'field-pihakDitemui');
});

function updateDesaList() {
    const desaList = dataDesa[kecamatan.value] || [];
    desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
    desaList.forEach(nama => {
        const opt = document.createElement("option");
        opt.value = nama;
        opt.textContent = nama;
        desa.appendChild(opt);
    });
    if (kecamatan.value) {
        fieldDesa.classList.remove("hidden");
        desa.setAttribute('required', '');
    } else {
        fieldDesa.classList.add("hidden");
        desa.removeAttribute('required');
    }
    checkAndShowNext('kecamatan', 'field-pihakDitemui');
}

// === Validasi Nama ===
function validateNama() {
    const input = document.getElementById('nama');
    const warning = document.getElementById('namaWarning');
    input.value = input.value.replace(/\d+/g, '');
    let hurufCount = 0;
    try {
        hurufCount = (input.value.match(new RegExp("\\p{L}", "gu")) || []).length;
    } catch (e) {
        hurufCount = (input.value.match(/[A-Za-z]/g) || []).length;
    }
    const isValid = hurufCount >= 5;

    if (isValid) {
        input.classList.remove('error');
        input.classList.add('success');
        warning.style.display = 'none';
        document.getElementById('field-asal').style.display = 'block';
        // Tampilkan kembali dropdown yang telah dipilih
        document.querySelectorAll('select:not(#nama)').forEach(select => {
            if (select.value && select.closest('.hidden') === null) {
                select.closest('div[id^="field-"], .hidden').style.display = 'block';
            }
        });
    } else {
        input.classList.remove('success');
        input.classList.add('error');
        warning.style.display = 'block';
        hideFieldsAfter('field-nama');
        // Sembunyikan semua dropdown kecuali field-nama
        document.querySelectorAll('select:not(#nama)').forEach(select => {
            const parentDiv = select.closest('div[id^="field-"], .hidden');
            if (parentDiv && parentDiv.id !== 'field-nama') {
                parentDiv.style.display = 'none';
                select.classList.remove('success', 'error');
            }
        });
    }
}

// === Kamera & Foto ===
const photoModal = document.getElementById('photoModal');
const videoFront = document.getElementById('videoFront');
const videoBack = document.getElementById('videoBack');
const canvasFront = document.getElementById('canvasFront');
const canvasBack = document.getElementById('canvasBack');
const capturedFrontPhoto = document.getElementById('capturedFrontPhoto');
const capturedBackPhoto = document.getElementById('capturedBackPhoto');
let streamFront = null;
let streamBack = null;
let fotoDataURLFront = null;
let fotoDataURLBack = null;
let hasPhoto = false;

async function bukaKamera() {
    photoModal.style.display = 'flex';
    try {
        streamFront = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" }
        });
        videoFront.srcObject = streamFront;
        videoFront.play();
    } catch (error) {
        console.error("Gagal mengakses kamera depan:", error);
        videoFront.style.display = 'none';
    }

    try {
        streamBack = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });
        videoBack.srcObject = streamBack;
        videoBack.play();
    } catch (error) {
        console.error("Gagal mengakses kamera belakang:", error);
        videoBack.style.display = 'none';
    }

    if (!streamFront && !streamBack) {
        alert("❌ Gagal mengakses kamera!\n\nPastikan izin kamera sudah diberikan di pengaturan browser.");
        tutupModal();
    }
}

function ambilFoto() {
    if (!streamFront && !streamBack) {
        alert("Kamera belum aktif!");
        return;
    }

    if (streamFront) {
        const contextFront = canvasFront.getContext('2d');
        canvasFront.width = videoFront.videoWidth || 480;
        canvasFront.height = videoFront.videoHeight || Math.round(canvasFront.width * 3 / 4);
        contextFront.drawImage(videoFront, 0, 0, canvasFront.width, canvasFront.height);
        fotoDataURLFront = canvasFront.toDataURL('image/png');
        capturedFrontPhoto.src = fotoDataURLFront;
        capturedFrontPhoto.style.display = 'block';
        videoFront.style.display = 'none';
    }

    if (streamBack) {
        const contextBack = canvasBack.getContext('2d');
        canvasBack.width = videoBack.videoWidth || 480;
        canvasBack.height = videoBack.videoHeight || Math.round(canvasBack.width * 3 / 4);
        contextBack.drawImage(videoBack, 0, 0, canvasBack.width, canvasBack.height);
        fotoDataURLBack = canvasBack.toDataURL('image/png');
        capturedBackPhoto.src = fotoDataURLBack;
        capturedBackPhoto.style.display = 'block';
        videoBack.style.display = 'none';
    }

    hasPhoto = !!(fotoDataURLFront || fotoDataURLBack);
}

function tutupModal() {
    photoModal.style.display = 'none';
    if (streamFront) {
        streamFront.getTracks().forEach(track => track.stop());
        streamFront = null;
    }
    if (streamBack) {
        streamBack.getTracks().forEach(track => track.stop());
        streamBack = null;
    }
    capturedFrontPhoto.style.display = 'none';
    capturedBackPhoto.style.display = 'none';
    videoFront.style.display = 'block';
    videoBack.style.display = 'block';
    fotoDataURLFront = null;
    fotoDataURLBack = null;
    hasPhoto = false;
}

function simpanFotoLangsung() {
    if (!hasPhoto) {
        alert("❌ Harap ambil foto terlebih dahulu!");
        return;
    }
    if (simpanData()) {
        alert("✅ Data berhasil disimpan!\n\nTotal data: " + dataBukuTamu.length);
        tutupModal();
        showData();
    } else {
        alert("❌ Mohon lengkapi semua data yang diperlukan:\n- Isi semua field yang bertanda (*)\n- Buat tanda tangan\n- Ambil foto");
    }
}
