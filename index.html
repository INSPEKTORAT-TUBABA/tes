<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <link rel="manifest" href="manifest.json"/>
    <meta name="theme-color" content="#007bff"/>
    <link rel="icon" href="icon-192.png"/>
    <title>Buku Tamu Digital</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
        body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 20px 10px; min-height: 100vh; }
        label { font-weight: bold; }
        select, input, textarea { width: 100%; padding: 6px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .hidden { display: none; }
        .required { color: red; }
        .error { border: 2px solid red !important; }
        .success { border: 2px solid green !important; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .header-gambar { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px; flex-wrap: nowrap; }
        .foto-kepala { width: 80px; height: auto; }
        .logo { width: 100px; height: auto; }

        /* Modal Foto */
        #photoModal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; padding: 10px; }
        #modalContent { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 95%; max-width: 1300px; text-align: center; border-radius: 8px; }
        #dualCameraFrame { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 900px; margin: 20px auto; }
        .camera-view { width: 100%; border: 3px solid #007bff; aspect-ratio: 4/3; overflow: hidden; position: relative; border-radius: 10px; background: #000; }
        .camera-view h4 { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 8px 16px; border-radius: 20px; margin: 0; font-size: 16px; z-index: 10; white-space: nowrap; }
        .camera-view video, .camera-view img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        @media (min-width: 768px) {
            #dualCameraFrame { flex-direction: row; gap: 30px; max-width: 1200px; }
            .camera-view { flex: 1; aspect-ratio: 16/9; max-width: 600px; }
            .camera-view h4 { font-size: 18px; padding: 10px 20px; }
        }
        #modalButtons { margin-top: 10px; display: flex; gap: 10px; justify-content: center; }
        #modalButtons button { padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        .btn-camera { background: #ffc107; color: black; }
        .btn-save { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
        .btn-camera:hover { background: #e0a800; }
        .btn-save:hover { background: #218838; }
        .btn-cancel:hover { background: #c82333; }
        .data-card { border: 1px solid #ddd; margin-bottom: 15px; padding: 15px; border-radius: 8px; background: #f9f9f9; }
        .data-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; }
        @media (min-width: 500px) { .data-grid { grid-template-columns: 1fr 1fr; } }
        .data-images { display: flex; flex-direction: column; gap: 20px; margin-top: 15px; }
        @media (min-width: 500px) { .data-images { flex-direction: row; } }
        #signature-pad { background: white; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Bagian HTML form, header, dan tampilan data tetap sama seperti sebelumnya -->

    <div style="margin-bottom: 80px;">
        <button type="button" onclick="showForm()" id="btnForm" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">üìù Form Input</button>
        <button type="button" onclick="showData()" id="btnData" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">üìä Lihat Data (<span id="dataCount">0</span>)</button>
        <button type="button" onclick="exportData()" id="btnExport" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üíæ Export PDF</button>
    </div>

    <!-- Sisanya sama seperti kode asli Anda -->

    <script>
        // ... (semua kode JavaScript sebelumnya tetap sama, termasuk signature, kamera, simpan data, dll) ...

        // Fungsi exportData yang sudah sangat dioptimasi dan aman
        function exportData() {
            if (dataBukuTamu.length === 0) {
                alert('Tidak ada data untuk di-export!\nSilakan tambahkan data terlebih dahulu.');
                return;
            }

            // Pastikan library jsPDF sudah ter-load
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                alert('Gagal memuat library PDF.\nCoba refresh halaman atau periksa koneksi internet.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Header lebih ringkas
                doc.setFontSize(13);
                doc.text('BUKU TAMU DIGITAL INSPEKTORAT KABUPATEN TULANG BAWANG BARAT', 148, 10, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Tanggal Export: ' + new Date().toLocaleDateString('id-ID'), 148, 16, { align: 'center' });

                // Header kolom dengan line break untuk hemat ruang
                const head = [[
                    'No',
                    'Nama',
                    'Instansi',
                    'Kecamatan',
                    'Desa/Tiyuh',
                    'Pihak\nDitemui',
                    'Jenis\nLayanan',
                    'Uraian',
                    'No HP',
                    'Tanggal',
                    'Tanda\nTangan',
                    'Foto\nDepan',
                    'Foto\nBelakang'
                ]];

                // Data dengan pembatasan panjang teks
                const body = dataBukuTamu.map((d, i) => [
                    i + 1,
                    d.nama ? d.nama.substring(0, 40) + (d.nama.length > 40 ? '...' : '') : '-',
                    d.asal === 'INSTANSI' ? (d.instansi || '-').substring(0, 38) + ((d.instansi || '').length > 38 ? '...' : '') : '-',
                    d.asal === 'MASYARAKAT' ? (d.kecamatan || '-').substring(0, 30) + ((d.kecamatan || '').length > 30 ? '...' : '') : '-',
                    d.desa ? d.desa.substring(0, 30) + (d.desa.length > 30 ? '...' : '') : '-',
                    d.pihakDitemui || '-',
                    d.jenisLayanan || '-',
                    d.uraian ? d.uraian.substring(0, 220) + (d.uraian.length > 220 ? '...' : '') : '-',
                    d.nomorHp || '-',
                    d.timestamp ? d.timestamp.split(', ')[0] : '-',
                    '', '', ''
                ]);

                doc.autoTable({
                    head: head,
                    body: body,
                    startY: 20,
                    margin: { top: 20, left: 6, right: 6, bottom: 12 },
                    theme: 'grid',
                    styles: {
                        fontSize: 7.6,
                        cellPadding: 2.4,
                        overflow: 'linebreak',
                        halign: 'left',
                        valign: 'middle',
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [0, 123, 255],
                        textColor: 255,
                        fontSize: 8.2,
                        fontStyle: 'bold',
                        halign: 'center',
                        cellPadding: 2.8
                    },
                    alternateRowStyles: { fillColor: [245, 248, 255] },
                    columnStyles: {
                        0:  { cellWidth: 9,   halign: 'center' },
                        1:  { cellWidth: 32 },
                        2:  { cellWidth: 34 },
                        3:  { cellWidth: 27 },
                        4:  { cellWidth: 26 },
                        5:  { cellWidth: 22 },
                        6:  { cellWidth: 20 },
                        7:  { cellWidth: 58 },  // Uraian paling lebar + wrap
                        8:  { cellWidth: 20 },
                        9:  { cellWidth: 20 },
                        10: { cellWidth: 14 },
                        11: { cellWidth: 14 },
                        12: { cellWidth: 14 }
                    },
                    didDrawCell: function(data) {
                        if (data.section === 'body' && data.column.index >= 10 && data.column.index <= 12) {
                            const item = dataBukuTamu[data.row.index];
                            let imgData = null;
                            if (data.column.index === 10) imgData = item.tandaTangan;
                            if (data.column.index === 11) imgData = item.fotoFront;
                            if (data.column.index === 12) imgData = item.fotoBack;

                            if (imgData) {
                                try {
                                    const imgWidth = 12;
                                    const imgHeight = 9;
                                    const x = data.cell.x + (data.cell.width - imgWidth) / 2;
                                    const y = data.cell.y + (data.cell.height - imgHeight) / 2;
                                    doc.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight, undefined, 'FAST');
                                } catch (e) {
                                    console.warn('Gambar gagal ditambahkan:', e);
                                }
                            }
                        }
                    },
                    rowPageBreak: 'avoid'
                });

                const filename = 'Buku_Tamu_Inspektorat_Tubaba_' + new Date().toISOString().slice(0,10) + '.pdf';
                doc.save(filename);
                
                alert('PDF berhasil diekspor!\nFile tersimpan dengan nama:\n' + filename);
            } catch (error) {
                console.error('Error saat export PDF:', error);
                alert('Gagal mengekspor PDF!\nPesan error: ' + error.message + '\nCoba refresh halaman atau kurangi data.');
            }
        }

        // ... (fungsi autoResize dan event DOMContentLoaded tetap sama) ...
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b867facb8997a7a',t:'MTc2NzQ4NTI3OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
