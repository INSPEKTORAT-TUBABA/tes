<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Buku Tamu Digital - Inspektorat Tubaba</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; background: #0a0e27; }
        body { font-family: 'Arial', sans-serif; min-height: 100vh; }
        
        /* Welcome Page Styles */
        #welcomePage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2a2f4a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        #particleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .welcome-content {
            position: relative;
            z-index: 2;
            text-align: center;
            padding: 20px;
        }
        
        .welcome-title {
            font-size: 2.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px rgba(102, 126, 234, 0.8),
                         0 0 40px rgba(118, 75, 162, 0.6);
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(102, 126, 234, 0.8), 0 0 40px rgba(118, 75, 162, 0.6); }
            to { text-shadow: 0 0 30px rgba(102, 126, 234, 1), 0 0 60px rgba(118, 75, 162, 0.8); }
        }
        
        .welcome-subtitle {
            font-size: 1.2em;
            color: #aab;
            margin-bottom: 40px;
            animation: fadeIn 1.5s ease-in;
        }
        
        .welcome-subtitle strong {
            font-size: 1.5em;
            display: block;
            margin-top: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn-start {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .btn-start:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        /* Main App Styles */
        #mainApp {
            display: none;
            max-width: 700px;
            margin: auto;
            padding: 20px 10px;
            background: white;
        }
        
        .header-gambar { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px; flex-wrap: nowrap; }
        .foto-kepala { width: 80px; height: auto; }
        .logo { width: 100px; height: auto; }
        
        label { font-weight: bold; }
        select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .hidden { display: none !important; }
        .required { color: red; }
        .error { border: 2px solid red !important; }
        .success { border: 2px solid green !important; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px; }
        
        #mainNavigation { margin: 20px 0; text-align: center; display: none; }
        #mainNavigation button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        #photoModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 10px;
        }

        #signature-pad { 
            background: white; 
            border: 3px solid #007bff;
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            display: block !important;          /* paksa tampil */
            margin: 10px auto;                  /* center sedikit */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 300px;                   /* minimal lebar biar tidak hilang */
            width: 100% !important;             /* ambil lebar parent penuh */
            max-width: 600px;
            height: 200px !important;           /* paksa tinggi */
        }
        
        .detail-container {
            max-width: 900px;
            margin: 20px auto;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .detail-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .detail-row {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            min-height: 50px;
        }
        .detail-label {
            width: 200px;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 14px;
            color: #495057;
            display: flex;
            align-items: center;
        }
        .detail-value {
            flex: 1;
            padding: 15px 20px;
            font-size: 14px;
            color: #212529;
            display: flex;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .welcome-title { font-size: 1.8em; }
            .detail-row { flex-direction: column; }
            .detail-label { width: 100%; border-right: none; border-bottom: 1px solid #e0e0e0; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- Welcome Page -->
<div id="welcomePage">
    <canvas id="particleCanvas"></canvas>
    <div class="welcome-content">
        <h1 class="welcome-title">SELAMAT DATANG</h1>
        <p class="welcome-subtitle">DI <strong>INSPEKTORAT DAERAH</strong><br/>KABUPATEN TULANG BAWANG BARAT</p>
        <button class="btn-start" onclick="startApp()">üìù ISI BUKU TAMU</button>
    </div>
</div>

<!-- Main Application -->
<div id="mainApp">
    <div class="header-gambar">
        <img src="bupati.png" alt="Wakil Bupati" class="foto-kepala" onerror="this.style.display='none'">
        <img src="logo-tubaba.png" alt="Logo Tubaba" class="logo" onerror="this.style.display='none'">
        <img src="wakil-bupati.png" alt="Bupati" class="foto-kepala" onerror="this.style.display='none'">
    </div>

    <div style="text-align: center; font-weight: bold; line-height: 1.3; margin: 20px 0;">
    <div>BUKU TAMU</div>
    <div>INSPEKTORAT DAERAH</div>
    <div>KABUPATEN TULANG BAWANG BARAT</div>
</div>

    <div id="formSection">
        <form id="bukuTamuForm">
            <div id="field-nama">
                <label>Nama: <span class="required">*</span></label>
                <input id="nama" required type="text" placeholder="Isi Minimal 5 Huruf" oninput="validateNama();"/>
            </div>

            <div id="field-asal" class="hidden">
                <label>INSTANSI/ASAL: <span class="required">*</span></label>
                <select id="asal" required onchange="asalChanged();">
                    <option value="">-- Pilih Asal --</option>
                    <option value="INSTANSI">INSTANSI/UNIT KERJA</option>
                    <option value="MASYARAKAT">MASYARAKAT</option>
                </select>
            </div>

            <div class="hidden" id="daftarInstansi">
                <label>DAFTAR INSTANSI/UNIT KERJA: <span class="required">*</span></label>
                <select id="instansi" onchange="checkAndShowNext('instansi', 'field-pihakDitemui');">
                    <option value="">-- Pilih Instansi --</option>
                    <option>SEKRETARIAT DAERAH</option>
                    <option>SEKRETARIAT DPRD</option>
                    <option>BADAN PERENCANAAN PEMBANGUNAN DAERAH</option>
                    <option>BADAN PENGELOLAAN KEUANGAN DAN ASET DAERAH</option>
                    <option>BADAN PENGELOLAAN PAJAK DAN RETRIBUSI DAERAH</option>
                    <option>BADAN KEPEGAWAIAN DAN PENGEMBANGAN SUMBER DAYA MANUSIA</option>
                    <option>BADAN KESATUAN BANGSA DAN POLITIK DAERAH</option>
                    <option>BADAN PENANGGULANGAN BENCANA DAERAH</option>
                    <option>DINAS LINGKUNGAN HIDUP</option>
                    <option>DINAS KESEHATAN</option>
                    <option>DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                    <option>DINAS KOPERASI, UMKM, PERINDUSTRIAN DAN PERDAGANGAN</option>
                    <option>DINAS SOSIAL</option>
                    <option>DINAS PEMUDA, OLAHRAGA DAN PARIWISATA</option>
                    <option>DINAS KOMUNIKASI DAN INFORMATIKA</option>
                    <option>DINAS PERUMAHAN, KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                    <option>DINAS PENANAMAN MODAL DAN PELAYANAN PERIZINAN TERPADU SATU PINTU</option>
                    <option>DINAS PENDIDIKAN DAN KEBUDAYAAN</option>
                    <option>DINAS KETAHANAN PANGAN</option>
                    <option>DINAS PEMBERDAYAAN MASYARAKAT DAN TIYUH</option>
                    <option>DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                    <option>DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                    <option>DINAS PERHUBUNGAN</option>
                    <option>DINAS PERTANIAN</option>
                    <option>DINAS PETERNAKAN DAN KESEHATAN HEWAN</option>
                    <option>DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                    <option>DINAS TENAGA KERJA DAN TRANSMIGRASI</option>
                    <option>DINAS PERIKANAN</option>
                    <option>DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                    <option>DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</option>
                    <option>SATUAN POLISI PAMONG PRAJA</option>
                    <option>BADAN PENGAWASAN KEUANGAN DAN PEMBANGUNAN (BPKP)</option>
                    <option>LAINNYA</option>
                </select>
            </div>

            <div class="hidden" id="daftarMasyarakat">
                <label>Kecamatan: <span class="required">*</span></label>
                <select id="kecamatan" onchange="updateDesaList();">
                    <option value="">-- Pilih Kecamatan --</option>
                    <option value="Tulang Bawang Tengah">1. Tulang Bawang Tengah</option>                    
                    <option value="Tulang Bawang Udik">2. Tulang Bawang Udik</option>
                    <option value="Tumijajar">3. Tumijajar</option>
                    <option value="Gunung Agung">4. Gunung Agung</option>
                    <option value="Way Kenanga">5. Way Kenanga</option>
                    <option value="Gunung Terang">6. Gunung Terang</option>
                    <option value="Lambu Kibang">7. Lambu Kibang</option>
                    <option value="Pagar Dewa">8. Pagar Dewa</option>
                    <option value="Batu Putih">9. Batu Putih</option>
                </select>
            </div>

            <div class="hidden" id="fieldDesa">
                <label>Desa/Kelurahan: <span class="required">*</span></label>
                <select id="desa" onchange="checkAndShowNext('desa', 'field-pihakDitemui');"></select>
            </div>

            <div id="field-pihakDitemui" class="hidden">
                <label>PIHAK YANG DITEMUI: <span class="required">*</span></label>
                <select id="pihakDitemui" required onchange="checkAndShowNext('pihakDitemui', 'field-jenisLayanan');">
                    <option value="">-- Pilih Pihak yang Ditemui --</option>
                    <option>INSPEKTUR</option>
                    <option>SEKRETARIS</option>
                    <option>IRBANSUS</option>
                    <option>IRBAN 1</option>
                    <option>IRBAN 2</option>
                    <option>IRBAN 3</option>
                    <option>IRBAN 4</option>
                </select>
            </div>

            <div id="field-jenisLayanan" class="hidden">
                <label>JENIS LAYANAN: <span class="required">*</span></label>
                <select id="jenisLayanan" required onchange="checkAndShowNext('jenisLayanan', 'field-uraian');">
                    <option value="">-- Pilih Jenis Layanan --</option>
                    <option>Permintaan Audit/Klarifikasi Khusus</option>
                    <option>Penanganan Pengaduan</option>
                    <option>Layanan Informasi Publik</option>
                    <option>Pembinaan & Konsultasi</option>
                    <option>Audit</option>
                    <option>Review</option>
                    <option>Evaluasi / Monitoring</option>
                    <option>Tindak Lanjut Temuan</option>
                </select>
            </div>

            <div id="field-uraian" class="hidden">
                <label>URAIAN: <span class="required">*</span></label>
                <textarea id="uraian" required rows="3" 
                    oninput="validateUraian(); autoResize(this);"></textarea>
            </div>

            <div id="field-nomorHp" class="hidden">
                <label>Nomor WhatsApp: <span class="required">*</span></label>
                <small style="color:#555; display:block; margin-bottom:4px;">
                    Harus diawali dengan <strong>08</strong> (contoh: 081234567890)
                </small>
                <input 
                    id="nomorHp" 
                    required 
                    type="tel" 
                    placeholder="08xxxxxxxxxx" 
                    pattern="08[0-9]{9,11}" 
                    maxlength="13" 
                    minlength="11"
                    oninput="validateNomorHp(this); checkAndShowNext('nomorHp', 'field-tandaTangan');"
                />
                <small id="nomorHpInfo" style="color:#dc3545; display:block; min-height:1.2em;"></small>
            </div>

            <!-- Tanda Tangan -->
            <div id="field-tandaTangan" class="hidden">
                <label>Tanda Tangan: <span class="required">*</span></label>
                <div class="warning" id="signatureWarning" style="display:none;">‚ö†Ô∏è Tanda tangan terlalu pendek (min 2 cm)</div>
                <canvas id="signature-pad" width="600" height="200"></canvas>
            </div>

            <!-- Tombol Aksi (Ambil Foto + Hapus Tanda Tangan) -->
            <div id="field-aksi" class="hidden" style="margin-top: 15px; text-align: center;">
                <div style="margin-bottom: 15px;">
                    <button type="button" onclick="bukaKamera()" 
                            style="font-size: 16px; background: #ffc107; color: black; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                        üì∏ Ambil Foto
                    </button>
                    
                    <button type="button" onclick="clearSignature()" 
                            style="font-size: 16px; background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                        üóëÔ∏è Hapus Tanda Tangan
                    </button>
                </div>

                <!-- Warning foto -->
                <div class="warning" id="photoWarning" style="display:none; margin: 10px 0;">‚ö†Ô∏è Foto wajib diambil!</div>

                <!-- Preview foto (tanpa label Depan/Belakang) -->
                <div id="photoPreview" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                    <div style="text-align:center;">
                        <img id="imgFront" style="max-width:220px; border:1px solid #ccc; border-radius:8px; display:none;" alt="Foto 1">
                    </div>
                    <div style="text-align:center;">
                        <img id="imgBack" style="max-width:220px; border:1px solid #ccc; border-radius:8px; display:none;" alt="Foto 2">
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div id="editModeButtons" style="margin-bottom: 80px; text-align: center; display: none;">
        <button type="button" onclick="saveEditedData()" 
                style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 5px; margin: 0 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
            üíæ Simpan Perubahan
        </button>
        <button type="button" onclick="cancelEdit()" 
                style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 5px; margin: 0 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ‚ùå Batal
        </button>
    </div>

    <div id="mainNavigation">
        <button onclick="showForm()" id="btnForm">üìù Form Input</button>
        <button onclick="showData()" id="btnData">üìä Lihat Data (<span id="dataCount">0</span>)</button>
        <button onclick="exportData()" id="btnExport">üìë Export Tabel Ringkasan</button>
    </div>

    <div id="dataSection" style="display: none;">
        <h2>üìä DATA BUKU TAMU</h2>
        <div style="margin-bottom: 20px;">
        </div>
        <div id="dataContainer"></div>
    </div>

    <!-- MODAL KAMERA -->
    <div id="photoModal">
        <div style="background:#fff; padding:20px; border-radius:12px; max-width:95%; width:100%; max-height:95vh; overflow-y:auto; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.4);">
            <h3 style="margin:0 0 15px; color:#333;">Ambil Dokumentasi Foto</h3>
            
            <div id="infoKamera" style="font-size:1.1em; font-weight:bold; margin-bottom:15px; color:#007bff;">
                Ambil foto pertama
            </div>

            <video id="video" autoplay playsinline muted style="width:100%; max-width:420px; background:#000; border-radius:8px; margin-bottom:20px;"></video>

            <div style="margin:20px 0;">
                <button type="button" class="btn-capture" onclick="capture()" 
                        style="background:#28a745; color:white; border:none; padding:14px 32px; font-size:1.2em; border-radius:50px; cursor:pointer; margin:0 10px; box-shadow:0 4px 12px rgba(40,167,69,0.4);">
                    üì∏ Ambil Foto
                </button>
                <button type="button" class="btn-cancel" onclick="stopAll()" 
                        style="background:#dc3545; color:white; border:none; padding:14px 32px; font-size:1.2em; border-radius:50px; cursor:pointer; margin:0 10px;">
                    ‚ùå Batal
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== PARTICLE ANIMATION =====
const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const particles = [];
const particleCount = 150;

class Particle {
    constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.z = Math.random() * 1000;
        this.vx = (Math.random() - 0.5) * 0.5;
        this.vy = (Math.random() - 0.5) * 0.5;
        this.vz = Math.random() * 2 + 1;
        this.size = Math.random() * 2 + 1;
        this.hue = Math.random() * 60 + 220;
    }
    
    update() {
        this.z -= this.vz;
        if (this.z <= 0) {
            this.z = 1000;
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
        }
        
        const scale = 1000 / (1000 + this.z);
        this.screenX = (this.x - canvas.width / 2) * scale + canvas.width / 2;
        this.screenY = (this.y - canvas.height / 2) * scale + canvas.height / 2;
        this.screenSize = this.size * scale;
    }
    
    draw() {
        const opacity = (1000 - this.z) / 1000;
        ctx.fillStyle = `hsla(${this.hue}, 100%, 60%, ${opacity})`;
        ctx.beginPath();
        ctx.arc(this.screenX, this.screenY, this.screenSize, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.shadowBlur = 10;
        ctx.shadowColor = `hsla(${this.hue}, 100%, 60%, ${opacity})`;
    }
}

for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
}

function animateParticles() {
    ctx.fillStyle = 'rgba(10, 14, 39, 0.1)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    particles.forEach(particle => {
        particle.update();
        particle.draw();
    });
    
    requestAnimationFrame(animateParticles);
}

animateParticles();

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

function startApp() {
    document.getElementById('welcomePage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.body.style.background = 'white';
}

function goToWelcome() {
    document.getElementById('welcomePage').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    document.body.style.background = '#0a0e27';
    
    document.getElementById('bukuTamuForm').reset();
    hideAllFields();
    document.getElementById('mainNavigation').style.display = 'none';
    document.getElementById('formSection').style.display = 'block';
    document.getElementById('dataSection').style.display = 'none';
}

// ===== GLOBAL VARIABLES =====
let dataBukuTamu = [];
let signatureCanvas, ctx2, isDrawing = false, totalStrokeLength = 0;
let hasSignature = false, hasPhoto = false;
let fotoDataURLFront = null, fotoDataURLBack = null;
let stream = null;
let step = 1; // 1 = depan, 2 = belakang
let editingIndex = -1, originalEditData = null;
let isEditMode = false;

const PIXELS_PER_CM = 37.7952755906;
const MIN_STROKE_LENGTH_CM = 2;

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    signatureCanvas = document.getElementById('signature-pad');
    ctx2 = signatureCanvas.getContext('2d');
    attachSignatureEvents();  // menggunakan fungsi baru yang lebih aman
    window.addEventListener('resize', resizeCanvas);
});

function attachSignatureEvents() {
    // Attach semua event listener (tidak remove dulu supaya aman saat pertama kali)
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    signatureCanvas.addEventListener('touchstart', handleTouch);
    signatureCanvas.addEventListener('touchmove', handleTouch);
    signatureCanvas.addEventListener('touchend', stopDrawing);
}

function resizeCanvas() {
    const field = document.getElementById('field-tandaTangan');
    if (!field || field.classList.contains('hidden')) return;

    // Tunggu sebentar agar elemen benar-benar visible
    setTimeout(() => {
        const container = signatureCanvas.parentElement;
        let newWidth = Math.min(container.offsetWidth || 600, 600);
        if (newWidth < 300) newWidth = 300;  // minimal biar tidak hilang

        // Simpan gambar lama sebelum resize
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = signatureCanvas.width;
        tempCanvas.height = signatureCanvas.height;
        tempCanvas.getContext('2d').drawImage(signatureCanvas, 0, 0);

        // Apply ukuran baru
        signatureCanvas.width = newWidth;
        signatureCanvas.height = 200;

        // Restore gambar + style drawing
        ctx2.drawImage(tempCanvas, 0, 0, newWidth, 200);
        ctx2.lineWidth = 2;
        ctx2.lineCap = 'round';
        ctx2.strokeStyle = '#00008B';

        // Re-attach events
        attachSignatureEvents();

        console.log("Canvas resized to:", newWidth, "x 200"); // debug
    }, 100); // delay kecil agar layout selesai
}
function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx2.beginPath();
    ctx2.moveTo(x, y);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx2.lineTo(x, y);
    ctx2.stroke();
    totalStrokeLength += 2;
    hasSignature = true;
}

function stopDrawing() {
    if (isDrawing) {
        isDrawing = false;
        const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
        if (strokeLengthCm >= MIN_STROKE_LENGTH_CM) {
            document.getElementById('field-aksi').classList.remove('hidden');
            signatureCanvas.classList.remove('error');
            document.getElementById('signatureWarning').style.display = 'none';
        }
    }
}

function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    signatureCanvas.dispatchEvent(mouseEvent);
}

function clearSignature() {
    ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    hasSignature = false;
    totalStrokeLength = 0;
    document.getElementById('signatureWarning').style.display = 'none';
    document.getElementById('field-aksi').classList.add('hidden');
}

// ===== FORM VALIDATION & NAVIGATION =====
function validateNama() {
    if (isEditMode) return;

    const namaInput = document.getElementById('nama');
    const namaValue = namaInput.value.trim();
    
    let hurufCount = 0;
    try {
        hurufCount = (namaValue.match(/\p{L}/gu) || []).length;
    } catch (e) {
        hurufCount = (namaValue.match(/[A-Za-z]/g) || []).length;
    }
    
    if (hurufCount >= 5) {
        namaInput.classList.remove('error');
        namaInput.classList.add('success');
        document.getElementById('field-asal').classList.remove('hidden');
        
        if (namaValue.toUpperCase() === 'UNTUNG') {
            document.getElementById('mainNavigation').style.display = 'block';
        }
    } else {
        namaInput.classList.add('error');
        namaInput.classList.remove('success');
        hideFieldsAfter('field-asal');
    }
}

function validateNomorHp(input) {
    if (isEditMode) return; // tetap longgar saat edit

    let value = input.value.trim();
    
    // Hapus semua karakter non-angka kecuali awalan
    const onlyDigits = value.replace(/[^0-9]/g, '');
    
    // Paksa awalan 08 jika user mulai ketik
    if (onlyDigits.length > 0 && !onlyDigits.startsWith('08')) {
        if (onlyDigits.startsWith('8')) {
            input.value = '0' + onlyDigits; // tambah 0 di depan jika mulai dengan 8
        } else if (onlyDigits.startsWith('62')) {
            input.value = '0' + onlyDigits.substring(2); // ganti 62 ‚Üí 08
        } else {
            input.value = '08' + onlyDigits; // paksa awalan 08
        }
    } else {
        input.value = onlyDigits;
    }

    const cleaned = input.value.trim();
    const isValidFormat = cleaned.startsWith('08') && 
                         cleaned.length >= 11 && 
                         cleaned.length <= 13 && 
                         /^[0-9]+$/.test(cleaned);

    // Update visual feedback
    if (isValidFormat) {
        input.classList.remove('error');
        input.classList.add('success');
        document.getElementById('nomorHpInfo').textContent = '';
    } else {
        input.classList.remove('success');
        input.classList.add('error');
        
        let msg = '';
        if (cleaned.length === 0) {
            msg = '';
        } else if (!cleaned.startsWith('08')) {
            msg = 'Harus diawali dengan 08';
        } else if (cleaned.length < 11) {
            msg = `Minimal 11 digit (saat ini: ${cleaned.length})`;
        } else if (cleaned.length > 13) {
            msg = `Maksimal 13 digit (saat ini: ${cleaned.length})`;
        }
        document.getElementById('nomorHpInfo').textContent = msg;
    }

    // Jika valid ‚Üí lanjut ke field berikutnya
    if (isValidFormat) {
        document.getElementById('field-tandaTangan').classList.remove('hidden');
        resizeCanvas();
    } else {
        hideFieldsAfter('field-nomorHp');
    }
}

function asalChanged() {
    if (isEditMode) {
        const asal = document.getElementById('asal').value;
        const daftarInstansi = document.getElementById('daftarInstansi');
        const daftarMasyarakat = document.getElementById('daftarMasyarakat');
        
        if (asal === 'INSTANSI') {
            daftarInstansi.classList.remove('hidden');
            daftarMasyarakat.classList.add('hidden');
        } else if (asal === 'MASYARAKAT') {
            daftarMasyarakat.classList.remove('hidden');
            daftarInstansi.classList.add('hidden');
        } else {
            daftarInstansi.classList.add('hidden');
            daftarMasyarakat.classList.add('hidden');
        }
        return;
    }

    const asal = document.getElementById('asal').value;
    const daftarInstansi = document.getElementById('daftarInstansi');
    const daftarMasyarakat = document.getElementById('daftarMasyarakat');
    
    if (asal === 'INSTANSI') {
        daftarInstansi.classList.remove('hidden');
        daftarMasyarakat.classList.add('hidden');
    } else if (asal === 'MASYARAKAT') {
        daftarMasyarakat.classList.remove('hidden');
        daftarInstansi.classList.add('hidden');
    } else {
        daftarInstansi.classList.add('hidden');
        daftarMasyarakat.classList.add('hidden');
    }
}

const dataDesa = {
    "Batu Putih": [
        "Marga Sari", "Margo Dadi", "Margo Mulya", "Mulyo Sari", "Panca Marga",
        "Sakti Jaya", "Sido Makmur", "Toto Katon", "Toto Makmur", "Toto Wonodadi"
    ],
    "Gunung Agung": [
        "Bangun Jaya", "Dwikora Jaya", "Jaya Murni", "Marga Jaya", "Mekar Jaya",
        "Mulya Jaya", "Mulya Sari", "Suka Jaya", "Sumber Jaya", "Sumber Rejeki",
        "Tri Tunggal Jaya", "Tunas Jaya", "Wono Rejo"
    ],
    "Gunung Terang": [
        "Gunung Agung", "Gunung Terang", "Kagungan Jaya", "Mulyo Jadi", "Setia Agung",
        "Setia Bumi", "Terang Bumi Agung", "Terang Makmur", "Terang Mulya", "Toto Mulyo"
    ],
    "Lambu Kibang": [
        "Gilang Tunggal Makarta", "Gunung Sari", "Kibang Budi Jaya", "Kibang Mulya Jaya",
        "Kibang Tri Jaya", "Kibang Yekti Jaya", "Lesung Bhakti Jaya", "Mekar Sari Jaya",
        "Pagar Jaya", "Sumber Rejo"
    ],
    "Pagar Dewa": [
        "Bujung Dewa", "Bujung Sari Marga", "Cahyou (Cahyou) Randu", "Marga Jaya Indah",
        "Pagar Dewa", "Pagar Dewa Suka Mulya"
    ],
    "Tulang Bawang Tengah": [
        "Bandar Dewa", "Candra Jaya", "Candra Kencana", "Candra Mukti", "Menggala Mas",
        "Mulya Jaya", "Mulya Kencana", "Mulyo Asri", "Panaragan", "Panaragan Jaya",
        "Panaragan Jaya Indah", "Panaragan Jaya Utama", "Penumangan", "Penumangan Baru",
        "Pulung Kencana", "Tirta Kencana", "Tirta Makmur", "Tunas Asri"
    ],
    "Tulang Bawang Udik": [
        "Gedung Ratu", "Gunung Katun Malai", "Gunung Katun Tanjungan", "Kagungan Ratu",
        "Karta", "Karta Raharja", "Karta Sari", "Marga Kencana", "Wai Sido"
    ],
    "Tumijajar": [
        "Daya Asri", "Daya Murni", "Daya Sakti", "Gunung Menanti", "Gunung Timbul",
        "Makarti", "Margo Dadi", "Margo Mulyo", "Murni Jaya", "Sumber Rejo"
    ],
    "Way Kenanga": [
        "Agung Jaya", "Balam Asri", "Balam Jaya", "Indraloka I", "Indraloka II",
        "Indraloka Jaya", "Indraloka Mukti", "Mercu Buana", "Pagar Buana"
    ]
};

function updateDesaList() {
    const kecamatan = document.getElementById('kecamatan').value;
    const desaSelect = document.getElementById('desa');
    const fieldDesa = document.getElementById('fieldDesa');
    
    desaSelect.innerHTML = '<option value="">-- Pilih Desa/Kelurahan --</option>';
    
    if (kecamatan && dataDesa[kecamatan]) {
        dataDesa[kecamatan].forEach(desa => {
            const option = document.createElement('option');
            option.value = desa;
            option.textContent = desa;
            desaSelect.appendChild(option);
        });
        fieldDesa.classList.remove('hidden');
    } else {
        fieldDesa.classList.add('hidden');
    }
}

function checkAndShowNext(currentId, nextFieldId) {
    if (isEditMode) return;

    const currentElement = document.getElementById(currentId);
    if (currentElement && currentElement.value.trim() !== '') {
        document.getElementById(nextFieldId).classList.remove('hidden');
        if (nextFieldId === 'field-tandaTangan') {
            resizeCanvas();
        }
    }
}

function hideFieldsAfter(fieldId) {
    if (isEditMode) return;

    const fields = ['field-asal', 'daftarInstansi', 'daftarMasyarakat', 'fieldDesa', 
                    'field-pihakDitemui', 'field-jenisLayanan', 'field-uraian', 
                    'field-nomorHp', 'field-tandaTangan', 'field-aksi'];
    let found = false;
    fields.forEach(id => {
        if (found) document.getElementById(id).classList.add('hidden');
        if (id === fieldId) found = true;
    });
}

function hideAllFields() {
    const fields = ['field-asal', 'daftarInstansi', 'daftarMasyarakat', 'fieldDesa', 
                    'field-pihakDitemui', 'field-jenisLayanan', 'field-uraian', 
                    'field-nomorHp', 'field-tandaTangan', 'field-aksi'];
    fields.forEach(id => document.getElementById(id).classList.add('hidden'));
}

function countWords(str) {
    if (!str.trim()) return 0;
    return str.trim().split(/\s+/).filter(word => word.length > 0).length;
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

function validateUraian() {
    if (isEditMode) return;

    const uraian = document.getElementById('uraian');
    const kata = countWords(uraian.value);
    
    if (kata >= 10) {
        uraian.classList.remove('error');
        uraian.classList.add('success');
        document.getElementById('field-nomorHp').classList.remove('hidden');
    } else {
        uraian.classList.remove('success');
        uraian.classList.add('error');
        hideFieldsAfter('field-uraian');
    }
    
    let info = document.getElementById('uraianInfo');
    if (!info) {
        info = document.createElement('small');
        info.id = 'uraianInfo';
        info.style.color = '#dc3545';
        uraian.parentNode.appendChild(info);
    }
    if (kata < 10) {
        info.textContent = `Minimal 10 kata (saat ini: ${kata} kata)`;
    } else {
        info.textContent = '';
    }
}

// ===== CAMERA FUNCTIONS =====
async function bukaKamera() {
    step = 1;
    document.getElementById('infoKamera').innerText = "Ambil foto pertama";
    document.getElementById('photoModal').style.display = 'flex';
    await initCamera('user');
}

async function initCamera(facing) {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: facing },
            audio: false
        });

        const video = document.getElementById('video');
        video.srcObject = stream;
        video.onloadedmetadata = () => video.play().catch(e => console.log("play error:", e));
    } catch (err) {
        console.error("Kamera error:", err);
        alert("Tidak dapat mengakses kamera.\nPastikan izin kamera diizinkan dan coba refresh halaman.");
        stopAll();
    }
}

function capture() {
    const video = document.getElementById('video');
    if (!video.srcObject) return;

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    const dataUrl = canvas.toDataURL('image/png');

    if (step === 1) {
        fotoDataURLFront = dataUrl;
        document.getElementById('imgFront').src = dataUrl;
        document.getElementById('imgFront').style.display = 'block';
        
        step = 2;
        document.getElementById('infoKamera').innerText = 'Ambil foto kedua';
        initCamera('environment');
    } else {
        fotoDataURLBack = dataUrl;
        document.getElementById('imgBack').src = dataUrl;
        document.getElementById('imgBack').style.display = 'block';
        
        hasPhoto = true;
        stopAll();
        if (simpanData()) {
            alert("‚úÖ Data berhasil disimpan!\nTotal data: " + dataBukuTamu.length);
            showData();
        
                }
    }
}

function stopAll() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
    document.getElementById('photoModal').style.display = 'none';
    document.getElementById('video').srcObject = null;
}

// ===== FORCE SHOW FIELDS SAAT EDIT =====
function forceShowEditFields() {
    const fieldsToShow = [
        'field-asal', 'field-pihakDitemui', 'field-jenisLayanan',
        'field-uraian', 'field-nomorHp', 'field-tandaTangan', 'field-aksi'
    ];
    
    fieldsToShow.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('hidden');
    });

    asalChanged();
    
    if (document.getElementById('asal').value === 'MASYARAKAT') {
        document.getElementById('fieldDesa').classList.remove('hidden');
    }
}

// ===== DATA MANAGEMENT =====
function simpanData() {
    const form = document.getElementById('bukuTamuForm');
    let isValid = true;

    // Reset warning
    document.getElementById('signatureWarning').style.display = 'none';
    document.getElementById('photoWarning').style.display = 'none';

    // Validasi dasar form HTML (required fields)
    if (!form.reportValidity()) isValid = false;

    // =====================================
    // Validasi KHUSUS hanya berlaku di mode TAMBAH BARU (bukan edit)
    // =====================================
    if (!isEditMode) {
        const uraianValue = document.getElementById('uraian').value.trim();
        const jumlahKata = countWords(uraianValue);
        if (jumlahKata < 10) {
            document.getElementById('uraian').classList.add('error');
            isValid = false;
            alert('Uraian minimal 10 kata saat input baru!');
        }

        const namaInput = document.getElementById('nama');
        let hurufCount = (namaInput.value.trim().match(/[A-Za-z]/g) || []).length;
        if (hurufCount < 5) {
            namaInput.classList.add('error');
            isValid = false;
            alert('Nama minimal 5 huruf saat input baru!');
        }

        const nomorHpInput = document.getElementById('nomorHp');
        const nomorValue = nomorHpInput.value.trim().replace(/[^0-9]/g, '');
        if (nomorValue.length < 11) {
            nomorHpInput.classList.add('error');
            isValid = false;
            alert('Nomor WA minimal 11 digit saat input baru!');
        }

        const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
        if (!hasSignature || strokeLengthCm < MIN_STROKE_LENGTH_CM) {
            document.getElementById('signatureWarning').style.display = 'block';
            isValid = false;
        }

        if (!hasPhoto) {
            document.getElementById('photoWarning').style.display = 'block';
            isValid = false;
        }
    } else {
        // Di mode edit: longgarkan
        // Hanya cek field wajib dasar
        const requiredFields = ['nama', 'asal', 'pihakDitemui', 'jenisLayanan'];
        requiredFields.forEach(id => {
            const el = document.getElementById(id);
            if (el && !el.value.trim()) {
                el.classList.add('error');
                isValid = false;
            }
        });

        // Foto & tanda tangan boleh tetap pakai yang lama
        if (!hasPhoto && !fotoDataURLFront && !fotoDataURLBack) {
            alert('Foto lama masih ada, boleh tidak diubah.');
        }
    }

    if (!isValid) return false;

    // Lanjut simpan data...
    const asal = document.getElementById('asal').value;
    const formData = {
        nama: document.getElementById('nama').value.trim(),
        asal: asal,
        instansi: asal === 'INSTANSI' ? document.getElementById('instansi').value : '',
        kecamatan: asal === 'MASYARAKAT' ? document.getElementById('kecamatan').value : '',
        desa: asal === 'MASYARAKAT' ? document.getElementById('desa').value : '',
        pihakDitemui: document.getElementById('pihakDitemui').value,
        jenisLayanan: document.getElementById('jenisLayanan').value,
        uraian: document.getElementById('uraian').value.trim(),
        nomorHp: document.getElementById('nomorHp').value.trim(),
        tandaTangan: hasSignature ? signatureCanvas.toDataURL('image/png') : (dataBukuTamu[editingIndex]?.tandaTangan || ''),
        fotoFront: fotoDataURLFront || (dataBukuTamu[editingIndex]?.fotoFront || null),
        fotoBack: fotoDataURLBack || (dataBukuTamu[editingIndex]?.fotoBack || null),
        timestamp: isEditMode ? (dataBukuTamu[editingIndex]?.timestamp || new Date().toLocaleString('id-ID')) : new Date().toLocaleString('id-ID')
    };

    if (editingIndex >= 0) {
        dataBukuTamu[editingIndex] = formData;
    } else {
        dataBukuTamu.push(formData);
    }

    updateDataCounter();
    resetFormComplete();
    return true;
}

function resetFormComplete() {
    document.getElementById('bukuTamuForm').reset();
    hasSignature = false;
    hasPhoto = false;
    fotoDataURLFront = null;
    fotoDataURLBack = null;
    totalStrokeLength = 0;
    clearSignature();
    hideAllFields();
    isEditMode = false;
    editingIndex = -1;
}

// ===== NAVIGATION =====
function showForm() {
    location.reload();
}

function showData() {
    document.getElementById('formSection').style.display = 'none';
    document.getElementById('dataSection').style.display = 'block';
    document.getElementById('btnForm').style.background = '#6c757d';
    document.getElementById('btnData').style.background = '#28a745';
    displayData();
}

function displayData() {
    const container = document.getElementById('dataContainer');
    if (dataBukuTamu.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>';
        return;
    }
    
    let html = '';
    dataBukuTamu.forEach((data, index) => {
        html += `
        <div class="detail-container">
            <div class="detail-header">
                <h3>Data Tamu #${index + 1}</h3>
                <div>
                    <button onclick="editData(${index})" style="background: #ffc107; color: black; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 5px;">‚úèÔ∏è Edit</button>
                    
                    <button type="button" onclick="exportDetailPerTamuPDF(${index})" 
                            style="background: #6610f2; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                        üñ®Ô∏è Simpan Detail Lengkap (Per Tamu)
                    </button>
                </div>
            </div>
            
            <div class="detail-row">
                <div class="detail-label">Nama Lengkap</div>
                <div class="detail-value">${data.nama}</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Asal / Instansi</div>
                <div class="detail-value">${data.instansi || (data.kecamatan ? `${data.kecamatan}${data.desa ? ', ' + data.desa : ''}` : data.asal)}</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Pihak Ditemui</div>
                <div class="detail-value">${data.pihakDitemui}</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Jenis Layanan</div>
                <div class="detail-value">${data.jenisLayanan}</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Uraian Keperluan</div>
                <div class="detail-value">${data.uraian}</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Nomor WhatsApp</div>
                <div class="detail-value">${data.nomorHp}</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">Waktu Kunjungan</div>
                <div class="detail-value">${data.timestamp}</div>
            </div>

              <div class="detail-row">
                <div class="detail-label">Dokumentasi Foto</div>
                <div class="detail-value">
                    ${data.fotoFront ? `<img src="${data.fotoFront}" style="width: 150px; margin-right: 10px; border: 1px solid #ddd;" alt="Foto 1">` : ''}
                    ${data.fotoBack ? `<img src="${data.fotoBack}" style="width: 150px; border: 1px solid #ddd;" alt="Foto 2">` : ''}
                </div>
</div>

<div class="detail-row">
                <div class="detail-label">Tanda Tangan</div>
                <div class="detail-value">
                    <img src="${data.tandaTangan}" style="max-width: 200px; border: 1px solid #ddd;" alt="TTD">
                </div>
           </div>

        </div>`;
    });
    container.innerHTML = html;
}

// ===== EDIT & DELETE =====
function editData(index) {
    console.log("Edit data dipanggil untuk index:", index); // untuk debug

    if (confirm('Edit data tamu #' + (index + 1) + '?')) {
        const data = dataBukuTamu[index];
        
        editingIndex = index;
        originalEditData = JSON.parse(JSON.stringify(data));
        isEditMode = true;
        
        document.getElementById('mainNavigation').style.display = 'none';
        document.getElementById('editModeButtons').style.display = 'block';
        
        document.getElementById('nama').value = data.nama;
        document.getElementById('field-asal').classList.remove('hidden');
        document.getElementById('asal').value = data.asal;
        
        if (data.asal === 'INSTANSI') {
            document.getElementById('daftarInstansi').classList.remove('hidden');
            document.getElementById('instansi').value = data.instansi;
        } else if (data.asal === 'MASYARAKAT') {
            document.getElementById('daftarMasyarakat').classList.remove('hidden');
            document.getElementById('kecamatan').value = data.kecamatan;
            updateDesaList();
            setTimeout(() => {
                document.getElementById('desa').value = data.desa;
            }, 100);
        }
        
        document.getElementById('field-pihakDitemui').classList.remove('hidden');
        document.getElementById('pihakDitemui').value = data.pihakDitemui;
        
        document.getElementById('field-jenisLayanan').classList.remove('hidden');
        document.getElementById('jenisLayanan').value = data.jenisLayanan;
        
        document.getElementById('field-uraian').classList.remove('hidden');
        document.getElementById('uraian').value = data.uraian;
        
        document.getElementById('field-nomorHp').classList.remove('hidden');
        document.getElementById('nomorHp').value = data.nomorHp;
        
        document.getElementById('field-tandaTangan').classList.remove('hidden');
        resizeCanvas();
        
        if (data.tandaTangan) {
            const img = new Image();
            img.onload = function() {
                ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                ctx2.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                hasSignature = true;
                totalStrokeLength = 100;

                attachSignatureEvents();
                
                // Panggil resize 2x dengan delay
                resizeCanvas();
                setTimeout(resizeCanvas, 300);  // panggil lagi setelah 300ms
            };
            img.src = data.tandaTangan;
        } else {
            attachSignatureEvents();
            resizeCanvas();
        }
        
        document.getElementById('field-aksi').classList.remove('hidden');
        fotoDataURLFront = data.fotoFront;
        fotoDataURLBack = data.fotoBack;
        hasPhoto = !!(data.fotoFront || data.fotoBack);
        
        forceShowEditFields();
        
        document.getElementById('formSection').style.display = 'block';
        document.getElementById('dataSection').style.display = 'none';
        
        alert('Data telah dimuat ke form.\nAnda bebas mengedit tanpa field hilang.\nSimpan setelah selesai.');
    }
}

function saveEditedData() {
    if (simpanData()) {
        alert("‚úÖ Perubahan berhasil disimpan!");
        editingIndex = -1;
        originalEditData = null;
        isEditMode = false;
        document.getElementById('mainNavigation').style.display = 'block';
        document.getElementById('editModeButtons').style.display = 'none';
        showData();
    } else {
        alert("‚ùå Data belum lengkap atau tidak valid.");
    }
}

function cancelEdit() {
    if (originalEditData && editingIndex >= 0) {
        dataBukuTamu[editingIndex] = originalEditData;
        updateDataCounter();
    }
    
    editingIndex = -1;
    originalEditData = null;
    isEditMode = false;
    
    document.getElementById('mainNavigation').style.display = 'block';
    document.getElementById('editModeButtons').style.display = 'none';
    
    showData();
    alert('Edit dibatalkan. Data asli dikembalikan.');
}

function deleteData(index) {
    if (confirm('Yakin ingin menghapus data tamu #' + (index + 1) + '?')) {
        dataBukuTamu.splice(index, 1);
        updateDataCounter();
        displayData();
        alert('Data berhasil dihapus!');
    }
}

// ===== EXPORT =====
function exportData() {
    if (dataBukuTamu.length === 0) {
        alert('Tidak ada data untuk di-export!');
        return;
    }

    const instansiData = dataBukuTamu.filter(d => d.asal === 'INSTANSI');
    const masyarakatData = dataBukuTamu.filter(d => d.asal === 'MASYARAKAT');

    function createSummaryPDF(data, type) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // landscape untuk tabel lebar
        const pageWidth = 297;
        const margin = 10;
        let y = margin;

        // Title
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setFont("helvetica", "bold");
doc.setFontSize(14);

// Menggunakan array dan loop (lebih mudah jika ingin ubah-ubah teks)
const titleLines = [
    "BUKU TAMU DIGITAL",
    "INSPEKTORAT DAERAH",
    "KABUPATEN TULANG BAWANG BARAT"
];

let currentY = y;
titleLines.forEach(line => {
    doc.text(line, pageWidth / 2, currentY, { align: 'center' });
    currentY += 5;  // jarak antar baris (sesuaikan 8-10)
});

y = currentY + 5;  // tambah jarak setelah judul selesai

        doc.setFontSize(10);
        doc.text(`Tanggal Export: ${new Date().toLocaleString('id-ID')}`, pageWidth / 2, y, { align: 'center' });
        y += 10;

        // Header tabel
        const title = type === 'instansi' ? 'DAFTAR TAMU INSTANSI / UNIT KERJA' : 'DAFTAR TAMU MASYARAKAT';
        doc.setFontSize(12);
        doc.text(title, margin, y);
        y += 2;

        // Kolom
        let columns;
        if (type === 'instansi') {
            columns = [
                { header: 'No', dataKey: 'no' },
                { header: 'Nama', dataKey: 'nama' },
                { header: 'Instansi', dataKey: 'instansi' },
                { header: 'Pihak Ditemui', dataKey: 'pihakDitemui' },
                { header: 'Layanan', dataKey: 'jenisLayanan' },
                { header: 'Uraian', dataKey: 'uraian' },
                { header: 'No HP', dataKey: 'nomorHp' },
                { header: 'Waktu', dataKey: 'timestamp' },
                { header: 'TTD', dataKey: 'tandaTangan' },
                { header: 'Foto Depan', dataKey: 'fotoFront' },
                { header: 'Foto Belakang', dataKey: 'fotoBack' }
            ];
        } else {
            columns = [
                { header: 'No', dataKey: 'no' },
                { header: 'Nama', dataKey: 'nama' },
                { header: 'Kecamatan', dataKey: 'kecamatan' },
                { header: 'Desa', dataKey: 'desa' },
                { header: 'Pihak Ditemui', dataKey: 'pihakDitemui' },
                { header: 'Layanan', dataKey: 'jenisLayanan' },
                { header: 'Uraian', dataKey: 'uraian' },
                { header: 'No HP', dataKey: 'nomorHp' },
                { header: 'Waktu', dataKey: 'timestamp' },
                { header: 'TTD', dataKey: 'tandaTangan' },
                { header: 'Foto Depan', dataKey: 'fotoFront' },
                { header: 'Foto Belakang', dataKey: 'fotoBack' }
            ];
        }

        // Rows
        const rows = data.map((d, i) => {
            let ttdCell = '';
            if (typeof d.tandaTangan === 'string' && d.tandaTangan.startsWith('data:image')) {
                ttdCell = { image: d.tandaTangan, fit: [20, 20] };
            }

            let frontCell = '';
            if (typeof d.fotoFront === 'string' && d.fotoFront.startsWith('data:image')) {
                frontCell = { image: d.fotoFront, fit: [20, 20] };
            }

            let backCell = '';
            if (typeof d.fotoBack === 'string' && d.fotoBack.startsWith('data:image')) {
                backCell = { image: d.fotoBack, fit: [20, 20] };
            }

            // Bersihkan No HP jika ada prefix aneh seperti 'C '
            let cleanedHp = d.nomorHp ? d.nomorHp.replace(/^C\s*/, '') : '';

            return {
                no: i + 1,
                nama: d.nama,
                instansi: d.instansi || '',
                kecamatan: d.kecamatan || '',
                desa: d.desa || '',
                pihakDitemui: d.pihakDitemui,
                jenisLayanan: d.jenisLayanan,
                uraian: d.uraian || '-', // Jika uraian kosong, tampilkan '-'
                nomorHp: cleanedHp,
                timestamp: d.timestamp,
                tandaTangan: ttdCell,
                fotoFront: frontCell,
                fotoBack: backCell
            };
        });

        // AutoTable
        doc.autoTable({
    columns: columns,
    body: rows,
    startY: y,
    margin: { left: margin, right: margin },

    styles: {
        fontSize: 8,
        cellPadding: 3,           // padding default untuk kolom teks
        overflow: 'linebreak',
        halign: 'left',
        valign: 'middle'
    },

    headStyles: {
        fillColor: type === 'instansi' ? [0, 123, 255] : [40, 167, 69],
        textColor: [255, 255, 255],
        fontStyle: 'bold',
        halign: 'center'
    },

    alternateRowStyles: { fillColor: [245, 245, 245] },

    columnStyles: {
        no: { cellWidth: 10, halign: 'center' },
        nama: { cellWidth: 25 },
        instansi: { cellWidth: 30 },
        kecamatan: { cellWidth: 25 },
        desa: { cellWidth: 25 },
        pihakDitemui: { cellWidth: 25 },
        jenisLayanan: { cellWidth: 25 },
        uraian: { cellWidth: 'auto' },
        nomorHp: { cellWidth: 27 },
        timestamp: { cellWidth: 20 },
        
        // Kolom gambar & tanda tangan
        tandaTangan: { 
            cellWidth: 22,          // sedikit diperbesar agar muat padding
            minCellHeight: 24 
        },
        fotoFront: { 
            cellWidth: 27, 
            minCellHeight: 27 
        },
        fotoBack: { 
            cellWidth: 27, 
            minCellHeight: 27 
        }
    },

    didParseCell: function (data) {
        // Hanya hapus teks di body (header tetap muncul)
        if (data.row.section === 'body' && 
            ['tandaTangan', 'fotoFront', 'fotoBack'].includes(data.column.dataKey)) {
            data.cell.text = '';
        }
    },

    didDrawCell: function (hookData) {
        const colKey = hookData.column.dataKey;
        
        if (['tandaTangan', 'fotoFront', 'fotoBack'].includes(colKey)) {
            if (hookData.cell.raw && hookData.cell.raw.image) {
                try {
                    // Padding 1 mm di semua sisi (‚âà 2.83 pt)
                    const padding = 2.8346;
                    
                    // Hitung posisi dan ukuran gambar dengan padding
                    const imgX = hookData.cell.x + padding;
                    const imgY = hookData.cell.y + padding;
                    
                    // Kurangi ukuran gambar sebanyak 2 √ó padding
                    const availWidth  = hookData.cell.width  - (padding * 2);
                    const availHeight = hookData.cell.height - (padding * 2);
                    
                    // Ukuran gambar maksimal (sesuaikan rasio, tapi pakai square untuk konsistensi)
                    const imgSize = Math.min(availWidth, availHeight);
                    
                    doc.addImage(
                        hookData.cell.raw.image,
                        'PNG',
                        imgX,
                        imgY,
                        imgSize,
                        imgSize
                    );
                } catch (e) {
                    console.log('Gagal render gambar di kolom ' + colKey + ':', e);
                }
            }
        }
    }
});


        // Simpan
        const dateStr = new Date().toISOString().split('T')[0];
        const suffix = type === 'instansi' ? '' : ' (Masyarakat)';
        doc.save(`Buku_Tamu_Ringkasan_${dateStr}${suffix}.pdf`);
    }

    if (instansiData.length > 0) createSummaryPDF(instansiData, 'instansi');
    if (masyarakatData.length > 0) createSummaryPDF(masyarakatData, 'masyarakat');

    if (instansiData.length > 0 || masyarakatData.length > 0) {
        alert('‚úÖ PDF ringkasan telah diunduh!');
    }
}
function exportDetailPerTamuPDF(index) {
    if (dataBukuTamu.length === 0 || index < 0 || index >= dataBukuTamu.length) {
        alert('Tidak ada data untuk tamu ini!');
        return;
    }

    const data = dataBukuTamu[index];
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageWidth = 210;
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);
    let y = 12;

    // Header
    doc.setFillColor(102, 126, 234);
    doc.rect(margin, y, contentWidth, 28, 'F');
    doc.setFillColor(118, 75, 162);
    doc.setGState(doc.GState({ opacity: 0.4 }));
    doc.rect(margin, y, contentWidth, 28, 'F');
    doc.setGState(doc.GState({ opacity: 1 }));

    doc.setFontSize(14);
    doc.setTextColor(255);
    doc.setFont("helvetica", "bold");
    doc.text('BUKU TAMU DIGITAL', pageWidth/2, y+10, { align: 'center' });

    doc.setFontSize(10);
    doc.text('INSPEKTORAT DAERAH KABUPATEN TULANG BAWANG BARAT', pageWidth/2, y+17, { align: 'center' });

    doc.setFontSize(8);
    doc.setTextColor(220, 220, 255);
    doc.text(`Data Tamu #${index + 1} ‚Ä¢ ${data.timestamp}`, pageWidth/2, y+24, { align: 'center' });

    y += 35;

    // Informasi utama (sama seperti tampilan web)
    const fields = [
        { label: "Nama Lengkap", value: data.nama || '-' },
        { label: "Asal / Instansi", value: data.instansi || (data.kecamatan ? `${data.kecamatan}${data.desa ? ', ' + data.desa : ''}` : data.asal || '-') },
        { label: "Pihak yang Ditemui", value: data.pihakDitemui || '-' },
        { label: "Jenis Layanan", value: data.jenisLayanan || '-' },
        { label: "Uraian Keperluan", value: data.uraian || '-' },
        { label: "Nomor WhatsApp", value: data.nomorHp || '-' },
        { label: "Waktu Kunjungan", value: data.timestamp || '-' }
    ];

    const labelWidth = 55;
    const rowHeightBase = 8;

    doc.setFontSize(10);
    fields.forEach(field => {
        const valueLines = doc.splitTextToSize(field.value, contentWidth - labelWidth - 6);
        const rowHeight = Math.max(rowHeightBase, valueLines.length * 5 + 2);

        // Background label
        doc.setFillColor(248, 249, 250);
        doc.rect(margin, y, labelWidth, rowHeight, 'F');

        // Background value
        doc.setFillColor(255, 255, 255);
        doc.rect(margin + labelWidth, y, contentWidth - labelWidth, rowHeight, 'F');

        // Border
        doc.setDrawColor(220, 220, 220);
        doc.setLineWidth(0.3);
        doc.rect(margin, y, contentWidth, rowHeight);

        // Garis pemisah kolom
        doc.line(margin + labelWidth, y, margin + labelWidth, y + rowHeight);

        // Label
        doc.setFont("helvetica", "bold");
        doc.setTextColor(73, 80, 87);
        doc.text(field.label, margin + 4, y + 5.5);

        // Value
        doc.setFont("helvetica", "normal");
        doc.setTextColor(33, 37, 41);
        doc.text(valueLines, margin + labelWidth + 4, y + 5.5);

        y += rowHeight;
    });

    y += 12;

    // Bagian Dokumentasi Foto & Tanda Tangan
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(40, 167, 69);
    doc.text("DOKUMENTASI FOTO & TANDA TANGAN", margin, y);
    y += 8;

    doc.setDrawColor(200);
    doc.setLineWidth(0.4);
    doc.line(margin, y, pageWidth - margin, y);
    y += 6;

    // Foto berjejer horizontal
    const photoSize = 70;      // lebar & tinggi foto
    const photoGap = 12;
    let photoX = margin;

    if (data.fotoFront) {
        try {
            doc.setDrawColor(180);
            doc.rect(photoX, y, photoSize, photoSize, 'S');
            doc.addImage(data.fotoFront, 'PNG', photoX + 1, y + 1, photoSize - 2, photoSize - 2);
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text("Foto 1", photoX + photoSize/2, y + photoSize + 5, { align: 'center' });
        } catch (e) { console.log("Gagal render foto depan", e); }
    }

    photoX += photoSize + photoGap;

    if (data.fotoBack) {
        try {
            doc.setDrawColor(180);
            doc.rect(photoX, y, photoSize, photoSize, 'S');
            doc.addImage(data.fotoBack, 'PNG', photoX + 1, y + 1, photoSize - 2, photoSize - 2);
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text("Foto 2", photoX + photoSize/2, y + photoSize + 5, { align: 'center' });
        } catch (e) { console.log("Gagal render foto belakang", e); }
    }

    y += photoSize + 18;  // turun setelah foto + caption

    // Tanda Tangan (di bawah foto)
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0, 123, 255);
    doc.text("Tanda Tangan:", margin, y);
    y += 6;

    if (data.tandaTangan) {
        try {
            const sigWidth = 100;
            const sigHeight = 50;
            doc.setDrawColor(180);
            doc.rect(margin, y, sigWidth, sigHeight, 'S');
            doc.addImage(data.tandaTangan, 'PNG', margin + 2, y + 2, sigWidth - 4, sigHeight - 4);
        } catch (e) { console.log("Gagal render tanda tangan", e); }
    } else {
        doc.setFontSize(9);
        doc.setTextColor(150);
        doc.text("(Tidak ada tanda tangan)", margin + 4, y + 8);
    }

    // Footer
    const bottomY = 280;
    doc.setDrawColor(200);
    doc.setLineWidth(0.3);
    doc.line(margin, bottomY, pageWidth - margin, bottomY);

    doc.setFontSize(8);
    doc.setTextColor(120);
    doc.text('Dokumen ini dibuat otomatis oleh Sistem Buku Tamu Digital - Inspektorat Kab. Tulang Bawang Barat', 
             pageWidth/2, bottomY + 6, { align: 'center' });

    // Simpan file
    const cleanTimestamp = data.timestamp.replace(/[\s,:]/g, '-');
    const filename = `Detail_Tamu_${index + 1}_${cleanTimestamp}.pdf`;
    doc.save(filename);

    alert('‚úÖ PDF detail tamu telah diunduh!');
}function updateDataCounter() {
    document.getElementById('dataCount').textContent = dataBukuTamu.length;
}
</script>
</body>
</html>
