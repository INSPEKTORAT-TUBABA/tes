<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buku Tamu Digital - Inspektorat Tubaba</title>
    
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
            overflow-x: hidden;
        }
        body { min-height: 100vh; padding: 15px; }

        /* Intro Page */
        #introPage {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10000;
            transition: opacity 0.6s ease;
        }
        #introPage.hidden { opacity: 0; pointer-events: none; }

        .intro-content { text-align: center; padding: 20px; max-width: 90%; }
        .intro-title {
            font-size: 2.8rem;
            font-weight: 900;
            margin: 0.3em 0;
            text-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .intro-subtitle {
            font-size: 1.6rem;
            margin: 0.8em 0 1.5em;
            line-height: 1.3;
        }
        .btn-start {
            padding: 16px 48px;
            font-size: 1.3rem;
            background: white;
            color: #4a6ee0;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-start:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        /* Logo Glow */
        .logo-glow {
            width: 110px;
            height: auto;
            margin-bottom: 25px;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.8)) drop-shadow(0 0 35px rgba(255,215,0,0.6));
            animation: fadeInUp 1s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* Main Content */
        #mainApp { display: none; max-width: 720px; margin: 0 auto; }
        #mainApp.visible { display: block; }

        .header-gambar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .foto-kepala, .logo { width: 90px; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        h1 { text-align: center; color: #2c3e50; margin: 0.4em 0; font-size: 1.9rem; }
        h2 { color: #34495e; text-align: center; margin-bottom: 1.2em; }

        form > div {
            margin-bottom: 1.2em;
            background: white;
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #2c3e50;
        }
        .required { color: #e74c3c; }
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
        }
        textarea { min-height: 80px; resize: vertical; }
        button {
            padding: 12px 24px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        .hidden { display: none !important; }

        /* Signature Canvas */
        #signature-pad {
            width: 100%;
            height: 180px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            touch-action: none;
        }

        /* Camera Modal */
       /* Camera Modal - FULLSCREEN LANDSCAPE */
#photoModal {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 3000;
    padding: 0;
    margin: 0;
    justify-content: center;
    align-items: center;
}

#modalContent {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
}

#dualCameraFrame {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    gap: 8px;
    padding: 10px;
    box-sizing: border-box;
    justify-content: center;
}

.camera-view {
    width: 100%;
    aspect-ratio: 16 / 9;           /* Landscape */
    border: 3px solid #3498db;
    border-radius: 8px;
    overflow: hidden;
    background: #000;
    box-shadow: 0 0 0 0;
    position: relative;
}

.camera-view video,
.camera-view img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
}

.camera-view h4 {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.75);
    color: white;
    padding: 6px 16px;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: bold;
    z-index: 10;
}

/* Fullscreen di laptop besar */
@media (min-width: 1024px) {
    #dualCameraFrame {
        flex-direction: row;
        gap: 12px;
        padding: 15px;
    }
    .camera-view {
        width: 50%;
        aspect-ratio: 16 / 9;
    }
}

/* Tombol close besar di fullscreen */
#btnTutupModal {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 20;
    background: rgba(231, 76, 60, 0.9);
    color: white;
    padding: 12px 20px;
    border-radius: 50px;
    font-size: 1.1rem;
}UNTUNG
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- Intro Page -->
<div id="introPage">
    <img src="Kabupaten Tulang Bawang Barat.png" class="logo-glow" alt="Logo Tubaba" onerror="this.src='https://via.placeholder.com/110?text=Logo';">
    <div class="intro-content">
        <h2 class="intro-title">SELAMAT DATANG</h2>
        <h1 class="intro-subtitle">DI INSPEKTORAT DAERAH<br>KABUPATEN TULANG BAWANG BARAT</h1>
        <button class="btn-start" onclick="startApp()">üìù ISI BUKU TAMU</button>
    </div>
</div>

<!-- Main App -->
<div id="mainApp">
    <div class="header-gambar">
        <img src="bupati.png" class="foto-kepala" alt="Bupati" onerror="this.style.display='none'">
        <img src="logo-tubaba.png" class="logo" alt="Logo Tubaba" onerror="this.style.display='none'">
        <img src="wakil-bupati.png" class="foto-kepala" alt="Wakil Bupati" onerror="this.style.display='none'">
    </div>

    <h1>BUKU TAMU DIGITAL<br>INSPEKTORAT KABUPATEN TULANG BAWANG BARAT</h1>

    <form id="bukuTamuForm">
        <div>
        <div id="formSection">
        <form id="bukuTamuForm">
            <div id="field-nama">
                <label>Nama: <span class="required">*</span></label>
                <input id="nama" required type="text" placeholder="Isi Minimal 5 Huruf" oninput="validateNama();"/>
            </div>

            <div id="field-asal" style="display: none;">
                <label>INSTANSI/ASAL: <span class="required">*</span></label>
                <select id="asal" required onchange="asalChanged();">
                    <option value="">-- Pilih Asal --</option>
                    <option value="INSTANSI">INSTANSI/UNIT KERJA</option>
                    <option value="MASYARAKAT">MASYARAKAT</option>
                </select>
            </div>

            <div class="hidden" id="daftarInstansi">
                <label>DAFTAR INSTANSI/UNIT KERJA: <span class="required">*</span></label>
                <select id="instansi" onchange="checkAndShowNext('instansi', 'field-pihakDitemui');">
                    <option value="">-- Pilih Instansi --</option>
                    <option>SEKRETARIAT DAERAH</option>
                    <option>SEKRETARIAT DPRD</option>
                    <option>BADAN PERENCANAAN PEMBANGUNAN DAERAH</option>
                    <option>BADAN PENGELOLAAN KEUANGAN DAN ASET DAERAH</option>
                    <option>BADAN PENGELOLAAN PAJAK DAN RETRIBUSI DAERAH</option>
                    <option>BADAN KEPEGAWAIAN DAN PENGEMBANGAN SUMBER DAYA MANUSIA</option>
                    <option>BADAN KESATUAN BANGSA DAN POLITIK DAERAH</option>
                    <option>BADAN PENANGGULANGAN BENCANA DAERAH</option>
                    <option>DINAS LINGKUNGAN HIDUP</option>
                    <option>DINAS KESEHATAN</option>
                    <option>DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                    <option>DINAS KOPERASI, UMKM, PERINDUSTRIAN DAN PERDAGANGAN</option>
                    <option>DINAS SOSIAL</option>
                    <option>DINAS PEMUDA, OLAHRAGA DAN PARIWISATA</option>
                    <option>DINAS KOMUNIKASI DAN INFORMATIKA</option>
                    <option>DINAS PERUMAHAN, KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                    <option>DINAS PENANAMAN MODAL DAN PELAYANAN PERIZINAN TERPADU SATU PINTU</option>
                    <option>DINAS PENDIDIKAN DAN KEBUDAYAAN</option>
                    <option>DINAS KETAHANAN PANGAN</option>
                    <option>DINAS PEMBERDAYAAN MASYARAKAT DAN TIYUH</option>
                    <option>DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                    <option>DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                    <option>DINAS PERHUBUNGAN</option>
                    <option>DINAS PERTANIAN</option>
                    <option>DINAS PETERNAKAN DAN KESEHATAN HEWAN</option>
                    <option>DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                    <option>DINAS TENAGA KERJA DAN TRANSMIGRASI</option>
                    <option>DINAS PERIKANAN</option>
                    <option>DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                    <option>DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</option>
                    <option>SATUAN POLISI PAMONG PRAJA</option>
                    <option>BADAN PENGAWASAN KEUANGAN DAN PEMBANGUNAN (BPKP)</option>
                    <option>LAINNYA</option>
                </select>
            </div>

            <div class="hidden" id="daftarMasyarakat">
                <label>Kecamatan: <span class="required">*</span></label>
                <select id="kecamatan" onchange="updateDesaList();">
                    <option value="">-- Pilih Kecamatan --</option>
                    <option value="Tulang Bawang Tengah">Tulang Bawang Tengah</option>
                    <option value="Tulang Bawang Udik">Tulang Bawang Udik</option>
                    <option value="Gunung Terang">Gunung Terang</option>
                    <option value="Gunung Agung">Gunung Agung</option>
                    <option value="Lambu Kibang">Lambu Kibang</option>
                    <option value="Way Kenanga">Way Kenanga</option>
                    <option value="Tumijajar">Tumijajar</option>
                    <option value="Pagar Dewa">Pagar Dewa</option>
                    <option value="Batu Putih">Batu Putih</option>
                </select>

                <div class="hidden" id="field-desa">
                    <label>Desa/Tiyuh: <span class="required">*</span></label>
                    <select id="desa" onchange="checkAndShowNext('desa', 'field-pihakDitemui');">
                        <option value="">-- Pilih Desa --</option>
                    </select>
                </div>
            </div>

            <div id="field-pihakDitemui" style="display: none;">
                <label>PIHAK YANG DITEMUI: <span class="required">*</span></label>
                <select id="pihakDitemui" required onchange="checkAndShowNext('pihakDitemui', 'field-jenisLayanan');">
                    <option value="">-- Pilih Pihak yang Ditemui --</option>
                    <option>INSPEKTUR</option>
                    <option>SEKRETARIS</option>
                    <option>IRBANSUS</option>
                    <option>IRBAN 1</option>
                    <option>IRBAN 2</option>
                    <option>IRBAN 3</option>
                    <option>IRBAN 4</option>
                </select>
            </div>

            <div id="field-jenisLayanan" style="display: none;">
                <label>JENIS LAYANAN: <span class="required">*</span></label>
                <select id="jenisLayanan" required onchange="checkAndShowNext('jenisLayanan', 'field-uraian');">
                    <option value="">-- Pilih Jenis Layanan --</option>
                    <option>Permintaan Audit/Klarifikasi Khusus</option>
                    <option>Penanganan Pengaduan</option>
                    <option>Layanan Informasi Publik</option>
                    <option>Pembinaan & Konsultasi</option>
                    <option>Audit</option>
                    <option>Review</option>
                    <option>Evaluasi / Monitoring</option>
                    <option>Tindak Lanjut Temuan</option>
                </select>
            </div>

            <div id="field-uraian" style="display: none;">
                <label>URAIAN: <span class="required">*</span></label>
                <textarea id="uraian" required oninput="autoResize(this); validateUraian();" style="overflow:hidden; resize:none; width:100%; min-height:60px;" placeholder="Minimal 15 karakter"></textarea>
            </div>

            <div id="field-nomorHp" style="display: none;">
                <label>NOMOR HP: <span class="required">*</span></label>
                <input id="nomorHp" inputmode="numeric" pattern="\d*" required type="text" placeholder="Minimal 11 digit" oninput="validateNomorHp();"/>
            </div>

            <div id="field-tandaTangan" style="display: none;">
                <label>Tanda Tangan: <span class="required">*</span></label>
                <div class="warning" id="signatureWarning" style="display:none;">‚ö†Ô∏è Tanda tangan wajib diisi dengan goresan minimal 2 cm!</div>
                <canvas height="200" id="signature-pad" style="border:1px solid #ccc; width: 100%;" width="700"></canvas>
                <button onclick="clearSignature()" type="button" style="background: #e9ecef; color: black; border: 1px solid #ccc; padding: 8px 15px; border-radius: 5px; cursor: pointer;">üßπ Bersihkan Tanda Tangan</button>
            </div>

            <div id="field-aksi" style="display: none;">
                <label>Foto: <span class="required">*</span></label>
                <div class="warning" id="photoWarning" style="display:none;">‚ö†Ô∏è Foto wajib diambil!</div>
                <button type="button" onclick="bukaKamera()" style="font-size: 16px; background: #ffc107; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üì∏ Ambil Foto</button>
            </div>
            
            <div id="field-simpan" style="display: none;">
                <br/>
                <button type="button" id="btnSimpanData" onclick="simpanDataDanTutupForm()" style="font-size: 18px; background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer;">üíæ Simpan Data</button>
            </div>
        </form>
    </div>

    <!-- Tombol navigasi utama (akan disembunyikan saat edit) -->
<div id="mainNavigation" style="margin-bottom: 80px; text-align: center;">
    <button type="button" onclick="showForm()" id="btnForm" 
            style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 0 8px 8px 0; cursor: pointer;">
        üìù Form Input
    </button>

    <button type="button" onclick="showData()" id="btnData" 
            style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 0 8px 8px 0; cursor: pointer;">
        üìä Lihat Data (<span id="dataCount">0</span>)
    </button>

    <button type="button" id="btnExportRingkasan" onclick="exportRingkasanPDF()" 
            style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 0 8px 8px 0; cursor: pointer; display: none;">
        üìë Export Tabel Ringkasan
    </button>
</div>

<!-- Tombol khusus mode Edit (awalnya disembunyikan) -->
<div id="editModeButtons" style="margin-bottom: 80px; text-align: center; display: none;">
    <button type="button" onclick="saveEditedData()" 
            style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 5px; margin: 0 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
        üíæ Simpan Perubahan
    </button>
    
    <button type="button" onclick="cancelEdit()" 
            style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 5px; margin: 0 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
        ‚ùå Batal
    </button>
</div>

    <div id="dataSection" style="display: none;">
        <h2>üìä DATA BUKU TAMU</h2>
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="button" onclick="exportDetailPerTamuPDF()" 
            style="background: #6610f2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
        üñ®Ô∏è Simpan Detail Lengkap (Per Tamu)
    </button>
        </div>
        <div id="dataContainer">
            <p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>
        </div>
    </div>

    <div id="photoModal">
    <div id="modalContent">
        <h3 id="cameraTitle">Pengambilan Foto Depan (Selfie)</h3>
        <div id="dualCameraFrame">
            <div class="camera-view" id="activeCameraView">
                <video id="videoActive" autoplay muted playsinline></video>
                <img id="previewActive" alt="Foto Terambil" style="display:none;">
            </div>
        </div>

        <div id="cameraStatus" style="color:white; margin:10px 0; font-weight:bold;">
            Langkah 1 dari 2: Foto Depan
        </div>

        <div id="modalButtons">
            <button type="button" id="btnCapture" onclick="captureCurrentPhoto()">üì∏ Ambil Foto</button>
            <button type="button" id="btnNextStep" onclick="switchToBackCamera()" style="display:none; background:#28a745;">
                ‚û°Ô∏è Lanjut Foto Belakang
            </button>
            <button type="button" id="btnSaveAndClose" onclick="simpanFotoLangsung()" style="display:none; background:#17a745;">
                ‚úÖ Simpan & Selesai
            </button>
            <button type="button" id="btnTutupModal" onclick="tutupModal()">‚ùå Tutup</button>
        </div>
    </div>
</div>

    <script>
        const signatureCanvas = document.getElementById('signature-pad');
        const ctx = signatureCanvas.getContext('2d');
        const signatureWarning = document.getElementById('signatureWarning');
        const photoWarning = document.getElementById('photoWarning');
        const asal = document.getElementById("asal");
        const daftarInstansi = document.getElementById("daftarInstansi");
        const daftarMasyarakat = document.getElementById("daftarMasyarakat");
        const kecamatan = document.getElementById("kecamatan");
        const desa = document.getElementById("desa");
        const instansi = document.getElementById("instansi");
        const fieldDesa = document.getElementById("field-desa");
        const photoModal = document.getElementById('photoModal');
// Variabel global baru
let currentStep = 'front';          // 'front' atau 'back'
let streamActive = null;
let fotoDataURLFront = null;
let fotoDataURLBack = null;
let hasPhotoFront = false;
let hasPhotoBack = false;

const videoActive   = document.getElementById('videoActive');
const previewActive = document.getElementById('previewActive');
const cameraTitle   = document.getElementById('cameraTitle');
const cameraStatus  = document.getElementById('cameraStatus');
const btnCapture    = document.getElementById('btnCapture');
const btnNextStep   = document.getElementById('btnNextStep');
const btnSaveClose  = document.getElementById('btnSaveAndClose');

async function bukaKamera() {
    photoModal.style.display = 'flex';
    currentStep = 'front';
    await startCamera('user');   // mulai dengan kamera depan
}

async function startCamera(facingMode) {
    // Matikan stream sebelumnya jika ada
    if (streamActive) {
        streamActive.getTracks().forEach(t => t.stop());
        streamActive = null;
    }

    try {
        streamActive = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: facingMode }
        });
        videoActive.srcObject = streamActive;
        videoActive.play();

        // Update UI
        if (facingMode === 'user') {
            cameraTitle.textContent = "Pengambilan Foto Depan (Selfie)";
            cameraStatus.textContent = "Langkah 1 dari 2: Foto Depan";
            btnNextStep.style.display = 'none';
        } else {
            cameraTitle.textContent = "Pengambilan Foto Belakang";
            cameraStatus.textContent = "Langkah 2 dari 2: Foto Belakang";
            btnNextStep.style.display = 'none';
            btnSaveClose.style.display = 'inline-block';
        }

        btnCapture.style.display = 'inline-block';
        previewActive.style.display = 'none';
        videoActive.style.display = 'block';

    } catch (err) {
        console.error("Gagal akses kamera:", err);
        alert("Gagal mengakses kamera " + (facingMode==='user'?'depan':'belakang') + ".\nPastikan izin kamera diizinkan.");
    }
}

function captureCurrentPhoto() {
    if (!streamActive) {
        alert("Kamera belum aktif!");
        return;
    }

    const canvas = document.createElement('canvas');
    canvas.width = videoActive.videoWidth;
    canvas.height = videoActive.videoHeight;
    canvas.getContext('2d').drawImage(videoActive, 0, 0);

    const dataUrl = canvas.toDataURL('image/png');

    if (currentStep === 'front') {
        fotoDataURLFront = dataUrl;
        hasPhotoFront = true;
    } else {
        fotoDataURLBack = dataUrl;
        hasPhotoBack = true;
    }

    // Tampilkan preview
    previewActive.src = dataUrl;
    previewActive.style.display = 'block';
    videoActive.style.display = 'none';

    // Matikan stream setelah capture (hemat resource)
    if (streamActive) {
        streamActive.getTracks().forEach(t => t.stop());
        streamActive = null;
    }

    // Update tombol
    btnCapture.style.display = 'none';

    if (currentStep === 'front') {
        btnNextStep.style.display = 'inline-block';
        btnNextStep.textContent = "‚û°Ô∏è Lanjut Foto Belakang";
    } else {
        btnSaveClose.style.display = 'inline-block';
    }
}

function switchToBackCamera() {
    currentStep = 'back';
    startCamera('environment');
    btnNextStep.style.display = 'none';
    btnCapture.style.display = 'inline-block';
}

function tutupModal() {
    photoModal.style.display = 'none';

    // Stop semua stream
    if (streamActive) {
        streamActive.getTracks().forEach(t => t.stop());
        streamActive = null;
    }

    // Reset UI
    currentStep = 'front';
    fotoDataURLFront = null;
    fotoDataURLBack = null;
    hasPhotoFront = false;
    hasPhotoBack = false;

    videoActive.srcObject = null;
    previewActive.style.display = 'none';
    videoActive.style.display = 'block';
    btnCapture.style.display = 'inline-block';
    btnNextStep.style.display = 'none';
    btnSaveClose.style.display = 'none';
}

function simpanFotoLangsung() {
    hasPhoto = hasPhotoFront || hasPhotoBack;  // minimal salah satu boleh

    if (!hasPhoto) {
        alert("Belum ada foto yang diambil!");
        return;
    }

    tutupModal();

    // Tampilkan tombol simpan data
    document.getElementById('field-simpan').style.display = 'block';

    let msg = "Foto berhasil disimpan:\n";
    if (hasPhotoFront) msg += "‚Ä¢ Foto depan OK\n";
    if (hasPhotoBack)  msg += "‚Ä¢ Foto belakang OK\n";
    alert(msg + "\nSilakan klik 'Simpan Data' untuk menyimpan formulir.");
}
        let drawing = false;
        let hasSignature = false;
        let dataBukuTamu = [];
        let lastX = 0;
        let lastY = 0;
        let totalStrokeLength = 0;
        const MIN_STROKE_LENGTH_CM = 2;
        const PIXELS_PER_CM = 37.8;

        function resizeCanvas() {
            const originalWidth = 700;
            const originalHeight = 200;
            const newWidth = Math.min(window.innerWidth - 40, originalWidth);
            const tempData = signatureCanvas.toDataURL();
            signatureCanvas.width = newWidth;
            signatureCanvas.height = Math.round(originalHeight * (newWidth / originalWidth));
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
            img.src = tempData;
            ctx.strokeStyle = '#0000FF';
            ctx.globalAlpha = 0.85;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = 'source-over';
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        ctx.strokeStyle = '#0000FF';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.globalAlpha = 0.85;
        ctx.globalCompositeOperation = 'source-over';
        let lastVelocity = 0;
        let lastTime = Date.now();

        function getCanvasPos(e) {
            const rect = signatureCanvas.getBoundingClientRect();
            if (e.touches && e.touches[0]) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function startDrawing(e) {
            e.preventDefault();
            drawing = true;
            hasSignature = true;
            totalStrokeLength = 0;
            ctx.beginPath();
            ctx.strokeStyle = '#0000FF';
            const pos = getCanvasPos(e);
            lastX = pos.x;
            lastY = pos.y;
            ctx.moveTo(lastX, lastY);
            lastTime = Date.now();
        }

        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const pos = getCanvasPos(e);
            const currentTime = Date.now();
            const deltaTime = (currentTime - lastTime) / 1000;
            const distance = Math.sqrt((pos.x - lastX) ** 2 + (pos.y - lastY) ** 2);
            totalStrokeLength += distance;
            const velocity = distance / (deltaTime || 1);
            const smoothedVelocity = lastVelocity * 0.7 + velocity * 0.3;
            ctx.lineWidth = Math.max(1.5, Math.min(3.5, 2 - smoothedVelocity / 100));
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastX = pos.x;
            lastY = pos.y;
            lastVelocity = smoothedVelocity;
            lastTime = currentTime;
        }

        function stopDrawing(e) {
            if (!drawing) return;
            e.preventDefault();
            drawing = false;
            // Validasi panjang goresan (2 cm ‚âà 75.6 piksel)
            const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
            if (strokeLengthCm < MIN_STROKE_LENGTH_CM) {
                hasSignature = false;
                signatureWarning.style.display = 'block';
                signatureWarning.textContent = '‚ö†Ô∏è Tanda Tangan Terlalu Pendek';
                signatureCanvas.classList.add('error');
                signatureCanvas.classList.remove('success');
                document.getElementById('field-aksi').style.display = 'none';
            } else {
                signatureWarning.style.display = 'none';
                signatureCanvas.classList.remove('error');
                signatureCanvas.classList.add('success');
                checkAndShowNext('signature-pad', 'field-aksi');
            }
        }

        signatureCanvas.addEventListener('mousedown', startDrawing);
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('mouseup', stopDrawing);
        signatureCanvas.addEventListener('mouseout', stopDrawing);
        signatureCanvas.addEventListener('touchstart', startDrawing, { passive: false });
        signatureCanvas.addEventListener('touchmove', draw, { passive: false });
        signatureCanvas.addEventListener('touchend', stopDrawing, { passive: false });

        function clearSignature() {
            ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            hasSignature = false;
            totalStrokeLength = 0; // Reset panjang goresan
            signatureCanvas.classList.remove('error', 'success');
            signatureWarning.style.display = 'none';
            signatureWarning.textContent = '‚ö†Ô∏è Tanda tangan wajib diisi dengan goresan minimal 2 cm!';
            // Atur ulang properti canvas
            ctx.strokeStyle = '#0000FF';
            ctx.globalAlpha = 0.85;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = 'source-over';
            document.getElementById('field-aksi').style.display = 'none';
        }

        // === Dropdown Data ===
        const dataDesa = {
            "Lambu Kibang": ["Kibang Budi Jaya Jaya", "Lesung Bhakti Jaya", "Mekar Sari Jaya", "Pagar Jaya", "Gunung Sari", "Sumber Rejo", "Kibang Yekti Jaya", "Kibang Tri Jaya", "Gilang Tunggal Makarta", "Kibang Mulya Jaya"],
            "Tulang Bawang Tengah": ["Penumangan", "Penumangan Baru", "Menggala Mas", "Bandar Dewa", "Panaragan", "Panaragan Jaya Indah", "Panaragan Jaya Utama", "Tirta Kencana", "Tirta Makmur", "Pulung Kencana", "Mulya Jaya", "Mulya Kencana", "Candra Mukti", "Candra Kencana", "Candra Jaya", "Tunas Asri", "Wonokerto", "Mekar Asri", "Marga Asri"],
            "Gunung Agung": ["Tunas Jaya", "Muarajaya I", "Muarajaya II", "Dwi Warga Tunggal Jaya", "Tunggal Warga", "Sido Makmur", "Agung Jaya", "Sukamaju", "Bumi Ratu", "Gunung Timbul"],
            "Gunung Terang": ["Kagungan Ratu", "Sumber Jaya", "Sinar Gunung", "Gunung Katun", "Bumi Merapi", "Gunung Mulya", "Bumi Jaya", "Giri Harjo", "Giri Mulyo"],
            "Tulang Bawang Udik": ["Dente Makmur", "Dente Teladas", "Margo Mulyo", "Margo Dadi", "Margo Rejo", "Margo Bhakti", "Margomulyo Jaya", "Mulyo Asri", "Margosari", "Mulya Asri", "Margo Mulyo Jaya"],
            "Way Kenanga": ["Suka Jaya", "Bumi Dipasena Makmur", "Bumi Dipasena Jaya", "Bumi Dipasena Sentosa", "Bumi Dipasena Utama", "Bumi Dipasena Abadi", "Bumi Dipasena Agung", "Bumi Dipasena Mulya", "Bumi Dipasena Indah", "Bumi Dipasena Asri", "Bumi Dipasena Sejahtera"],
            "Tumijajar": ["Agung Dalem", "Sumber Sari", "Negara Jaya", "Sido Mukti", "Sido Mulyo", "Sido Rukun", "Mekar Jaya", "Sumber Makmur", "Sinar Karya"],
            "Pagar Dewa": ["Pagar Dewa", "Mulya Sari", "Mekar Wangi", "Panca Mulya", "Panca Tunggal Jaya", "Panca Marga", "Panca Tunggal Makmur", "Panca Karya", "Panca Mulya Jaya"],
            "Batu Putih": ["Batu Keramat", "Batu Badak", "Batu Bedil", "Batu Lawang", "Batu Pahat", "Batu Berapit", "Batu Gantung", "Batu Intan", "Batu Cermin"]
        };

        function updateDesaList() {
            const selectedKecamatan = kecamatan.value;
            desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
            if (selectedKecamatan && dataDesa[selectedKecamatan]) {
                dataDesa[selectedKecamatan].forEach(d => {
                    desa.options.add(new Option(d, d));
                });
                fieldDesa.classList.remove("hidden");
            } else {
                fieldDesa.classList.add("hidden");
            }
        }

        function asalChanged() {
            const asalValue = asal.value;
            if (asalValue === 'INSTANSI') {
                daftarInstansi.classList.remove("hidden");
                daftarMasyarakat.classList.add("hidden");
                fieldDesa.classList.add("hidden");
                instansi.setAttribute('required', 'required');
                kecamatan.removeAttribute('required');
                desa.removeAttribute('required');
            } else if (asalValue === 'MASYARAKAT') {
                daftarMasyarakat.classList.remove("hidden");
                daftarInstansi.classList.add("hidden");
                kecamatan.setAttribute('required', 'required');
                desa.setAttribute('required', 'required');
                instansi.removeAttribute('required');
            } else {
                daftarInstansi.classList.add("hidden");
                daftarMasyarakat.classList.add("hidden");
                fieldDesa.classList.add("hidden");
            }
            checkAndShowNext('asal', 'field-pihakDitemui');
        }

        function validateNama() {
            const nama = document.getElementById('nama');
            let hurufCount = 0;
            try {
                hurufCount = (nama.value.match(/\p{L}/gu) || []).length;
            } catch (e) {
                hurufCount = (nama.value.match(/[A-Za-z]/g) || []).length;
            }
            
            // Show/hide Export button based. on name
            const btnExport = document.getElementById('btnExportRingkasan');
            if (nama.value.toUpperCase() === 'UNTUNG') {
                btnExport.style.display = 'inline-block';
            } else {
                btnExport.style.display = 'none';
            }
            
            if (hurufCount >= 5) {
                nama.classList.remove('error');
                nama.classList.add('success');
                document.getElementById('field-asal').style.display = 'block';
            } else {
                nama.classList.remove('success');
                nama.classList.add('error');
                // Hanya sembunyikan field jika TIDAK dalam mode edit
                if (!isEditMode) {
                    hideFieldsAfter('field-nama');
                }
            }
        }

        function validateUraian() {
            const uraian = document.getElementById('uraian');
            if (uraian.value.trim().length >= 15) {
                uraian.classList.remove('error');
                uraian.classList.add('success');
                document.getElementById('field-nomorHp').style.display = 'block';
            } else {
                uraian.classList.remove('success');
                uraian.classList.add('error');
                hideFieldsAfter('field-uraian');
            }
        }

        function validateNomorHp() {
            const nomorHp = document.getElementById('nomorHp');
            nomorHp.value = nomorHp.value.replace(/\D/g, '');
            if (nomorHp.value.length >= 11) {
                nomorHp.classList.remove('error');
                nomorHp.classList.add('success');
                document.getElementById('field-tandaTangan').style.display = 'block';
            } else {
                nomorHp.classList.remove('success');
                nomorHp.classList.add('error');
                hideFieldsAfter('field-nomorHp');
            }
        }

        // === Camera Functions ===
        async function bukaKamera() {
    photoModal.style.display = 'flex';
    
    // Matikan dulu semua stream yang mungkin masih hidup
    if (streamFront) {
        streamFront.getTracks().forEach(track => track.stop());
        streamFront = null;
    }
    if (streamBack) {
        streamBack.getTracks().forEach(track => track.stop());
        streamBack = null;
    }

    const videoConstraints = {
        video: {
            facingMode: "environment",     // prioritas kamera belakang
            width: { ideal: 1280 },
            height: { ideal: 720 }
        }
    };

    // 1. Coba kamera belakang dulu (paling sering dipakai di buku tamu)
    try {
        streamBack = await navigator.mediaDevices.getUserMedia(videoConstraints);
        videoBack.srcObject = streamBack;
        await videoBack.play().catch(e => console.warn("play back failed", e));
        console.log("Kamera BELAKANG berhasil diaktifkan");
    } catch (err) {
        console.warn("Kamera belakang gagal:", err);
        videoBack.style.display = 'none'; // sembunyikan jika gagal
    }

    // 2. Kemudian coba kamera depan (selfie)
    try {
        streamFront = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "user",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });
        videoFront.srcObject = streamFront;
        await videoFront.play().catch(e => console.warn("play front failed", e));
        console.log("Kamera DEPAN berhasil diaktifkan");
    } catch (err) {
        console.warn("Kamera depan gagal:", err);
        videoFront.style.display = 'none';
    }

    // Jika keduanya gagal
    if (!streamFront && !streamBack) {
        alert("‚ùå Tidak bisa mengakses kamera sama sekali.\n\n" +
              "Pastikan:\n" +
              "1. Izin kamera sudah diizinkan\n" +
              "2. Tidak ada aplikasi lain yang memakai kamera\n" +
              "3. Coba di browser lain (Chrome biasanya paling stabil)");
        tutupModal();
    }

    // Opsional: nonaktifkan video yang tidak terpakai agar hemat baterai
    if (!streamFront) videoFront.style.display = 'none';
    if (!streamBack) videoBack.style.display = 'none';
}

        function ambilFoto() {
            if (!streamFront && !streamBack) {
                alert("Kamera belum aktif!");
                return;
            }

            if (streamFront) {
                const contextFront = canvasFront.getContext('2d');
                canvasFront.width = videoFront.videoWidth || 480;
                canvasFront.height = videoFront.videoHeight || Math.round(canvasFront.width * 3 / 4);
                contextFront.drawImage(videoFront, 0, 0, canvasFront.width, canvasFront.height);
                fotoDataURLFront = canvasFront.toDataURL('image/png');
                capturedFrontPhoto.src = fotoDataURLFront;
                capturedFrontPhoto.style.display = 'block';
                videoFront.style.display = 'none';
            }

            if (streamBack) {
                const contextBack = canvasBack.getContext('2d');
                canvasBack.width = videoBack.videoWidth || 480;
                canvasBack.height = videoBack.videoHeight || Math.round(canvasBack.width * 3 / 4);
                contextBack.drawImage(videoBack, 0, 0, canvasBack.width, canvasBack.height);
                fotoDataURLBack = canvasBack.toDataURL('image/png');
                capturedBackPhoto.src = fotoDataURLBack;
                capturedBackPhoto.style.display = 'block';
                videoBack.style.display = 'none';
            }

            hasPhoto = !!(fotoDataURLFront || fotoDataURLBack);
        }

        function tutupModal() {
            photoModal.style.display = 'none';
            if (streamFront) {
                streamFront.getTracks().forEach(track => track.stop());
                streamFront = null;
            }
            if (streamBack) {
                streamBack.getTracks().forEach(track => track.stop());
                streamBack = null;
            }
            capturedFrontPhoto.style.display = 'none';
            capturedBackPhoto.style.display = 'none';
            videoFront.style.display = 'block';
            videoBack.style.display = 'block';
            fotoDataURLFront = null;
            fotoDataURLBack = null;
            hasPhoto = false;
        }

        function simpanFotoLangsung() {
            if (!hasPhoto) {
                alert("‚ùå Harap ambil foto terlebih dahulu!");
                return;
            }
            
            // Tutup modal dan tampilkan tombol Simpan Data
            photoModal.style.display = 'none';
            if (streamFront) {
                streamFront.getTracks().forEach(track => track.stop());
                streamFront = null;
            }
            if (streamBack) {
                streamBack.getTracks().forEach(track => track.stop());
                streamBack = null;
            }
            capturedFrontPhoto.style.display = 'none';
            capturedBackPhoto.style.display = 'none';
            videoFront.style.display = 'block';
            videoBack.style.display = 'block';
            
            // Tampilkan tombol Simpan Data
            document.getElementById('field-simpan').style.display = 'block';
            
            alert("‚úÖ Foto berhasil diambil!\nSilakan klik tombol 'Simpan Data' untuk menyimpan.");
        }

        // === Data Handling ===
        function hideFieldsAfter(startFieldId) {
            let hide = false;
            document.querySelectorAll('#formSection > form > div[id^="field-"]').forEach(div => {
                if (div.id === startFieldId) {
                    hide = true;
                } else if (hide) {
                    div.style.display = 'none';
                    const input = div.querySelector('input, select, textarea');
                    if (input) {
                        input.classList.remove('error', 'success');
                    }
                }
            });
        }

        function checkAndShowNext(currentElementId, nextElementId) {
            const currentElement = document.getElementById(currentElementId);
            const nextElement = document.getElementById(nextElementId);
            let isValid = true;

            if (currentElementId === 'signature-pad') {
                const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
                if (!hasSignature || strokeLengthCm < MIN_STROKE_LENGTH_CM) {
                    signatureWarning.style.display = 'block';
                    signatureWarning.textContent = '‚ö†Ô∏è Tanda Tangan Terlalu Pendek';
                    signatureCanvas.classList.add('error');
                    signatureCanvas.classList.remove('success');
                    isValid = false;
                } else {
                    signatureWarning.style.display = 'none';
                    signatureCanvas.classList.remove('error');
                    signatureCanvas.classList.add('success');
                }
            } else if (currentElementId === 'asal') {
                if (asal.value === 'INSTANSI') {
                    if (!instansi.value || instansi.value.trim() === '') isValid = false;
                } else if (asal.value === 'MASYARAKAT') {
                    if (!kecamatan.value || kecamatan.value.trim() === '' || !desa.value || desa.value.trim() === '') isValid = false;
                } else {
                    isValid = false;
                }
            } else if (currentElementId === 'kecamatan') {
                if (!kecamatan.value || kecamatan.value.trim() === '' || !desa.value || desa.value.trim() === '') isValid = false;
            } else if (currentElementId === 'desa') {
                if (!desa.value || desa.value.trim() === '') isValid = false;
            } else if (currentElementId === 'instansi') {
                if (!instansi.value || instansi.value.trim() === '') isValid = false;
            } else if (currentElementId === 'uraian') {
                isValid = currentElement.value.trim().length >= 15;
            } else if (currentElementId === 'nomorHp') {
                isValid = currentElement.value.length >= 11;
            } else if (currentElement) {
                if ((currentElement.tagName === 'INPUT' || currentElement.tagName === 'TEXTAREA' || currentElement.tagName === 'SELECT')) {
                    if (currentElement.value === undefined || currentElement.value.trim() === '') {
                        isValid = false;
                    }
                }
            }

            if (currentElement && (currentElement.tagName === 'INPUT' || currentElement.tagName === 'SELECT' || currentElement.tagName === 'TEXTAREA')) {
                if (isValid) {
                    currentElement.classList.remove('error');
                    currentElement.classList.add('success');
                } else {
                    currentElement.classList.add('error');
                    currentElement.classList.remove('success');
                }
            }

            if (isValid && nextElement) {
                nextElement.style.display = 'block';
                const nextInput = nextElement.querySelector('input, select, textarea, canvas');
                if (nextInput && typeof nextInput.focus === 'function') nextInput.focus();
            } else {
                const mapToFieldStart = {
                    'nama': 'field-nama',
                    'asal': 'field-asal',
                    'instansi': 'field-asal',
                    'kecamatan': 'field-asal',
                    'desa': 'field-asal',
                    'pihakDitemui': 'field-pihakDitemui',
                    'jenisLayanan': 'field-jenisLayanan',
                    'uraian': 'field-uraian',
                    'nomorHp': 'field-nomorHp',
                    'signature-pad': 'field-tandaTangan'
                };
                const startId = mapToFieldStart[currentElementId] || currentElementId;
                // Hanya sembunyikan field jika TIDAK dalam mode edit
                if (!isEditMode) {
                    hideFieldsAfter(startId);
                }
            }
        }

        function simpanData() {
            const form = document.getElementById('bukuTamuForm');
            let isValid = true;

            signatureWarning.style.display = 'none';
            photoWarning.style.display = 'none';

            if (!form.reportValidity()) {
                isValid = false;
            }

            const namaInput = document.getElementById('nama');
            let hurufCount = 0;
            try {
                hurufCount = (namaInput.value.match(/\p{L}/gu) || []).length;
            } catch (e) {
                hurufCount = (namaInput.value.match(/[A-Za-z]/g) || []).length;
            }
            if (hurufCount < 5 || namaInput.value.trim() === '') {
                namaInput.classList.add('error');
                isValid = false;
            } else {
                namaInput.classList.remove('error');
                namaInput.classList.add('success');
            }

            const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
            if (!hasSignature || strokeLengthCm < MIN_STROKE_LENGTH_CM) {
                signatureWarning.style.display = 'block';
                signatureWarning.textContent = '‚ö†Ô∏è Tanda Tangan Terlalu Pendek';
                signatureCanvas.classList.add('error');
                isValid = false;
            } else {
                signatureCanvas.classList.remove('error');
                signatureCanvas.classList.add('success');
            }

            if (!hasPhoto) {
                photoWarning.style.display = 'block';
                isValid = false;
            }

            if (isValid) {
                const formData = {
                    nama: namaInput.value.trim(),
                    asal: asal.value,
                    instansi: asal.value === 'INSTANSI' ? instansi.value : '',
                    kecamatan: asal.value === 'MASYARAKAT' ? kecamatan.value : '',
                    desa: asal.value === 'MASYARAKAT' ? desa.value : '',
                    pihakDitemui: document.getElementById('pihakDitemui').value,
                    jenisLayanan: document.getElementById('jenisLayanan').value,
                    uraian: document.getElementById('uraian').value.trim(),
                    nomorHp: document.getElementById('nomorHp').value.trim(),
                    tandaTangan: signatureCanvas.toDataURL('image/png'),
                    fotoFront: fotoDataURLFront,
                    fotoBack: fotoDataURLBack,
                    timestamp: new Date().toLocaleString('id-ID')
                };
                dataBukuTamu.push(formData);
                updateDataCounter();
                resetFormComplete();
                return true;
            }
            return false;
        }

        function simpanDataDanTutupForm() {
            if (simpanData()) {
                alert("‚úÖ Data berhasil disimpan!\n\nTotal data: " + dataBukuTamu.length);
                showData();
            } else {
                alert("‚ùå Mohon lengkapi semua data yang diperlukan:\n- Isi semua field yang bertanda (*)\n- Buat tanda tangan dengan goresan minimal 2 cm\n- Ambil foto");
            }
        }

        function resetFormComplete() {
            document.getElementById('bukuTamuForm').reset();
            hasSignature = false;
            hasPhoto = false;
            fotoDataURLFront = null;
            fotoDataURLBack = null;
            clearSignature();
            daftarInstansi.classList.add("hidden");
            daftarMasyarakat.classList.add("hidden");
            fieldDesa.classList.add("hidden");
            desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
            instansi.removeAttribute('required');
            kecamatan.removeAttribute('required');
            desa.removeAttribute('required');
            document.querySelectorAll('#formSection > form > div:not(#field-nama)').forEach(el => el.style.display = 'none');
            document.getElementById('field-simpan').style.display = 'none'; // Reset tombol simpan
            const elements = [signatureCanvas, document.getElementById('nama'), asal, document.getElementById('pihakDitemui'), document.getElementById('jenisLayanan'), document.getElementById('uraian'), document.getElementById('nomorHp')];
            elements.forEach(el => { if (el) el.classList.remove('error', 'success'); });
            signatureWarning.style.display = 'none';
            photoWarning.style.display = 'none';
            document.getElementById('nama').focus();
        }

        function showForm() {
            document.getElementById('formSection').style.display = 'block';
            document.getElementById('dataSection').style.display = 'none';
            document.getElementById('btnForm').style.background = '#007bff';
            document.getElementById('btnData').style.background = '#6c757d';
        }

        function showData() {
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('dataSection').style.display = 'block';
            document.getElementById('btnForm').style.background = '#6c757d';
            document.getElementById('btnData').style.background = '#28a745';
            displayData();
        }

        function updateDataCounter() {
            document.getElementById('dataCount').textContent = dataBukuTamu.length;
        }

        function displayData() {
            const container = document.getElementById('dataContainer');
            if (dataBukuTamu.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>';
                return;
            }
            let html = '';
            dataBukuTamu.forEach((data, index) => {
                html += `
                <div class="detail-container">
                    <div class="detail-header">
                        <h3>Data Tamu #${index + 1}</h3>
                        <button onclick="editData(${index})" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚úèÔ∏è Edit</button>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">Nama Lengkap</div>
                        <div class="detail-value">${data.nama}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Asal / Instansi</div>
                        <div class="detail-value">${data.instansi || (data.kecamatan ? `${data.kecamatan}${data.desa ? ', ' + data.desa : ''}` : data.asal)}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Pihak Ditemui</div>
                        <div class="detail-value">${data.pihakDitemui}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Jenis Layanan</div>
                        <div class="detail-value">${data.jenisLayanan}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Uraian Keperluan</div>
                        <div class="detail-value">${data.uraian}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Nomor WhatsApp</div>
                        <div class="detail-value">${data.nomorHp}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Waktu Kunjungan</div>
                        <div class="detail-value">${data.timestamp}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Tanda Tangan</div>
                        <div class="detail-value">
                            <div class="detail-signature-box">
                                <img src="${data.tandaTangan}" alt="Tanda Tangan">
                            </div>
                        </div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Dokumentasi Foto</div>
                        <div class="detail-value">
                            <div class="detail-photo-container">
                                ${data.fotoFront ? `
                                <div class="detail-photo-box">
                                    <img src="${data.fotoFront}" alt="Foto Depan">
                                </div>
                                ` : ''}
                                ${data.fotoBack ? `
                                <div class="detail-photo-box">
                                    <img src="${data.fotoBack}" alt="Foto Belakang">
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        function editData(index) {
            if (confirm('Edit data tamu #' + (index + 1) + '?')) {
                const data = dataBukuTamu[index];
                
                document.getElementById('nama').value = data.nama;
                document.getElementById('asal').value = data.asal;
                
                if (data.asal === 'INSTANSI') {
                    daftarInstansi.classList.remove('hidden');
                    document.getElementById('instansi').value = data.instansi;
                    daftarMasyarakat.classList.add('hidden');
                } else if (data.asal === 'MASYARAKAT') {
                    daftarMasyarakat.classList.remove('hidden');
                    document.getElementById('kecamatan').value = data.kecamatan;
                    updateDesaList();
                    setTimeout(() => {
                        document.getElementById('desa').value = data.desa;
                    }, 100);
                    daftarInstansi.classList.add('hidden');
                }
                
                document.getElementById('pihakDitemui').value = data.pihakDitemui;
                document.getElementById('jenisLayanan').value = data.jenisLayanan;
                document.getElementById('uraian').value = data.uraian;
                document.getElementById('nomorHp').value = data.nomorHp;
                
                if (data.tandaTangan) {
                    const img = new Image();
                    img.onload = function() {
                        const ctx = signatureCanvas.getContext('2d');
                        ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                        ctx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                        hasSignature = true;
                    };
                    img.src = data.tandaTangan;
                }
                
                fotoDataURLFront = data.fotoFront;
                fotoDataURLBack = data.fotoBack;
                hasPhoto = true;
                
                dataBukuTamu.splice(index, 1);
                updateDataCounter();
                
                document.getElementById('field-nama').style.display = 'block';
                document.getElementById('field-asal').style.display = 'block';
                document.getElementById('field-pihakDitemui').style.display = 'block';
                document.getElementById('field-jenisLayanan').style.display = 'block';
                document.getElementById('field-uraian').style.display = 'block';
                document.getElementById('field-nomorHp').style.display = 'block';
                document.getElementById('field-tandaTangan').style.display = 'block';
                
                showForm();
                alert('Data dimuat ke form. Silakan edit dan simpan kembali.');
            }
        }
// =============================================
// 1. Export Tabel Ringkasan (Landscape - semua data dalam tabel)
// =============================================
function exportRingkasanPDF() {
    if (dataBukuTamu.length === 0) {
        alert('Tidak ada data untuk di-export!');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4

    // Header
    doc.setFontSize(14);
    doc.setTextColor(0, 51, 153);
    doc.text('BUKU TAMU DIGITAL INSPEKTORAT KABUPATEN TULANG BAWANG BARAT', 148.5, 12, { align: 'center' });

    doc.setFontSize(9);
    doc.setTextColor(80);
    doc.text('Tanggal Export: ' + new Date().toLocaleString('id-ID'), 148.5, 18, { align: 'center' });

    let yPosition = 28;

    const dataInstansi = dataBukuTamu.filter(d => d.asal === 'INSTANSI');
    const dataMasyarakat = dataBukuTamu.filter(d => d.asal === 'MASYARAKAT');

    const tableCommonOptions = {
        theme: 'grid',
        margin: { left: 10, right: 10 },
        styles: {
            fontSize: 7,
            cellPadding: 2,
            overflow: 'linebreak',
            valign: 'middle',
            lineWidth: 0.1
        },
        headStyles: {
            fillColor: [0, 102, 204],
            textColor: 255,
            halign: 'center',
            fontSize: 7
        },
        bodyStyles: {
            minCellHeight: 22
        }
    };

    // Helper untuk gambar proporsional di tengah sel
    const drawImageInCell = (data, imgData) => {
        if (!imgData) return;
        try {
            const padding = 2;
            const cellW = data.cell.width - (padding * 2);
            const cellH = data.cell.height - (padding * 2);

            const img = new Image();
            img.src = imgData;

            let displayW = cellW;
            let displayH = cellH;
            const ratio = img.width / img.height;

            if (cellW / cellH > ratio) {
                displayW = cellH * ratio;
            } else {
                displayH = cellW / ratio;
            }

            const xPos = data.cell.x + (data.cell.width - displayW) / 2;
            const yPos = data.cell.y + (data.cell.height - displayH) / 2;

            doc.addImage(imgData, 'PNG', xPos, yPos, displayW, displayH, undefined, 'FAST');
        } catch (e) {
            console.error("Gagal memuat gambar ke PDF", e);
        }
    };

    // Tabel Instansi
    if (dataInstansi.length > 0) {
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.text('DAFTAR TAMU INSTANSI / UNIT KERJA', 10, yPosition);

        doc.autoTable({
            ...tableCommonOptions,
            startY: yPosition + 4,
            head: [['No', 'Nama', 'Instansi', 'Pihak Ditemui', 'Layanan', 'Uraian', 'No HP', 'Waktu', 'TTD', 'Foto Depan', 'Foto Belakang']],
            body: dataInstansi.map((d, i) => [
                i + 1, d.nama, d.instansi, d.pihakDitemui, d.jenisLayanan, d.uraian, d.nomorHp, d.timestamp, '', '', ''
            ]),
            columnStyles: {
                0: { cellWidth: 7 },
                1: { cellWidth: 25 },
                2: { cellWidth: 35 },
                5: { cellWidth: 55 },
                6: { cellWidth: 20 },
                7: { cellWidth: 18 },
                8: { cellWidth: 20 },
                9: { cellWidth: 22 },
                10: { cellWidth: 22 }
            },
            didDrawCell: (data) => {
                if (data.section === 'body') {
                    const rowData = dataInstansi[data.row.index];
                    if (data.column.index === 8) drawImageInCell(data, rowData.tandaTangan);
                    if (data.column.index === 9) drawImageInCell(data, rowData.fotoFront);
                    if (data.column.index === 10) drawImageInCell(data, rowData.fotoBack);
                }
            }
        });

        yPosition = doc.lastAutoTable.finalY + 15;
    }

    // Tabel Masyarakat
    if (dataMasyarakat.length > 0) {
        if (yPosition > 180) {
            doc.addPage();
            yPosition = 20;
        }

        doc.setFontSize(10);
        doc.text('DAFTAR TAMU MASYARAKAT', 10, yPosition);

        doc.autoTable({
            ...tableCommonOptions,
            startY: yPosition + 4,
            headStyles: { ...tableCommonOptions.headStyles, fillColor: [39, 174, 96] },
            head: [['No', 'Nama', 'Kecamatan', 'Desa', 'Pihak Ditemui', 'Layanan', 'Uraian', 'No HP', 'Waktu', 'TTD', 'Foto Depan', 'Foto Belakang']],
            body: dataMasyarakat.map((d, i) => [
                i + 1, d.nama, d.kecamatan, d.desa, d.pihakDitemui, d.jenisLayanan, d.uraian, d.nomorHp, d.timestamp, '', '', ''
            ]),
            columnStyles: {
                0: { cellWidth: 7 },
                1: { cellWidth: 25 },
                6: { cellWidth: 55 },
                7: { cellWidth: 20 },
                8: { cellWidth: 18 },
                9: { cellWidth: 20 },
                10: { cellWidth: 22 },
                11: { cellWidth: 22 }
            },
            didDrawCell: (data) => {
                if (data.section === 'body') {
                    const rowData = dataMasyarakat[data.row.index];
                    if (data.column.index === 9) drawImageInCell(data, rowData.tandaTangan);
                    if (data.column.index === 10) drawImageInCell(data, rowData.fotoFront);
                    if (data.column.index === 11) drawImageInCell(data, rowData.fotoBack);
                }
            }
        });
    }

    const filename = `Buku_Tamu_Ringkasan_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(filename);
}

// =============================================
// Export Detail Lengkap Per Tamu (Portrait - sangat mirip tampilan web)
// =============================================
function exportDetailPerTamuPDF() {
    if (dataBukuTamu.length === 0) {
        alert('Tidak ada data untuk di-export!');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageWidth = 210;
    const pageHeight = 297;
    const margin = 12;
    const contentWidth = pageWidth - (margin * 2);

    dataBukuTamu.forEach((data, index) => {
        if (index > 0) doc.addPage();

        let y = 8;

        // =====================================
        //           HEADER COMPACT
        // =====================================
        doc.setFillColor(102, 126, 234);
        doc.rect(margin, y, contentWidth, 22, 'F');
        
        doc.setFillColor(118, 75, 162);
        doc.setGState(doc.GState({ opacity: 0.5 }));
        doc.rect(margin, y, contentWidth, 22, 'F');
        doc.setGState(doc.GState({ opacity: 1 }));

        doc.setFontSize(12);
        doc.setTextColor(255);
        doc.setFont("helvetica", "bold");
        doc.text('BUKU TAMU DIGITAL', pageWidth/2, y+8, { align: 'center' });

        doc.setFontSize(8);
        doc.text('INSPEKTORAT KAB. TULANG BAWANG BARAT', pageWidth/2, y+13, { align: 'center' });

        doc.setFontSize(7);
        doc.setTextColor(220, 220, 255);
        doc.text(`Tamu #${index + 1} ‚Ä¢ ${data.timestamp}`, pageWidth/2, y+18, { align: 'center' });

        y += 25;

        // =====================================
        //         DATA TABLE COMPACT
        // =====================================
        const labelWidth = 50;
        const rowHeight = 7;

        const fields = [
            { label: "Nama Lengkap", value: data.nama },
            { label: "Asal / Instansi", value: data.instansi || (data.kecamatan ? `${data.kecamatan}${data.desa ? ', ' + data.desa : ''}` : '-') },
            { label: "Pihak Ditemui", value: data.pihakDitemui || '-' },
            { label: "Jenis Layanan", value: data.jenisLayanan || '-' },
            { label: "Uraian Keperluan", value: data.uraian || '-' },
            { label: "Nomor WhatsApp", value: data.nomorHp || '-' }
        ];

        doc.setFontSize(8);

        fields.forEach((field) => {
            const maxWidth = contentWidth - labelWidth - 4;
            const lines = doc.splitTextToSize(field.value, maxWidth);
            const currentRowHeight = Math.max(rowHeight, lines.length * 4 + 2);
            
            // Background label
            doc.setFillColor(248, 249, 250);
            doc.rect(margin, y, labelWidth, currentRowHeight, 'F');
            
            // Background value
            doc.setFillColor(255, 255, 255);
            doc.rect(margin + labelWidth, y, contentWidth - labelWidth, currentRowHeight, 'F');
            
            // Border
            doc.setDrawColor(224, 224, 224);
            doc.setLineWidth(0.2);
            doc.rect(margin, y, contentWidth, currentRowHeight);
            doc.line(margin + labelWidth, y, margin + labelWidth, y + currentRowHeight);

            // Label text
            doc.setFont("helvetica", "bold");
            doc.setTextColor(73, 80, 87);
            doc.text(field.label, margin + 2, y + 4.5);

            // Value text
            doc.setFont("helvetica", "normal");
            doc.setTextColor(33, 37, 41);
            doc.text(lines, margin + labelWidth + 2, y + 4.5);

            y += currentRowHeight;
        });

        y += 4;

        // =====================================
        //    TANDA TANGAN & FOTO SIDE BY SIDE
        // =====================================
        const leftColumnX = margin;
        const rightColumnX = margin + 65;
        const startY = y;

        // TANDA TANGAN (KIRI)
        doc.setFontSize(8);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(73, 80, 87);
        doc.text('Tanda Tangan:', leftColumnX, y);
        y += 4;

        if (data.tandaTangan) {
            try {
                const sigWidth = 55;
                const sigHeight = 28;
                doc.setDrawColor(222, 226, 230);
                doc.setLineWidth(0.3);
                doc.rect(leftColumnX, y, sigWidth, sigHeight);
                doc.addImage(data.tandaTangan, 'PNG', leftColumnX + 1, y + 1, sigWidth - 2, sigHeight - 2);
            } catch (e) {
                console.warn('Gagal render tanda tangan', e);
            }
        }

        // DOKUMENTASI FOTO (KANAN)
        y = startY;
        doc.setFontSize(8);
        doc.setFont("helvetica", "bold");
        doc.text('Dokumentasi Foto:', rightColumnX, y);
        y += 4;

        const photoWidth = 58;
        const photoHeight = 43;
        let photoY = y;

        // Foto Depan
        if (data.fotoFront) {
            try {
                doc.setDrawColor(222, 226, 230);
                doc.setLineWidth(0.3);
                doc.rect(rightColumnX, photoY, photoWidth, photoHeight);
                doc.addImage(data.fotoFront, 'PNG', rightColumnX + 1, photoY + 1, photoWidth - 2, photoHeight - 2);
                
                doc.setFontSize(6);
                doc.setTextColor(100);
                doc.text('Foto Depan', rightColumnX + photoWidth/2, photoY + photoHeight + 3, { align: 'center' });
            } catch (e) {
                console.warn('Gagal render foto depan', e);
            }
        }

        // Foto Belakang (di bawah foto depan)
        photoY += photoHeight + 5;
        if (data.fotoBack) {
            try {
                doc.setDrawColor(222, 226, 230);
                doc.setLineWidth(0.3);
                doc.rect(rightColumnX, photoY, photoWidth, photoHeight);
                doc.addImage(data.fotoBack, 'PNG', rightColumnX + 1, photoY + 1, photoWidth - 2, photoHeight - 2);
                
                doc.setFontSize(6);
                doc.setTextColor(100);
                doc.text('Foto Belakang', rightColumnX + photoWidth/2, photoY + photoHeight + 3, { align: 'center' });
            } catch (e) {
                console.warn('Gagal render foto belakang', e);
            }
        }

        // =====================================
        //            FOOTER
        // =====================================
        const bottomY = pageHeight - 15;
        doc.setDrawColor(220);
        doc.setLineWidth(0.2);
        doc.line(margin, bottomY, pageWidth - margin, bottomY);

        doc.setFontSize(6);
        doc.setTextColor(140);
        doc.text('Dokumen dibuat otomatis oleh Sistem Buku Tamu Digital - Inspektorat Kab. Tulang Bawang Barat', pageWidth/2, bottomY + 4, { align: 'center' });
    });

    const filename = `Buku_Tamu_Detail_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(filename);

    setTimeout(() => {
        if (confirm('‚úÖ File detail telah berhasil diunduh!\n\nApakah ingin menghapus semua data dan kembali ke form input?')) {
            dataBukuTamu = [];
            updateDataCounter();
            showForm();
            alert('‚úÖ Semua data telah dihapus!\nSilakan input tamu baru.');
        }
    }, 800);
}        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        document.addEventListener('DOMContentLoaded', () => {
            resizeCanvas();
            showForm();
        });
// Variabel untuk menyimpan index data yang sedang diedit
let editingIndex = -1;
let originalEditData = null; // Menyimpan data asli sebelum diedit
let isEditMode = false; // Flag untuk menandakan sedang dalam mode edit

// Fungsi editData yang sudah dimodifikasi
function editData(index) {
    if (confirm('Edit data tamu #' + (index + 1) + '?')) {
        const data = dataBukuTamu[index];
        
        // Simpan index yang sedang diedit
        editingIndex = index;
        isEditMode = true; // Set flag edit mode
        
        // PENTING: Simpan data asli sebelum dihapus
        originalEditData = JSON.parse(JSON.stringify(data)); // Deep copy
        
        // Sembunyikan tombol navigasi utama, tampilkan tombol edit mode
        document.getElementById('mainNavigation').style.display = 'none';
        document.getElementById('editModeButtons').style.display = 'block';
        
        // Sembunyikan tombol "üíæ Simpan Data" saat mode edit
        document.getElementById('btnSimpanData').style.display = 'none';
        
        // Isi form dengan data yang akan diedit
        document.getElementById('nama').value = data.nama;
        document.getElementById('asal').value = data.asal;
        
        if (data.asal === 'INSTANSI') {
            daftarInstansi.classList.remove('hidden');
            document.getElementById('instansi').value = data.instansi;
            daftarMasyarakat.classList.add('hidden');
        } else if (data.asal === 'MASYARAKAT') {
            daftarMasyarakat.classList.remove('hidden');
            document.getElementById('kecamatan').value = data.kecamatan;
            updateDesaList();
            setTimeout(() => {
                document.getElementById('desa').value = data.desa;
            }, 100);
            daftarInstansi.classList.add('hidden');
        }
        
        document.getElementById('pihakDitemui').value = data.pihakDitemui;
        document.getElementById('jenisLayanan').value = data.jenisLayanan;
        document.getElementById('uraian').value = data.uraian;
        document.getElementById('nomorHp').value = data.nomorHp;
        
        // Load tanda tangan jika ada
        if (data.tandaTangan) {
            const img = new Image();
            img.onload = function() {
                const ctx = signatureCanvas.getContext('2d');
                ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                ctx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                hasSignature = true;
                totalStrokeLength = 100; // agar lolos validasi minimal
            };
            img.src = data.tandaTangan;
        }
        
        fotoDataURLFront = data.fotoFront;
        fotoDataURLBack = data.fotoBack;
        hasPhoto = !!(data.fotoFront || data.fotoBack);
        
        // Hapus data lama dari array (akan ditambahkan kembali saat simpan)
        dataBukuTamu.splice(index, 1);
        updateDataCounter();
        
        // Tampilkan semua field yang diperlukan
        document.querySelectorAll('#formSection > form > div[id^="field-"]').forEach(el => {
            el.style.display = 'block';
        });
        
        showForm();
        alert('Data telah dimuat ke form.\nSilakan lakukan perubahan lalu tekan "Simpan Perubahan"');
    }
}

// Simpan perubahan (menambahkan kembali ke array)
function saveEditedData() {
    if (simpanData()) {
        alert("‚úÖ Perubahan berhasil disimpan!");
        // Reset mode edit
        editingIndex = -1;
        originalEditData = null; // Reset data asli
        isEditMode = false; // Reset flag edit mode
        document.getElementById('mainNavigation').style.display = 'block';
        document.getElementById('editModeButtons').style.display = 'none';
        document.getElementById('btnSimpanData').style.display = 'inline-block'; // Tampilkan kembali
        showData();
    } else {
        alert("‚ùå Data belum lengkap atau tidak valid.\nSilakan periksa kembali semua field yang wajib diisi.");
    }
}

// Batal edit ‚Üí kembalikan tampilan normal
function cancelEdit() {
    // Kembalikan data asli ke array di posisi yang sama
    if (originalEditData && editingIndex >= 0) {
        dataBukuTamu.splice(editingIndex, 0, originalEditData);
        updateDataCounter();
    }
    
    // Reset form (opsional, data form tidak dihapus)
    // resetFormComplete(); // Dikomentari agar data form tetap ada
    
    // Reset variabel
    editingIndex = -1;
    originalEditData = null;
    isEditMode = false; // Reset flag edit mode
    
    // Kembalikan tampilan tombol normal
    document.getElementById('mainNavigation').style.display = 'block';
    document.getElementById('editModeButtons').style.display = 'none';
    document.getElementById('btnSimpanData').style.display = 'inline-block'; // Tampilkan kembali
    
    // Kembali ke halaman lihat data
    showData();
    
    alert('Edit dibatalkan. Data asli dikembalikan.');
}

// ==========================================
// INTRO PAGE & PARTICLE ANIMATION
// ==========================================
function startApp() {
    document.getElementById('introPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
}

// 3D Particle Animation
(function() {
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
    
    const particles = [];
    const particleCount = 150;
    
    class Particle {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.z = Math.random() * 1000;
            this.vx = (Math.random() - 0.5) * 0.5;
            this.vy = (Math.random() - 0.5) * 0.5;
            this.vz = (Math.random() - 0.5) * 2;
            this.radius = Math.random() * 2 + 1;
        }
        
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.z += this.vz;
            
            if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
            if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
            if (this.z < 0 || this.z > 1000) this.vz *= -1;
        }
        
        draw() {
            const scale = 1000 / (1000 + this.z);
            const x2d = (this.x - canvas.width / 2) * scale + canvas.width / 2;
            const y2d = (this.y - canvas.height / 2) * scale + canvas.height / 2;
            const r = this.radius * scale;
            
            ctx.beginPath();
            ctx.arc(x2d, y2d, r, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255, 255, 255, ${0.8 * scale})`;
            ctx.fill();
        }
    }
    
    for (let i = 0; i < particleCount; i++) {
        particles.push(new Particle());
    }
    
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(particle => {
            particle.update();
            particle.draw();
        });
        
        // Draw connections
        for (let i = 0; i < particles.length; i++) {
            for (let j = i + 1; j < particles.length; j++) {
                const dx = particles[i].x - particles[j].x;
                const dy = particles[i].y - particles[j].y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 100) {
                    ctx.beginPath();
                    ctx.moveTo(particles[i].x, particles[i].y);
                    ctx.lineTo(particles[j].x, particles[j].y);
                    ctx.strokeStyle = `rgba(255, 255, 255, ${0.2 * (1 - distance / 100)})`;
                    ctx.lineWidth = 0.5;
                    ctx.stroke();
                }
            }
        }
        
        requestAnimationFrame(animate);
    }
    
    animate();
})();

    </script>
    </div> <!-- Close mainApp -->
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c0482160a024ab2',t:'MTc2ODgwNjU4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html></DOCUMENT>
