<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link rel="manifest" href="manifest.json"/>
    <meta name="theme-color" content="#007bff"/>
    <link rel="icon" href="icon-192.png"/>
    <title>Buku Tamu Digital</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
        body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 20px 10px; min-height: 100vh; background: #f8f9fa; }
        label { font-weight: bold; }
        select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .hidden { display: none; }
        .required { color: red; }
        .error { border: 2px solid red !important; }
        .success { border: 2px solid green !important; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .header-gambar { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px; flex-wrap: nowrap; }
        .foto-kepala { width: 80px; height: auto; }
        .logo { width: 100px; height: auto; }

        /* Modal Foto */
        #photoModal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; padding: 10px; }
        #modalContent { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 95%; max-width: 1300px; text-align: center; border-radius: 8px; }
        #dualCameraFrame { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 900px; margin: 20px auto; }
        .camera-view { width: 100%; border: 3px solid #007bff; aspect-ratio: 4/3; overflow: hidden; position: relative; border-radius: 10px; background: #000; }
        .camera-view h4 { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 8px 16px; border-radius: 20px; margin: 0; font-size: 16px; z-index: 10; white-space: nowrap; }
        .camera-view video, .camera-view img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        @media (min-width: 768px) {
            #dualCameraFrame { flex-direction: row; gap: 30px; max-width: 1200px; }
            .camera-view { flex: 1; aspect-ratio: 16/9; max-width: 600px; }
            .camera-view h4 { font-size: 18px; padding: 10px 20px; }
        }
        #modalButtons { margin-top: 10px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        #modalButtons button { padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; min-width: 120px; }
        .btn-camera { background: #ffc107; color: black; }
        .btn-save { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
        .btn-camera:hover { background: #e0a800; }
        .btn-save:hover { background: #218838; }
        .btn-cancel:hover { background: #c82333; }

        .data-card { border: 1px solid #ddd; margin-bottom: 15px; padding: 15px; border-radius: 8px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .data-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; }
        @media (min-width: 500px) { .data-grid { grid-template-columns: 1fr 1fr; } }
        .data-images { display: flex; flex-direction: column; gap: 20px; margin-top: 15px; }
        @media (min-width: 500px) { .data-images { flex-direction: row; justify-content: center; } }
        .data-images img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid #ddd; }
        #signature-pad { background: white; border: 1px solid #ccc; border-radius: 4px; }
    </style>

    <!-- jsPDF dan AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <div style="margin-bottom: 80px; text-align: center;">
        <button type="button" onclick="showForm()" id="btnForm" style="background:#007bff;color:white;padding:12px 20px;border:none;border-radius:5px;margin:5px;font-size:16px;cursor:pointer;">üìù Form Input</button>
        <button type="button" onclick="showData()" id="btnData" style="background:#6c757d;color:white;padding:12px 20px;border:none;border-radius:5px;margin:5px;font-size:16px;cursor:pointer;">üìä Lihat Data (<span id="dataCount">0</span>)</button>
        <button type="button" onclick="exportData()" id="btnExport" style="background:#17a2b8;color:white;padding:12px 20px;border:none;border-radius:5px;margin:5px;font-size:16px;cursor:pointer;">üíæ Export PDF</button>
    </div>

    <!-- Tempatkan form dan tampilan data Anda di sini (pastikan ada elemen dengan id yang sesuai seperti #formSection, #dataSection, dll) -->
    <!-- Contoh placeholder jika belum ada: -->
    <div id="formSection" class="hidden">
        <h2>Form Buku Tamu</h2>
        <!-- Isi form Anda di sini -->
    </div>

    <div id="dataSection" class="hidden">
        <h2>Data Buku Tamu</h2>
        <div id="dataList"></div>
    </div>

    <script>
        // Variabel global data (pastikan ini ada di kode asli Anda)
        let dataBukuTamu = JSON.parse(localStorage.getItem('dataBukuTamu')) || [];

        // Fungsi untuk update jumlah data
        function updateDataCount() {
            document.getElementById('dataCount').textContent = dataBukuTamu.length;
        }

        // Contoh fungsi showForm dan showData (sesuaikan dengan kode Anda)
        function showForm() {
            document.getElementById('formSection').classList.remove('hidden');
            document.getElementById('dataSection').classList.add('hidden');
        }

        function showData() {
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('dataSection').classList.remove('hidden');
            // Render data di sini jika belum ada fungsi render
        }

        // *** FUNGSI EXPORT PDF YANG SUDAH DIPERBAIKI ***
        function exportData() {
            if (dataBukuTamu.length === 0) {
                alert('Tidak ada data untuk di-export!\nSilakan tambahkan data terlebih dahulu.');
                return;
            }

            if (typeof window.jspdf === 'undefined') {
                alert('Gagal memuat library PDF. Coba refresh halaman.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Header
                doc.setFontSize(14);
                doc.text('BUKU TAMU DIGITAL', 148, 10, { align: 'center' });
                doc.setFontSize(12);
                doc.text('INSPEKTORAT KABUPATEN TULANG BAWANG BARAT', 148, 16, { align: 'center' });
                doc.setFontSize(10);
                doc.text('Tanggal Export: ' + new Date().toLocaleDateString('id-ID'), 148, 22, { align: 'center' });

                const head = [[
                    'No', 'Nama', 'Instansi', 'Kecamatan', 'Desa/Tiyuh',
                    'Pihak\nDitemui', 'Jenis\nLayanan', 'Uraian', 'No HP', 'Tanggal',
                    'Tanda\nTangan', 'Foto\nDepan', 'Foto\nBelakang'
                ]];

                const body = dataBukuTamu.map((d, i) => [
                    i + 1,
                    d.nama?.substring(0,35) + (d.nama?.length > 35 ? '...' : '') || '-',
                    d.asal === 'INSTANSI' ? (d.instansi?.substring(0,30) + (d.instansi?.length > 30 ? '...' : '') || '-') : '-',
                    d.asal === 'MASYARAKAT' ? (d.kecamatan?.substring(0,25) + '...' || '-') : '-',
                    d.desa?.substring(0,25) + (d.desa?.length > 25 ? '...' : '') || '-',
                    d.pihakDitemui || '-',
                    d.jenisLayanan || '-',
                    d.uraian?.substring(0,150) + (d.uraian?.length > 150 ? '...' : '') || '-',
                    d.nomorHp || '-',
                    d.timestamp ? d.timestamp.split(', ')[0] : '-',
                    '', '', ''
                ]);

                doc.autoTable({
                    head: head,
                    body: body,
                    startY: 28,
                    margin: { left: 6, right: 6 },
                    theme: 'grid',
                    styles: {
                        fontSize: 7,
                        cellPadding: 2,
                        overflow: 'linebreak',
                        valign: 'middle',
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [0, 123, 255],
                        textColor: [255, 255, 255],
                        fontSize: 7.5,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    alternateRowStyles: { fillColor: [240, 248, 255] },
                    columnStyles: {
                        0:  { cellWidth: 8,  halign: 'center' },
                        1:  { cellWidth: 25 },
                        2:  { cellWidth: 25 },
                        3:  { cellWidth: 20 },
                        4:  { cellWidth: 20 },
                        5:  { cellWidth: 18 },
                        6:  { cellWidth: 18 },
                        7:  { cellWidth: 62 },  // Kolom uraian paling lebar
                        8:  { cellWidth: 18 },
                        9:  { cellWidth: 18 },
                        10: { cellWidth: 12 },
                        11: { cellWidth: 12 },
                        12: { cellWidth: 12 }
                    },
                    didDrawCell: function (data) {
                        if (data.section === 'body' && data.column.index >= 10 && data.column.index <= 12) {
                            const item = dataBukuTamu[data.row.index];
                            let imgData = null;
                            if (data.column.index === 10) imgData = item.tandaTangan;
                            if (data.column.index === 11) imgData = item.fotoFront;
                            if (data.column.index === 12) imgData = item.fotoBack;

                            if (imgData) {
                                try {
                                    const imgWidth = 10;
                                    const imgHeight = 7.5;
                                    const x = data.cell.x + (data.cell.width - imgWidth) / 2;
                                    const y = data.cell.y + (data.cell.height - imgHeight) / 2;
                                    doc.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight, undefined, 'FAST');
                                } catch (e) {
                                    console.warn('Gagal menambahkan gambar:', e);
                                }
                            }
                        }
                    }
                });

                const filename = 'Buku_Tamu_Inspektorat_Tubaba_' + new Date().toISOString().slice(0,10) + '.pdf';
                doc.save(filename);
                alert('PDF berhasil diekspor!\nNama file: ' + filename);
            } catch (error) {
                console.error('Error export PDF:', error);
                alert('Gagal export PDF. Error: ' + error.message);
            }
        }

        // Panggil saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            updateDataCount();
            // Tambahkan inisialisasi lain jika perlu
        });
    </script>
</body>
</html>
