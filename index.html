<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Buku Tamu Digital - Inspektorat Daerah Tubaba</title>
    <style>

        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; background: #0a0e27; }
        body { font-family: 'Arial', sans-serif; min-height: 100vh; }

        /* ========================================
           BINGKAI DEKORATIF EMAS - FRAME OVERLAY
           ======================================== */

        /* Layer 1 ‚Äì border emas utama (fixed, selalu di atas semua konten) */
        body::before {
            content: '';
            position: fixed;
            inset: 0;                        /* top/right/bottom/left: 0 */
            border: 10px solid transparent;
            border-image: linear-gradient(135deg,
                #f5e07a 0%,
                #d4a820 20%,
                #a07810 40%,
                #f5e07a 55%,
                #d4a820 70%,
                #c8960e 85%,
                #f5e07a 100%
            ) 1;
            box-shadow:
                inset 0 0 18px 4px rgba(212, 168, 32, 0.55),   /* glow inset emas hangat */
                inset 0 0 6px 1px rgba(0, 0, 0, 0.55),          /* bayangan dalam gelap */
                0 0 22px 6px rgba(212, 168, 32, 0.30);           /* glow luar halus */
            pointer-events: none;
            z-index: 99999;
        }

        /* Layer 2 ‚Äì garis dalam halus (lapis kedua, efek bingkai ganda) */
        body::after {
            content: '';
            position: fixed;
            inset: 16px;                     /* sedikit masuk dari tepi */
            border: 1.5px solid rgba(212, 168, 32, 0.40);
            box-shadow:
                inset 0 0 10px 2px rgba(212, 168, 32, 0.15),
                0 0 8px 2px rgba(212, 168, 32, 0.12);
            pointer-events: none;
            z-index: 99998;
            border-radius: 2px;
        }

        /* ‚îÄ‚îÄ Ornamen sudut dekoratif ‚îÄ‚îÄ */
        .corner-ornament {
            position: fixed;
            width: 48px;
            height: 48px;
            z-index: 99999;
            pointer-events: none;
        }
        .corner-ornament::before,
        .corner-ornament::after {
            content: '';
            position: absolute;
            background: linear-gradient(135deg, #f5e07a, #d4a820, #a07810);
        }
        /* garis horizontal ornamen sudut */
        .corner-ornament::before {
            width: 28px;
            height: 2.5px;
            top: 10px;
        }
        /* garis vertikal ornamen sudut */
        .corner-ornament::after {
            width: 2.5px;
            height: 28px;
            left: 10px;
        }
        /* posisi masing-masing sudut */
        .corner-ornament.tl { top: 10px;  left: 10px;  }
        .corner-ornament.tr { top: 10px;  right: 10px; transform: scaleX(-1); }
        .corner-ornament.bl { bottom: 10px; left: 10px;  transform: scaleY(-1); }
        .corner-ornament.br { bottom: 10px; right: 10px; transform: scale(-1,-1); }

        /* titik permata di sudut */
        .corner-ornament .gem {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 9px;
            height: 9px;
            background: radial-gradient(circle at 35% 35%, #fff7a0, #d4a820, #7a5800);
            border-radius: 50%;
            box-shadow: 0 0 6px 2px rgba(212,168,32,0.7);
        }
        
        /* Welcome Page Styles */
        #welcomePage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2a2f4a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 26px;        /* ruang aman agar konten tidak tertutup bingkai */
        }
        
        #particleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .welcome-content {
            position: relative;
            z-index: 2;
            text-align: center;
            padding: 20px;
        }
        
        .welcome-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px rgba(102, 126, 234, 0.8),
                         0 0 40px rgba(118, 75, 162, 0.6);
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(102, 126, 234, 0.8), 0 0 40px rgba(118, 75, 162, 0.6); }
            to { text-shadow: 0 0 30px rgba(102, 126, 234, 1), 0 0 60px rgba(118, 75, 162, 0.8); }
        }
        
        .welcome-subtitle {
            font-size: 1,6em;
font-weight: bold;

            color: #fff;
            margin-bottom: 40px;
            animation: fadeIn 1.5s ease-in;
        }
        
        .welcome-subtitle strong {
            font-size: 1.8em;
            display: block;
            margin-top: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn-start {
            padding: 15px 50px;
            font-size: 1.4em;
            font-weight: bold;
            background: linear-gradient(135deg, #0d1f45 0%, #1a3a6e 60%, #0d1f45 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .btn-start:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        /* ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
           ‚ïë   DESAIN HALAMAN UTAMA - GAYA INSTANSI PEMERINTAH    ‚ïë
           ‚ïë   Konsep: "Dokumen Resmi Melayang"                   ‚ïë
           ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù */

        /* ‚îÄ‚îÄ 1. Body saat mainApp aktif: Ruang kantor biru tua ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        body.app-aktif {
            background:
                linear-gradient(160deg,
                    #0a1628 0%,
                    #0d1f45 35%,
                    #0f2548 65%,
                    #0a1a38 100%
                ) fixed;
            background-attachment: fixed;
        }

        /* Motif tapis Lampung di seluruh halaman (opacity sangat tipis) */
        body.app-aktif::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            opacity: 0.045;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cdefs%3E%3Cpattern id='tp' x='0' y='0' width='200' height='200' patternUnits='userSpaceOnUse'%3E%3Crect width='200' height='200' fill='none'/%3E%3Cpath d='M100 4 L196 100 L100 196 L4 100 Z' fill='none' stroke='%23d4a820' stroke-width='2.5'/%3E%3Cpath d='M100 28 L172 100 L100 172 L28 100 Z' fill='none' stroke='%23f5e07a' stroke-width='1.5'/%3E%3Cpath d='M100 52 L148 100 L100 148 L52 100 Z' fill='none' stroke='%23d4a820' stroke-width='1'/%3E%3Cpolygon points='0,0 28,0 0,28' fill='%23d4a820'/%3E%3Cpolygon points='0,0 17,0 0,17' fill='%23f5e07a'/%3E%3Cpolygon points='200,0 172,0 200,28' fill='%23d4a820'/%3E%3Cpolygon points='200,0 183,0 200,17' fill='%23f5e07a'/%3E%3Cpolygon points='0,200 28,200 0,172' fill='%23d4a820'/%3E%3Cpolygon points='0,200 17,200 0,183' fill='%23f5e07a'/%3E%3Cpolygon points='200,200 172,200 200,172' fill='%23d4a820'/%3E%3Cpolygon points='200,200 183,200 200,183' fill='%23f5e07a'/%3E%3Cg transform='translate(100,100)'%3E%3Cpolygon points='0,-24 5,-5 24,0 5,5 0,24 -5,5 -24,0 -5,-5' fill='%23d4a820'/%3E%3Cpolygon points='0,-15 3.5,-3.5 15,0 3.5,3.5 0,15 -3.5,3.5 -15,0 -3.5,-3.5' fill='%23f5e07a'/%3E%3Ccircle cx='0' cy='0' r='6' fill='%23d4a820'/%3E%3Ccircle cx='0' cy='0' r='3' fill='%23f5e07a'/%3E%3C/g%3E%3Cg transform='translate(100,0)'%3E%3Cpolygon points='0,-8 2,-2 8,0 2,2 0,8 -2,2 -8,0 -2,-2' fill='%23d4a820'/%3E%3C/g%3E%3Cg transform='translate(100,200)'%3E%3Cpolygon points='0,-8 2,-2 8,0 2,2 0,8 -2,2 -8,0 -2,-2' fill='%23d4a820'/%3E%3C/g%3E%3Cg transform='translate(0,100)'%3E%3Cpolygon points='0,-8 2,-2 8,0 2,2 0,8 -2,2 -8,0 -2,-2' fill='%23d4a820'/%3E%3C/g%3E%3Cg transform='translate(200,100)'%3E%3Cpolygon points='0,-8 2,-2 8,0 2,2 0,8 -2,2 -8,0 -2,-2' fill='%23d4a820'/%3E%3C/g%3E%3C/pattern%3E%3C/defs%3E%3Crect width='200' height='200' fill='url(%23tp)'/%3E%3C/svg%3E");
            background-size: 200px 200px;
            background-repeat: repeat;
        }

        /* ‚îÄ‚îÄ 2. mainApp: Kartu dokumen resmi melayang ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #mainApp {
            display: none;
            position: relative;
            z-index: 2;
            max-width: 720px;
            margin: 20px auto;
            padding: 0;                       /* padding dikelola per-section */
            border-radius: 12px 12px 8px 8px;
            background: #f7f3eb;              /* perkamen krem hangat */
            box-shadow:
                0 2px 4px rgba(0,0,0,0.08),
                0 8px 24px rgba(0,0,0,0.22),
                0 20px 60px rgba(0,0,0,0.30),
                0 0 0 1px rgba(212,168,32,0.28);
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ 3. Banner kop surat di puncak mainApp ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #mainApp::before {
            content: '';
            display: block;
            height: 6px;
            background: linear-gradient(90deg,
                #a07810 0%, #d4a820 25%, #f5e07a 50%, #d4a820 75%, #a07810 100%
            );
            position: relative;
            z-index: 3;
        }

        /* Motif halus di dalam kartu mainApp */
        #mainApp::after {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 0;
            opacity: 0.028;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cdefs%3E%3Cpattern id='in' x='0' y='0' width='120' height='120' patternUnits='userSpaceOnUse'%3E%3Cpath d='M60 5 L115 60 L60 115 L5 60 Z' fill='none' stroke='%23a07810' stroke-width='1.8'/%3E%3Cpath d='M60 24 L96 60 L60 96 L24 60 Z' fill='none' stroke='%23d4a820' stroke-width='1'/%3E%3Cg transform='translate(60,60)'%3E%3Cpolygon points='0,-14 3,-3 14,0 3,3 0,14 -3,3 -14,0 -3,-3' fill='%23a07810'/%3E%3Ccircle cx='0' cy='0' r='4' fill='%23d4a820'/%3E%3C/g%3E%3Cpolygon points='0,0 16,0 0,16' fill='%23a07810'/%3E%3Cpolygon points='120,0 104,0 120,16' fill='%23a07810'/%3E%3Cpolygon points='0,120 16,120 0,104' fill='%23a07810'/%3E%3Cpolygon points='120,120 104,120 120,104' fill='%23a07810'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='120' height='120' fill='url(%23in)'/%3E%3C/svg%3E");
            background-size: 120px 120px;
        }

        /* Semua konten di dalam mainApp di atas pseudo-element */
        #mainApp > * { position: relative; z-index: 1; }

        /* ‚îÄ‚îÄ 4. Area header foto & judul ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .header-gambar {
            padding: 24px 20px 0 20px !important;
        }

        /* ‚îÄ‚îÄ 5. Label form: aksen garis kiri emas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #mainApp label {
            display: block;
            padding-left: 10px;
            border-left: 3px solid #d4a820;
            color: #1a1a2e;
            font-size: 0.88em;
            letter-spacing: 0.03em;
            margin-top: 14px;
        }

        /* ‚îÄ‚îÄ 6. Input/select/textarea: bersih & profesional ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #mainApp select,
        #mainApp input:not([type='file']),
        #mainApp textarea {
            background-color: #ffffff !important;
            border: 1.5px solid #d0c8b8 !important;
            border-radius: 6px !important;
            color: #1a1a2e !important;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 0.95em;
        }

        #mainApp select:focus,
        #mainApp input:focus,
        #mainApp textarea:focus {
            outline: none !important;
            border-color: #d4a820 !important;
            box-shadow: 0 0 0 3px rgba(212,168,32,0.15) !important;
        }

        /* ‚îÄ‚îÄ 7. formSection & dataSection padding ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #formSection,
        #dataSection {
            padding: 16px 20px 28px 20px;
        }

        /* ‚îÄ‚îÄ 8. Navigasi tombol ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #mainNavigation {
            margin: 0 !important;
            padding: 14px 20px;
            background: linear-gradient(180deg, #f0ead8 0%, #e8dfc8 100%);
            border-top: 1px solid rgba(212,168,32,0.30);
            border-bottom: 1px solid rgba(212,168,32,0.20);
            text-align: center;
            display: none;
        }

        #mainNavigation button {
            background: linear-gradient(135deg, #0d1f45 0%, #1a3560 100%) !important;
            color: #f5e07a !important;
            padding: 10px 20px !important;
            border: 1px solid rgba(212,168,32,0.50) !important;
            border-radius: 6px !important;
            margin: 5px 4px !important;
            cursor: pointer !important;
            font-size: 0.92em !important;
            font-weight: bold !important;
            letter-spacing: 0.02em;
            box-shadow: 0 2px 6px rgba(0,0,0,0.18);
            transition: all 0.2s;
        }

        #mainNavigation button:hover {
            background: linear-gradient(135deg, #d4a820 0%, #f5e07a 100%) !important;
            color: #0d1f45 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212,168,32,0.35);
        }

        /* ‚îÄ‚îÄ 9. Judul tengah "BUKU TAMU INSPEKTORAT..." ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #mainApp .app-judul-utama {
            background: linear-gradient(135deg, #0d1f45 0%, #1a3a6e 60%, #0d1f45 100%);
            color: #f5e07a;
            text-align: center;
            padding: 18px 20px 16px;
            letter-spacing: 0.06em;
            font-weight: bold;
            font-size: 1em;
            line-height: 1.6;
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, transparent, #d4a820, #f5e07a, #d4a820, transparent) 1;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        /* ‚îÄ‚îÄ 10. Tombol submit & action buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #mainApp button[type="button"][onclick*="simpan"],
        #mainApp button[type="submit"],
        #mainApp #btnSimpan {
            background: linear-gradient(135deg, #0d1f45, #1a3560) !important;
            color: #f5e07a !important;
            border: 1px solid rgba(212,168,32,0.6) !important;
        }

        /* ‚îÄ‚îÄ 11. Warning & info boxes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #mainApp .warning {
            background: linear-gradient(135deg, #fffbf0, #fff8e8);
            border: 1px solid rgba(212,168,32,0.50);
            border-left: 4px solid #d4a820;
            border-radius: 6px;
        }

        /* ‚îÄ‚îÄ 12. Data section title ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #dataSection h2 {
            color: #0d1f45;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, #d4a820, transparent) 1;
            padding-bottom: 8px;
            margin-bottom: 16px;
            font-size: 1.1em;
            letter-spacing: 0.04em;
        }
        
        .header-gambar { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: nowrap; padding: 24px 20px 0 20px; }
        .foto-kepala { width: 90px; height: auto; }
        .logo { width: 110px; height: auto; }
        
        label { font-weight: bold; }
        select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .hidden { display: none !important; }
        .required { color: red; }
        .error { border: 2px solid red !important; }
        .success { border: 2px solid #28a745n !important; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; margin: 12px 0; border-radius: 6px; font-size: 0.95em; }        
       #mainNavigation { margin: 25px 0; text-align: center; display: none; }
        #mainNavigation button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            margin: 8px 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }
        
        #photoModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 15px;
        }

        #signature-pad { 
            background: white; 
            border: 3px solid #007bff;
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            display: block !important;          /* paksa tampil */
            margin: 10px auto;                  /* center sedikit */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 300px;                   /* minimal lebar biar tidak hilang */
            width: 100% !important;             /* ambil lebar parent penuh */
            max-width: 600px;
            height: 200px !important;           /* paksa tinggi */
        }
        
        .detail-container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            border: 1px solid rgba(212,168,32,0.25);
            box-shadow: 0 2px 10px rgba(13,31,69,0.10), 0 0 0 1px rgba(212,168,32,0.10);
            border-radius: 8px;
            overflow: hidden;
        }
        .detail-header {
            background: linear-gradient(135deg, #0d1f45 0%, #1a3a6e 60%, #0d1f45 100%);
            color: white;
            padding: 18px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
flex-wrap: wrap;
            gap: 12px;
        }
        .detail-row {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            min-height: 50px;
        }
        .detail-label {
            width: 200px;
            padding: 15px 24px;
            background-color: #fdf2dc;
            border-right: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 0.95em;
            color: #495057;
            display: flex;
            align-items: center;
        }
        .detail-value {
            flex: 1;
            padding: 16px 24px;
            font-size: 14px;
            color: #212529;
            display: flex;
            align-items: center;
flex-wrap: wrap;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .welcome-title { font-size: 1.9em; }
            .detail-row { flex-direction: column; }
            .detail-label { width: 100%; border-right: none; border-bottom: 1px solid #e0e0e0; }
none; border-bottom: 1px solid #e0e0e0; }
            .header-gambar { gap: 15px; }        
}
        </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Logo 3D Canvas */
        #logoCanvas3D {
            position: relative;
            display: block;
            width: 300px;
            height: 300px;
            margin: 0 auto 20px auto;
            opacity: 0;
            border-radius: 8px;
            /* background hitam dinonaktifkan agar gradient welcomePage tetap terlihat */
        }
    </style>
</head>

<body>
<!-- Ornamen sudut bingkai emas -->
<div class="corner-ornament tl" aria-hidden="true"><div class="gem"></div></div>
<div class="corner-ornament tr" aria-hidden="true"><div class="gem"></div></div>
<div class="corner-ornament bl" aria-hidden="true"><div class="gem"></div></div>
<div class="corner-ornament br" aria-hidden="true"><div class="gem"></div></div>
<!-- Welcome Page -->
<div id="welcomePage">
    <canvas id="particleCanvas"></canvas>
    <div class="welcome-content">
        <canvas id="logoCanvas3D"></canvas>
        <h1 class="welcome-title">SELAMAT DATANG</h1>
        <p class="welcome-subtitle">DI <strong>INSPEKTORAT DAERAH</strong><br/>KABUPATEN TULANG BAWANG BARAT</p>
        <button class="btn-start" onclick="startApp()">üìù ISI BUKU TAMU</button>
    </div>
</div>

<!-- Main Application -->
<div id="mainApp">
    <div class="header-gambar">
        <img src="bupati.png" alt="Wakil Bupati" class="foto-kepala" onerror="this.style.display='none'">
        <img src="logo-tubaba.png" alt="Logo Tubaba" class="logo" onerror="this.style.display='none'">
        <img src="wakil-bupati.png" alt="Bupati" class="foto-kepala" onerror="this.style.display='none'">
    </div>

    <div class="app-judul-utama">
        <div style="font-size:0.85em; opacity:0.80; letter-spacing:0.12em;">‚ú¶ BUKU TAMU DIGITAL ‚ú¶</div>
        <div style="font-size:1.05em; margin: 4px 0;">INSPEKTORAT DAERAH</div>
        <div style="font-size:0.9em; opacity:0.88;">KABUPATEN TULANG BAWANG BARAT</div>
    </div>

    <div id="formSection">
        <form id="bukuTamuForm">
            <div id="field-nama">
                <label>Nama: <span class="required">*</span></label>
                <input id="nama" required type="text" placeholder="Isi Minimal 5 Huruf" oninput="validateNama();"/>
            </div>

            <div id="field-asal" class="hidden">
                <label>INSTANSI/ASAL: <span class="required">*</span></label>
                <select id="asal" required onchange="asalChanged();">
                    <option value="">-- Pilih Asal --</option>
                    <option value="INSTANSI">INSTANSI/UNIT KERJA</option>
                    <option value="MASYARAKAT">MASYARAKAT</option>
                </select>
            </div>

            <div class="hidden" id="daftarInstansi">
                <label>DAFTAR INSTANSI/UNIT KERJA: <span class="required">*</span></label>
                <select id="instansi" onchange="checkAndShowNext('instansi', 'field-pihakDitemui');">
                    <option value="">-- Pilih Instansi --</option>
                    <option>SEKRETARIAT DAERAH</option>
                    <option>SEKRETARIAT DPRD</option>
                    <option>BADAN PERENCANAAN PEMBANGUNAN DAERAH</option>
                    <option>BADAN PENGELOLAAN KEUANGAN DAN ASET DAERAH</option>
                    <option>BADAN PENGELOLAAN PAJAK DAN RETRIBUSI DAERAH</option>
                    <option>BADAN KEPEGAWAIAN DAN PENGEMBANGAN SUMBER DAYA MANUSIA</option>
                    <option>BADAN KESATUAN BANGSA DAN POLITIK DAERAH</option>
                    <option>BADAN PENANGGULANGAN BENCANA DAERAH</option>
                    <option>DINAS LINGKUNGAN HIDUP</option>
                    <option>DINAS KESEHATAN</option>
                    <option>DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                    <option>DINAS KOPERASI, UMKM, PERINDUSTRIAN DAN PERDAGANGAN</option>
                    <option>DINAS SOSIAL</option>
                    <option>DINAS PEMUDA, OLAHRAGA DAN PARIWISATA</option>
                    <option>DINAS KOMUNIKASI DAN INFORMATIKA</option>
                    <option>DINAS PERUMAHAN, KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                    <option>DINAS PENANAMAN MODAL DAN PELAYANAN PERIZINAN TERPADU SATU PINTU</option>
                    <option>DINAS PENDIDIKAN DAN KEBUDAYAAN</option>
                    <option>DINAS KETAHANAN PANGAN</option>
                    <option>DINAS PEMBERDAYAAN MASYARAKAT DAN TIYUH</option>
                    <option>DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                    <option>DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                    <option>DINAS PERHUBUNGAN</option>
                    <option>DINAS PERTANIAN</option>
                    <option>DINAS PETERNAKAN DAN KESEHATAN HEWAN</option>
                    <option>DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                    <option>DINAS TENAGA KERJA DAN TRANSMIGRASI</option>
                    <option>DINAS PERIKANAN</option>
                    <option>DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                    <option>DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</option>
                    <option>SATUAN POLISI PAMONG PRAJA</option>
                    <option>BADAN PENGAWASAN KEUANGAN DAN PEMBANGUNAN (BPKP)</option>
                    <option>LAINNYA</option>
                </select>
            </div>

            <div class="hidden" id="daftarMasyarakat">
                <label>Kecamatan: <span class="required">*</span></label>
                <select id="kecamatan" onchange="updateDesaList();">
                    <option value="">-- Pilih Kecamatan --</option>
                    <option value="Tulang Bawang Tengah">1. Tulang Bawang Tengah</option>                    
                    <option value="Tulang Bawang Udik">2. Tulang Bawang Udik</option>
                    <option value="Tumijajar">3. Tumijajar</option>
                    <option value="Gunung Agung">4. Gunung Agung</option>
                    <option value="Way Kenanga">5. Way Kenanga</option>
                    <option value="Gunung Terang">6. Gunung Terang</option>
                    <option value="Lambu Kibang">7. Lambu Kibang</option>
                    <option value="Pagar Dewa">8. Pagar Dewa</option>
                    <option value="Batu Putih">9. Batu Putih</option>
                </select>
            </div>

            <div class="hidden" id="fieldDesa">
                <label>Desa/Kelurahan: <span class="required">*</span></label>
                <select id="desa" onchange="checkAndShowNext('desa', 'field-pihakDitemui');"></select>
            </div>

            <div id="field-pihakDitemui" class="hidden">
                <label>PIHAK YANG DITEMUI: <span class="required">*</span></label>
                <select id="pihakDitemui" required onchange="checkAndShowNext('pihakDitemui', 'field-jenisLayanan');">
                    <option value="">-- Pilih Pihak yang Ditemui --</option>
                    <option>INSPEKTUR</option>
                    <option>SEKRETARIS</option>
                    <option>IRBANSUS</option>
                    <option>IRBAN 1</option>
                    <option>IRBAN 2</option>
                    <option>IRBAN 3</option>
                    <option>IRBAN 4</option>
                </select>
            </div>

            <div id="field-jenisLayanan" class="hidden">
                <label>JENIS LAYANAN: <span class="required">*</span></label>
                <select id="jenisLayanan" required onchange="checkAndShowNext('jenisLayanan', 'field-uraian');">
                    <option value="">-- Pilih Jenis Layanan --</option>
                    <option>Permintaan Audit/Klarifikasi Khusus</option>
                    <option>Penanganan Pengaduan</option>
                    <option>Layanan Informasi Publik</option>
                    <option>Pembinaan & Konsultasi</option>
                    <option>Audit</option>
                    <option>Review</option>
                    <option>Evaluasi / Monitoring</option>
                    <option>Tindak Lanjut Temuan</option>
                </select>
            </div>

            <div id="field-uraian" class="hidden">
                <label>URAIAN: <span class="required">*</span></label>
                <textarea id="uraian" required rows="3" 
                    oninput="validateUraian(); autoResize(this);"></textarea>
            </div>

            <div id="field-nomorHp" class="hidden">
                <label>Nomor WhatsApp: <span class="required">*</span></label>
                <small style="color:#555; display:block; margin-bottom:4px;">
                    Harus diawali dengan <strong>08</strong> (contoh: 081234567890)
                </small>
                <input 
                    id="nomorHp" 
                    required 
                    type="tel" 
                    placeholder="08xxxxxxxxxx" 
                    pattern="08[0-9]{9,11}" 
                    maxlength="13" 
                    minlength="11"
                    oninput="validateNomorHp(this); checkAndShowNext('nomorHp', 'field-tandaTangan');"
                />
                <small id="nomorHpInfo" style="color:#dc3545; display:block; min-height:1.2em;"></small>
            </div>

            <!-- Tanda Tangan -->
            <div id="field-tandaTangan" class="hidden">
                <label>Tanda Tangan: <span class="required">*</span></label>
                <div class="warning" id="signatureWarning" style="display:none;">‚ö†Ô∏è Tanda tangan terlalu pendek (min 2 cm)</div>
                <canvas id="signature-pad" width="900" height="25"></canvas>
            </div>

            <!-- Tombol Aksi (Ambil Foto + Hapus Tanda Tangan) -->
            <div id="field-aksi" class="hidden" style="margin-top: 1px; text-align: center;">
                <div style="margin-bottom: 15px;">
                    <button type="button" onclick="bukaKamera()" 
                            style="font-size: 16px; background: #ffc107; color: black; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 0 10px;">
                        üì∏ Ambil Foto
                    </button>
                    
                    <button type="button" onclick="clearSignature()" 
                            style="font-size: 16px; background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 0 1px;">
                        üóëÔ∏è Hapus Tanda Tangan
                    </button>
                </div>

                <!-- Warning foto -->
                <div class="warning" id="photoWarning" style="display:none; margin: 10px 0;">‚ö†Ô∏è Foto wajib diambil!</div>

                <!-- Preview foto (tanpa label Depan/Belakang) -->
               <!-- Preview foto (tanpa label Depan/Belakang) -->
<div id="photoPreview" style="margin-top: 20px; margin-bottom: 40px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
    <div style="text-align:center;">
        <img id="imgFront" style="max-width:220px; border:1px solid #ccc; border-radius:8px; display:none;" alt="Foto Depan">
    </div>
    <div style="text-align:center;">
        <img id="imgBack" style="max-width:220px; border:1px solid #ccc; border-radius:8px; display:none;" alt="Foto Belakang">
    </div>
</div>
            </div>
        </form>
    </div>

    <div id="editModeButtons" style="margin-bottom: 80px; text-align: center; display: none;">
        <button type="button" onclick="saveEditedData()" 
                style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 5px; margin: 0 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
            üíæ Simpan Perubahan
        </button>
        <button type="button" onclick="cancelEdit()" 
                style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 5px; margin: 0 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ‚ùå Batal
        </button>
    </div>

    <div id="mainNavigation">
        <button onclick="showForm()" id="btnForm">üìù Form Input</button>
        <button onclick="showData()" id="btnData">üìä Lihat Data (<span id="dataCount">0</span>)</button>
        <button onclick="exportData()" id="btnExport">üìë Export Tabel Ringkasan</button>
    </div>

    <div id="dataSection" style="display: none;">
        <h2>üìä DATA BUKU TAMU</h2>
        <div style="margin-bottom: 20px;">
        </div>
        <div id="dataContainer"></div>
    </div>

    <!-- MODAL KAMERA -->
    <div id="photoModal">
        <div style="background:#fff; padding:20px; border-radius:12px; max-width:95%; width:100%; max-height:95vh; overflow-y:auto; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.4);">
            <h3 style="margin:0 0 15px; color:#333;">Ambil Dokumentasi Foto</h3>
            
            <div id="infoKamera" style="font-size:1.1em; font-weight:bold; margin-bottom:15px; color:#007bff;">
                Ambil foto pertama
            </div>

            <video id="video" autoplay playsinline muted style="width:100%; max-width:420px; background:#000; border-radius:8px; margin-bottom:20px;"></video>

            <div style="margin:20px 0;">
                <button type="button" class="btn-capture" onclick="capture()" 
                        style="background:#28a745; color:white; border:none; padding:14px 32px; font-size:1.2em; border-radius:50px; cursor:pointer; margin:0 10px; box-shadow:0 4px 12px rgba(40,167,69,0.4);">
                    üì∏ Ambil Foto
                </button>
                <button type="button" class="btn-cancel" onclick="stopAll()" 
                        style="background:#dc3545; color:white; border:none; padding:14px 32px; font-size:1.2em; border-radius:50px; cursor:pointer; margin:0 10px;">
                    ‚ùå Batal
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== LOGO 3D (Three.js) - Animasi Logo Tulang Bawang Barat =====
(function() {
    const LOGO_IMG_URL = "https://upload.wikimedia.org/wikipedia/commons/6/6b/Lambang_Kabupaten_Tulang_Bawang_Barat.png";

    const logoImgEl = new Image();
    logoImgEl.crossOrigin = "anonymous";
    logoImgEl.src = LOGO_IMG_URL;

    logoImgEl.onload = function() {
        const oc = document.createElement("canvas"), ot = oc.getContext("2d");
        const MAXW = Math.min(300, 300);
        const SC = Math.min(1, MAXW / logoImgEl.width);
        oc.width = Math.round(logoImgEl.width * SC);
        oc.height = Math.round(logoImgEl.height * SC);
        ot.drawImage(logoImgEl, 0, 0, oc.width, oc.height);
        const px = ot.getImageData(0, 0, oc.width, oc.height);

        const LP = [], RP = [];
        for (let y = 0; y < oc.height; y++) {
            let lx = -1, rx = -1;
            for (let x = 0; x < oc.width; x++) if (px.data[(y * oc.width + x) * 4 + 3] > 20) { lx = x; break; }
            for (let x = oc.width - 1; x >= 0; x--) if (px.data[(y * oc.width + x) * 4 + 3] > 20) { rx = x; break; }
            if (lx >= 0 && rx >= 0) {
                const W3 = 2.0, H3 = 2.0 * (oc.height / oc.width), ny = y / oc.height;
                LP.push([-W3 / 2 + (lx / oc.width) * W3, H3 / 2 - ny * H3]);
                RP.push([-W3 / 2 + (rx / oc.width) * W3, H3 / 2 - ny * H3]);
            }
        }
        launchLogo3D({ LP, RP });
    };

    logoImgEl.onerror = function() { console.warn("Logo 3D: Gagal memuat gambar logo."); };

    function launchLogo3D({ LP, RP }) {
        const c3 = document.getElementById("logoCanvas3D");
        if (!c3) return;

        const logoR = new THREE.WebGLRenderer({ canvas: c3, antialias: true, alpha: true });
        logoR.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        logoR.setSize(300, 300);
        logoR.setClearColor(0x000000, 0); // transparan agar background gradient terlihat

        const logoScene = new THREE.Scene();
        const logoCam = new THREE.PerspectiveCamera(38, 1, 0.1, 200);
        logoCam.position.set(0, 0.3, 7.2);
        logoCam.lookAt(0, 0, 0);

        logoScene.add(new THREE.AmbientLight(0xffffff, 1.0));
        const kl = new THREE.DirectionalLight(0xfffaf0, 0.9); kl.position.set(3, 5, 8); logoScene.add(kl);
        const kl2 = new THREE.DirectionalLight(0xfff8f0, 0.9); kl2.position.set(-3, -5, -8); logoScene.add(kl2);
        const fl = new THREE.DirectionalLight(0xe0eeff, 0.7); fl.position.set(-5, -2, 4); logoScene.add(fl);
        const fl2 = new THREE.DirectionalLight(0xffe0d0, 0.7); fl2.position.set(5, 2, -4); logoScene.add(fl2);
        const r1 = new THREE.PointLight(0xffcc44, 1.2, 25); r1.position.set(-5, 2, -6); logoScene.add(r1);
        const r2 = new THREE.PointLight(0x44aaff, 0.8, 20); r2.position.set(5, -1, -5); logoScene.add(r2);
        const logoMV = new THREE.PointLight(0xffe080, 1.2, 22); logoScene.add(logoMV);

        function buildLogoShape() {
            const T = 100, st = Math.max(1, Math.floor(LP.length / T));
            const sL = [], sR = [];
            for (let i = 0; i < LP.length; i += st) { sL.push(LP[i]); sR.push(RP[i]); }
            sL.push(LP[LP.length - 1]); sR.push(RP[RP.length - 1]);
            const sh = new THREE.Shape();
            sh.moveTo(sL[0][0], sL[0][1]);
            for (let i = 0; i < sR.length; i++) sh.lineTo(sR[i][0], sR[i][1]);
            for (let i = sL.length - 1; i >= 0; i--) sh.lineTo(sL[i][0], sL[i][1]);
            sh.closePath();
            return sh;
        }

        function uvGeoLogo(sh, seg) {
            const g = new THREE.ShapeGeometry(sh, seg);
            g.computeBoundingBox();
            const bb = g.boundingBox, sx = bb.max.x - bb.min.x, sy = bb.max.y - bb.min.y;
            const pos = g.attributes.position, uv = new Float32Array(pos.count * 2);
            for (let i = 0; i < pos.count; i++) {
                uv[i * 2] = (pos.getX(i) - bb.min.x) / sx;
                uv[i * 2 + 1] = (pos.getY(i) - bb.min.y) / sy;
            }
            g.setAttribute('uv', new THREE.BufferAttribute(uv, 2));
            return g;
        }

        const logoTL = new THREE.TextureLoader();
        logoTL.crossOrigin = "anonymous";
        logoTL.load(LOGO_IMG_URL, function(tex) {
            tex.anisotropy = logoR.capabilities.getMaxAnisotropy();
            tex.minFilter = THREE.LinearMipmapLinearFilter;
            tex.magFilter = THREE.LinearFilter;

            const shape = buildLogoShape();
            const faceM = new THREE.MeshBasicMaterial({ map: tex });
            const edgeM = new THREE.MeshStandardMaterial({ color: 0xd4a820, roughness: 0.13, metalness: 0.96 });
            const edgD = new THREE.MeshStandardMaterial({ color: 0xa07810, roughness: 0.08, metalness: 0.98 });
            const inv = new THREE.MeshBasicMaterial({ transparent: true, opacity: 0, depthWrite: false, colorWrite: false });

            const D = 0.38, HD = D / 2;
            const logoGrp = new THREE.Group();
            logoScene.add(logoGrp);

            const eg = new THREE.ExtrudeGeometry(shape, {
                depth: D, bevelEnabled: true, bevelThickness: 0.045, bevelSize: 0.045,
                bevelSegments: 16, curveSegments: 128
            });
            eg.translate(0, 0, -HD);
            logoGrp.add(new THREE.Mesh(eg, [inv, inv, edgeM]));

            const fg = uvGeoLogo(shape, 128);
            const fm = new THREE.Mesh(fg, faceM); fm.position.z = HD + 0.002; logoGrp.add(fm);

            const bg2 = uvGeoLogo(shape, 128);
            const pb = bg2.attributes.position, ub = bg2.attributes.uv;
            for (let i = 0; i < pb.count; i++) { pb.setX(i, -pb.getX(i)); ub.setX(i, 1 - ub.getX(i)); }
            pb.needsUpdate = true; ub.needsUpdate = true; bg2.computeVertexNormals();
            const bm = new THREE.Mesh(bg2, faceM); bm.position.z = -(HD + 0.002); logoGrp.add(bm);

            const sp = shape.getPoints(120);
            const ro = new THREE.Shape(sp.map(p => new THREE.Vector2(p.x * 1.045, p.y * 1.045)));
            ro.holes.push(new THREE.Path(sp));
            const rg = new THREE.ExtrudeGeometry(ro, {
                depth: D * 0.70, bevelEnabled: true, bevelThickness: 0.022,
                bevelSize: 0.022, bevelSegments: 10, curveSegments: 128
            });
            rg.translate(0, 0, -(HD * 0.70));
            logoGrp.add(new THREE.Mesh(rg, edgD));

            // Halo belakang (sprite glow)
            const hc = document.createElement("canvas"); hc.width = hc.height = 256;
            const ht = hc.getContext("2d");
            const hg = ht.createRadialGradient(128, 128, 5, 128, 128, 128);
            hg.addColorStop(0, "rgba(255,220,80,0.6)");
            hg.addColorStop(0.3, "rgba(255,160,30,0.3)");
            hg.addColorStop(0.6, "rgba(80,120,255,0.18)");
            hg.addColorStop(1, "rgba(0,0,0,0)");
            ht.fillStyle = hg; ht.fillRect(0, 0, 256, 256);
            const logoHS = new THREE.Sprite(new THREE.SpriteMaterial({
                map: new THREE.CanvasTexture(hc), transparent: true,
                blending: THREE.AdditiveBlending, depthWrite: false, opacity: 0.8
            }));
            logoHS.scale.set(7.2, 9.5, 1); logoHS.position.z = -0.5; logoGrp.add(logoHS);

            // Bintang latar
            const sv = new Float32Array(2000 * 3);
            for (let i = 0; i < sv.length; i++) sv[i] = (Math.random() - 0.5) * 150;
            const sgg = new THREE.BufferGeometry();
            sgg.setAttribute('position', new THREE.BufferAttribute(sv, 3));
            logoScene.add(new THREE.Points(sgg, new THREE.PointsMaterial({ color: 0xffffff, size: 0.055, sizeAttenuation: true })));

            // Fade in
            let fo = 0;
            const fi = setInterval(function() {
                fo += 0.04;
                c3.style.opacity = Math.min(fo, 1).toFixed(2);
                if (fo >= 1) clearInterval(fi);
            }, 16);

            logoGrp.rotation.x = 0.12;
            let logoAng = 0, logoLast = performance.now(), logoGT2 = 0;

            (function logoRender(now) {
                const dt = (now - logoLast) / 1000; logoLast = now;
                logoAng += dt * (Math.PI * 2 / 22);
                logoGT2 += dt;
                logoGrp.rotation.y = logoAng;
                logoGrp.rotation.x = 0.12 + Math.sin(logoAng * 0.35) * 0.08;
                logoHS.material.opacity = 0.55 + 0.25 * Math.sin(logoGT2 * 0.9);
                logoMV.position.set(Math.sin(-logoAng * 1.2) * 6, Math.cos(-logoAng * 0.6) * 2.5, Math.sin(logoAng * 0.4) * 2 - 2);
                logoR.render(logoScene, logoCam);
                requestAnimationFrame(logoRender);
            })(performance.now());
        });
    }
})();
</script>

<script>
const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const particles = [];
const particleCount = 150;

class Particle {
    constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.z = Math.random() * 1000;
        this.vx = (Math.random() - 0.5) * 0.5;
        this.vy = (Math.random() - 0.5) * 0.5;
        this.vz = Math.random() * 2 + 1;
        this.size = Math.random() * 2 + 1;
        this.hue = Math.random() * 60 + 220;
    }
    
    update() {
        this.z -= this.vz;
        if (this.z <= 0) {
            this.z = 1000;
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
        }
        
        const scale = 1000 / (1000 + this.z);
        this.screenX = (this.x - canvas.width / 2) * scale + canvas.width / 2;
        this.screenY = (this.y - canvas.height / 2) * scale + canvas.height / 2;
        this.screenSize = this.size * scale;
    }
    
    draw() {
        const opacity = (1000 - this.z) / 1000;
        ctx.fillStyle = `hsla(${this.hue}, 100%, 60%, ${opacity})`;
        ctx.beginPath();
        ctx.arc(this.screenX, this.screenY, this.screenSize, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.shadowBlur = 10;
        ctx.shadowColor = `hsla(${this.hue}, 100%, 60%, ${opacity})`;
    }
}

for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
}

function animateParticles() {
    ctx.fillStyle = 'rgba(10, 14, 39, 0.1)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    particles.forEach(particle => {
        particle.update();
        particle.draw();
    });
    
    requestAnimationFrame(animateParticles);
}

animateParticles();

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

function startApp() {
    document.getElementById('welcomePage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.body.classList.add('app-aktif');
}

function goToWelcome() {
    document.getElementById('welcomePage').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    document.body.classList.remove('app-aktif');
    document.body.style.background = '#0a0e27';
    
    document.getElementById('bukuTamuForm').reset();
    hideAllFields();
    document.getElementById('mainNavigation').style.display = 'none';
    document.getElementById('formSection').style.display = 'block';
    document.getElementById('dataSection').style.display = 'none';
}

// ===== GLOBAL VARIABLES =====
let dataBukuTamu = [];
let dataTamuSementara = []; // Data sementara: sudah foto belakang, belum dikonfirmasi ke ekspor
let signatureCanvas, ctx2, isDrawing = false, totalStrokeLength = 0;
let hasSignature = false, hasPhoto = false;
let fotoDataURLFront = null, fotoDataURLBack = null;
let stream = null;
let step = 1; // 1 = depan, 2 = belakang
let editingIndex = -1, originalEditData = null;
let isEditMode = false;
let editingSementara = false;   // true jika sedang edit data dari dataTamuSementara

const PIXELS_PER_CM = 37.7952755906;
const MIN_STROKE_LENGTH_CM = 2;

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    signatureCanvas = document.getElementById('signature-pad');
    ctx2 = signatureCanvas.getContext('2d');
    attachSignatureEvents();  // menggunakan fungsi baru yang lebih aman
    window.addEventListener('resize', resizeCanvas);
});

function attachSignatureEvents() {
    // Attach semua event listener (tidak remove dulu supaya aman saat pertama kali)
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    signatureCanvas.addEventListener('touchstart', handleTouch);
    signatureCanvas.addEventListener('touchmove', handleTouch);
    signatureCanvas.addEventListener('touchend', stopDrawing);
}

function resizeCanvas() {
    const field = document.getElementById('field-tandaTangan');
    if (!field || field.classList.contains('hidden')) return;

    // Tunggu sebentar agar elemen benar-benar visible
    setTimeout(() => {
        const container = signatureCanvas.parentElement;
        let newWidth = Math.min(container.offsetWidth || 600, 600);
        if (newWidth < 300) newWidth = 300;  // minimal biar tidak hilang

        // Simpan gambar lama sebelum resize
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = signatureCanvas.width;
        tempCanvas.height = signatureCanvas.height;
        tempCanvas.getContext('2d').drawImage(signatureCanvas, 0, 0);

        // Apply ukuran baru
        signatureCanvas.width = newWidth;
        signatureCanvas.height = 200;

        // Restore gambar + style drawing
        ctx2.drawImage(tempCanvas, 0, 0, newWidth, 200);
        ctx2.lineWidth = 2;
        ctx2.lineCap = 'round';
        ctx2.strokeStyle = '#00008B';

        // Re-attach events
        attachSignatureEvents();

        console.log("Canvas resized to:", newWidth, "x 200"); // debug
    }, 100); // delay kecil agar layout selesai
}
function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx2.beginPath();
    ctx2.moveTo(x, y);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx2.lineTo(x, y);
    ctx2.stroke();
    totalStrokeLength += 2;
    hasSignature = true;
}

function stopDrawing() {
    if (isDrawing) {
        isDrawing = false;

        // Hitung panjang coretan (tetap seperti sebelumnya)
        const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
        if (strokeLengthCm >= MIN_STROKE_LENGTH_CM) {
            document.getElementById('field-aksi').classList.remove('hidden');
            signatureCanvas.classList.remove('error');
            document.getElementById('signatureWarning').style.display = 'none';

            // ‚îÄ‚îÄ‚îÄ Recenter sekarang juga ‚îÄ‚îÄ‚îÄ
            signatureDataURL = recenterSignature();
            if (signatureDataURL) {
                // Optional: tampilkan preview yang sudah recenter di canvas asli
                const img = new Image();
                img.onload = () => {
                    ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                    ctx2.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                };
                img.src = signatureDataURL;
            }
        }
    }
}
function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    signatureCanvas.dispatchEvent(mouseEvent);
}

function clearSignature() {
    ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    hasSignature = false;
    totalStrokeLength = 0;
    document.getElementById('signatureWarning').style.display = 'none';
    document.getElementById('field-aksi').classList.add('hidden');
}

// ===== FORM VALIDATION & NAVIGATION =====
function validateNama() {
    if (isEditMode) return;

    const namaInput = document.getElementById('nama');
    const namaValue = namaInput.value.trim();
    
    let hurufCount = 0;
    try {
        hurufCount = (namaValue.match(/\p{L}/gu) || []).length;
    } catch (e) {
        hurufCount = (namaValue.match(/[A-Za-z]/g) || []).length;
    }
    
    if (hurufCount >= 5) {
        namaInput.classList.remove('error');
        namaInput.classList.add('success');
        document.getElementById('field-asal').classList.remove('hidden');
        
        if (namaValue.toUpperCase() === 'UNTUNG') {
            document.getElementById('mainNavigation').style.display = 'block';
        }
    } else {
        namaInput.classList.add('error');
        namaInput.classList.remove('success');
        hideFieldsAfter('field-asal');
    }
}

function validateNomorHp(input) {
    if (isEditMode) return; // tetap longgar saat edit

    let value = input.value.trim();
    
    // Hapus semua karakter non-angka kecuali awalan
    const onlyDigits = value.replace(/[^0-9]/g, '');
    
    // Paksa awalan 08 jika user mulai ketik
    if (onlyDigits.length > 0 && !onlyDigits.startsWith('08')) {
        if (onlyDigits.startsWith('8')) {
            input.value = '0' + onlyDigits; // tambah 0 di depan jika mulai dengan 8
        } else if (onlyDigits.startsWith('62')) {
            input.value = '0' + onlyDigits.substring(2); // ganti 62 ‚Üí 08
        } else {
            input.value = '08' + onlyDigits; // paksa awalan 08
        }
    } else {
        input.value = onlyDigits;
    }

    const cleaned = input.value.trim();
    const isValidFormat = cleaned.startsWith('08') && 
                         cleaned.length >= 11 && 
                         cleaned.length <= 13 && 
                         /^[0-9]+$/.test(cleaned);

    // Update visual feedback
    if (isValidFormat) {
        input.classList.remove('error');
        input.classList.add('success');
        document.getElementById('nomorHpInfo').textContent = '';
    } else {
        input.classList.remove('success');
        input.classList.add('error');
        
        let msg = '';
        if (cleaned.length === 0) {
            msg = '';
        } else if (!cleaned.startsWith('08')) {
            msg = 'Harus diawali dengan 08';
        } else if (cleaned.length < 11) {
            msg = `Minimal 11 digit (saat ini: ${cleaned.length})`;
        } else if (cleaned.length > 13) {
            msg = `Maksimal 13 digit (saat ini: ${cleaned.length})`;
        }
        document.getElementById('nomorHpInfo').textContent = msg;
    }

    // Jika valid ‚Üí lanjut ke field berikutnya
    if (isValidFormat) {
        document.getElementById('field-tandaTangan').classList.remove('hidden');
        resizeCanvas();
    } else {
        hideFieldsAfter('field-nomorHp');
    }
}

function asalChanged() {
   if (isEditMode) {
        const asal = document.getElementById('asal').value;
        const daftarInstansi = document.getElementById('daftarInstansi');
        const daftarMasyarakat = document.getElementById('daftarMasyarakat');
        const fieldDesa = document.getElementById('fieldDesa');   // ‚Üê TAMBAHKAN INI

        if (asal === 'INSTANSI') {
            daftarInstansi.classList.remove('hidden');
            daftarMasyarakat.classList.add('hidden');
            fieldDesa.classList.add('hidden');                    // ‚Üê INI YANG DIBUTUHKAN
        } 
        else if (asal === 'MASYARAKAT') {
            daftarMasyarakat.classList.remove('hidden');
            daftarInstansi.classList.add('hidden');
            fieldDesa.classList.remove('hidden');                 // opsional, biar konsisten
        } 
        else {
            daftarInstansi.classList.add('hidden');
            daftarMasyarakat.classList.add('hidden');
            fieldDesa.classList.add('hidden');
        }
        return;
    
    }

    const asal = document.getElementById('asal').value;
    const daftarInstansi = document.getElementById('daftarInstansi');
    const daftarMasyarakat = document.getElementById('daftarMasyarakat');
    
    if (asal === 'INSTANSI') {
        daftarInstansi.classList.remove('hidden');
        daftarMasyarakat.classList.add('hidden');
    } else if (asal === 'MASYARAKAT') {
        daftarMasyarakat.classList.remove('hidden');
        daftarInstansi.classList.add('hidden');
    } else {
        daftarInstansi.classList.add('hidden');
        daftarMasyarakat.classList.add('hidden');
    }
}

const dataDesa = {
    "Batu Putih": [
        "Marga Sari", "Margo Dadi", "Margo Mulya", "Mulyo Sari", "Panca Marga",
        "Sakti Jaya", "Sido Makmur", "Toto Katon", "Toto Makmur", "Toto Wonodadi"
    ],
    "Gunung Agung": [
        "Bangun Jaya", "Dwikora Jaya", "Jaya Murni", "Marga Jaya", "Mekar Jaya",
        "Mulya Jaya", "Mulya Sari", "Suka Jaya", "Sumber Jaya", "Sumber Rejeki",
        "Tri Tunggal Jaya", "Tunas Jaya", "Wono Rejo"
    ],
    "Gunung Terang": [
        "Gunung Agung", "Gunung Terang", "Kagungan Jaya", "Mulyo Jadi", "Setia Agung",
        "Setia Bumi", "Terang Bumi Agung", "Terang Makmur", "Terang Mulya", "Toto Mulyo"
    ],
    "Lambu Kibang": [
        "Gilang Tunggal Makarta", "Gunung Sari", "Kibang Budi Jaya", "Kibang Mulya Jaya",
        "Kibang Tri Jaya", "Kibang Yekti Jaya", "Lesung Bhakti Jaya", "Mekar Sari Jaya",
        "Pagar Jaya", "Sumber Rejo"
    ],
    "Pagar Dewa": [
        "Bujung Dewa", "Bujung Sari Marga", "Cahyou (Cahyou) Randu", "Marga Jaya Indah",
        "Pagar Dewa", "Pagar Dewa Suka Mulya"
    ],
    "Tulang Bawang Tengah": [
        "Bandar Dewa", "Candra Jaya", "Candra Kencana", "Candra Mukti", "Menggala Mas",
        "Mulya Jaya", "Mulya Kencana", "Mulyo Asri", "Panaragan", "Panaragan Jaya",
        "Panaragan Jaya Indah", "Panaragan Jaya Utama", "Penumangan", "Penumangan Baru",
        "Pulung Kencana", "Tirta Kencana", "Tirta Makmur", "Tunas Asri"
    ],
    "Tulang Bawang Udik": [
        "Gedung Ratu", "Gunung Katun Malai", "Gunung Katun Tanjungan", "Kagungan Ratu",
        "Karta", "Karta Raharja", "Karta Sari", "Marga Kencana", "Wai Sido"
    ],
    "Tumijajar": [
        "Daya Asri", "Daya Murni", "Daya Sakti", "Gunung Menanti", "Gunung Timbul",
        "Makarti", "Margo Dadi", "Margo Mulyo", "Murni Jaya", "Sumber Rejo"
    ],
    "Way Kenanga": [
        "Agung Jaya", "Balam Asri", "Balam Jaya", "Indraloka I", "Indraloka II",
        "Indraloka Jaya", "Indraloka Mukti", "Mercu Buana", "Pagar Buana"
    ]
};

function updateDesaList() {
    const kecamatan = document.getElementById('kecamatan').value;
    const desaSelect = document.getElementById('desa');
    const fieldDesa = document.getElementById('fieldDesa');
    
    desaSelect.innerHTML = '<option value="">-- Pilih Desa/Kelurahan --</option>';
    
    if (kecamatan && dataDesa[kecamatan]) {
        dataDesa[kecamatan].forEach(desa => {
            const option = document.createElement('option');
            option.value = desa;
            option.textContent = desa;
            desaSelect.appendChild(option);
        });
        fieldDesa.classList.remove('hidden');
    } else {
        fieldDesa.classList.add('hidden');
    }
}
// Force reflow (kadang membantu di beberapa browser mobile)
setTimeout(() => {
    document.getElementById('formSection').style.display = 'block';
}, 50);
function checkAndShowNext(currentId, nextFieldId) {
    if (isEditMode) return;

    const currentElement = document.getElementById(currentId);
    if (currentElement && currentElement.value.trim() !== '') {
        document.getElementById(nextFieldId).classList.remove('hidden');
        if (nextFieldId === 'field-tandaTangan') {
            resizeCanvas();
        }
    }
}

function hideFieldsAfter(fieldId) {
    if (isEditMode) return;

    const fields = ['field-asal', 'daftarInstansi', 'daftarMasyarakat', 'fieldDesa', 
                    'field-pihakDitemui', 'field-jenisLayanan', 'field-uraian', 
                    'field-nomorHp', 'field-tandaTangan', 'field-aksi'];
    let found = false;
    fields.forEach(id => {
        if (found) document.getElementById(id).classList.add('hidden');
        if (id === fieldId) found = true;
    });
}

function hideAllFields() {
    const fields = ['field-asal', 'daftarInstansi', 'daftarMasyarakat', 'fieldDesa', 
                    'field-pihakDitemui', 'field-jenisLayanan', 'field-uraian', 
                    'field-nomorHp', 'field-tandaTangan', 'field-aksi'];
    fields.forEach(id => document.getElementById(id).classList.add('hidden'));
}

function countWords(str) {
    if (!str.trim()) return 0;
    return str.trim().split(/\s+/).filter(word => word.length > 0).length;
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

function validateUraian() {
    if (isEditMode) return;

    const uraian = document.getElementById('uraian');
    const panjang = uraian.value.trim().length;
    
    if (panjang >= 15) {
        uraian.classList.remove('error');
        uraian.classList.add('success');
        document.getElementById('field-nomorHp').classList.remove('hidden');
    } else {
        uraian.classList.remove('success');
        uraian.classList.add('error');
        hideFieldsAfter('field-uraian');
    }
    
    let info = document.getElementById('uraianInfo');
    if (!info) {
        info = document.createElement('small');
        info.id = 'uraianInfo';
        info.style.color = '#dc3545';
        uraian.parentNode.appendChild(info);
    }
    if (panjang < 15) {
        info.textContent = `Minimal 15 karakter (saat ini: ${panjang})`;
    } else {
        info.textContent = '';
    }
}

// ===== CAMERA FUNCTIONS =====
async function bukaKamera() {
    step = 1;
    document.getElementById('infoKamera').innerText = "Ambil foto pertama";
    document.getElementById('photoModal').style.display = 'flex';
    await initCamera('user');
}

async function initCamera(facing) {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: facing },
            audio: false
        });

        const video = document.getElementById('video');
        video.srcObject = stream;
        video.onloadedmetadata = () => video.play().catch(e => console.log("play error:", e));
    } catch (err) {
        console.error("Kamera error:", err);
        alert("Tidak dapat mengakses kamera.\nPastikan izin kamera diizinkan dan coba refresh halaman.");
        stopAll();
    }
}

function capture() {
    const video = document.getElementById('video');
    if (!video.srcObject) return;

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    const dataUrl = canvas.toDataURL('image/png');

    if (step === 1) {
        fotoDataURLFront = dataUrl;
        document.getElementById('imgFront').src = dataUrl;
        document.getElementById('imgFront').style.display = 'block';
        step = 2;
        document.getElementById('infoKamera').innerText = 'Ambil foto kedua';
        initCamera('environment');
    } else {
        fotoDataURLBack = dataUrl;
        document.getElementById('imgBack').src = dataUrl;
        document.getElementById('imgBack').style.display = 'block';
        hasPhoto = true;
        stopAll();

        if (!isEditMode) {
            if (simpanDataSementara()) {
                alert("‚úÖ Data tersimpan sementara!\n\nData akan masuk ke Export Tabel Ringkasan setelah Anda menekan\nüñ®Ô∏è Simpan Detail Lengkap (Per Tamu).");
                showData();
            }
        } else {
            alert("Foto berhasil diambil. Lanjut edit lalu simpan perubahan.");
            document.getElementById('photoPreview').scrollIntoView({behavior:'smooth'});
        }
    }
}
function stopAll() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
    document.getElementById('photoModal').style.display = 'none';
    document.getElementById('video').srcObject = null;
}

// ===== FORCE SHOW FIELDS SAAT EDIT =====
function forceShowEditFields() {
    const fieldsToShow = [
        'field-asal', 'field-pihakDitemui', 'field-jenisLayanan',
        'field-uraian', 'field-nomorHp', 'field-tandaTangan', 'field-aksi'
    ];
    
    fieldsToShow.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('hidden');
    });

    asalChanged();
    
    if (document.getElementById('asal').value === 'MASYARAKAT') {
        document.getElementById('fieldDesa').classList.remove('hidden');
    }
}

// ===== DATA MANAGEMENT =====
function simpanData() {
    const form = document.getElementById('bukuTamuForm');
    let isValid = true;

    // Reset warning
    document.getElementById('signatureWarning').style.display = 'none';
    document.getElementById('photoWarning').style.display = 'none';

    // Validasi dasar form HTML (required fields)
    if (!form.reportValidity()) isValid = false;

    // =====================================
    // Validasi KHUSUS hanya berlaku di mode TAMBAH BARU (bukan edit)
    // =====================================
    if (!isEditMode) {
        const uraianValue = document.getElementById('uraian').value.trim();
if (uraianValue.length < 15) {
    document.getElementById('uraian').classList.add('error');
    isValid = false;
    alert('Uraian minimal 15 karakter saat input baru!');
}


        const namaInput = document.getElementById('nama');
        let hurufCount = (namaInput.value.trim().match(/[A-Za-z]/g) || []).length;
        if (hurufCount < 5) {
            namaInput.classList.add('error');
            isValid = false;
            alert('Nama minimal 5 huruf saat input baru!');
        }

        const nomorHpInput = document.getElementById('nomorHp');
        const nomorValue = nomorHpInput.value.trim().replace(/[^0-9]/g, '');
        if (nomorValue.length < 11) {
            nomorHpInput.classList.add('error');
            isValid = false;
            alert('Nomor WA minimal 11 digit saat input baru!');
        }

        const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
        if (!hasSignature || strokeLengthCm < MIN_STROKE_LENGTH_CM) {
            document.getElementById('signatureWarning').style.display = 'block';
            isValid = false;
        }

        if (!hasPhoto) {
            document.getElementById('photoWarning').style.display = 'block';
            isValid = false;
        }
    } else {
        // Di mode edit: longgarkan
        // Hanya cek field wajib dasar
        const requiredFields = ['nama', 'asal', 'pihakDitemui', 'jenisLayanan'];
        requiredFields.forEach(id => {
            const el = document.getElementById(id);
            if (el && !el.value.trim()) {
                el.classList.add('error');
                isValid = false;
            }
        });

        // Foto & tanda tangan boleh tetap pakai yang lama
        if (!hasPhoto && !fotoDataURLFront && !fotoDataURLBack) {
            alert('Foto lama masih ada, boleh tidak diubah.');
        }
    }

    if (!isValid) return false;

    // Lanjut simpan data...
    const asal = document.getElementById('asal').value;
    const formData = {
        nama: document.getElementById('nama').value.trim(),
        asal: asal,
        instansi: asal === 'INSTANSI' ? document.getElementById('instansi').value : '',
        kecamatan: asal === 'MASYARAKAT' ? document.getElementById('kecamatan').value : '',
        desa: asal === 'MASYARAKAT' ? document.getElementById('desa').value : '',
        pihakDitemui: document.getElementById('pihakDitemui').value,
        jenisLayanan: document.getElementById('jenisLayanan').value,
        uraian: document.getElementById('uraian').value.trim(),
        nomorHp: document.getElementById('nomorHp').value.trim(),
        tandaTangan: hasSignature ? signatureCanvas.toDataURL('image/png') : (editingSementara ? (dataTamuSementara[editingIndex]?.tandaTangan || '') : (dataBukuTamu[editingIndex]?.tandaTangan || '')),
        fotoFront: fotoDataURLFront || (editingSementara ? (dataTamuSementara[editingIndex]?.fotoFront || null) : (dataBukuTamu[editingIndex]?.fotoFront || null)),
        fotoBack: fotoDataURLBack || (editingSementara ? (dataTamuSementara[editingIndex]?.fotoBack || null) : (dataBukuTamu[editingIndex]?.fotoBack || null)),
        timestamp: isEditMode ? (editingSementara ? (dataTamuSementara[editingIndex]?.timestamp || new Date().toLocaleString('id-ID')) : (dataBukuTamu[editingIndex]?.timestamp || new Date().toLocaleString('id-ID'))) : new Date().toLocaleString('id-ID')
    };

    if (editingIndex >= 0) {
        if (editingSementara) {
            // Pertahankan flag _sementara saat edit data pending
            formData._sementara = true;
            dataTamuSementara[editingIndex] = formData;
        } else {
            dataBukuTamu[editingIndex] = formData;
        }
    } else {
        dataBukuTamu.push(formData);
    }

    updateDataCounter();
    resetFormComplete();
    return true;
}

function simpanDataSementara() {
    // Sama seperti simpanData, tapi data masuk ke dataTamuSementara (bukan dataBukuTamu)
    const form = document.getElementById('bukuTamuForm');
    let isValid = true;

    const requiredFields = ['nama', 'asal', 'pihakDitemui', 'jenisLayanan'];
    requiredFields.forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.value.trim()) {
            el.classList.add('error');
            isValid = false;
        }
    });

    if (!isValid) {
        alert('‚ùå Data belum lengkap. Silakan lengkapi form terlebih dahulu.');
        return false;
    }

    const asal = document.getElementById('asal').value;
    const formData = {
        nama: document.getElementById('nama').value.trim(),
        asal: asal,
        instansi: asal === 'INSTANSI' ? document.getElementById('instansi').value : '',
        kecamatan: asal === 'MASYARAKAT' ? document.getElementById('kecamatan').value : '',
        desa: asal === 'MASYARAKAT' ? document.getElementById('desa').value : '',
        pihakDitemui: document.getElementById('pihakDitemui').value,
        jenisLayanan: document.getElementById('jenisLayanan').value,
        uraian: document.getElementById('uraian').value.trim(),
        nomorHp: document.getElementById('nomorHp').value.trim(),
        tandaTangan: signatureCanvas ? signatureCanvas.toDataURL('image/png') : '',
        fotoFront: fotoDataURLFront || null,
        fotoBack: fotoDataURLBack || null,
        timestamp: new Date().toLocaleString('id-ID'),
        _sementara: true  // penanda bahwa data ini belum dikonfirmasi
    };

    dataTamuSementara.push(formData);
    updateDataCounter();
    resetFormComplete();
    return true;
}

function resetFormComplete() {
    document.getElementById('bukuTamuForm').reset();
    hasSignature = false;
    hasPhoto = false;
    fotoDataURLFront = null;
    fotoDataURLBack = null;
    totalStrokeLength = 0;
    clearSignature();
    hideAllFields();
    isEditMode = false;
    editingIndex = -1;
    editingSementara = false;
}

// ===== NAVIGATION =====
function showForm() {
    location.reload();
}

function showData() {
    document.getElementById('formSection').style.display = 'none';
    document.getElementById('dataSection').style.display = 'block';
    document.getElementById('btnForm').style.background = '#6c757d';
    document.getElementById('btnData').style.background = '#28a745';
    displayData();
}

function displayData() {
    const container = document.getElementById('dataContainer');
    if (dataBukuTamu.length === 0 && dataTamuSementara.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>';
        return;
    }
    
    let html = '';

    // ‚îÄ‚îÄ Tampilkan data SEMENTARA (belum dikonfirmasi ke ekspor) ‚îÄ‚îÄ
    if (dataTamuSementara.length > 0) {
        html += `<div style="background:#fff8e1;border:2px dashed #ffc107;border-radius:10px;padding:10px 14px;margin-bottom:18px;">
            <b style="color:#b8860b;">‚è≥ Data Menunggu Konfirmasi (${dataTamuSementara.length})</b>
            <p style="margin:4px 0 0;font-size:0.88em;color:#7a5800;">
                Data berikut <u>belum masuk</u> ke Export Tabel Ringkasan.<br>
                Klik <b>üñ®Ô∏è Simpan Detail Lengkap (Per Tamu)</b> untuk mengonfirmasi & mengekspor PDF sekaligus memasukkan ke tabel ringkasan.
            </p>
        </div>`;
        dataTamuSementara.forEach((data, sIndex) => {
            html += buildDetailHTML(data, sIndex, true);
        });
    }

    // ‚îÄ‚îÄ Data final (sudah masuk ke ekspor) ‚îÄ‚îÄ
    if (dataBukuTamu.length > 0) {
        html += `<div style="background:#e8f5e9;border:2px solid #28a745;border-radius:10px;padding:10px 14px;margin-bottom:14px;">
            <b style="color:#155724;">‚úÖ Data Terkonfirmasi (${dataBukuTamu.length}) ‚Äî Sudah masuk Export Tabel Ringkasan</b>
        </div>`;
        dataBukuTamu.forEach((data, index) => {
            html += buildDetailHTML(data, index, false);
        });
    }
    container.innerHTML = html;
}

// ‚îÄ‚îÄ Helper: bangun HTML kartu detail satu tamu ‚îÄ‚îÄ
function buildDetailHTML(data, index, isSementara) {
    const headerBg  = isSementara ? 'background:#fff3cd;border-left:5px solid #ffc107;' : '';
    const badge     = isSementara
        ? `<span style="background:#ffc107;color:#000;font-size:0.8em;padding:3px 8px;border-radius:20px;font-weight:bold;margin-right:8px;">‚è≥ BELUM DIKONFIRMASI</span>`
        : `<span style="background:#28a745;color:#fff;font-size:0.8em;padding:3px 8px;border-radius:20px;font-weight:bold;margin-right:8px;">‚úÖ TERKONFIRMASI</span>`;
    const nomor     = isSementara ? `S-${index + 1}` : `${index + 1}`;
    const editBtn   = isSementara
        ? `<button onclick="editSementara(${index})" style="background:#17a2b8;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin-right:5px;">‚úèÔ∏è Edit</button>
           <button onclick="hapusSementara(${index})" style="background:#dc3545;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin-right:5px;">üóëÔ∏è Hapus</button>`
        : `<button onclick="editData(${index})" style="background:#ffc107;color:black;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin-right:5px;">‚úèÔ∏è Edit</button>`;
    const simpanBtn = isSementara
        ? `<button type="button" onclick="konfirmasiDanSimpanPDF(${index})"
               style="background:#6610f2;color:white;padding:8px 15px;border:none;border-radius:5px;cursor:pointer;">
               üñ®Ô∏è Simpan Detail Lengkap (Per Tamu)
           </button>`
        : `<button type="button" onclick="exportDetailPerTamuPDF(${index})"
               style="background:#6610f2;color:white;padding:8px 15px;border:none;border-radius:5px;cursor:pointer;">
               üñ®Ô∏è Simpan Detail Lengkap (Per Tamu)
           </button>`;

    return `
    <div class="detail-container" style="${headerBg}">
        <div class="detail-header">
            <h3>${badge}Data Tamu #${nomor}</h3>
            <div>${editBtn}${simpanBtn}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Nama Lengkap</div>
            <div class="detail-value">${data.nama}</div>
        </div>
${data.asal === 'INSTANSI' ? `
<div class="detail-row">
    <div class="detail-label">Instansi / Unit Kerja</div>
    <div class="detail-value">${data.instansi || '-'}</div>
</div>
` : data.asal === 'MASYARAKAT' ? `
<div class="detail-row">
    <div class="detail-label">Asal</div>
    <div class="detail-value">Masyarakat</div>
</div>
<div class="detail-row">
    <div class="detail-label">Kecamatan</div>
    <div class="detail-value">${data.kecamatan || '-'}</div>
</div>
<div class="detail-row">
    <div class="detail-label">Desa / Kelurahan</div>
    <div class="detail-value">${data.desa || '-'}</div>
</div>
` : `
<div class="detail-row">
    <div class="detail-label">Asal</div>
    <div class="detail-value">${data.asal || '-'}</div>
</div>
`}
        <div class="detail-row">
            <div class="detail-label">Pihak Ditemui</div>
            <div class="detail-value">${data.pihakDitemui}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Jenis Layanan</div>
            <div class="detail-value">${data.jenisLayanan}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Uraian Keperluan</div>
            <div class="detail-value">${data.uraian}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Nomor WhatsApp</div>
            <div class="detail-value">${data.nomorHp}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Waktu Kunjungan</div>
            <div class="detail-value">${data.timestamp}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Dokumentasi Foto</div>
            <div class="detail-value">
                ${data.fotoFront ? `<img src="${data.fotoFront}" style="width:150px;margin-right:10px;border:1px solid #ddd;" alt="Foto Depan">` : ''}
                ${data.fotoBack  ? `<img src="${data.fotoBack}"  style="width:150px;border:1px solid #ddd;" alt="Foto Belakang">` : ''}
            </div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Tanda Tangan</div>
            <div class="detail-value">
                <img src="${data.tandaTangan}" style="max-width:300px;border:1px solid #ddd;" alt="TTD">
            </div>
        </div>
    </div>`;
}

// ===== KONFIRMASI DATA SEMENTARA ‚Üí FINAL =====
function konfirmasiDanSimpanPDF(sIndex) {
    if (sIndex < 0 || sIndex >= dataTamuSementara.length) return;
    const data = dataTamuSementara[sIndex];

    if (!confirm(`Konfirmasi data tamu "${data.nama}"?\n\nData akan masuk ke Export Tabel Ringkasan dan PDF detail akan diunduh.`)) return;

    // Pindahkan ke array final
    delete data._sementara;
    dataBukuTamu.push(data);
    dataTamuSementara.splice(sIndex, 1);
    updateDataCounter();

    // Generate PDF menggunakan index baru di dataBukuTamu
    const finalIndex = dataBukuTamu.length - 1;
    exportDetailPerTamuPDF(finalIndex);

    displayData();
    alert(`‚úÖ Data "${data.nama}" berhasil dikonfirmasi!\nTotal data terkonfirmasi: ${dataBukuTamu.length}`);
}

function hapusSementara(sIndex) {
    if (sIndex < 0 || sIndex >= dataTamuSementara.length) return;
    const data = dataTamuSementara[sIndex];
    if (confirm(`Hapus data sementara "${data.nama}"?\nData yang dihapus tidak dapat dikembalikan.`)) {
        dataTamuSementara.splice(sIndex, 1);
        updateDataCounter();
        displayData();
    }
}

// ===== EDIT & DELETE =====
function editData(index) {
    if (confirm('Edit data tamu #' + (index + 1) + '?')) {
        const data = dataBukuTamu[index];
        
        editingIndex = index;
        originalEditData = JSON.parse(JSON.stringify(data));
        isEditMode = true;
        editingSementara = false;

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ISI SEMUA FIELD (termasuk yang wajib seperti NAMA)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('nama').value = data.nama || '';

        // Trigger validasi nama supaya field berikutnya muncul
        validateNama();   // ‚Üê ini penting agar field-asal muncul

        // Asal & trigger perubahan asal
        document.getElementById('asal').value = data.asal || '';
        asalChanged();    // ‚Üê ini yang paling krusial untuk menampilkan/hide instansi vs kecamatan

        // Lanjut isi field lain sesuai asal
        if (data.asal === 'INSTANSI') {
            document.getElementById('instansi').value = data.instansi || '';
        } else if (data.asal === 'MASYARAKAT') {
            document.getElementById('kecamatan').value = data.kecamatan || '';
            updateDesaList();
            // Delay kecil supaya opsi desa sudah ter-render
            setTimeout(() => {
                document.getElementById('desa').value = data.desa || '';
            }, 50);
        }

        document.getElementById('pihakDitemui').value = data.pihakDitemui || '';
        document.getElementById('jenisLayanan').value = data.jenisLayanan || '';
        document.getElementById('uraian').value = data.uraian || '';
        document.getElementById('nomorHp').value = data.nomorHp || '';

        // Tanda tangan
        if (data.tandaTangan) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                ctx2.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                hasSignature = true;
                totalStrokeLength = 100; // cukup untuk lolos validasi
            };
            img.src = data.tandaTangan;
        }

        fotoDataURLFront = data.fotoFront || null;
        fotoDataURLBack  = data.fotoBack  || null;
        hasPhoto = !!(data.fotoFront || data.fotoBack);

        if (data.fotoFront) document.getElementById('imgFront').src = data.fotoFront;
        if (data.fotoBack)  document.getElementById('imgBack').src  = data.fotoBack;

        // Force tampilkan field yang relevan
        forceShowEditFields();

        // Pastikan form terlihat
        document.getElementById('formSection').style.display = 'block';
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('editModeButtons').style.display = 'block'; // jika pakai tombol simpan/batal khusus edit

           }
}
// ‚îÄ‚îÄ Fungsi edit khusus data SEMENTARA (belum dikonfirmasi) ‚Äî diadaptasi dari V7 ‚îÄ‚îÄ
function editSementara(sIndex) {
    if (confirm('Edit data sementara #S-' + (sIndex + 1) + '?')) {
        const data = dataTamuSementara[sIndex];

        editingIndex = sIndex;
        originalEditData = JSON.parse(JSON.stringify(data));
        isEditMode = true;
        editingSementara = true;   // ‚Üê tandai bahwa kita sedang edit array sementara

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ISI SEMUA FIELD (termasuk yang wajib seperti NAMA)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('nama').value = data.nama || '';

        // Trigger validasi nama supaya field berikutnya muncul
        validateNama();

        // Asal & trigger perubahan asal
        document.getElementById('asal').value = data.asal || '';
        asalChanged();    // ‚Üê krusial untuk tampilkan/hide instansi vs kecamatan

        // Isi field sesuai asal
        if (data.asal === 'INSTANSI') {
            document.getElementById('instansi').value = data.instansi || '';
        } else if (data.asal === 'MASYARAKAT') {
            document.getElementById('kecamatan').value = data.kecamatan || '';
            updateDesaList();
            setTimeout(() => {
                document.getElementById('desa').value = data.desa || '';
            }, 50);
        }

        document.getElementById('pihakDitemui').value = data.pihakDitemui || '';
        document.getElementById('jenisLayanan').value = data.jenisLayanan || '';
        document.getElementById('uraian').value = data.uraian || '';
        document.getElementById('nomorHp').value = data.nomorHp || '';

        // Tanda tangan
        if (data.tandaTangan) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                ctx2.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                hasSignature = true;
                totalStrokeLength = 100; // cukup untuk lolos validasi
            };
            img.src = data.tandaTangan;
        }

        fotoDataURLFront = data.fotoFront || null;
        fotoDataURLBack  = data.fotoBack  || null;
        hasPhoto = !!(data.fotoFront || data.fotoBack);

        if (data.fotoFront) document.getElementById('imgFront').src = data.fotoFront;
        if (data.fotoBack)  document.getElementById('imgBack').src  = data.fotoBack;

        // Force tampilkan field yang relevan
        forceShowEditFields();

        // Pastikan form terlihat
        document.getElementById('formSection').style.display = 'block';
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('editModeButtons').style.display = 'block';
    }
}

function saveEditedData() {
    if (simpanData()) {
        alert("‚úÖ Perubahan berhasil disimpan!");
        editingIndex = -1;
        originalEditData = null;
        isEditMode = false;
        editingSementara = false;
        document.getElementById('mainNavigation').style.display = 'block';
        document.getElementById('editModeButtons').style.display = 'none';
        showData();
    } else {
        alert("‚ùå Data belum lengkap atau tidak valid.");
    }
}

function cancelEdit() {
    if (originalEditData && editingIndex >= 0) {
        // Kembalikan ke array yang sesuai
        if (editingSementara) {
            dataTamuSementara[editingIndex] = originalEditData;
        } else {
            dataBukuTamu[editingIndex] = originalEditData;
        }
        updateDataCounter();
    }

    editingIndex = -1;
    originalEditData = null;
    isEditMode = false;
    editingSementara = false;

    document.getElementById('mainNavigation').style.display = 'block';
    document.getElementById('editModeButtons').style.display = 'none';

    showData();
    alert('Edit dibatalkan. Data asli dikembalikan.');
}

function deleteData(index) {
    if (confirm('Yakin ingin menghapus data tamu #' + (index + 1) + '?')) {
        dataBukuTamu.splice(index, 1);
        updateDataCounter();
        displayData();
        alert('Data berhasil dihapus!');
    }
}

// ===== EXPORT =====
function exportData() {
    if (dataBukuTamu.length === 0) {
        alert('Tidak ada data untuk di-export!');
        return;
    }

    const instansiData = dataBukuTamu.filter(d => d.asal === 'INSTANSI');
    const masyarakatData = dataBukuTamu.filter(d => d.asal === 'MASYARAKAT');

    function createSummaryPDF(data, type) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // landscape untuk tabel lebar
        const pageWidth = 297;
        const margin = 10;
        let y = margin;

        // Title
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setFont("helvetica", "bold");
doc.setFontSize(14);

// Menggunakan array dan loop (lebih mudah jika ingin ubah-ubah teks)
const titleLines = [
    "BUKU TAMU DIGITAL",
    "INSPEKTORAT DAERAH",
    "KABUPATEN TULANG BAWANG BARAT"
];

let currentY = y;
titleLines.forEach(line => {
    doc.text(line, pageWidth / 2, currentY, { align: 'center' });
    currentY += 5;  // jarak antar baris (sesuaikan 8-10)
});

y = currentY + 5;  // tambah jarak setelah judul selesai

        doc.setFontSize(10);
        doc.text(`Tanggal Export: ${new Date().toLocaleString('id-ID')}`, pageWidth / 2, y, { align: 'center' });
        y += 10;

        // Header tabel
        const title = type === 'instansi' ? 'DAFTAR TAMU INSTANSI / UNIT KERJA' : 'DAFTAR TAMU MASYARAKAT';
        doc.setFontSize(12);
        doc.text(title, margin, y);
        y += 2;

        // Kolom
        let columns;
        if (type === 'instansi') {
            columns = [
                { header: 'No', dataKey: 'no' },
                { header: 'Nama', dataKey: 'nama' },
                { header: 'Instansi', dataKey: 'instansi' },
                { header: 'Pihak Ditemui', dataKey: 'pihakDitemui' },
                { header: 'Layanan', dataKey: 'jenisLayanan' },
                { header: 'Uraian', dataKey: 'uraian' },
                { header: 'No HP', dataKey: 'nomorHp' },
                { header: 'Waktu', dataKey: 'timestamp' },
                { header: 'TTD', dataKey: 'tandaTangan' },
                { header: 'Foto Depan', dataKey: 'fotoFront' },
                { header: 'Foto Belakang', dataKey: 'fotoBack' }
            ];
        } else {
            columns = [
                { header: 'No', dataKey: 'no' },
                { header: 'Nama', dataKey: 'nama' },
                { header: 'Kecamatan', dataKey: 'kecamatan' },
                { header: 'Desa', dataKey: 'desa' },
                { header: 'Pihak Ditemui', dataKey: 'pihakDitemui' },
                { header: 'Layanan', dataKey: 'jenisLayanan' },
                { header: 'Uraian', dataKey: 'uraian' },
                { header: 'No HP', dataKey: 'nomorHp' },
                { header: 'Waktu', dataKey: 'timestamp' },
                { header: 'TTD', dataKey: 'tandaTangan' },
                { header: 'Foto Depan', dataKey: 'fotoFront' },
                { header: 'Foto Belakang', dataKey: 'fotoBack' }
            ];
        }

        // Rows
        const rows = data.map((d, i) => {
            let ttdCell = '';
            if (typeof d.tandaTangan === 'string' && d.tandaTangan.startsWith('data:image')) {
                ttdCell = { image: d.tandaTangan, fit: [20, 20] };
            }

            let frontCell = '';
            if (typeof d.fotoFront === 'string' && d.fotoFront.startsWith('data:image')) {
                frontCell = { image: d.fotoFront, fit: [20, 20] };
            }

            let backCell = '';
            if (typeof d.fotoBack === 'string' && d.fotoBack.startsWith('data:image')) {
                backCell = { image: d.fotoBack, fit: [20, 20] };
            }

            // Bersihkan No HP jika ada prefix aneh seperti 'C '
            let cleanedHp = d.nomorHp ? d.nomorHp.replace(/^C\s*/, '') : '';

            return {
                no: i + 1,
                nama: d.nama,
                instansi: d.instansi || '',
                kecamatan: d.kecamatan || '',
                desa: d.desa || '',
                pihakDitemui: d.pihakDitemui,
                jenisLayanan: d.jenisLayanan,
                uraian: d.uraian || '-', // Jika uraian kosong, tampilkan '-'
                nomorHp: cleanedHp,
                timestamp: d.timestamp,
                tandaTangan: ttdCell,
                fotoFront: frontCell,
                fotoBack: backCell
            };
        });

        // AutoTable
        doc.autoTable({
    columns: columns,
    body: rows,
    startY: y,
    margin: { left: margin, right: margin },

    styles: {
        fontSize: 8,
        cellPadding: 3,           // padding default untuk kolom teks
        overflow: 'linebreak',
        halign: 'left',
        valign: 'middle'
    },

    headStyles: {
        fillColor: type === 'instansi' ? [0, 123, 255] : [40, 167, 69],
        textColor: [255, 255, 255],
        fontStyle: 'bold',
        halign: 'center'
    },

    alternateRowStyles: { fillColor: [245, 245, 245] },

    columnStyles: {
        no: { cellWidth: 10, halign: 'center' },
        nama: { cellWidth: 25 },
        instansi: { cellWidth: 30 },
        kecamatan: { cellWidth: 25 },
        desa: { cellWidth: 25 },
        pihakDitemui: { cellWidth: 25 },
        jenisLayanan: { cellWidth: 25 },
        uraian: { cellWidth: 'auto' },
        nomorHp: { cellWidth: 27 },
        timestamp: { cellWidth: 20 },
        
        // Kolom gambar & tanda tangan
        tandaTangan: { 
            cellWidth: 22,          // sedikit diperbesar agar muat padding
            minCellHeight: 24 
        },
        fotoFront: { 
            cellWidth: 27, 
            minCellHeight: 27 
        },
        fotoBack: { 
            cellWidth: 27, 
            minCellHeight: 27 
        }
    },

    didParseCell: function (data) {
        // Hanya hapus teks di body (header tetap muncul)
        if (data.row.section === 'body' && 
            ['tandaTangan', 'fotoFront', 'fotoBack'].includes(data.column.dataKey)) {
            data.cell.text = '';
        }
    },

    didDrawCell: function (hookData) {
        const colKey = hookData.column.dataKey;
        
        if (['tandaTangan', 'fotoFront', 'fotoBack'].includes(colKey)) {
            if (hookData.cell.raw && hookData.cell.raw.image) {
                try {
                    // Padding 1 mm di semua sisi (‚âà 2.83 pt)
                    const padding = 2.8346;
                    
                    // Hitung posisi dan ukuran gambar dengan padding
                    const imgX = hookData.cell.x + padding;
                    const imgY = hookData.cell.y + padding;
                    
                    // Kurangi ukuran gambar sebanyak 2 √ó padding
                    const availWidth  = hookData.cell.width  - (padding * 2);
                    const availHeight = hookData.cell.height - (padding * 2);
                    
                    // Ukuran gambar maksimal (sesuaikan rasio, tapi pakai square untuk konsistensi)
                    const imgSize = Math.min(availWidth, availHeight);
                    
                    doc.addImage(
                        hookData.cell.raw.image,
                        'PNG',
                        imgX,
                        imgY,
                        imgSize,
                        imgSize
                    );
                } catch (e) {
                    console.log('Gagal render gambar di kolom ' + colKey + ':', e);
                }
            }
        }
    }
});


        // Simpan
        const dateStr = new Date().toISOString().split('T')[0];
        const suffix = type === 'instansi' ? '' : ' (Masyarakat)';
        doc.save(`Buku_Tamu_Ringkasan_${dateStr}${suffix}.pdf`);
    }

    if (instansiData.length > 0) createSummaryPDF(instansiData, 'instansi');
    if (masyarakatData.length > 0) createSummaryPDF(masyarakatData, 'masyarakat');

    if (instansiData.length > 0 || masyarakatData.length > 0) {
        alert('‚úÖ PDF ringkasan telah diunduh!');
    }
}
function exportDetailPerTamuPDF(index) {
    if (dataBukuTamu.length === 0 || index < 0 || index >= dataBukuTamu.length) {
        alert('Tidak ada data untuk tamu ini!');
        return;
    }

    const data = dataBukuTamu[index];
    const { jsPDF } = window.jspdf;
    const doc        = new jsPDF('p', 'mm', 'a4');
    const pageWidth  = 210;
    const pageHeight = 297;
    const margin     = 15;
    const contentWidth = pageWidth - margin * 2;
    let y = 12;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ‚ù∂  GRADIENT DIAGONAL ‚Äî 300 strip interpolasi (kiri-atas ‚Üí kanan-bawah)
    //     #eef3fb (biru putih sejuk)  ‚Üí  #fdf8ec (krem emas hangat)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const GR = { r1:0xEE,g1:0xF3,b1:0xFB, r2:0xFD,g2:0xF8,b2:0xEC };
    const STRIPS = 300;
    const sH = pageHeight / STRIPS;
    for (let i = 0; i < STRIPS; i++) {
        const t = i / (STRIPS - 1);
        doc.setFillColor(
            Math.round(GR.r1 + t*(GR.r2-GR.r1)),
            Math.round(GR.g1 + t*(GR.g2-GR.g1)),
            Math.round(GR.b1 + t*(GR.b2-GR.b1))
        );
        doc.rect(0, i*sH, pageWidth, sH + 0.15, 'F');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ‚ù∑  POLA GEOMETRIS ‚Äî guilloche / security-paper lines
    //     Tiga lapisan: sine-wave interference + radial spokes + diamond grid
    //     Semua pada opacity 3-4% ‚Üí tidak mengganggu teks
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function drawGeometricPattern() {
        // ‚îÄ‚îÄ A. Gelombang sinus saling-berjalin (interference waves) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        //    10 set gelombang, setiap set = 2 frekuensi yang di-superposisi
        doc.setDrawColor(13, 31, 100);
        doc.setLineWidth(0.08);

        const WAVE_SETS = [
            { amp:4.5, freq1:0.038, freq2:0.019, phase:0.0,  gap:9  },
            { amp:3.5, freq1:0.052, freq2:0.026, phase:1.1,  gap:11 },
            { amp:5.0, freq1:0.028, freq2:0.014, phase:2.3,  gap:14 },
            { amp:3.0, freq1:0.065, freq2:0.032, phase:0.7,  gap:8  },
            { amp:4.0, freq1:0.045, freq2:0.022, phase:1.8,  gap:12 },
        ];

        // Horizontal waves (berjalan kiri-kanan)
        for (const ws of WAVE_SETS) {
            let baseY = ws.gap;
            while (baseY < pageHeight) {
                const pts = [];
                for (let px = 0; px <= pageWidth; px += 0.6) {
                    const rad = px * ws.freq1 + ws.phase;
                    const rad2 = px * ws.freq2 + ws.phase * 1.7;
                    const dy = ws.amp * Math.sin(rad) + (ws.amp * 0.4) * Math.sin(rad2);
                    pts.push({ x: px, y: baseY + dy });
                }
                // Gambar path sebagai polyline
                for (let pi = 0; pi < pts.length - 1; pi++) {
                    doc.line(pts[pi].x, pts[pi].y, pts[pi+1].x, pts[pi+1].y);
                }
                baseY += ws.gap * 2;
            }
        }

        // Vertical waves (berjalan atas-bawah, tegak lurus dengan horizontal)
        doc.setDrawColor(100, 31, 13);
        const VWAVE_SETS = [
            { amp:3.5, freq1:0.040, freq2:0.020, phase:0.5,  gap:18 },
            { amp:2.5, freq1:0.055, freq2:0.027, phase:1.5,  gap:22 },
        ];
        for (const ws of VWAVE_SETS) {
            let baseX = ws.gap;
            while (baseX < pageWidth) {
                const pts = [];
                for (let py = 0; py <= pageHeight; py += 0.6) {
                    const rad  = py * ws.freq1 + ws.phase;
                    const rad2 = py * ws.freq2 + ws.phase * 1.9;
                    const dx   = ws.amp * Math.sin(rad) + (ws.amp * 0.35) * Math.sin(rad2);
                    pts.push({ x: baseX + dx, y: py });
                }
                for (let pi = 0; pi < pts.length - 1; pi++) {
                    doc.line(pts[pi].x, pts[pi].y, pts[pi+1].x, pts[pi+1].y);
                }
                baseX += ws.gap * 2;
            }
        }

        // ‚îÄ‚îÄ B. Radial spokes dari 4 sudut (simpul geometris) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        doc.setDrawColor(13, 60, 120);
        doc.setLineWidth(0.07);
        const corners = [
            { cx:0,         cy:0          },   // kiri-atas
            { cx:pageWidth, cy:0          },   // kanan-atas
            { cx:0,         cy:pageHeight },   // kiri-bawah
            { cx:pageWidth, cy:pageHeight },   // kanan-bawah
        ];
        const SPOKE_COUNT = 28;
        const SPOKE_LEN   = 120;  // mm

        for (const corner of corners) {
            for (let s = 0; s < SPOKE_COUNT; s++) {
                const angle = (s / SPOKE_COUNT) * Math.PI / 2;  // 90¬∞ quadrant
                const baseAngle = (corner.cx === 0 ? 0 : Math.PI) +
                                  (corner.cy === 0 ? 0 : Math.PI);
                const theta = baseAngle + angle - Math.PI / 4;
                const ex = corner.cx + SPOKE_LEN * Math.cos(theta);
                const ey = corner.cy + SPOKE_LEN * Math.sin(theta);
                doc.line(corner.cx, corner.cy, ex, ey);
            }
        }

        // ‚îÄ‚îÄ C. Grid diamond bersilang (di seluruh halaman, sangat tipis) ‚îÄ‚îÄ
        doc.setDrawColor(80, 60, 20);
        doc.setLineWidth(0.06);
        const DGAP = 28;  // spasi diagonal
        // Lines \  (top-left ke bottom-right)
        for (let d = -pageHeight; d < pageWidth + pageHeight; d += DGAP) {
            doc.line(d, 0, d + pageHeight, pageHeight);
        }
        // Lines /  (top-right ke bottom-left)
        for (let d = -pageHeight; d < pageWidth + pageHeight; d += DGAP) {
            doc.line(pageWidth - d, 0, pageWidth - d - pageHeight, pageHeight);
        }

        // ‚îÄ‚îÄ D. Lingkaran konsentris tipis di tengah halaman ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        doc.setDrawColor(13, 31, 100);
        doc.setLineWidth(0.07);
        const CX = pageWidth / 2;
        const CY = pageHeight / 2;
        for (let r = 8; r < 160; r += 14) {
            doc.circle(CX, CY, r, 'S');
        }
        // Tambah 4 simpul kecil di sudut-dalam
        for (const corn of corners) {
            for (let r = 5; r < 55; r += 10) {
                doc.circle(corn.cx, corn.cy, r, 'S');
            }
        }
    }

    // ‚îÄ‚îÄ Semua pola geometris dirender pada opacity rendah ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    doc.setGState(doc.GState({ opacity: 0.038 }));
    drawGeometricPattern();
    doc.setGState(doc.GState({ opacity: 1.0 }));

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ‚ù∏  Fungsi helper: tambahkan stempel waktu langsung di atas foto
    //     Returns: dataURL baru dengan overlay banner timestamp
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function stampPhotoWithTime(originalDataUrl, labelText, timestamp) {
        try {
            const img = new Image();
            // Kita perlu sinkron ‚Äî canvas harus sudah siap sebelum return
            // Buat canvas sementara dengan ukuran tetap
            const cvs = document.createElement('canvas');
            cvs.width  = 480;
            cvs.height = 480;
            const ctx  = cvs.getContext('2d');

            // Gambar foto asli (stretch ke canvas)
            const tmpImg = new Image();
            tmpImg.src = originalDataUrl;
            ctx.drawImage(tmpImg, 0, 0, 480, 480);

            // ‚îÄ‚îÄ Banner gelap di bagian bawah foto (stempel waktu) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const bannerH = 58;
            const bannerY = 480 - bannerH;

            // Gradient gelap dari bawah ke atas
            const grad = ctx.createLinearGradient(0, bannerY - 10, 0, 480);
            grad.addColorStop(0, 'rgba(0, 0, 0, 0)');
            grad.addColorStop(0.3, 'rgba(0, 10, 40, 0.72)');
            grad.addColorStop(1,   'rgba(0, 10, 40, 0.88)');
            ctx.fillStyle = grad;
            ctx.fillRect(0, bannerY - 10, 480, bannerH + 10);

            // Label (Foto Depan / Foto Belakang) ‚Äî besar dan bold
            ctx.fillStyle = '#f5e07a';          // kuning emas
            ctx.font      = 'bold 26px Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.shadowColor = 'rgba(0,0,0,0.7)';
            ctx.shadowBlur  = 4;
            ctx.fillText(labelText, 14, bannerY + 22);

            // Garis pemisah tipis emas
            ctx.strokeStyle = 'rgba(212, 168, 32, 0.7)';
            ctx.lineWidth   = 1.2;
            ctx.beginPath();
            ctx.moveTo(14, bannerY + 29);
            ctx.lineTo(466, bannerY + 29);
            ctx.stroke();

            // Timestamp kecil ‚Äî putih
            ctx.fillStyle = 'rgba(220, 235, 255, 0.92)';
            ctx.font      = '18px Arial, sans-serif';
            ctx.shadowBlur = 3;
            ctx.fillText('üïê ' + timestamp, 14, bannerY + 50);

            ctx.shadowBlur = 0;

            // Border emas tipis di sekeliling foto
            ctx.strokeStyle = 'rgba(212, 168, 32, 0.85)';
            ctx.lineWidth   = 3;
            ctx.strokeRect(2, 2, 476, 476);

            return cvs.toDataURL('image/jpeg', 0.92);
        } catch(e) {
            console.warn('stampPhoto gagal:', e);
            return originalDataUrl;  // fallback ke foto asli
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ‚ùπ  Render seluruh konten PDF (dipanggil setelah watermark siap)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function drawWatermarkThenContent(logoDataUrl) {

        // ‚îÄ‚îÄ Watermark logo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (logoDataUrl) {
            try {
                const wmW = 170, wmH = 170;
                const wmX = (pageWidth  - wmW) / 2;
                const wmY = (pageHeight - wmH) / 2;
                doc.setGState(doc.GState({ opacity: 0.052 }));
                doc.addImage(logoDataUrl, 'PNG', wmX, wmY, wmW, wmH);
                doc.setGState(doc.GState({ opacity: 1.0 }));
            } catch(e) {
                console.warn('Watermark gagal:', e);
                doc.setGState(doc.GState({ opacity: 1.0 }));
            }
        }

        // ‚îÄ‚îÄ Bingkai emas ganda di tepi halaman ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        doc.setDrawColor(180, 140, 20);
        doc.setLineWidth(0.65);
        doc.rect(8, 8, pageWidth - 16, pageHeight - 16, 'S');

        doc.setDrawColor(212, 168, 32);
        doc.setLineWidth(0.25);
        doc.rect(11, 11, pageWidth - 22, pageHeight - 22, 'S');

        // ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        doc.setFillColor(13, 31, 69);
        doc.rect(margin, y, contentWidth, 32, 'F');

        doc.setGState(doc.GState({ opacity: 0.45 }));
        doc.setFillColor(26, 58, 110);
        doc.rect(margin + contentWidth * 0.4, y, contentWidth * 0.6, 32, 'F');
        doc.setGState(doc.GState({ opacity: 1.0 }));

        doc.setDrawColor(212, 168, 32);
        doc.setLineWidth(1.2);
        doc.line(margin, y,      margin + contentWidth, y);
        doc.line(margin, y + 32, margin + contentWidth, y + 32);

        doc.setFontSize(15);
        doc.setTextColor(245, 224, 122);
        doc.setFont("helvetica", "bold");
        doc.text('BUKU TAMU DIGITAL', pageWidth / 2, y + 11, { align: 'center' });

        doc.setFontSize(9.5);
        doc.setTextColor(220, 235, 255);
        doc.text('INSPEKTORAT DAERAH KABUPATEN TULANG BAWANG BARAT', pageWidth / 2, y + 19, { align: 'center' });

        doc.setFontSize(7.5);
        doc.setTextColor(180, 200, 240);
        doc.text(`Data Tamu #${index + 1}  ‚Ä¢  ${data.timestamp}`, pageWidth / 2, y + 27, { align: 'center' });

        y += 40;

        // ‚îÄ‚îÄ TABEL DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const fields = [{ label: "Nama Lengkap", value: data.nama || '-' }];

        if (data.asal === 'INSTANSI') {
            fields.push({ label: "Instansi / Unit Kerja", value: data.instansi || '-' });
        } else if (data.asal === 'MASYARAKAT') {
            fields.push(
                { label: "Asal",             value: "Masyarakat"       },
                { label: "Kecamatan",        value: data.kecamatan || '-' },
                { label: "Desa / Kelurahan", value: data.desa      || '-' }
            );
        } else {
            fields.push({ label: "Asal", value: data.asal || '-' });
        }

        fields.push(
            { label: "Pihak yang Ditemui", value: data.pihakDitemui || '-' },
            { label: "Jenis Layanan",      value: data.jenisLayanan  || '-' },
            { label: "Uraian Keperluan",   value: data.uraian        || '-' },
            { label: "Nomor WhatsApp",     value: data.nomorHp       || '-' },
            { label: "Waktu Kunjungan",    value: data.timestamp     || '-' }
        );

        const labelWidth    = 55;
        const rowHeightBase = 8;
        doc.setFontSize(9.5);

        fields.forEach((field, fi) => {
            const valueLines = doc.splitTextToSize(field.value, contentWidth - labelWidth - 6);
            const rowHeight  = Math.max(rowHeightBase, valueLines.length * 5 + 3);
            const isEven     = fi % 2 === 0;

            doc.setFillColor(isEven ? 232 : 240, isEven ? 238 : 245, isEven ? 252 : 255);
            doc.setGState(doc.GState({ opacity: 0.88 }));
            doc.rect(margin, y, labelWidth, rowHeight, 'F');

            doc.setFillColor(255, 255, 255);
            doc.setGState(doc.GState({ opacity: 0.78 }));
            doc.rect(margin + labelWidth, y, contentWidth - labelWidth, rowHeight, 'F');
            doc.setGState(doc.GState({ opacity: 1.0 }));

            doc.setDrawColor(200, 210, 230);
            doc.setLineWidth(0.25);
            doc.rect(margin, y, contentWidth, rowHeight, 'S');
            doc.line(margin + labelWidth, y, margin + labelWidth, y + rowHeight);

            doc.setDrawColor(13, 31, 69);
            doc.setLineWidth(1.8);
            doc.line(margin, y, margin, y + rowHeight);
            doc.setLineWidth(0.25);

            doc.setFont("helvetica", "bold");
            doc.setTextColor(13, 31, 69);
            doc.text(field.label, margin + 4, y + 5.5);

            doc.setFont("helvetica", "normal");
            doc.setTextColor(30, 30, 50);
            doc.text(valueLines, margin + labelWidth + 4, y + 5.5);

            y += rowHeight;
        });

        y += 14;

        // ‚îÄ‚îÄ SECTION DOKUMENTASI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        doc.setFillColor(13, 31, 69);
        doc.setGState(doc.GState({ opacity: 0.92 }));
        doc.rect(margin, y, contentWidth, 8, 'F');
        doc.setGState(doc.GState({ opacity: 1.0 }));

        doc.setFontSize(9);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(245, 224, 122);
        doc.text("DOKUMENTASI FOTO & TANDA TANGAN", margin + 4, y + 5.5);

        y += 12;

        // ‚îÄ‚îÄ FOTO dengan stempel waktu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const photoSize = 70;
        const photoGap  = 12;
        let photoX      = margin;

        if (data.fotoFront) {
            try {
                // Terapkan stempel waktu ke foto via canvas
                const stampedFront = stampPhotoWithTime(
                    data.fotoFront,
                    'Foto Depan',
                    data.timestamp
                );
                doc.addImage(stampedFront, 'JPEG', photoX, y, photoSize, photoSize);
            } catch(e) {
                // Fallback: foto polos + caption
                doc.setDrawColor(180, 140, 20);
                doc.setLineWidth(0.5);
                doc.rect(photoX, y, photoSize, photoSize, 'S');
                doc.addImage(data.fotoFront, 'PNG', photoX + 1, y + 1, photoSize - 2, photoSize - 2);
                doc.setFontSize(8); doc.setTextColor(80, 80, 100);
                doc.text("Foto Depan", photoX + photoSize / 2, y + photoSize + 5, { align: 'center' });
            }
        }

        photoX += photoSize + photoGap;

        if (data.fotoBack) {
            try {
                const stampedBack = stampPhotoWithTime(
                    data.fotoBack,
                    'Foto Belakang',
                    data.timestamp
                );
                doc.addImage(stampedBack, 'JPEG', photoX, y, photoSize, photoSize);
            } catch(e) {
                doc.setDrawColor(180, 140, 20);
                doc.setLineWidth(0.5);
                doc.rect(photoX, y, photoSize, photoSize, 'S');
                doc.addImage(data.fotoBack, 'PNG', photoX + 1, y + 1, photoSize - 2, photoSize - 2);
                doc.setFontSize(8); doc.setTextColor(80, 80, 100);
                doc.text("Foto Belakang", photoX + photoSize / 2, y + photoSize + 5, { align: 'center' });
            }
        }

        y += photoSize + 16;

        // ‚îÄ‚îÄ TANDA TANGAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(13, 31, 69);
        doc.text("Tanda Tangan:", margin, y);
        y += 4;

        const sigWidth  = 80;
        const sigHeight = 28;
        const sigX = margin + 2;
        const sigY = y + 2;

        doc.setFillColor(255, 255, 255);
        doc.setGState(doc.GState({ opacity: 0.88 }));
        doc.rect(sigX - 2, sigY - 2, sigWidth + 4, sigHeight + 14, 'F');
        doc.setGState(doc.GState({ opacity: 1.0 }));
        doc.setDrawColor(180, 140, 20);
        doc.setLineWidth(0.5);
        doc.rect(sigX - 2, sigY - 2, sigWidth + 4, sigHeight + 14, 'S');

        if (data.tandaTangan) {
            try {
                doc.addImage(data.tandaTangan, 'PNG', sigX, sigY, sigWidth, sigHeight);
            } catch(e) {
                doc.setFontSize(9); doc.setTextColor(150);
                doc.text("(Gagal menampilkan tanda tangan)", sigX + 4, sigY + 8);
            }
        } else {
            doc.setFontSize(9); doc.setTextColor(150);
            doc.text("(Tidak ada tanda tangan)", sigX + 4, sigY + 8);
        }

        const namaBawah = data.nama || "________________________";
        doc.setFontSize(11);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(13, 31, 69);
        doc.text(namaBawah, sigX + sigWidth / 2, sigY + sigHeight + 10, { align: 'center' });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  ‚ù∫  FOOTER ‚Äî garis + teks TIDAK saling menimpa
        //     Struktur: [background putih] [garis emas] [spasi 5mm] [teks]
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const footerLineY  = 280;         // posisi garis pemisah
        const footerTextY  = footerLineY + 6;   // teks dimulai 6mm DI BAWAH garis
        const footerBgY    = footerLineY - 1;   // background dimulai 1mm di atas garis

        // Background putih ringan di area footer agar teks terlihat jelas
        // di atas motif geometris/gradient
        doc.setFillColor(250, 248, 244);
        doc.setGState(doc.GState({ opacity: 0.90 }));
        doc.rect(margin - 2, footerBgY, contentWidth + 4, 16, 'F');
        doc.setGState(doc.GState({ opacity: 1.0 }));

        // Garis emas footer
        doc.setDrawColor(180, 140, 20);
        doc.setLineWidth(0.55);
        doc.line(margin, footerLineY, pageWidth - margin, footerLineY);

        // Ornamen titik emas di ujung kiri dan kanan garis
        doc.setFillColor(212, 168, 32);
        doc.circle(margin, footerLineY, 0.8, 'F');
        doc.circle(pageWidth - margin, footerLineY, 0.8, 'F');

        // Teks catatan kaki ‚Äî duduk rapi di bawah garis
        doc.setFontSize(7.5);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(70, 70, 95);
        doc.text(
            'Dokumen ini dibuat otomatis oleh Sistem Buku Tamu Digital \u2014 Inspektorat Kab. Tulang Bawang Barat',
            pageWidth / 2,
            footerTextY,
            { align: 'center' }
        );

        // Simpan file
        const cleanTimestamp = data.timestamp.replace(/[\s,:]/g, '-');
        doc.save(`Detail_Tamu_${index + 1}_${cleanTimestamp}.pdf`);
        alert('‚úÖ PDF detail tamu telah diunduh!');
    }

    // ‚îÄ‚îÄ Muat logo watermark async ‚Üí render semua konten ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const LOGO_URL = "https://upload.wikimedia.org/wikipedia/commons/6/6b/Lambang_Kabupaten_Tulang_Bawang_Barat.png";
    const logoImg  = new Image();
    logoImg.crossOrigin = "anonymous";

    logoImg.onload = function() {
        const cvs = document.createElement('canvas');
        cvs.width  = logoImg.width;
        cvs.height = logoImg.height;
        cvs.getContext('2d').drawImage(logoImg, 0, 0);
        drawWatermarkThenContent(cvs.toDataURL('image/png'));
    };

    logoImg.onerror = function() {
        drawWatermarkThenContent(null);
    };

    logoImg.src = LOGO_URL;
}
function updateDataCounter() {
    const totalFinal = dataBukuTamu.length;
    const totalSementara = dataTamuSementara.length;
    const total = totalFinal + totalSementara;
    let label = total;
    if (totalSementara > 0) label = `${totalFinal}+${totalSementara}‚è≥`;
    document.getElementById('dataCount').textContent = label;
}
// Tambahkan variabel global atau di dalam scope yang sesuai
let signatureDataURL = null;  // akan menyimpan versi yang sudah di-recenter

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Fungsi utama: recenter dan crop tanda tangan
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function recenterSignature() {
    if (!hasSignature) return null;

    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = signatureCanvas.width;
    tempCanvas.height = signatureCanvas.height;
    const tempCtx = tempCanvas.getContext('2d');

    // Ambil data gambar asli
    tempCtx.drawImage(signatureCanvas, 0, 0);

    // Cari bounding box (area yang ada coretan)
    const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
    const data = imageData.data;
    let minX = tempCanvas.width, minY = tempCanvas.height;
    let maxX = 0, maxY = 0;

    for (let y = 0; y < tempCanvas.height; y++) {
        for (let x = 0; x < tempCanvas.width; x++) {
            const i = (y * tempCanvas.width + x) * 4;
            // Jika ada opacity (bukan transparan sepenuhnya)
            if (data[i + 3] > 10) {   // threshold kecil supaya tidak terlalu sensitif
                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x);
                maxY = Math.max(maxY, y);
            }
        }
    }

    // Jika tidak ada coretan ‚Üí kembalikan null
    if (minX === tempCanvas.width || maxX === 0) return null;

    const width = maxX - minX + 2;
    const height = maxY - minY + 2;

    // Buat canvas baru dengan ukuran yang diinginkan (final display size)
    const finalWidth = 400;   // ‚Üê sesuaikan sesuai kebutuhan tampilan/PDF
    const finalHeight = 150;  // ‚Üê sesuaikan

    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = finalWidth;
    finalCanvas.height = finalHeight;
    const finalCtx = finalCanvas.getContext('2d');

    // Isi background putih (penting untuk PDF & preview)
    finalCtx.fillStyle = 'white';
    finalCtx.fillRect(0, 0, finalWidth, finalHeight);

    // Hitung posisi tengah
    const offsetX = Math.round((finalWidth - width) / 2);
    const offsetY = Math.round((finalHeight - height) / 2);

    // Gambar bagian coretan ke tengah canvas baru
    finalCtx.drawImage(
        tempCanvas,
        minX, minY, width, height,          // source rect
        offsetX, offsetY, width, height     // destination rect (ditempatkan di tengah)
    );

    return finalCanvas.toDataURL('image/png');
}
</script>
<script>
// Fungsi scroll yang lebih lembut & nyaman dilihat
function smoothScrollTo(element) {
    if (!element) return;

    // Hitung posisi yang diinginkan: agak di atas tengah layar
    const rect = element.getBoundingClientRect();
    const offset = 80;  // jarak dari atas layar (pixel) ‚Äì bisa diubah 60‚Äì120
    const targetY = rect.top + window.scrollY - offset;

    // Scroll dengan animasi yang sangat halus
    window.scrollTo({
        top: targetY,
        behavior: 'smooth'
    });
}

// Versi dengan timeout kecil (lebih stabil di Android/iOS saat keyboard muncul)
function scrollToFieldWhenFocused(el) {
    setTimeout(() => {
        smoothScrollTo(el);
    }, 280);   // 280‚Äì350 ms biasanya pas setelah keyboard muncul
}

// Pasang event ke semua field input
document.addEventListener('DOMContentLoaded', () => {
    const focusable = document.querySelectorAll(
        'input, textarea, select, button:not(.btn-capture):not(.btn-cancel)'
    );

    focusable.forEach(field => {
        field.addEventListener('focus', () => {
            scrollToFieldWhenFocused(field);
        });

        // Khusus textarea ‚Üí scroll ulang saat ukuran berubah
        if (field.tagName === 'TEXTAREA') {
            field.addEventListener('input', () => {
                setTimeout(() => scrollToFieldWhenFocused(field), 120);
            });
        }
    });

    // Khusus field tanda tangan (saat muncul)
    const ttdField = document.getElementById('field-tandaTangan');
    if (ttdField) {
        const observer = new MutationObserver(() => {
            if (!ttdField.classList.contains('hidden')) {
                setTimeout(() => {
                    smoothScrollTo(ttdField);
                }, 450);  // sedikit lebih lama karena canvas butuh waktu render
            }
        });
        observer.observe(ttdField, { attributes: true, attributeFilter: ['class'] });
    }

    // Deteksi keyboard muncul via resize (cadangan)
    let prevHeight = window.innerHeight;
    window.addEventListener('resize', () => {
        const currHeight = window.innerHeight;
        if (currHeight < prevHeight * 0.82) {  // keyboard kemungkinan muncul
            const active = document.activeElement;
            if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) {
                scrollToFieldWhenFocused(active);
            }
        }
        prevHeight = currHeight;
    });
});
</script>
</body>
</html>
