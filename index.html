<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <link rel="manifest" href="manifest.json"/>
    <meta name="theme-color" content="#007bff"/>
    <link rel="icon" href="icon-192.png"/>
    <title>Buku Tamu Digital</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
        body {
            font-family: sans-serif;
            max-width: 700px;
            margin: auto;
            padding: 20px 10px;
            min-height: 100vh;
        }
        label { font-weight: bold; }
        select, input, textarea {
            width: 100%; padding: 6px; margin-top: 5px;
            border: 1px solid #ccc; border-radius: 4px;
        }
        .hidden { display: none; }
        .required { color: red; }
        .error { border: 2px solid red !important; }
        .success { border: 2px solid green !important; }
        .warning {
            background-color: #fff3cd; border: 1px solid #ffeaa7;
            padding: 10px; margin: 10px 0; border-radius: 5px;
        }
        #btnHome {
            position: fixed; bottom: 20px; right: 20px;
            background: #ffc107; color: black; border: none;
            padding: 12px 16px; border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 16px;
            z-index: 9999; cursor: pointer;
        }
        #btnHome:hover { background: #e0a800; }
        @media (min-width: 768px) { #btnHome { display: none; } }
        .data-card {
            border: 1px solid #ddd; margin-bottom: 15px;
            padding: 15px; border-radius: 8px; background: #f9f9f9;
        }
        .data-grid {
            display: grid; grid-template-columns: 1fr; gap: 10px;
            margin-bottom: 15px;
        }
        @media (min-width: 500px) { .data-grid { grid-template-columns: 1fr 1fr; } }
        .data-images {
            display: flex; flex-direction: column; gap: 20px; margin-top: 15px;
        }
        @media (min-width: 500px) { .data-images { flex-direction: row; } }
        .header-gambar {
            display: flex; justify-content: center; align-items: center;
            gap: 20px; margin-bottom: 15px; flex-wrap: nowrap;
        }
        .foto-kepala { width: 80px; height: auto; }
        .logo { width: 100px; height: auto; }

        /* Modal Foto */
        #photoModal {
            display: none; position: fixed; z-index: 10000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); justify-content: center;
            align-items: center; flex-direction: column; padding: 10px;
        }
        #modalContent {
            background-color: #fefefe; padding: 20px;
            border: 1px solid #888; width: 95%; max-width: 1300px;
            text-align: center; border-radius: 8px;
        }
        #dualCameraFrame {
            display: flex; flex-direction: column; gap: 20px;
            width: 100%; max-width: 900px; margin: 20px auto;
        }
        .camera-view {
            width: 100%; border: 3px solid #007bff;
            aspect-ratio: 4/3; overflow: hidden; position: relative;
            border-radius: 10px; background: #000;
        }
        .camera-view h4 {
            position: absolute; top: 10px; left: 50%;
            transform: translateX(-50%); background: rgba(0,0,0,0.6);
            color: white; padding: 8px 16px; border-radius: 20px;
            margin: 0; font-size: 16px; z-index: 10; white-space: nowrap;
        }
        .camera-view video, .camera-view img {
            width: 100%; height: 100%; object-fit: cover;
            position: absolute; top: 0; left: 0;
        }
        @media (min-width: 768px) {
            #dualCameraFrame { flex-direction: row; gap: 30px; max-width: 1200px; }
            .camera-view { flex: 1; aspect-ratio: 16/9; max-width: 600px; }
            .camera-view h4 { font-size: 18px; padding: 10px 20px; }
        }
        #modalButtons { margin-top: 10px; display: flex; gap: 10px; justify-content: center; }
        #modalButtons button {
            padding: 10px 20px; border: none; border-radius: 5px;
            font-size: 16px; cursor: pointer;
        }
        .btn-camera { background: #ffc107; color: black; }
        .btn-save { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
        .btn-camera:hover { background: #e0a800; }
        .btn-save:hover { background: #218838; }
        .btn-cancel:hover { background: #c82333; }
    </style>
    <!-- Library untuk export PDF dengan gambar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="header-gambar">
        <img src="bupati.png" alt="Wakil Bupati" class="foto-kepala">
        <img src="logo-tubaba.png" alt="Logo Tubaba" class="logo">
        <img src="wakil-bupati.png" alt="Bupati" class="foto-kepala">
    </div>

    <h1 style="text-align: center;">BUKU TAMU INSPEKTORAT TUBABA</h1>

    <div id="formSection">
        <form id="bukuTamuForm">
            <div id="field-nama">
                <label>Nama: <span class="required">*</span></label>
                <input id="nama" required type="text" placeholder="Isi Minimal 5 Huruf" oninput="validateNama();"/>
            </div>

            <div id="field-asal" style="display: none;">
                <label>INSTANSI/ASAL: <span class="required">*</span></label>
                <select id="asal" required onchange="checkAndShowNext('asal', 'field-pihakDitemui')">
                    <option value="">-- Pilih Asal --</option>
                    <option value="INSTANSI">INSTANSI/UNIT KERJA</option>
                    <option value="MASYARAKAT">MASYARAKAT</option>
                </select>
            </div>

            <div class="hidden" id="daftarInstansi">
                <label>DAFTAR INSTANSI/UNIT KERJA: <span class="required">*</span></label>
                <select id="instansi" onchange="checkAndShowNext('instansi', 'field-pihakDitemui')">
                    <option value="">-- Pilih Instansi --</option>
                    <option>SEKRETARIAT DAERAH</option>
                    <option>SEKRETARIAT DPRD</option>
                    <option>BADAN PERENCANAAN PEMBANGUNAN DAERAH</option>
                    <option>BADAN PENGELOLAAN KEUANGAN DAN ASET DAERAH</option>
                    <option>BADAN PENGELOLAAN PAJAK DAN RETRIBUSI DAERAH</option>
                    <option>BADAN KEPEGAWAIAN DAN PENGEMBANGAN SUMBER DAYA MANUSIA</option>
                    <option>BADAN KESATUAN BANGSA DAN POLITIK DAERAH</option>
                    <option>BADAN PENANGGULANGAN BENCANA DAERAH</option>
                    <option>DINAS LINGKUNGAN HIDUP</option>
                    <option>DINAS KESEHATAN</option>
                    <option>DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                    <option>DINAS KOPERASI, UMKM, PERINDUSTRIAN DAN PERDAGANGAN</option>
                    <option>DINAS SOSIAL</option>
                    <option>DINAS PEMUDA, OLAHRAGA DAN PARIWISATA</option>
                    <option>DINAS KOMUNIKASI DAN INFORMATIKA</option>
                    <option>DINAS PERUMAHAN, KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                    <option>DINAS PENANAMAN MODAL DAN PELAYANAN PERIZINAN TERPADU SATU PINTU</option>
                    <option>DINAS PENDIDIKAN DAN KEBUDAYAAN</option>
                    <option>DINAS KETAHANAN PANGAN</option>
                    <option>DINAS PEMBERDAYAAN MASYARAKAT DAN TIYUH</option>
                    <option>DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                    <option>DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                    <option>DINAS PERHUBUNGAN</option>
                    <option>DINAS PERTANIAN</option>
                    <option>DINAS PETERNAKAN DAN KESEHATAN HEWAN</option>
                    <option>DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                    <option>DINAS TENAGA KERJA DAN TRANSMIGRASI</option>
                    <option>DINAS PERIKANAN</option>
                    <option>DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                    <option>DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</option>
                    <option>SATUAN POLISI PAMONG PRAJA</option>
                    <option>BADAN PENGAWASAN KEUANGAN DAN PEMBANGUNAN (BPKP)</option>
                    <option>LAINNYA</option>
                </select>
            </div>

            <div class="hidden" id="daftarMasyarakat">
                <label>Kecamatan: <span class="required">*</span></label>
                <select id="kecamatan" onchange="updateDesaList()">
                    <option value="">-- Pilih Kecamatan --</option>
                    <option value="Tulang Bawang Tengah">Tulang Bawang Tengah</option>
                    <option value="Tulang Bawang Udik">Tulang Bawang Udik</option>
                    <option value="Gunung Terang">Gunung Terang</option>
                    <option value="Gunung Agung">Gunung Agung</option>
                    <option value="Lambu Kibang">Lambu Kibang</option>
                    <option value="Way Kenanga">Way Kenanga</option>
                    <option value="Tumijajar">Tumijajar</option>
                    <option value="Pagar Dewa">Pagar Dewa</option>
                    <option value="Batu Putih">Batu Putih</option>
                </select>

                <div class="hidden" id="field-desa">
                    <label>Desa/Tiyuh: <span class="required">*</span></label>
                    <select id="desa" onchange="checkAndShowNext('desa', 'field-pihakDitemui')">
                        <option value="">-- Pilih Desa --</option>
                    </select>
                </div>
            </div>

            <div id="field-pihakDitemui" style="display: none;">
                <label>PIHAK YANG DITEMUI: <span class="required">*</span></label>
                <select id="pihakDitemui" required onchange="checkAndShowNext('pihakDitemui', 'field-jenisLayanan')">
                    <option value="">-- Pilih Pihak yang Ditemui --</option>
                    <option>INSPEKTUR</option>
                    <option>SEKRETARIS</option>
                    <option>IRBANSUS</option>
                    <option>IRBAN 1</option>
                    <option>IRBAN 2</option>
                    <option>IRBAN 3</option>
                    <option>IRBAN 4</option>
                </select>
            </div>

            <div id="field-jenisLayanan" style="display: none;">
                <label>JENIS LAYANAN: <span class="required">*</span></label>
                <select id="jenisLayanan" required onchange="checkAndShowNext('jenisLayanan', 'field-uraian')">
                    <option value="">-- Pilih Jenis Layanan --</option>
                    <option>Permintaan Audit/Klarifikasi Khusus</option>
                    <option>Penanganan Pengaduan</option>
                    <option>Layanan Informasi Publik</option>
                    <option>Pembinaan & Konsultasi</option>
                    <option>Audit</option>
                    <option>Review</option>
                    <option>Evaluasi/Monitoring</option>
                    <option>Tindak Lanjut Temuan</option>
                </select>
            </div>

            <div id="field-uraian" style="display: none;">
                <label>URAIAN: <span class="required">*</span></label>
                <textarea id="uraian" required oninput="autoResize(this); validateUraian();" style="overflow:hidden; resize:none; width:100%; min-height:60px;"></textarea>
            </div>

            <div id="field-nomorHp" style="display: none;">
                <label>NOMOR HP: <span class="required">*</span></label>
                <input id="nomorHp" inputmode="numeric" pattern="\d*" required type="text" oninput="validateNomorHp();"/>
            </div>

            <div id="field-tandaTangan" style="display: none;">
                <label>Tanda Tangan: <span class="required">*</span></label>
                <div class="warning" id="signatureWarning" style="display:none;">‚ö†Ô∏è Tanda tangan wajib diisi dengan goresan minimal 2 cm!</div>
                <canvas height="200" id="signature-pad" style="border:1px solid #ccc; width: 100%;" width="700"></canvas>
                <button type="button" onclick="clearSignature()" style="background:#e9ecef;color:black;border:1px solid #ccc;padding:8px 15px;border-radius:5px;margin-top:10px;">üßπ Bersihkan Tanda Tangan</button>
            </div>

            <div id="field-aksi" style="display: none;">
                <label>Foto: <span class="required">*</span></label>
                <div class="warning" id="photoWarning" style="display:none;">‚ö†Ô∏è Foto wajib diambil!</div>
                <button type="button" onclick="bukaKamera()" style="font-size:16px;background:#ffc107;color:black;border:none;padding:10px 20px;border-radius:5px;">üì∏ Ambil Foto</button><br><br>
                <button type="button" onclick="simpanDataDanTutupForm()" style="font-size:18px;background:#28a745;color:white;border:none;padding:12px 24px;border-radius:5px;">üíæ Simpan Data</button>
            </div>
        </form>
    </div>

    <div style="margin-bottom:80px;">
        <button type="button" onclick="showForm()" id="btnForm" style="background:#007bff;color:white;padding:10px 20px;border:none;border-radius:5px;margin-right:10px;">üìù Form Input</button>
        <button type="button" onclick="showData()" id="btnData" style="background:#6c757d;color:white;padding:10px 20px;border:none;border-radius:5px;margin-right:10px;">üìä Lihat Data (<span id="dataCount">0</span>)</button>
        <button type="button" onclick="exportData()" style="background:#dc3545;color:white;padding:10px 20px;border:none;border-radius:5px;">üìÑ Export PDF</button>
    </div>

    <div id="dataSection" style="display:none;">
        <h2>üìä DATA BUKU TAMU</h2>
        <div style="margin-bottom:20px;">
            <button type="button" onclick="clearAllData()" style="background:#dc3545;color:white;padding:8px 15px;border:none;border-radius:5px;">üóëÔ∏è Hapus Semua Data</button>
        </div>
        <div id="dataContainer">
            <p style="text-align:center;color:#666;">Belum ada data yang tersimpan</p>
        </div>
    </div>

    <div id="photoModal">
        <div id="modalContent">
            <h3 style="color:black;">Bingkai Pengambilan Foto</h3>
            <div id="dualCameraFrame">
                <div class="camera-view">
                    <h4>Kamera Depan (Selfie)</h4>
                    <video id="videoFront" autoplay muted playsinline></video>
                    <img id="capturedFrontPhoto" alt="Foto Selfie" style="display:none;">
                </div>
                <div class="camera-view">
                    <h4>Kamera Belakang</h4>
                    <video id="videoBack" autoplay muted playsinline></video>
                    <img id="capturedBackPhoto" alt="Foto Belakang" style="display:none;">
                </div>
            </div>
            <canvas id="canvasFront" style="display:none;"></canvas>
            <canvas id="canvasBack" style="display:none;"></canvas>
            <div id="modalButtons">
                <button type="button" class="btn-camera" onclick="ambilFoto()">üì∏ Ambil Foto</button>
                <button type="button" class="btn-save" onclick="simpanFotoLangsung()">‚úÖ Simpan & Lihat Data</button>
                <button type="button" class="btn-cancel" onclick="tutupModal()">‚ùå Tutup</button>
            </div>
        </div>
    </div>

    <script>
        // === Variabel & Element ===
        const signatureCanvas = document.getElementById('signature-pad');
        const ctx = signatureCanvas.getContext('2d');
        const signatureWarning = document.getElementById('signatureWarning');
        const photoWarning = document.getElementById('photoWarning');
        const asal = document.getElementById("asal");
        const daftarInstansi = document.getElementById("daftarInstansi");
        const daftarMasyarakat = document.getElementById("daftarMasyarakat");
        const kecamatan = document.getElementById("kecamatan");
        const desa = document.getElementById("desa");
        const instansi = document.getElementById("instansi");
        const fieldDesa = document.getElementById("field-desa");
        const photoModal = document.getElementById('photoModal');
        const videoFront = document.getElementById('videoFront');
        const videoBack = document.getElementById('videoBack');
        const canvasFront = document.getElementById('canvasFront');
        const canvasBack = document.getElementById('canvasBack');
        const capturedFrontPhoto = document.getElementById('capturedFrontPhoto');
        const capturedBackPhoto = document.getElementById('capturedBackPhoto');

        let streamFront = null, streamBack = null;
        let fotoDataURLFront = null, fotoDataURLBack = null;
        let hasPhoto = false, drawing = false, hasSignature = false;
        let dataBukuTamu = [];
        let lastX = 0, lastY = 0, totalStrokeLength = 0;
        const MIN_STROKE_LENGTH_CM = 2;
        const PIXELS_PER_CM = 37.8;

        // === Signature Canvas ===
        function resizeCanvas() {
            const ratio = window.devicePixelRatio || 1;
            const newWidth = signatureCanvas.parentElement.offsetWidth;
            const temp = signatureCanvas.toDataURL();
            signatureCanvas.width = newWidth * ratio;
            signatureCanvas.height = 200 * ratio;
            signatureCanvas.style.width = newWidth + 'px';
            signatureCanvas.style.height = '200px';
            ctx.scale(ratio, ratio);
            const img = new Image();
            img.src = temp;
            img.onload = () => ctx.drawImage(img, 0, 0, newWidth, 200);
            ctx.strokeStyle = '#0000FF'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function getPos(e) {
            const rect = signatureCanvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
        }
        function startDrawing(e) { e.preventDefault(); drawing = true; hasSignature = true; totalStrokeLength = 0; ctx.beginPath(); const pos = getPos(e); lastX = pos.x; lastY = pos.y; ctx.moveTo(lastX, lastY); }
        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const pos = getPos(e);
            const dist = Math.hypot(pos.x - lastX, pos.y - lastY);
            totalStrokeLength += dist;
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastX = pos.x; lastY = pos.y;
        }
        function stopDrawing() {
            if (!drawing) return;
            drawing = false;
            const lengthCm = totalStrokeLength / PIXELS_PER_CM;
            if (lengthCm < MIN_STROKE_LENGTH_CM) {
                hasSignature = false;
                signatureWarning.style.display = 'block';
                signatureWarning.textContent = '‚ö†Ô∏è Tanda Tangan Terlalu Pendek';
                signatureCanvas.classList.add('error');
                document.getElementById('field-aksi').style.display = 'none';
            } else {
                signatureWarning.style.display = 'none';
                signatureCanvas.classList.remove('error');
                signatureCanvas.classList.add('success');
                document.getElementById('field-aksi').style.display = 'block';
            }
        }
        signatureCanvas.addEventListener('mousedown', startDrawing);
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('mouseup', stopDrawing);
        signatureCanvas.addEventListener('mouseout', stopDrawing);
        signatureCanvas.addEventListener('touchstart', startDrawing, {passive:false});
        signatureCanvas.addEventListener('touchmove', draw, {passive:false});
        signatureCanvas.addEventListener('touchend', stopDrawing);

        function clearSignature() {
            ctx.clearRect(0,0,signatureCanvas.width,signatureCanvas.height);
            hasSignature = false; totalStrokeLength = 0;
            signatureCanvas.classList.remove('error','success');
            signatureWarning.style.display = 'none';
            document.getElementById('field-aksi').style.display = 'none';
        }

        // === Dropdown Desa ===
        const dataDesa = { /* ... (sama seperti sebelumnya, tetap copy dari kode asli) ... */ };
        // (untuk menghemat tempat, dataDesa tetap sama seperti kode Anda sebelumnya)

        // === Validasi & Navigasi Form ===
        function validateNama() { /* kode validasi nama sama seperti asli */ }
        function validateUraian() { /* sama */ }
        function validateNomorHp() { /* sama */ }
        function checkAndShowNext(id, next) { /* logika progresif form sama */ }

        // === Kamera ===
        async function bukaKamera() { /* kode kamera sama */ }
        function ambilFoto() { /* sama */ }
        function tutupModal() { /* sama */ }
        function simpanFotoLangsung() { if (hasPhoto && simpanData()) { alert('Data tersimpan!'); tutupModal(); showData(); } }

        // === Simpan Data ===
        function simpanData() {
            // validasi lengkap
            if (!hasSignature || totalStrokeLength / PIXELS_PER_CM < MIN_STROKE_LENGTH_CM || !hasPhoto) return false;
            const formData = {
                nama: document.getElementById('nama').value.trim(),
                asal: asal.value,
                instansi: asal.value === 'INSTANSI' ? instansi.value : '',
                kecamatan: asal.value === 'MASYARAKAT' ? kecamatan.value : '',
                desa: asal.value === 'MASYARAKAT' ? desa.value : '',
                pihakDitemui: document.getElementById('pihakDitemui').value,
                jenisLayanan: document.getElementById('jenisLayanan').value,
                uraian: document.getElementById('uraian').value.trim(),
                nomorHp: document.getElementById('nomorHp').value.trim(),
                tandaTangan: signatureCanvas.toDataURL('image/png'),
                fotoFront: fotoDataURLFront,
                fotoBack: fotoDataURLBack,
                timestamp: new Date().toLocaleString('id-ID')
            };
            dataBukuTamu.push(formData);
            updateDataCounter();
            resetFormComplete();
            return true;
        }

        // === UI ===
        function showForm() { /* sama */ }
        function showData() { /* sama */ }
        function displayData() { /* sama */ }
        function updateDataCounter() { document.getElementById('dataCount').textContent = dataBukuTamu.length; }
        function resetFormComplete() { /* reset semua field */ }

        // === EXPORT PDF DENGAN GAMBAR ===
        function exportData() {
            if (dataBukuTamu.length === 0) { alert('Tidak ada data!'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            const headers = [["No","Nama","Asal","Instansi","Kecamatan","Desa/Tiyuh","Pihak Ditemui","Jenis Layanan","Uraian","Nomor HP","Waktu","Tanda Tangan","Foto Depan","Foto Belakang"]];
            const body = dataBukuTamu.map((d,i) => [
                i+1, d.nama, d.asal, d.instansi||"-", d.kecamatan||"-", d.desa||"-",
                d.pihakDitemui, d.jenisLayanan, d.uraian, d.nomorHp, d.timestamp,
                "", "", "" // placeholder gambar
            ]);

            doc.autoTable({
                head: headers,
                body: body,
                startY: 20,
                theme: 'grid',
                headStyles: { fillColor: [0,123,255], textColor:255 },
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    11: { cellWidth: 35 },
                    12: { cellWidth: 35 },
                    13: { cellWidth: 35 }
                },
                didDrawCell: (data) => {
                    if (data.section === 'body' && data.column.index >= 11) {
                        const item = dataBukuTamu[data.row.index];
                        let img = null;
                        if (data.column.index === 11) img = item.tandaTangan;
                        if (data.column.index === 12) img = item.fotoFront;
                        if (data.column.index === 13) img = item.fotoBack;
                        if (img) {
                            doc.addImage(img, 'PNG', data.cell.x + 2, data.cell.y + 2, 31, 25);
                        }
                    }
                }
            });

            const today = new Date().toISOString().slice(0,10);
            doc.save(`Buku_Tamu_Inspektorat_Tubaba_${today}.pdf`);
            alert('PDF berhasil diunduh dengan tanda tangan dan foto!');
        }

        function autoResize(t) { t.style.height = 'auto'; t.style.height = t.scrollHeight + 'px'; }

        document.addEventListener('DOMContentLoaded', () => {
            resizeCanvas();
            showForm();
        });
    </script>
</body>
</html>
