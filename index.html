<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Buku Tamu Digital - Inspektorat Daerah Tubaba</title>
    <style>

        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; background: #0a0e27; }
        body { font-family: 'Arial', sans-serif; min-height: 100vh; }

        /* ========================================
           BINGKAI DEKORATIF EMAS - FRAME OVERLAY
           ======================================== */

        /* Layer 1 ‚Äì border emas utama (fixed, selalu di atas semua konten) */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            border: 10px solid transparent;
            border-image: linear-gradient(135deg,
                #f5e07a 0%,
                #d4a820 20%,
                #a07810 40%,
                #f5e07a 55%,
                #d4a820 70%,
                #c8960e 85%,
                #f5e07a 100%
            ) 1;
            box-shadow:
                inset 0 0 18px 4px rgba(212, 168, 32, 0.55),
                inset 0 0 6px 1px rgba(0, 0, 0, 0.55),
                0 0 22px 6px rgba(212, 168, 32, 0.30);
            pointer-events: none;
            z-index: 99999;
        }

        /* Layer 2 ‚Äì garis dalam halus */
        body::after {
            content: '';
            position: fixed;
            inset: 16px;
            border: 1.5px solid rgba(212, 168, 32, 0.40);
            box-shadow:
                inset 0 0 10px 2px rgba(212, 168, 32, 0.15),
                0 0 8px 2px rgba(212, 168, 32, 0.12);
            pointer-events: none;
            z-index: 99998;
            border-radius: 2px;
        }

        /* ‚îÄ‚îÄ Ornamen sudut dekoratif ‚îÄ‚îÄ */
        .corner-ornament {
            position: fixed;
            width: 48px;
            height: 48px;
            z-index: 99999;
            pointer-events: none;
        }
        .corner-ornament::before,
        .corner-ornament::after {
            content: '';
            position: absolute;
            background: linear-gradient(135deg, #f5e07a, #d4a820, #a07810);
        }
        .corner-ornament::before {
            width: 28px;
            height: 2.5px;
            top: 10px;
        }
        .corner-ornament::after {
            width: 2.5px;
            height: 28px;
            left: 10px;
        }
        .corner-ornament.tl { top: 10px;  left: 10px;  }
        .corner-ornament.tr { top: 10px;  right: 10px; transform: scaleX(-1); }
        .corner-ornament.bl { bottom: 10px; left: 10px;  transform: scaleY(-1); }
        .corner-ornament.br { bottom: 10px; right: 10px; transform: scale(-1,-1); }

        .corner-ornament .gem {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 9px;
            height: 9px;
            background: radial-gradient(circle at 35% 35%, #fff7a0, #d4a820, #7a5800);
            border-radius: 50%;
            box-shadow: 0 0 6px 2px rgba(212,168,32,0.7);
        }
        
        /* Welcome Page Styles */
        #welcomePage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2a2f4a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 26px;
        }
        
        #particleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .welcome-content {
            position: relative;
            z-index: 2;
            text-align: center;
            padding: 20px;
        }
        
        .welcome-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px rgba(102, 126, 234, 0.8),
                         0 0 40px rgba(118, 75, 162, 0.6);
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(102, 126, 234, 0.8), 0 0 40px rgba(118, 75, 162, 0.6); }
            to { text-shadow: 0 0 30px rgba(102, 126, 234, 1), 0 0 60px rgba(118, 75, 162, 0.8); }
        }
        
        .welcome-subtitle {
            font-size: 1.6em;
            font-weight: bold;
            color: #fff;
            margin-bottom: 40px;
            animation: fadeIn 1.5s ease-in;
        }
        
        .welcome-subtitle strong {
            font-size: 1.8em;
            display: block;
            margin-top: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn-start {
            padding: 15px 50px;
            font-size: 1.4em;
            font-weight: bold;
            background: linear-gradient(135deg, #0d1f45 0%, #1a3a6e 60%, #0d1f45 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .btn-start:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        body.app-aktif {
            background:
                linear-gradient(160deg,
                    #0a1628 0%,
                    #0d1f45 35%,
                    #0f2548 65%,
                    #0a1a38 100%
                ) fixed;
            background-attachment: fixed;
        }

        body.app-aktif::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            opacity: 0.045;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cdefs%3E%3Cpattern id='tp' x='0' y='0' width='200' height='200' patternUnits='userSpaceOnUse'%3E%3Crect width='200' height='200' fill='none'/%3E%3Cpath d='M100 4 L196 100 L100 196 L4 100 Z' fill='none' stroke='%23d4a820' stroke-width='2.5'/%3E%3Cpath d='M100 28 L172 100 L100 172 L28 100 Z' fill='none' stroke='%23f5e07a' stroke-width='1.5'/%3E%3Cpath d='M100 52 L148 100 L100 148 L52 100 Z' fill='none' stroke='%23d4a820' stroke-width='1'/%3E%3Cpolygon points='0,0 28,0 0,28' fill='%23d4a820'/%3E%3Cpolygon points='0,0 17,0 0,17' fill='%23f5e07a'/%3E%3Cpolygon points='200,0 172,0 200,28' fill='%23d4a820'/%3E%3Cpolygon points='200,0 183,0 200,17' fill='%23f5e07a'/%3E%3Cpolygon points='0,200 28,200 0,172' fill='%23d4a820'/%3E%3Cpolygon points='0,200 17,200 0,183' fill='%23f5e07a'/%3E%3Cpolygon points='200,200 172,200 200,172' fill='%23d4a820'/%3E%3Cpolygon points='200,200 183,200 200,183' fill='%23f5e07a'/%3E%3Cg transform='translate(100,100)'%3E%3Cpolygon points='0,-24 5,-5 24,0 5,5 0,24 -5,5 -24,0 -5,-5' fill='%23d4a820'/%3E%3Cpolygon points='0,-15 3.5,-3.5 15,0 3.5,3.5 0,15 -3.5,3.5 -15,0 -3.5,-3.5' fill='%23f5e07a'/%3E%3Ccircle cx='0' cy='0' r='6' fill='%23d4a820'/%3E%3Ccircle cx='0' cy='0' r='3' fill='%23f5e07a'/%3E%3C/g%3E%3Cg transform='translate(100,0)'%3E%3Cpolygon points='0,-8 2,-2 8,0 2,2 0,8 -2,2 -8,0 -2,-2' fill='%23d4a820'/%3E%3C/g%3E%3Cg transform='translate(100,200)'%3E%3Cpolygon points='0,-8 2,-2 8,0 2,2 0,8 -2,2 -8,0 -2,-2' fill='%23d4a820'/%3E%3C/g%3E%3Cg transform='translate(0,100)'%3E%3Cpolygon points='0,-8 2,-2 8,0 2,2 0,8 -2,2 -8,0 -2,-2' fill='%23d4a820'/%3E%3C/g%3E%3Cg transform='translate(200,100)'%3E%3Cpolygon points='0,-8 2,-2 8,0 2,2 0,8 -2,2 -8,0 -2,-2' fill='%23d4a820'/%3E%3C/g%3E%3C/pattern%3E%3C/defs%3E%3Crect width='200' height='200' fill='url(%23tp)'/%3E%3C/svg%3E");
            background-size: 200px 200px;
            background-repeat: repeat;
        }

        #mainApp {
            display: none;
            position: relative;
            z-index: 2;
            max-width: 720px;
            margin: 20px auto;
            padding: 0;
            border-radius: 12px 12px 8px 8px;
            background: #f7f3eb;
            box-shadow:
                0 2px 4px rgba(0,0,0,0.08),
                0 8px 24px rgba(0,0,0,0.22),
                0 20px 60px rgba(0,0,0,0.30),
                0 0 0 1px rgba(212,168,32,0.28);
            overflow: hidden;
        }

        #mainApp::before {
            content: '';
            display: block;
            height: 6px;
            background: linear-gradient(90deg,
                #a07810 0%, #d4a820 25%, #f5e07a 50%, #d4a820 75%, #a07810 100%
            );
            position: relative;
            z-index: 3;
        }

        #mainApp::after {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 0;
            opacity: 0.028;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cdefs%3E%3Cpattern id='in' x='0' y='0' width='120' height='120' patternUnits='userSpaceOnUse'%3E%3Cpath d='M60 5 L115 60 L60 115 L5 60 Z' fill='none' stroke='%23a07810' stroke-width='1.8'/%3E%3Cpath d='M60 24 L96 60 L60 96 L24 60 Z' fill='none' stroke='%23d4a820' stroke-width='1'/%3E%3Cg transform='translate(60,60)'%3E%3Cpolygon points='0,-14 3,-3 14,0 3,3 0,14 -3,3 -14,0 -3,-3' fill='%23a07810'/%3E%3Ccircle cx='0' cy='0' r='4' fill='%23d4a820'/%3E%3C/g%3E%3Cpolygon points='0,0 16,0 0,16' fill='%23a07810'/%3E%3Cpolygon points='120,0 104,0 120,16' fill='%23a07810'/%3E%3Cpolygon points='0,120 16,120 0,104' fill='%23a07810'/%3E%3Cpolygon points='120,120 104,120 120,104' fill='%23a07810'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='120' height='120' fill='url(%23in)'/%3E%3C/svg%3E");
            background-size: 120px 120px;
        }

        #mainApp > * { position: relative; z-index: 1; }

        .header-gambar {
            padding: 24px 20px 0 20px !important;
        }

        #mainApp label {
            display: block;
            padding-left: 10px;
            border-left: 3px solid #d4a820;
            color: #1a1a2e;
            font-size: 0.88em;
            letter-spacing: 0.03em;
            margin-top: 14px;
        }

        #mainApp select,
        #mainApp input:not([type='file']),
        #mainApp textarea {
            background-color: #ffffff !important;
            border: 1.5px solid #d0c8b8 !important;
            border-radius: 6px !important;
            color: #1a1a2e !important;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 0.95em;
        }

        #mainApp select:focus,
        #mainApp input:focus,
        #mainApp textarea:focus {
            outline: none !important;
            border-color: #d4a820 !important;
            box-shadow: 0 0 0 3px rgba(212,168,32,0.15) !important;
        }

        #formSection,
        #dataSection {
            padding: 16px 20px 28px 20px;
        }

        #mainNavigation {
            margin: 0 !important;
            padding: 14px 20px;
            background: linear-gradient(180deg, #f0ead8 0%, #e8dfc8 100%);
            border-top: 1px solid rgba(212,168,32,0.30);
            border-bottom: 1px solid rgba(212,168,32,0.20);
            text-align: center;
            display: none;
        }

        #mainNavigation button {
            background: linear-gradient(135deg, #0d1f45 0%, #1a3560 100%) !important;
            color: #f5e07a !important;
            padding: 10px 20px !important;
            border: 1px solid rgba(212,168,32,0.50) !important;
            border-radius: 6px !important;
            margin: 5px 4px !important;
            cursor: pointer !important;
            font-size: 0.92em !important;
            font-weight: bold !important;
            letter-spacing: 0.02em;
            box-shadow: 0 2px 6px rgba(0,0,0,0.18);
            transition: all 0.2s;
        }

        #mainNavigation button:hover {
            background: linear-gradient(135deg, #d4a820 0%, #f5e07a 100%) !important;
            color: #0d1f45 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212,168,32,0.35);
        }

        #mainApp .app-judul-utama {
            background: linear-gradient(135deg, #0d1f45 0%, #1a3a6e 60%, #0d1f45 100%);
            color: #f5e07a;
            text-align: center;
            padding: 18px 20px 16px;
            letter-spacing: 0.06em;
            font-weight: bold;
            font-size: 1em;
            line-height: 1.6;
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, transparent, #d4a820, #f5e07a, #d4a820, transparent) 1;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        #mainApp button[type="button"][onclick*="simpan"],
        #mainApp button[type="submit"],
        #mainApp #btnSimpan {
            background: linear-gradient(135deg, #0d1f45, #1a3560) !important;
            color: #f5e07a !important;
            border: 1px solid rgba(212,168,32,0.6) !important;
        }

        #mainApp .warning {
            background: linear-gradient(135deg, #fffbf0, #fff8e8);
            border: 1px solid rgba(212,168,32,0.50);
            border-left: 4px solid #d4a820;
            border-radius: 6px;
        }

        #dataSection h2 {
            color: #0d1f45;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, #d4a820, transparent) 1;
            padding-bottom: 8px;
            margin-bottom: 16px;
            font-size: 1.1em;
            letter-spacing: 0.04em;
        }
        
        .header-gambar { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: nowrap; padding: 24px 20px 0 20px; }
        .foto-kepala { width: 90px; height: auto; }
        .logo { width: 110px; height: auto; }
        
        label { font-weight: bold; }
        select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .hidden { display: none !important; }
        #welcomePage.tersembunyi { display: none !important; visibility: hidden !important; pointer-events: none !important; z-index: -1 !important; }
        .required { color: red; }
        .error { border: 2px solid red !important; }
        .success { border: 2px solid #28a745 !important; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; margin: 12px 0; border-radius: 6px; font-size: 0.95em; }        
       #mainNavigation { margin: 25px 0; text-align: center; display: none; }
        #mainNavigation button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            margin: 8px 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }
        
        #photoModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 15px;
        }

        #signature-pad { 
            background: white; 
            border: 3px solid #007bff;
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            display: block !important;
            margin: 10px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 300px;
            width: 100% !important;
            max-width: 600px;
            height: 200px !important;
        }
        
        .detail-container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            border: 1px solid rgba(212,168,32,0.25);
            box-shadow: 0 2px 10px rgba(13,31,69,0.10), 0 0 0 1px rgba(212,168,32,0.10);
            border-radius: 8px;
            overflow: hidden;
        }
        .detail-header {
            background: linear-gradient(135deg, #0d1f45 0%, #1a3a6e 60%, #0d1f45 100%);
            color: white;
            padding: 18px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .detail-row {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            min-height: 50px;
        }
        .detail-label {
            width: 200px;
            padding: 15px 24px;
            background-color: #fdf2dc;
            border-right: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 0.95em;
            color: #495057;
            display: flex;
            align-items: center;
        }
        .detail-value {
            flex: 1;
            padding: 16px 24px;
            font-size: 14px;
            color: #212529;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .welcome-title { font-size: 1.9em; }
            .detail-row { flex-direction: column; }
            .detail-label { width: 100%; border-right: none; border-bottom: 1px solid #e0e0e0; }
            .header-gambar { gap: 15px; }        
        }
    
        /* ===== STEP FORM ===== */

        /* ‚îÄ‚îÄ Header label ringkas (tetap di atas) ‚îÄ‚îÄ */
        #stepHeader {
            background: linear-gradient(135deg, #0d1f45 0%, #1a3a6e 100%);
            padding: 14px 20px 10px;
            color: #f5e07a;
        }
        #stepHeader .sh-title {
            font-size: 1em;
            font-weight: bold;
            letter-spacing: 0.06em;
        }
        #stepHeader .sh-sub {
            font-size: 0.72em;
            opacity: 0.65;
            margin-top: 2px;
            letter-spacing: 0.04em;
        }
        #stepHeader .sh-bar-wrap {
            margin-top: 8px;
            height: 4px;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
            overflow: hidden;
        }
        #stepHeader .sh-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f5e07a, #d4a820);
            border-radius: 2px;
            transition: width 0.55s ease;
        }

        /* ‚îÄ‚îÄ Area input aktif (satu field per waktu) ‚îÄ‚îÄ */
        #stepInputArea {
            background: #fffef8;
            padding: 18px 20px 14px;
            border-bottom: 1px solid rgba(212,168,32,0.2);
            min-height: 88px;
        }
        #stepInputArea > div { margin: 0; }
        #stepInputArea label {
            display: block;
            font-weight: bold;
            font-size: 0.93em;
            color: #0d1f45;
            margin-bottom: 7px;
        }
        .sf-enter {
            animation: sfSlideIn 0.38s cubic-bezier(0.22,1,0.36,1);
        }
        @keyframes sfSlideIn {
            from { opacity:0; transform: translateY(10px); }
            to   { opacity:1; transform: translateY(0); }
        }

        /* ‚îÄ‚îÄ Tombol Lanjut ‚îÄ‚îÄ */
        .btn-lanjut {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 26px;
            background: linear-gradient(135deg, #0d1f45, #1a3a6e);
            color: #f5e07a;
            border: none;
            border-radius: 20px;
            font-size: 0.87em;
            font-weight: bold;
            cursor: pointer;
            letter-spacing: 0.04em;
            box-shadow: 0 2px 8px rgba(13,31,69,.28);
            transition: transform .15s, box-shadow .15s;
        }
        .btn-lanjut:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(13,31,69,.38);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           SCROLL PAPER ‚Äî EFEK BERGULIR ANIMATIF
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #paperScroll {
            position: relative;
            margin: 0;
            overflow: hidden;
        }
        #paperScroll:empty { display: none; }

        /* Header tabel ringkasan */
        #psTableHead {
            display: none;
            background: linear-gradient(135deg, #0d1f45 0%, #1a3a6e 100%);
            color: #f5e07a;
            font-size: 0.78em;
            font-weight: 800;
            letter-spacing: 0.10em;
            padding: 10px 20px 9px;
            border-top: 2px solid rgba(212,168,32,0.5);
            border-bottom: 1px solid rgba(212,168,32,0.30);
            text-transform: uppercase;
        }

        /* ‚îÄ‚îÄ Baris isian (ps-row) ‚îÄ‚îÄ */
        .ps-row {
            display: grid;
            grid-template-columns: 22px 148px 14px 1fr;
            align-items: stretch;
            background: #fffef8;
            border-bottom: 1px solid rgba(212,168,32,0.15);
            position: relative;
            overflow: hidden;
            /* Animasi BERGULIR dari atas */
            clip-path: inset(0 0 100% 0);
            animation: rollDown 0.55s cubic-bezier(0.22,1,0.36,1) forwards;
        }
        .ps-row:nth-child(odd)  { background: #fffef8; }
        .ps-row:nth-child(even) { background: #fff8e8; }

        /* Garis aksen emas kiri */
        .ps-row::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0; width: 3.5px;
            background: linear-gradient(180deg, #f5e07a 0%, #d4a820 50%, #b8860b 100%);
        }

        /* ‚îÄ‚îÄ Keyframe: gulir turun seperti tirai membuka ‚îÄ‚îÄ */
        @keyframes rollDown {
            0%   {
                clip-path: inset(0 0 100% 0);
                transform: translateY(-6px);
                opacity: 0;
            }
            40%  { opacity: 1; }
            100% {
                clip-path: inset(0 0 0% 0);
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ‚îÄ‚îÄ Nomor urut ‚îÄ‚îÄ */
        .ps-num {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0 10px 6px;
        }
        .ps-num-inner {
            width: 18px; height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0d1f45, #1a3a6e);
            color: #f5e07a;
            font-size: 0.62em;
            font-weight: 800;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 1px 5px rgba(13,31,69,.30);
        }

        /* ‚îÄ‚îÄ Label (kolom tengah) ‚îÄ‚îÄ */
        .ps-lbl {
            padding: 10px 8px 10px 10px;
            font-size: 0.80em;
            font-weight: 700;
            color: #0d1f45;
            background: rgba(253,242,220,0.50);
            border-right: 1.5px solid rgba(212,168,32,0.28);
            display: flex;
            align-items: center;
            line-height: 1.3;
            /* Transisi label: teks muncul setelah baris muncul */
            animation: fadeLabel 0.4s 0.25s ease both;
        }
        @keyframes fadeLabel {
            from { opacity:0; transform: translateX(-5px); }
            to   { opacity:1; transform: translateX(0); }
        }

        /* ‚îÄ‚îÄ Titik dua ‚îÄ‚îÄ */
        .ps-sep {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 2px;
            font-weight: 800;
            color: #b8860b;
            font-size: 0.90em;
            background: rgba(253,242,220,0.30);
            border-right: 1px solid rgba(212,168,32,0.15);
        }

        /* ‚îÄ‚îÄ Nilai (kolom kanan) ‚îÄ‚îÄ */
        .ps-val {
            padding: 10px 14px 10px 10px;
            font-size: 0.88em;
            font-weight: 600;
            color: #1a1a2e;
            display: flex;
            align-items: center;
            word-break: break-word;
            line-height: 1.4;
            /* Efek nilai muncul seperti tertulis */
            overflow: hidden;
        }
        .ps-val-inner {
            display: inline-block;
            animation: slideVal 0.45s 0.35s cubic-bezier(0.22,1,0.36,1) both;
        }
        @keyframes slideVal {
            from {
                opacity: 0;
                transform: translateX(18px);
                filter: blur(3px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
                filter: blur(0);
            }
        }

        /* Baris TTD ‚Äî tampil khusus dengan latar beda */
        .ps-row[data-field="tandaTangan"] {
            background: linear-gradient(90deg, rgba(13,31,69,0.06), rgba(212,168,32,0.06));
        }
        .ps-row[data-field="tandaTangan"] .ps-val-inner {
            color: #1a7a1a;
            font-weight: 800;
        }

        /* Separator seksi DOKUMENTASI */
        .ps-section-sep {
            display: none;
            background: linear-gradient(90deg, #0d1f45, #1a3a6e, #0d1f45);
            color: #f5e07a;
            font-size: 0.72em;
            font-weight: 800;
            letter-spacing: 0.10em;
            padding: 7px 20px;
            text-transform: uppercase;
            border-top: 1px solid rgba(212,168,32,0.35);
            border-bottom: 1px solid rgba(212,168,32,0.35);
            animation: rollDown 0.45s cubic-bezier(0.22,1,0.36,1) both;
        }

        /* Shadow bawah kertas */
        #paperScroll::after {
            content: '';
            display: block;
            height: 6px;
            background: linear-gradient(180deg, rgba(160,120,16,0.12), transparent);
        }

        /* ‚îÄ‚îÄ Stagger animasi: setiap baris sedikit terlambat ‚îÄ‚îÄ */
        .ps-row:nth-child(1)  { animation-delay: 0ms; }
        .ps-row:nth-child(2)  { animation-delay: 0ms; }
        .ps-row:nth-child(3)  { animation-delay: 0ms; }
        /* dst ‚Äî tidak perlu stagger karena tiap baris muncul satu persatu */

        /* ‚îÄ‚îÄ Kilap emas saat baris muncul ‚îÄ‚îÄ */
        .ps-row::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(245,224,122,0.18) 40%,
                rgba(245,224,122,0.32) 52%,
                rgba(245,224,122,0.18) 64%,
                transparent 100%
            );
            transform: translateX(-100%);
            animation: shimmer 0.70s 0.20s ease forwards;
            pointer-events: none;
        }
        @keyframes shimmer {
            0%   { transform: translateX(-100%); opacity:1; }
            100% { transform: translateX(110%);  opacity:0; }
        }

        /* ‚îÄ‚îÄ Update nilai: flash highlight ‚îÄ‚îÄ */
        .ps-val-inner.updated {
            animation: flashUpdate 0.50s ease both;
        }
        @keyframes flashUpdate {
            0%   { background: rgba(212,168,32,0.35); border-radius:3px; }
            100% { background: transparent; }
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           OVERLAY PRATINJAU DATA LENGKAP TAMU
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        #overlayPratinjau {
            position: fixed;
            inset: 0;
            z-index: 99000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        /* Backdrop gelap */
        .op-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(5, 8, 30, 0.82);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            animation: opFadeIn 0.35s ease both;
        }
        @keyframes opFadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        /* Panel utama ‚Äî sheet dari bawah */
        .op-panel {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 680px;
            max-height: 96dvh;
            max-height: 96vh;
            display: flex;
            flex-direction: column;
            background: #f7f3eb;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
            box-shadow:
                0 -8px 40px rgba(13,31,69,0.45),
                0 0 0 1.5px rgba(212,168,32,0.45);
            animation: opSlideUp 0.42s cubic-bezier(0.22,1,0.36,1) both;
        }
        @keyframes opSlideUp {
            from { transform: translateY(100%); opacity: 0.4; }
            to   { transform: translateY(0);    opacity: 1; }
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .op-header {
            flex-shrink: 0;
            background: linear-gradient(135deg, #0d1f45 0%, #1a3a6e 60%, #0d1f45 100%);
            padding: 14px 16px 12px;
            border-bottom: 2.5px solid transparent;
            border-image: linear-gradient(90deg, transparent, #d4a820, #f5e07a, #d4a820, transparent) 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .op-header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }
        .op-logo-img {
            width: 38px;
            height: 38px;
            object-fit: contain;
            flex-shrink: 0;
        }
        .op-header-text {
            min-width: 0;
        }
        .op-htitle {
            font-size: 0.80em;
            font-weight: 800;
            color: #f5e07a;
            letter-spacing: 0.08em;
            white-space: nowrap;
        }
        .op-hsubtitle {
            font-size: 0.64em;
            color: rgba(245,224,122,0.70);
            letter-spacing: 0.04em;
            margin-top: 2px;
        }
        .op-timestamp {
            font-size: 0.64em;
            color: rgba(245,224,122,0.60);
            text-align: right;
            flex-shrink: 0;
            line-height: 1.4;
        }
        .op-close-btn {
            background: rgba(245,224,122,0.15);
            border: 1px solid rgba(245,224,122,0.35);
            color: #f5e07a;
            width: 32px; height: 32px;
            border-radius: 50%;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .op-close-btn:hover { background: rgba(245,224,122,0.30); }

        /* ‚îÄ‚îÄ Body ‚îÄ‚îÄ */
        .op-body {
            flex: 1;
            overflow-y: auto;
            padding: 14px 14px 10px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        .op-body::-webkit-scrollbar { width: 4px; }
        .op-body::-webkit-scrollbar-thumb { background: rgba(212,168,32,0.35); border-radius: 2px; }

        /* ‚îÄ‚îÄ Kartu ‚îÄ‚îÄ */
        .op-card {
            background: #fff;
            border: 1.5px solid rgba(212,168,32,0.30);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(13,31,69,0.08);
            animation: opCardIn 0.40s cubic-bezier(0.22,1,0.36,1) both;
        }
        .op-card:nth-child(1) { animation-delay: 0.08s; }
        .op-card:nth-child(2) { animation-delay: 0.18s; }
        @keyframes opCardIn {
            from { opacity:0; transform: translateY(16px); }
            to   { opacity:1; transform: translateY(0); }
        }
        .op-card-title {
            background: linear-gradient(90deg, #0d1f45, #1a3a6e);
            color: #f5e07a;
            font-size: 0.76em;
            font-weight: 800;
            letter-spacing: 0.09em;
            padding: 8px 14px;
            text-transform: uppercase;
        }

        /* ‚îÄ‚îÄ Tabel data ‚îÄ‚îÄ */
        .op-table {}
        .op-row {
            display: grid;
            grid-template-columns: 140px 12px 1fr;
            border-bottom: 1px solid rgba(212,168,32,0.14);
            min-height: 38px;
        }
        .op-row:last-child { border-bottom: none; }
        .op-row:nth-child(odd)  { background: #fffef8; }
        .op-row:nth-child(even) { background: #fff; }
        .op-rlbl {
            padding: 9px 8px 9px 14px;
            font-size: 0.78em;
            font-weight: 700;
            color: #0d1f45;
            border-right: 2px solid rgba(212,168,32,0.28);
            background: rgba(253,242,220,0.50);
            display: flex;
            align-items: center;
            line-height: 1.3;
        }
        .op-rsep {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #b8860b;
            font-size: 0.85em;
        }
        .op-rval {
            padding: 9px 12px;
            font-size: 0.84em;
            font-weight: 600;
            color: #1a1a2e;
            display: flex;
            align-items: center;
            word-break: break-word;
            line-height: 1.4;
        }

        /* ‚îÄ‚îÄ Foto grid ‚îÄ‚îÄ */
        .op-foto-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 12px 12px 6px;
        }
        .op-foto-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .op-foto-label {
            font-size: 0.72em;
            font-weight: 700;
            color: #0d1f45;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            align-self: flex-start;
        }
        .op-foto-img {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            border-radius: 8px;
            border: 1.5px solid rgba(212,168,32,0.35);
            box-shadow: 0 2px 8px rgba(13,31,69,0.14);
            display: none;
        }
        .op-foto-empty {
            width: 100%;
            aspect-ratio: 4/3;
            background: #f0ead8;
            border: 1.5px dashed rgba(212,168,32,0.40);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.72em;
            color: #aaa;
        }

        /* ‚îÄ‚îÄ Tanda Tangan ‚îÄ‚îÄ */
        .op-ttd-wrap {
            padding: 6px 12px 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .op-ttd-wrap .op-foto-label {
            align-self: flex-start;
        }
        .op-ttd-box {
            width: 100%;
            max-width: 340px;
            min-height: 80px;
            border: 1.5px solid rgba(212,168,32,0.35);
            border-radius: 8px;
            background: #fff;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(13,31,69,0.10);
        }
        .op-ttd-img {
            width: 100%;
            max-height: 110px;
            object-fit: contain;
            display: none;
        }
        .op-nama-ttd {
            font-size: 0.82em;
            font-weight: 700;
            color: #0d1f45;
            margin-top: 2px;
            letter-spacing: 0.03em;
        }

        /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
        .op-footer {
            flex-shrink: 0;
            display: flex;
            gap: 10px;
            padding: 12px 14px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            background: linear-gradient(0deg, #f0ead8 0%, #f7f3eb 100%);
            border-top: 1px solid rgba(212,168,32,0.28);
        }
        .op-btn {
            flex: 1;
            padding: 13px 10px;
            border: none;
            border-radius: 10px;
            font-size: 0.90em;
            font-weight: 800;
            cursor: pointer;
            letter-spacing: 0.02em;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .op-btn:active { transform: scale(0.97); }
        .op-btn-secondary {
            background: #fff;
            color: #0d1f45;
            border: 1.5px solid rgba(13,31,69,0.30);
        }
        .op-btn-primary {
            background: linear-gradient(135deg, #0d1f45, #1a3a6e);
            color: #f5e07a;
            box-shadow: 0 4px 16px rgba(13,31,69,0.35);
        }
        .op-btn-primary:hover { box-shadow: 0 6px 22px rgba(13,31,69,0.50); }


        @keyframes opSlideDown {
            from { transform: translateY(0);    opacity: 1; }
            to   { transform: translateY(110%); opacity: 0.2; }
        }
        /* ‚îÄ‚îÄ Responsive Desktop (>600px) ‚îÄ‚îÄ */
        @media (min-width: 600px) {
            #overlayPratinjau {
                align-items: center;
            }
            .op-panel {
                border-radius: 16px;
                max-height: 92dvh;
                max-height: 92vh;
                margin: 20px;
                box-shadow:
                    0 20px 60px rgba(13,31,69,0.50),
                    0 0 0 1.5px rgba(212,168,32,0.45);
                animation: opZoomIn 0.38s cubic-bezier(0.22,1,0.36,1) both;
            }
            @keyframes opZoomIn {
                from { transform: scale(0.92) translateY(30px); opacity: 0.3; }
                to   { transform: scale(1)    translateY(0);    opacity: 1; }
            }
        }


        /* ‚îÄ‚îÄ Pratinjau TTD di ringkasan ‚îÄ‚îÄ */
        .ps-val-ttd {
            padding: 6px 10px !important;
            align-items: center !important;
        }
        .ps-ttd-preview {
            max-height: 52px;
            max-width: 100%;
            width: auto;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid rgba(212,168,32,0.30);
            background: #fff;
            box-shadow: 0 1px 5px rgba(13,31,69,0.10);
            display: block;
            transition: opacity 0.22s ease;
            animation: ttdFadeIn 0.45s 0.35s ease both;
        }
        @keyframes ttdFadeIn {
            from { opacity:0; transform: scale(0.92); }
            to   { opacity:1; transform: scale(1); }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        #logoCanvas3D {
            position: relative;
            display: block;
            width: 300px;
            height: 300px;
            margin: 0 auto 20px auto;
            opacity: 0;
            border-radius: 8px;
        }
    </style>
</head>

<body>
<!-- Ornamen sudut bingkai emas -->
<div class="corner-ornament tl" aria-hidden="true"><div class="gem"></div></div>
<div class="corner-ornament tr" aria-hidden="true"><div class="gem"></div></div>
<div class="corner-ornament bl" aria-hidden="true"><div class="gem"></div></div>
<div class="corner-ornament br" aria-hidden="true"><div class="gem"></div></div>
<!-- Welcome Page -->
<div id="welcomePage">
    <canvas id="particleCanvas"></canvas>
    <div class="welcome-content">
        <canvas id="logoCanvas3D"></canvas>
        <h1 class="welcome-title">SELAMAT DATANG</h1>
        <p class="welcome-subtitle">DI <strong>INSPEKTORAT DAERAH</strong><br/>KABUPATEN TULANG BAWANG BARAT</p>
        <button class="btn-start" onclick="startApp()">üìù ISI BUKU TAMU</button>
    </div>
</div>

<!-- Main Application -->
<div id="mainApp">
    <div class="header-gambar">
        <img src="bupati.png" alt="Wakil Bupati" class="foto-kepala" onerror="this.style.display='none'">
        <img src="logo-tubaba.png" alt="Logo Tubaba" class="logo" onerror="this.style.display='none'">
        <img src="wakil-bupati.png" alt="Bupati" class="foto-kepala" onerror="this.style.display='none'">
    </div>

    <div class="app-judul-utama">
        <div style="font-size:0.85em; opacity:0.80; letter-spacing:0.12em;">‚ú¶ BUKU TAMU DIGITAL ‚ú¶</div>
        <div style="font-size:1.05em; margin: 4px 0;">INSPEKTORAT DAERAH</div>
        <div style="font-size:0.9em; opacity:0.88;">KABUPATEN TULANG BAWANG BARAT</div>
    </div>

    <div id="formSection">

        <!-- ‚ïê‚ïê HEADER: label ringkas mewakili semua field ‚ïê‚ïê -->
        <div id="stepHeader">
            <div class="sh-title">üìã FORMULIR BUKU TAMU</div>
            <div class="sh-sub" id="shSub">Nama ¬∑ Asal ¬∑ Instansi/Kecamatan ¬∑ Pihak Ditemui ¬∑ Layanan ¬∑ Uraian ¬∑ No. WA ¬∑ Tanda Tangan</div>
            <div class="sh-bar-wrap"><div class="sh-bar" id="shBar"></div></div>
        </div>

        <form id="bukuTamuForm">

            <!-- ‚ïê‚ïê AREA INPUT AKTIF (satu field per waktu) ‚ïê‚ïê -->
            <div id="stepInputArea">

                <!-- Banner mode edit bebas -->
                <div id="editBannerOverlay" style="display:none; align-items:center; gap:10px; background:linear-gradient(135deg,#0d1f45,#1a3a6e); color:#f5e07a; padding:10px 16px; font-size:0.84em; font-weight:700; letter-spacing:0.04em; animation: sfSlideIn 0.4s ease both;">
                    <span style="font-size:1.2em;">‚úèÔ∏è</span>
                    <span style="flex:1;">MODE EDIT ‚Äî Ubah data sesuai kebutuhan, lalu ambil foto ulang</span>
                    <button type="button" onclick="selesaiEditBebas()" style="background:rgba(245,224,122,0.20);border:1px solid rgba(245,224,122,0.50);color:#f5e07a;padding:5px 12px;border-radius:16px;font-size:0.85em;font-weight:800;cursor:pointer;white-space:nowrap;">
                        üîç Pratinjau
                    </button>
                </div>

                <div id="field-nama">
                    <label>üë§ Nama Lengkap <span class="required">*</span></label>
                    <input id="nama" required type="text" placeholder="Minimal 5 huruf"
                        oninput="validateNama(); autoStepNama();"
                        onkeydown="if(event.key==='Enter'){event.preventDefault();stepNama();}"/>
                    <small id="namaHint" style="color:#888;font-size:0.75em;">Akan lanjut otomatis setelah selesai mengetik</small>
                </div>

                <div id="field-asal" class="hidden">
                    <label>üè† Asal / Instansi <span class="required">*</span></label>
                    <select id="asal" required onchange="asalChanged();">
                        <option value="">-- Pilih Asal --</option>
                        <option value="INSTANSI">INSTANSI / UNIT KERJA</option>
                        <option value="MASYARAKAT">MASYARAKAT</option>
                    </select>
                </div>

                <div class="hidden" id="daftarInstansi">
                    <label>üè¢ Instansi / Unit Kerja <span class="required">*</span></label>
                    <select id="instansi" onchange="checkAndShowNext('instansi', 'field-pihakDitemui');">
                        <option value="">-- Pilih Instansi --</option>
                        <option>SEKRETARIAT DAERAH</option>
                        <option>SEKRETARIAT DPRD</option>
                        <option>BADAN PERENCANAAN PEMBANGUNAN DAERAH</option>
                        <option>BADAN PENGELOLAAN KEUANGAN DAN ASET DAERAH</option>
                        <option>BADAN PENGELOLAAN PAJAK DAN RETRIBUSI DAERAH</option>
                        <option>BADAN KEPEGAWAIAN DAN PENGEMBANGAN SUMBER DAYA MANUSIA</option>
                        <option>BADAN KESATUAN BANGSA DAN POLITIK DAERAH</option>
                        <option>BADAN PENANGGULANGAN BENCANA DAERAH</option>
                        <option>DINAS LINGKUNGAN HIDUP</option>
                        <option>DINAS KESEHATAN</option>
                        <option>DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                        <option>DINAS KOPERASI, UMKM, PERINDUSTRIAN DAN PERDAGANGAN</option>
                        <option>DINAS SOSIAL</option>
                        <option>DINAS PEMUDA, OLAHRAGA DAN PARIWISATA</option>
                        <option>DINAS KOMUNIKASI DAN INFORMATIKA</option>
                        <option>DINAS PERUMAHAN, KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                        <option>DINAS PENANAMAN MODAL DAN PELAYANAN PERIZINAN TERPADU SATU PINTU</option>
                        <option>DINAS PENDIDIKAN DAN KEBUDAYAAN</option>
                        <option>DINAS KETAHANAN PANGAN</option>
                        <option>DINAS PEMBERDAYAAN MASYARAKAT DAN TIYUH</option>
                        <option>DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                        <option>DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                        <option>DINAS PERHUBUNGAN</option>
                        <option>DINAS PERTANIAN</option>
                        <option>DINAS PETERNAKAN DAN KESEHATAN HEWAN</option>
                        <option>DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                        <option>DINAS TENAGA KERJA DAN TRANSMIGRASI</option>
                        <option>DINAS PERIKANAN</option>
                        <option>DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                        <option>DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</option>
                        <option>SATUAN POLISI PAMONG PRAJA</option>
                        <option>BADAN PENGAWASAN KEUANGAN DAN PEMBANGUNAN (BPKP)</option>
                        <option>LAINNYA</option>
                    </select>
                </div>

                <div class="hidden" id="daftarMasyarakat">
                    <label>üó∫Ô∏è Kecamatan <span class="required">*</span></label>
                    <select id="kecamatan" onchange="updateDesaList();">
                        <option value="">-- Pilih Kecamatan --</option>
                        <option value="Tulang Bawang Tengah">1. Tulang Bawang Tengah</option>
                        <option value="Tulang Bawang Udik">2. Tulang Bawang Udik</option>
                        <option value="Tumijajar">3. Tumijajar</option>
                        <option value="Gunung Agung">4. Gunung Agung</option>
                        <option value="Way Kenanga">5. Way Kenanga</option>
                        <option value="Gunung Terang">6. Gunung Terang</option>
                        <option value="Lambu Kibang">7. Lambu Kibang</option>
                        <option value="Pagar Dewa">8. Pagar Dewa</option>
                        <option value="Batu Putih">9. Batu Putih</option>
                    </select>
                </div>

                <div class="hidden" id="fieldDesa">
                    <label>üèòÔ∏è Desa / Kelurahan <span class="required">*</span></label>
                    <select id="desa" onchange="checkAndShowNext('desa', 'field-pihakDitemui');"></select>
                </div>

                <div id="field-pihakDitemui" class="hidden">
                    <label>üë• Pihak yang Ditemui <span class="required">*</span></label>
                    <select id="pihakDitemui" required onchange="checkAndShowNext('pihakDitemui', 'field-jenisLayanan');">
                        <option value="">-- Pilih --</option>
                        <option>INSPEKTUR</option>
                        <option>SEKRETARIS</option>
                        <option>IRBANSUS</option>
                        <option>IRBAN 1</option>
                        <option>IRBAN 2</option>
                        <option>IRBAN 3</option>
                        <option>IRBAN 4</option>
                    </select>
                </div>

                <div id="field-jenisLayanan" class="hidden">
                    <label>üìã Jenis Layanan <span class="required">*</span></label>
                    <select id="jenisLayanan" required onchange="checkAndShowNext('jenisLayanan', 'field-uraian');">
                        <option value="">-- Pilih --</option>
                        <option>Permintaan Audit/Klarifikasi Khusus</option>
                        <option>Penanganan Pengaduan</option>
                        <option>Layanan Informasi Publik</option>
                        <option>Pembinaan &amp; Konsultasi</option>
                        <option>Audit</option>
                        <option>Review</option>
                        <option>Evaluasi / Monitoring</option>
                        <option>Tindak Lanjut Temuan</option>
                    </select>
                </div>

                <div id="field-uraian" class="hidden">
                    <label>üìù Uraian Keperluan <span class="required">*</span></label>
                    <textarea id="uraian" required rows="3"
                        oninput="validateUraian(); autoResize(this); autoStepUraian();"
                        onkeydown="if(event.ctrlKey&&event.key==='Enter'){event.preventDefault();stepUraian();}"></textarea>
                    <small style="color:#888;font-size:0.75em;">Akan lanjut otomatis setelah selesai mengetik (min. 10 karakter)</small>
                </div>

                <div id="field-nomorHp" class="hidden">
                    <label>üì± Nomor WhatsApp <span class="required">*</span></label>
                    <small style="color:#555; display:block; margin-bottom:4px;">Awali dengan <strong>08</strong> (contoh: 081234567890)</small>
                    <input id="nomorHp" required type="tel" placeholder="08xxxxxxxxxx"
                        pattern="08[0-9]{9,11}" maxlength="13" minlength="11"
                        oninput="validateNomorHp(this); autoStepNomorHp();"
                        onkeydown="if(event.key==='Enter'){event.preventDefault();stepNomorHp();}"/>
                    <small id="nomorHpInfo" style="color:#dc3545; display:block; min-height:1.2em;"></small>
                    <small style="color:#888;font-size:0.75em;">Akan lanjut otomatis setelah nomor valid</small>
                </div>

                <div id="field-tandaTangan" class="hidden">
                    <label>‚úçÔ∏è Tanda Tangan <span class="required">*</span></label>
                    <div class="warning" id="signatureWarning" style="display:none;">‚ö†Ô∏è Tanda tangan terlalu pendek (min 2 cm)</div>
                    <canvas id="signature-pad" width="900" height="25"></canvas>
                </div>

                <!-- Tombol Aksi setelah TTD selesai -->
                <div id="field-aksi" class="hidden" style="margin-top:1px; text-align:center;">
                    <div style="margin-bottom:15px;">
                        <button type="button" onclick="bukaKamera()"
                                style="font-size:16px; background:#ffc107; color:black; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; margin:0 10px;">
                            üì∏ Ambil Foto
                        </button>
                        <button type="button" onclick="clearSignature()"
                                style="font-size:16px; background:#dc3545; color:white; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; margin:0 1px;">
                            üóëÔ∏è Hapus Tanda Tangan
                        </button>
                    </div>
                    <div class="warning" id="photoWarning" style="display:none; margin:10px 0;">‚ö†Ô∏è Foto wajib diambil!</div>
                    <div id="photoPreview" style="margin-top:20px; margin-bottom:40px; display:flex; flex-wrap:wrap; gap:20px; justify-content:center;">
                        <div style="text-align:center;">
                            <img id="imgFront" style="max-width:220px; border:1px solid #ccc; border-radius:8px; display:none;" alt="Foto Depan">
                        </div>
                        <div style="text-align:center;">
                            <img id="imgBack" style="max-width:220px; border:1px solid #ccc; border-radius:8px; display:none;" alt="Foto Belakang">
                        </div>
                    </div>
                </div>

            </div><!-- /stepInputArea -->

        </form>

        <!-- ‚ïê‚ïê KERTAS TERURAI: jawaban bergulir animatif ‚ïê‚ïê -->
        <div id="paperScroll">
            <div id="psTableHead" style="display:none;">üìã RINGKASAN ISIAN</div>
            <div id="ps-section-dok" class="ps-section-sep" style="display:none;">üì∑ Dokumentasi Foto &amp; Tanda Tangan</div>
        </div>

    </div>

    <div id="editModeButtons" style="margin-bottom: 80px; text-align: center; display: none;">
        <button type="button" onclick="saveEditedData()" 
                style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 5px; margin: 0 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
            üíæ Simpan Perubahan
        </button>
        <button type="button" onclick="cancelEdit()" 
                style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 5px; margin: 0 10px; cursor: pointer; font-size: 16px; font-weight: bold;">
            ‚ùå Batal
        </button>
    </div>

    <div id="mainNavigation">
        <button onclick="showForm()" id="btnForm">üìù Form Input</button>
        <button onclick="showData()" id="btnData" style="display:none;">üìä Lihat Data (<span id="dataCount">0</span>)</button>
        <button onclick="exportData()" id="btnExport" style="display:none;">üìë Export Tabel Ringkasan</button>
        <button onclick="resetSemuaData()" id="btnReset" style="display:none; background: linear-gradient(135deg,#7b0000,#c0392b) !important; color:#fff !important;">üóëÔ∏è Hapus Semua Data</button>
    </div>

    <div id="dataSection" style="display: none;">
        <h2>üìä DATA BUKU TAMU</h2>
        <div style="margin-bottom: 20px;"></div>
        <div id="dataContainer"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         OVERLAY PRATINJAU DATA LENGKAP TAMU
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="overlayPratinjau" style="display:none;">
        <!-- Backdrop -->
        <div class="op-backdrop" onclick="tutupOverlay()"></div>

        <!-- Panel utama -->
        <div class="op-panel" id="opPanel">

            <!-- Header panel -->
            <div class="op-header">
                <div class="op-header-logo">
                    <img src="logo-tubaba.png" alt="Logo" class="op-logo-img" onerror="this.style.display='none'">
                    <div class="op-header-text">
                        <div class="op-htitle">‚ú¶ BUKU TAMU DIGITAL ‚ú¶</div>
                        <div class="op-hsubtitle">INSPEKTORAT DAERAH ¬∑ KAB. TULANG BAWANG BARAT</div>
                    </div>
                </div>
                <div class="op-timestamp" id="opTimestamp"></div>
                <button class="op-close-btn" onclick="tutupOverlay()" title="Tutup">‚úï</button>
            </div>

            <!-- Body scrollable -->
            <div class="op-body" id="opBody">

                <!-- Kartu data tamu -->
                <div class="op-card">
                    <div class="op-card-title">üìã DATA TAMU</div>
                    <div class="op-table" id="opDataTable">
                        <!-- Diisi JS -->
                    </div>
                </div>

                <!-- Kartu foto & TTD -->
                <div class="op-card" id="opCardFoto">
                    <div class="op-card-title">üì∑ DOKUMENTASI &amp; TANDA TANGAN</div>
                    <div class="op-foto-grid">
                        <div class="op-foto-box">
                            <div class="op-foto-label">Foto Depan</div>
                            <img id="opImgFront" class="op-foto-img" src="" alt="Foto Depan">
                            <div class="op-foto-empty" id="opImgFrontEmpty">Belum ada foto</div>
                        </div>
                        <div class="op-foto-box">
                            <div class="op-foto-label">Foto Belakang</div>
                            <img id="opImgBack" class="op-foto-img" src="" alt="Foto Belakang">
                            <div class="op-foto-empty" id="opImgBackEmpty">Belum ada foto</div>
                        </div>
                    </div>
                    <div class="op-ttd-wrap">
                        <div class="op-foto-label">Tanda Tangan</div>
                        <div class="op-ttd-box">
                            <img id="opImgTTD" class="op-ttd-img" src="" alt="Tanda Tangan">
                            <div class="op-foto-empty" id="opTTDEmpty">Belum ada tanda tangan</div>
                        </div>
                        <div class="op-nama-ttd" id="opNamaTTD"></div>
                    </div>
                </div>

            </div><!-- /op-body -->

            <!-- Footer tombol aksi -->
            <div class="op-footer">
                <button class="op-btn op-btn-secondary" onclick="editDariOverlay()">‚úèÔ∏è Edit Data</button>
                <button class="op-btn op-btn-primary" onclick="simpanDetailDariOverlay()">üñ®Ô∏è Simpan Detail Lengkap (Per Tamu)</button>
            </div>
        </div>
    </div>

    <!-- MODAL KAMERA -->
    <div id="photoModal">
        <div style="background:#fff; padding:20px; border-radius:12px; max-width:95%; width:100%; max-height:95vh; overflow-y:auto; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.4);">
            <h3 style="margin:0 0 15px; color:#333;">Ambil Dokumentasi Foto</h3>
            
            <div id="infoKamera" style="font-size:1.1em; font-weight:bold; margin-bottom:15px; color:#007bff;">
                Ambil foto pertama
            </div>

            <video id="video" autoplay playsinline muted style="width:100%; max-width:420px; background:#000; border-radius:8px; margin-bottom:20px;"></video>

            <div style="margin:20px 0;">
                <button type="button" class="btn-capture" onclick="capture()" 
                        style="background:#28a745; color:white; border:none; padding:14px 32px; font-size:1.2em; border-radius:50px; cursor:pointer; margin:0 10px; box-shadow:0 4px 12px rgba(40,167,69,0.4);">
                    üì∏ Ambil Foto
                </button>
                <button type="button" class="btn-cancel" onclick="stopAll()" 
                        style="background:#dc3545; color:white; border:none; padding:14px 32px; font-size:1.2em; border-radius:50px; cursor:pointer; margin:0 10px;">
                    ‚ùå Batal
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== LOGO 3D (Three.js) =====
(function() {
    const LOGO_IMG_URL = "https://upload.wikimedia.org/wikipedia/commons/6/6b/Lambang_Kabupaten_Tulang_Bawang_Barat.png";

    const logoImgEl = new Image();
    logoImgEl.crossOrigin = "anonymous";
    logoImgEl.src = LOGO_IMG_URL;

    logoImgEl.onload = function() {
        const oc = document.createElement("canvas"), ot = oc.getContext("2d");
        const MAXW = Math.min(300, 300);
        const SC = Math.min(1, MAXW / logoImgEl.width);
        oc.width = Math.round(logoImgEl.width * SC);
        oc.height = Math.round(logoImgEl.height * SC);
        ot.drawImage(logoImgEl, 0, 0, oc.width, oc.height);
        const px = ot.getImageData(0, 0, oc.width, oc.height);

        const LP = [], RP = [];
        for (let y = 0; y < oc.height; y++) {
            let lx = -1, rx = -1;
            for (let x = 0; x < oc.width; x++) if (px.data[(y * oc.width + x) * 4 + 3] > 20) { lx = x; break; }
            for (let x = oc.width - 1; x >= 0; x--) if (px.data[(y * oc.width + x) * 4 + 3] > 20) { rx = x; break; }
            if (lx >= 0 && rx >= 0) {
                const W3 = 2.0, H3 = 2.0 * (oc.height / oc.width), ny = y / oc.height;
                LP.push([-W3 / 2 + (lx / oc.width) * W3, H3 / 2 - ny * H3]);
                RP.push([-W3 / 2 + (rx / oc.width) * W3, H3 / 2 - ny * H3]);
            }
        }
        launchLogo3D({ LP, RP });
    };

    logoImgEl.onerror = function() { console.warn("Logo 3D: Gagal memuat gambar logo."); };

    function launchLogo3D({ LP, RP }) {
        const c3 = document.getElementById("logoCanvas3D");
        if (!c3) return;

        const logoR = new THREE.WebGLRenderer({ canvas: c3, antialias: true, alpha: true });
        logoR.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        logoR.setSize(300, 300);
        logoR.setClearColor(0x000000, 0);

        const logoScene = new THREE.Scene();
        const logoCam = new THREE.PerspectiveCamera(38, 1, 0.1, 200);
        logoCam.position.set(0, 0.3, 7.2);
        logoCam.lookAt(0, 0, 0);

        logoScene.add(new THREE.AmbientLight(0xffffff, 1.0));
        const kl = new THREE.DirectionalLight(0xfffaf0, 0.9); kl.position.set(3, 5, 8); logoScene.add(kl);
        const kl2 = new THREE.DirectionalLight(0xfff8f0, 0.9); kl2.position.set(-3, -5, -8); logoScene.add(kl2);
        const fl = new THREE.DirectionalLight(0xe0eeff, 0.7); fl.position.set(-5, -2, 4); logoScene.add(fl);
        const fl2 = new THREE.DirectionalLight(0xffe0d0, 0.7); fl2.position.set(5, 2, -4); logoScene.add(fl2);
        const r1 = new THREE.PointLight(0xffcc44, 1.2, 25); r1.position.set(-5, 2, -6); logoScene.add(r1);
        const r2 = new THREE.PointLight(0x44aaff, 0.8, 20); r2.position.set(5, -1, -5); logoScene.add(r2);
        const logoMV = new THREE.PointLight(0xffe080, 1.2, 22); logoScene.add(logoMV);

        function buildLogoShape() {
            const T = 100, st = Math.max(1, Math.floor(LP.length / T));
            const sL = [], sR = [];
            for (let i = 0; i < LP.length; i += st) { sL.push(LP[i]); sR.push(RP[i]); }
            sL.push(LP[LP.length - 1]); sR.push(RP[RP.length - 1]);
            const sh = new THREE.Shape();
            sh.moveTo(sL[0][0], sL[0][1]);
            for (let i = 0; i < sR.length; i++) sh.lineTo(sR[i][0], sR[i][1]);
            for (let i = sL.length - 1; i >= 0; i--) sh.lineTo(sL[i][0], sL[i][1]);
            sh.closePath();
            return sh;
        }

        function uvGeoLogo(sh, seg) {
            const g = new THREE.ShapeGeometry(sh, seg);
            g.computeBoundingBox();
            const bb = g.boundingBox, sx = bb.max.x - bb.min.x, sy = bb.max.y - bb.min.y;
            const pos = g.attributes.position, uv = new Float32Array(pos.count * 2);
            for (let i = 0; i < pos.count; i++) {
                uv[i * 2] = (pos.getX(i) - bb.min.x) / sx;
                uv[i * 2 + 1] = (pos.getY(i) - bb.min.y) / sy;
            }
            g.setAttribute('uv', new THREE.BufferAttribute(uv, 2));
            return g;
        }

        const logoTL = new THREE.TextureLoader();
        logoTL.crossOrigin = "anonymous";
        logoTL.load(LOGO_IMG_URL, function(tex) {
            tex.anisotropy = logoR.capabilities.getMaxAnisotropy();
            tex.minFilter = THREE.LinearMipmapLinearFilter;
            tex.magFilter = THREE.LinearFilter;

            const shape = buildLogoShape();
            const faceM = new THREE.MeshBasicMaterial({ map: tex });
            const edgeM = new THREE.MeshStandardMaterial({ color: 0xd4a820, roughness: 0.13, metalness: 0.96 });
            const edgD = new THREE.MeshStandardMaterial({ color: 0xa07810, roughness: 0.08, metalness: 0.98 });
            const inv = new THREE.MeshBasicMaterial({ transparent: true, opacity: 0, depthWrite: false, colorWrite: false });

            const D = 0.38, HD = D / 2;
            const logoGrp = new THREE.Group();
            logoScene.add(logoGrp);

            const eg = new THREE.ExtrudeGeometry(shape, {
                depth: D, bevelEnabled: true, bevelThickness: 0.045, bevelSize: 0.045,
                bevelSegments: 16, curveSegments: 128
            });
            eg.translate(0, 0, -HD);
            logoGrp.add(new THREE.Mesh(eg, [inv, inv, edgeM]));

            const fg = uvGeoLogo(shape, 128);
            const fm = new THREE.Mesh(fg, faceM); fm.position.z = HD + 0.002; logoGrp.add(fm);

            const bg2 = uvGeoLogo(shape, 128);
            const pb = bg2.attributes.position, ub = bg2.attributes.uv;
            for (let i = 0; i < pb.count; i++) { pb.setX(i, -pb.getX(i)); ub.setX(i, 1 - ub.getX(i)); }
            pb.needsUpdate = true; ub.needsUpdate = true; bg2.computeVertexNormals();
            const bm = new THREE.Mesh(bg2, faceM); bm.position.z = -(HD + 0.002); logoGrp.add(bm);

            const sp = shape.getPoints(120);
            const ro = new THREE.Shape(sp.map(p => new THREE.Vector2(p.x * 1.045, p.y * 1.045)));
            ro.holes.push(new THREE.Path(sp));
            const rg = new THREE.ExtrudeGeometry(ro, {
                depth: D * 0.70, bevelEnabled: true, bevelThickness: 0.022,
                bevelSize: 0.022, bevelSegments: 10, curveSegments: 128
            });
            rg.translate(0, 0, -(HD * 0.70));
            logoGrp.add(new THREE.Mesh(rg, edgD));

            const hc = document.createElement("canvas"); hc.width = hc.height = 256;
            const ht = hc.getContext("2d");
            const hg = ht.createRadialGradient(128, 128, 5, 128, 128, 128);
            hg.addColorStop(0, "rgba(255,220,80,0.6)");
            hg.addColorStop(0.3, "rgba(255,160,30,0.3)");
            hg.addColorStop(0.6, "rgba(80,120,255,0.18)");
            hg.addColorStop(1, "rgba(0,0,0,0)");
            ht.fillStyle = hg; ht.fillRect(0, 0, 256, 256);
            const logoHS = new THREE.Sprite(new THREE.SpriteMaterial({
                map: new THREE.CanvasTexture(hc), transparent: true,
                blending: THREE.AdditiveBlending, depthWrite: false, opacity: 0.8
            }));
            logoHS.scale.set(7.2, 9.5, 1); logoHS.position.z = -0.5; logoGrp.add(logoHS);

            const sv = new Float32Array(2000 * 3);
            for (let i = 0; i < sv.length; i++) sv[i] = (Math.random() - 0.5) * 150;
            const sgg = new THREE.BufferGeometry();
            sgg.setAttribute('position', new THREE.BufferAttribute(sv, 3));
            logoScene.add(new THREE.Points(sgg, new THREE.PointsMaterial({ color: 0xffffff, size: 0.055, sizeAttenuation: true })));

            let fo = 0;
            const fi = setInterval(function() {
                fo += 0.04;
                c3.style.opacity = Math.min(fo, 1).toFixed(2);
                if (fo >= 1) clearInterval(fi);
            }, 16);

            logoGrp.rotation.x = 0.12;
            let logoAng = 0, logoLast = performance.now(), logoGT2 = 0;

            (function logoRender(now) {
                const dt = (now - logoLast) / 1000; logoLast = now;
                logoAng += dt * (Math.PI * 2 / 22);
                logoGT2 += dt;
                logoGrp.rotation.y = logoAng;
                logoGrp.rotation.x = 0.12 + Math.sin(logoAng * 0.35) * 0.08;
                logoHS.material.opacity = 0.55 + 0.25 * Math.sin(logoGT2 * 0.9);
                logoMV.position.set(Math.sin(-logoAng * 1.2) * 6, Math.cos(-logoAng * 0.6) * 2.5, Math.sin(logoAng * 0.4) * 2 - 2);
                logoR.render(logoScene, logoCam);
                requestAnimationFrame(logoRender);
            })(performance.now());
        });
    }
})();
</script>

<script>
const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const particles = [];
const particleCount = 150;

class Particle {
    constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.z = Math.random() * 1000;
        this.vx = (Math.random() - 0.5) * 0.5;
        this.vy = (Math.random() - 0.5) * 0.5;
        this.vz = Math.random() * 2 + 1;
        this.size = Math.random() * 2 + 1;
        this.hue = Math.random() * 60 + 220;
    }
    
    update() {
        this.z -= this.vz;
        if (this.z <= 0) {
            this.z = 1000;
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
        }
        
        const scale = 1000 / (1000 + this.z);
        this.screenX = (this.x - canvas.width / 2) * scale + canvas.width / 2;
        this.screenY = (this.y - canvas.height / 2) * scale + canvas.height / 2;
        this.screenSize = this.size * scale;
    }
    
    draw() {
        const opacity = (1000 - this.z) / 1000;
        ctx.fillStyle = `hsla(${this.hue}, 100%, 60%, ${opacity})`;
        ctx.beginPath();
        ctx.arc(this.screenX, this.screenY, this.screenSize, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 10;
        ctx.shadowColor = `hsla(${this.hue}, 100%, 60%, ${opacity})`;
    }
}

for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
}

function animateParticles() {
    ctx.fillStyle = 'rgba(10, 14, 39, 0.1)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    particles.forEach(particle => {
        particle.update();
        particle.draw();
    });
    requestAnimationFrame(animateParticles);
}

animateParticles();

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

function sembunyikanWelcome() {
    var wp = document.getElementById('welcomePage');
    wp.classList.add('tersembunyi');
    wp.style.display = 'none';
    wp.style.visibility = 'hidden';
    wp.style.zIndex = '-1';
    wp.style.pointerEvents = 'none';
}

function tampilkanWelcome() {
    var wp = document.getElementById('welcomePage');
    wp.classList.remove('tersembunyi');
    wp.style.display = 'flex';
    wp.style.visibility = '';
    wp.style.zIndex = '';
    wp.style.pointerEvents = '';
}

function startApp() {
    sembunyikanWelcome();
    document.getElementById('mainApp').style.display = 'block';
    document.body.classList.add('app-aktif');
    lsLoad();
    updateDataCounter();
    document.getElementById('mainNavigation').style.display = 'block';
}

function goToWelcome() {
    tampilkanWelcome();
    document.getElementById('mainApp').style.display = 'none';
    document.body.classList.remove('app-aktif');
    document.body.style.background = '#0a0e27';
    document.getElementById('bukuTamuForm').reset();
    hideAllFields();
    document.getElementById('mainNavigation').style.display = 'none';
    document.getElementById('formSection').style.display = 'block';
    document.getElementById('dataSection').style.display = 'none';
}

// ===== GLOBAL VARIABLES =====
const LS_KEY_FINAL     = 'bukuTamu_dataFinal_v1';
const LS_KEY_SEMENTARA = 'bukuTamu_dataSementara_v1';

// ===== ASYNC image compress ‚Äî WAJIB async karena img.onload asinkron =====
function kompresGambar(dataUrl, maxW, maxH, kualitas) {
    return new Promise(function(resolve) {
        if (!dataUrl || typeof dataUrl !== 'string' || !dataUrl.startsWith('data:image')) {
            return resolve(dataUrl || null);
        }
        var img = new Image();
        img.onload = function() {
            try {
                var w = img.naturalWidth  || maxW;
                var h = img.naturalHeight || maxH;
                if (w > maxW) { h = Math.round(h * maxW / w); w = maxW; }
                if (h > maxH) { w = Math.round(w * maxH / h); h = maxH; }
                if (w < 1) w = 1;
                if (h < 1) h = 1;
                var cvs = document.createElement('canvas');
                cvs.width = w; cvs.height = h;
                var c = cvs.getContext('2d');
                c.fillStyle = '#ffffff';
                c.fillRect(0, 0, w, h);
                c.drawImage(img, 0, 0, w, h);
                resolve(cvs.toDataURL('image/jpeg', kualitas || 0.35));
            } catch(e) { resolve(dataUrl); }
        };
        img.onerror = function() { resolve(dataUrl); };
        img.src = dataUrl;
    });
}

async function buatDataUntukStorage(arr) {
    return Promise.all(arr.map(async function(d) {
        return Object.assign({}, d, {
            fotoFront:   await kompresGambar(d.fotoFront,   320, 320, 0.55),
            fotoBack:    await kompresGambar(d.fotoBack,    320, 320, 0.55),
            tandaTangan: await kompresGambar(d.tandaTangan, 480, 180, 0.75)
        });
    }));
}

async function lsSave() {
    try {
        const compressed = await buatDataUntukStorage(dataBukuTamu);
        localStorage.setItem(LS_KEY_FINAL, JSON.stringify(compressed));
    } catch(e) {
        try {
            const tanpaFoto = await Promise.all(dataBukuTamu.map(async function(d) {
                return Object.assign({}, d, {
                    fotoFront: null,
                    fotoBack:  null,
                    tandaTangan: await kompresGambar(d.tandaTangan, 400, 150, 0.75)
                });
            }));
            localStorage.setItem(LS_KEY_FINAL, JSON.stringify(tanpaFoto));
        } catch(e2) {
            console.warn('localStorage penuh total:', e2);
        }
    }
    try {
        const compressedS = await buatDataUntukStorage(dataTamuSementara);
        localStorage.setItem(LS_KEY_SEMENTARA, JSON.stringify(compressedS));
    } catch(e) {
        console.warn('localStorage sementara gagal:', e);
    }
}

function lsLoad() {
    try {
        const raw = localStorage.getItem(LS_KEY_FINAL);
        if (raw) dataBukuTamu = JSON.parse(raw);
    } catch(e) { dataBukuTamu = []; }
    try {
        const raw2 = localStorage.getItem(LS_KEY_SEMENTARA);
        if (raw2) dataTamuSementara = JSON.parse(raw2);
    } catch(e) { dataTamuSementara = []; }
}

function lsClear() {
    localStorage.removeItem(LS_KEY_FINAL);
    localStorage.removeItem(LS_KEY_SEMENTARA);
}

let dataBukuTamu = [];
let dataTamuSementara = [];
let signatureCanvas, ctx2, isDrawing = false, totalStrokeLength = 0;
let hasSignature = false, hasPhoto = false;
let fotoDataURLFront = null, fotoDataURLBack = null;
let stream = null;
let step = 1;
let editingIndex = -1, originalEditData = null;
let isEditMode = false;
let editingSementara = false;

const PIXELS_PER_CM = 37.7952755906;
const MIN_STROKE_LENGTH_CM = 2;

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    signatureCanvas = document.getElementById('signature-pad');
    ctx2 = signatureCanvas.getContext('2d');
    attachSignatureEvents();
    window.addEventListener('resize', resizeCanvas);
});

function attachSignatureEvents() {
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    signatureCanvas.addEventListener('touchstart', handleTouch);
    signatureCanvas.addEventListener('touchmove', handleTouch);
    signatureCanvas.addEventListener('touchend', stopDrawing);
}

function resizeCanvas() {
    const field = document.getElementById('field-tandaTangan');
    if (!field || field.classList.contains('hidden')) return;
    setTimeout(() => {
        const container = signatureCanvas.parentElement;
        let newWidth = Math.min(container.offsetWidth || 600, 600);
        if (newWidth < 300) newWidth = 300;
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = signatureCanvas.width;
        tempCanvas.height = signatureCanvas.height;
        tempCanvas.getContext('2d').drawImage(signatureCanvas, 0, 0);
        signatureCanvas.width = newWidth;
        signatureCanvas.height = 200;
        ctx2.drawImage(tempCanvas, 0, 0, newWidth, 200);
        ctx2.lineWidth = 2;
        ctx2.lineCap = 'round';
        ctx2.strokeStyle = '#00008B';
        attachSignatureEvents();
    }, 100);
}

function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx2.beginPath();
    ctx2.moveTo(x, y);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx2.lineTo(x, y);
    ctx2.stroke();
    totalStrokeLength += 2;
    hasSignature = true;
}

function stopDrawing() {
    if (!isDrawing) return;
    isDrawing = false;
    const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
    if (strokeLengthCm >= MIN_STROKE_LENGTH_CM) {
        signatureCanvas.classList.remove('error');
        document.getElementById('signatureWarning').style.display = 'none';
        signatureDataURL = recenterSignature();
        if (signatureDataURL) {
            const img = new Image();
            img.onload = () => {
                ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                ctx2.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                if (!isEditMode && !_editBebasMode) {
                    /* Step mode: tampil TTD sebagai gambar di ringkasan */
                    tampilJawabTTD(signatureDataURL);
                    aktifkanField('field-aksi');
                } else {
                    /* Edit/bebas mode: cukup tampilkan field-aksi */
                    document.getElementById('field-aksi').classList.remove('hidden');
                }
            };
            img.src = signatureDataURL;
        }
    }
}

function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    signatureCanvas.dispatchEvent(mouseEvent);
}

function clearSignature() {
    ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    hasSignature = false;
    totalStrokeLength = 0;
    signatureDataURL = null;
    document.getElementById('signatureWarning').style.display = 'none';
    document.getElementById('field-aksi').classList.add('hidden');
    if (!isEditMode) {
        // Hapus baris TTD dan sembunyikan separator dokumentasi
        const bubTTD = document.querySelector('.ps-row[data-field="tandaTangan"]');
        if (bubTTD) {
            bubTTD.style.transition = 'opacity 0.20s, transform 0.20s';
            bubTTD.style.opacity = '0';
            bubTTD.style.transform = 'translateX(-8px)';
            setTimeout(() => bubTTD.remove(), 220);
        }
        const sep = document.getElementById('ps-section-dok');
        if (sep) sep.style.display = 'none';
        aktifkanField('field-tandaTangan');
    }
}

// ===== STEP-FORM HELPERS =====

const _TOTAL_STEPS = 8;   // nama, asal, instansi/kecamatan, desa, pihak, layanan, uraian, hp, ttd

function tampilJawab(fieldKey, labelTeks, valueTeks) {
    if (isEditMode || _editBebasMode) return;

    const box = document.getElementById('paperScroll');
    if (!box) return;

    // Tampilkan header tabel saat pertama kali ada isian
    const thead = document.getElementById('psTableHead');
    if (thead && thead.style.display === 'none') {
        thead.style.display = 'block';
    }

    // Hapus baris lama untuk key ini jika ada (update nilai)
    const oldRow = document.querySelector('.ps-row[data-field="' + fieldKey + '"]');
    if (oldRow) {
        // Efek UPDATE: flash nilai lama lalu ganti
        const oldVal = oldRow.querySelector('.ps-val-inner');
        if (oldVal) {
            // Animasi ganti nilai: slide keluar ‚Üí ganti teks ‚Üí slide masuk + flash
            oldVal.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
            oldVal.style.opacity = '0';
            oldVal.style.transform = 'translateX(-12px)';
            setTimeout(() => {
                oldVal.textContent = valueTeks;
                oldVal.style.transition = '';
                oldVal.style.opacity = '1';
                oldVal.style.transform = 'translateX(0)';
                oldVal.classList.remove('updated');
                void oldVal.offsetWidth;
                oldVal.classList.add('updated');
            }, 180);
        }
        return;
    }

    // Hitung nomor urut (hanya dari .ps-row, bukan separator)
    const num = box.querySelectorAll('.ps-row').length + 1;

    const row = document.createElement('div');
    row.className = 'ps-row';
    row.dataset.field = fieldKey;
    row.innerHTML =
        '<div class="ps-num"><div class="ps-num-inner">' + num + '</div></div>' +
        '<div class="ps-lbl">' + escHtml(labelTeks) + '</div>' +
        '<div class="ps-sep">:</div>' +
        '<div class="ps-val"><span class="ps-val-inner">' + escHtml(valueTeks) + '</span></div>';

    // Untuk TTD: tampilkan separator & insert setelah separator
    if (fieldKey === 'tandaTangan') {
        const sep = document.getElementById('ps-section-dok');
        if (sep) {
            sep.style.display = 'block';
            // re-trigger animasi separator
            sep.style.animation = 'none';
            void sep.offsetWidth;
            sep.style.animation = '';
            box.appendChild(sep);   // pindahkan separator ke akhir
        }
        box.appendChild(row);
    } else {
        // Insert sebelum separator dokumentasi jika sudah ada
        const sep = document.getElementById('ps-section-dok');
        if (sep && sep.style.display !== 'none') {
            box.insertBefore(row, sep);
        } else {
            box.appendChild(row);
        }
    }
    _updateProgress(num);

    // Scroll halus ke baris baru setelah animasi mulai
    setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 120);
}


function tampilJawabTTD(dataUrl) {
    if (isEditMode || _editBebasMode) return;
    const box = document.getElementById('paperScroll');
    if (!box) return;

    // Tampilkan header tabel jika belum
    const thead = document.getElementById('psTableHead');
    if (thead && thead.style.display === 'none') thead.style.display = 'block';

    // Hapus baris TTD lama jika ada (saat ulang tanda tangan)
    const oldRow = document.querySelector('.ps-row[data-field="tandaTangan"]');
    if (oldRow) {
        // Update gambar saja
        const oldImg = oldRow.querySelector('.ps-ttd-preview');
        if (oldImg && dataUrl) {
            oldImg.style.opacity = '0';
            setTimeout(() => {
                oldImg.src = dataUrl;
                oldImg.style.opacity = '1';
            }, 180);
        }
        return;
    }

    // Separator dokumentasi
    const sep = document.getElementById('ps-section-dok');
    if (sep) {
        sep.style.display = 'block';
        sep.style.animation = 'none';
        void sep.offsetWidth;
        sep.style.animation = '';
        box.appendChild(sep);
    }

    const num = box.querySelectorAll('.ps-row').length + 1;
    const row = document.createElement('div');
    row.className = 'ps-row';
    row.dataset.field = 'tandaTangan';

    // Konten: label + gambar TTD kecil
    row.innerHTML =
        '<div class="ps-num"><div class="ps-num-inner">' + num + '</div></div>' +
        '<div class="ps-lbl">Tanda Tangan</div>' +
        '<div class="ps-sep">:</div>' +
        '<div class="ps-val ps-val-ttd">' +
            (dataUrl
                ? '<img class="ps-ttd-preview" src="' + dataUrl + '" alt="TTD"/>'
                : '<span class="ps-val-inner" style="color:#1a7a1a;font-weight:800;">‚úÖ Diterima</span>'
            ) +
        '</div>';

    box.appendChild(row);
    _updateProgress(num);
    setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 120);
}

function _updateProgress(filled) {
    const bar = document.getElementById('shBar');
    if (bar) bar.style.width = Math.min(Math.round(filled / _TOTAL_STEPS * 100), 100) + '%';
    const sub = document.getElementById('shSub');
    if (sub && filled > 0) sub.textContent = filled + ' dari ' + _TOTAL_STEPS + ' data telah diisi';
}

function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function sembunyikanField(id) {
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden');
}

function aktifkanField(id) {
    if (isEditMode || _editBebasMode) {
        const el = document.getElementById(id);
        if (el) { el.classList.remove('hidden'); if (id==='field-tandaTangan') resizeCanvas(); }
        return;
    }
    // Sembunyikan semua field di stepInputArea kecuali field-aksi yang aktif
    const area = document.getElementById('stepInputArea');
    if (area) {
        Array.from(area.children).forEach(c => { c.classList.add('hidden'); });
    }
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove('hidden');
    el.classList.remove('sf-enter');
    void el.offsetWidth;
    el.classList.add('sf-enter');
    setTimeout(() => {
        const area2 = document.getElementById('stepInputArea');
        if (area2) area2.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        const f = el.querySelector('input,select,textarea');
        if (f) setTimeout(() => f.focus(), 50);
    }, 100);
    if (id === 'field-tandaTangan') resizeCanvas();
}

function bersihJawab() {
    const box = document.getElementById('paperScroll');
    if (box) {
        // Hapus semua baris isian (simpan elemen statis)
        box.querySelectorAll('.ps-row').forEach(r => r.remove());
    }
    const thead = document.getElementById('psTableHead');
    if (thead) thead.style.display = 'none';
    const sep = document.getElementById('ps-section-dok');
    if (sep) sep.style.display = 'none';
    const bar = document.getElementById('shBar');
    if (bar) bar.style.width = '0%';
    const sub = document.getElementById('shSub');
    if (sub) sub.textContent = 'Nama ¬∑ Asal ¬∑ Instansi/Kecamatan ¬∑ Pihak Ditemui ¬∑ Layanan ¬∑ Uraian ¬∑ No. WA ¬∑ Tanda Tangan';
}

// ===== FORM VALIDATION =====
function validateNama() {
    if (isEditMode) return;
    const namaInput = document.getElementById('nama');
    const namaValue = namaInput.value.trim();
    let hurufCount = 0;
    try { hurufCount = (namaValue.match(/\p{L}/gu) || []).length; }
    catch(e) { hurufCount = (namaValue.match(/[A-Za-z]/g) || []).length; }
    if (hurufCount >= 5) {
        namaInput.classList.remove('error');
        namaInput.classList.add('success');
    } else {
        namaInput.classList.add('error');
        namaInput.classList.remove('success');
    }
}

/* Dipanggil saat user klik Lanjut atau tekan Enter di field Nama */
function stepNama() {
    if (isEditMode) return;
    const namaInput = document.getElementById('nama');
    const namaValue = namaInput.value.trim();
    let hurufCount = 0;
    try { hurufCount = (namaValue.match(/\p{L}/gu) || []).length; }
    catch(e) { hurufCount = (namaValue.match(/[A-Za-z]/g) || []).length; }
    if (hurufCount < 5) { namaInput.classList.add('error'); return; }
    /* Admin check */
    if (namaValue === 'Untung1') {
        document.getElementById('btnData').style.display = '';
        document.getElementById('btnExport').style.display = '';
        document.getElementById('btnReset').style.display = '';
        document.getElementById('mainNavigation').style.display = 'block';
    } else {
        document.getElementById('btnData').style.display = 'none';
        document.getElementById('btnExport').style.display = 'none';
        document.getElementById('btnReset').style.display = 'none';
    }
    _stepNamaDone = true;
    clearTimeout(_timerNama);
    if (!_editBebasMode) {
        tampilJawab('nama', 'Nama Lengkap', namaValue);
        aktifkanField('field-asal');
    }
}

function validateNomorHp(input) {
    if (isEditMode) return;
    let value = input.value.trim();
    const onlyDigits = value.replace(/[^0-9]/g, '');
    if (onlyDigits.length > 0 && !onlyDigits.startsWith('08')) {
        if (onlyDigits.startsWith('8')) {
            input.value = '0' + onlyDigits;
        } else if (onlyDigits.startsWith('62')) {
            input.value = '0' + onlyDigits.substring(2);
        } else {
            input.value = '08' + onlyDigits;
        }
    } else {
        input.value = onlyDigits;
    }
    const cleaned = input.value.trim();
    const isValidFormat = cleaned.startsWith('08') && 
                         cleaned.length >= 11 && 
                         cleaned.length <= 13 && 
                         /^[0-9]+$/.test(cleaned);
    if (isValidFormat) {
        input.classList.remove('error');
        input.classList.add('success');
        document.getElementById('nomorHpInfo').textContent = '';
    } else {
        input.classList.remove('success');
        input.classList.add('error');
        let msg = '';
        if (cleaned.length === 0) {
            msg = '';
        } else if (!cleaned.startsWith('08')) {
            msg = 'Harus diawali dengan 08';
        } else if (cleaned.length < 11) {
            msg = `Minimal 11 digit (saat ini: ${cleaned.length})`;
        } else if (cleaned.length > 13) {
            msg = `Maksimal 13 digit (saat ini: ${cleaned.length})`;
        }
        document.getElementById('nomorHpInfo').textContent = msg;
    }
}

function stepNomorHp() {
    if (isEditMode) return;
    const input = document.getElementById('nomorHp');
    const cleaned = input.value.trim();
    const ok = cleaned.startsWith('08') && cleaned.length >= 11 &&
               cleaned.length <= 13 && /^[0-9]+$/.test(cleaned);
    if (!ok) { input.classList.add('error'); return; }
    _stepHpDone = true;
    clearTimeout(_timerHp);
    if (!_editBebasMode) {
        tampilJawab('nomorHp', 'Nomor WhatsApp', cleaned);
        aktifkanField('field-tandaTangan');
        resizeCanvas();
    }
}

function asalChanged() {
   if (isEditMode) {
        const asal = document.getElementById('asal').value;
        const daftarInstansi = document.getElementById('daftarInstansi');
        const daftarMasyarakat = document.getElementById('daftarMasyarakat');
        const fieldDesa = document.getElementById('fieldDesa');
        if (asal === 'INSTANSI') {
            daftarInstansi.classList.remove('hidden');
            daftarMasyarakat.classList.add('hidden');
            fieldDesa.classList.add('hidden');
        } else if (asal === 'MASYARAKAT') {
            daftarMasyarakat.classList.remove('hidden');
            daftarInstansi.classList.add('hidden');
            fieldDesa.classList.remove('hidden');
        } else {
            daftarInstansi.classList.add('hidden');
            daftarMasyarakat.classList.add('hidden');
            fieldDesa.classList.add('hidden');
        }
        return;
    }
    const asal = document.getElementById('asal').value;
    if (!asal) return;
    const label = asal === 'INSTANSI' ? 'Instansi / Unit Kerja' : 'Masyarakat';
    if (!_editBebasMode) tampilJawab('asal', 'Asal', label);
    if (asal === 'INSTANSI') {
        if (_editBebasMode) {
            document.getElementById('daftarInstansi').classList.remove('hidden');
            document.getElementById('daftarMasyarakat').classList.add('hidden');
            document.getElementById('fieldDesa').classList.add('hidden');
        } else {
            aktifkanField('daftarInstansi');
        }
    } else {
        if (_editBebasMode) {
            document.getElementById('daftarMasyarakat').classList.remove('hidden');
            document.getElementById('daftarInstansi').classList.add('hidden');
            document.getElementById('fieldDesa').classList.remove('hidden');
        } else {
            aktifkanField('daftarMasyarakat');
        }
    }
}

const dataDesa = {
    "Batu Putih": ["Marga Sari", "Margo Dadi", "Margo Mulya", "Mulyo Sari", "Panca Marga", "Sakti Jaya", "Sido Makmur", "Toto Katon", "Toto Makmur", "Toto Wonodadi"],
    "Gunung Agung": ["Bangun Jaya", "Dwikora Jaya", "Jaya Murni", "Marga Jaya", "Mekar Jaya", "Mulya Jaya", "Mulya Sari", "Suka Jaya", "Sumber Jaya", "Sumber Rejeki", "Tri Tunggal Jaya", "Tunas Jaya", "Wono Rejo"],
    "Gunung Terang": ["Gunung Agung", "Gunung Terang", "Kagungan Jaya", "Mulyo Jadi", "Setia Agung", "Setia Bumi", "Terang Bumi Agung", "Terang Makmur", "Terang Mulya", "Toto Mulyo"],
    "Lambu Kibang": ["Gilang Tunggal Makarta", "Gunung Sari", "Kibang Budi Jaya", "Kibang Mulya Jaya", "Kibang Tri Jaya", "Kibang Yekti Jaya", "Lesung Bhakti Jaya", "Mekar Sari Jaya", "Pagar Jaya", "Sumber Rejo"],
    "Pagar Dewa": ["Bujung Dewa", "Bujung Sari Marga", "Cahyou (Cahyou) Randu", "Marga Jaya Indah", "Pagar Dewa", "Pagar Dewa Suka Mulya"],
    "Tulang Bawang Tengah": ["Bandar Dewa", "Candra Jaya", "Candra Kencana", "Candra Mukti", "Menggala Mas", "Mulya Jaya", "Mulya Kencana", "Mulyo Asri", "Panaragan", "Panaragan Jaya", "Panaragan Jaya Indah", "Panaragan Jaya Utama", "Penumangan", "Penumangan Baru", "Pulung Kencana", "Tirta Kencana", "Tirta Makmur", "Tunas Asri"],
    "Tulang Bawang Udik": ["Gedung Ratu", "Gunung Katun Malai", "Gunung Katun Tanjungan", "Kagungan Ratu", "Karta", "Karta Raharja", "Karta Sari", "Marga Kencana", "Wai Sido"],
    "Tumijajar": ["Daya Asri", "Daya Murni", "Daya Sakti", "Gunung Menanti", "Gunung Timbul", "Makarti", "Margo Dadi", "Margo Mulyo", "Murni Jaya", "Sumber Rejo"],
    "Way Kenanga": ["Agung Jaya", "Balam Asri", "Balam Jaya", "Indraloka I", "Indraloka II", "Indraloka Jaya", "Indraloka Mukti", "Mercu Buana", "Pagar Buana"]
};

function updateDesaList() {
    const kecamatan = document.getElementById('kecamatan').value;
    const desaSelect = document.getElementById('desa');
    desaSelect.innerHTML = '<option value="">-- Pilih Desa/Kelurahan --</option>';
    if (!kecamatan) return;
    if (isEditMode) {
        if (dataDesa[kecamatan]) {
            dataDesa[kecamatan].forEach(d => {
                const o = document.createElement('option');
                o.value = d; o.textContent = d;
                desaSelect.appendChild(o);
            });
        }
        document.getElementById('fieldDesa').classList.remove('hidden');
        return;
    }
    /* Step mode / edit bebas */
    if (dataDesa[kecamatan]) {
        dataDesa[kecamatan].forEach(d => {
            const o = document.createElement('option');
            o.value = d; o.textContent = d;
            desaSelect.appendChild(o);
        });
    }
    if (_editBebasMode) {
        document.getElementById('fieldDesa').classList.remove('hidden');
    } else {
        tampilJawab('kecamatan', 'Kecamatan', kecamatan);
        aktifkanField('fieldDesa');
    }
}

setTimeout(() => {
    document.getElementById('formSection').style.display = 'block';
}, 50);

function checkAndShowNext(currentId, nextFieldId) {
    if (isEditMode || _editBebasMode) {
        /* edit/bebas mode: hanya tampilkan field berikutnya tanpa step UI */
        const el = document.getElementById(currentId);
        if (el && el.value.trim()) {
            document.getElementById(nextFieldId).classList.remove('hidden');
            if (nextFieldId === 'field-tandaTangan') resizeCanvas();
        }
        return;
    }
    const el = document.getElementById(currentId);
    if (!el || !el.value.trim()) return;
    const val = el.value.trim();
    const META = {
        instansi:     { lbl: 'Instansi / Unit Kerja' },
        desa:         { lbl: 'Desa / Kelurahan' },
        pihakDitemui: { lbl: 'Pihak yang Ditemui' },
        jenisLayanan: { lbl: 'Jenis Layanan' },
    };
    if (META[currentId]) {
        tampilJawab(currentId, META[currentId].lbl, val);
    }
    aktifkanField(nextFieldId);
    if (nextFieldId === 'field-tandaTangan') resizeCanvas();
}

function hideFieldsAfter(fieldId) {
    if (isEditMode) return;
    const fields = ['field-asal', 'daftarInstansi', 'daftarMasyarakat', 'fieldDesa', 
                    'field-pihakDitemui', 'field-jenisLayanan', 'field-uraian', 
                    'field-nomorHp', 'field-tandaTangan', 'field-aksi'];
    let found = false;
    fields.forEach(id => {
        if (found) document.getElementById(id).classList.add('hidden');
        if (id === fieldId) found = true;
    });
}

function hideAllFields() {
    ['field-asal','daftarInstansi','daftarMasyarakat','fieldDesa',
     'field-pihakDitemui','field-jenisLayanan','field-uraian',
     'field-nomorHp','field-tandaTangan','field-aksi'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    });
    bersihJawab();
    /* Tampilkan kembali field Nama dengan animasi */
    const fn = document.getElementById('field-nama');
    if (fn) {
        fn.classList.remove('hidden');
        fn.classList.remove('field-step-enter');
        void fn.offsetWidth;
        fn.classList.add('field-step-enter');
    }
}

function countWords(str) {
    if (!str.trim()) return 0;
    return str.trim().split(/\s+/).filter(word => word.length > 0).length;
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

function validateUraian() {
    if (isEditMode) return;
    const uraian = document.getElementById('uraian');
    const panjang = uraian.value.trim().length;
    let info = document.getElementById('uraianInfo');
    if (!info) {
        info = document.createElement('small');
        info.id = 'uraianInfo'; info.style.color = '#dc3545';
        uraian.parentNode.appendChild(info);
    }
    if (panjang >= 10) {
        uraian.classList.remove('error'); uraian.classList.add('success');
        info.textContent = '';
    } else {
        uraian.classList.remove('success'); uraian.classList.add('error');
        info.textContent = panjang > 0 ? `Minimal 10 karakter (saat ini: ${panjang})` : '';
    }
}

function stepUraian() {
    if (isEditMode) return;
    const uraian = document.getElementById('uraian');
    const panjang = uraian.value.trim().length;
    if (panjang < 10) { uraian.classList.add('error'); return; }
    _stepUraianDone = true;
    clearTimeout(_timerUraian);
    if (!_editBebasMode) {
        const val = uraian.value.trim();
        const preview = val.length > 70 ? val.substring(0, 70) + '\u2026' : val;
        tampilJawab('uraian', 'Uraian', preview);
        aktifkanField('field-nomorHp');
    }
}

// ===== AUTO-ADVANCE (tanpa tombol Lanjut) =====
let _timerNama = null, _timerUraian = null, _timerHp = null;
let _stepNamaDone = false, _stepUraianDone = false, _stepHpDone = false;
let _editBebasMode = false;  // Mode edit bebas dari overlay (semua field tampil sekaligus)

function autoStepNama() {
    if (isEditMode || _stepNamaDone || _editBebasMode) return;
    clearTimeout(_timerNama);
    const namaInput = document.getElementById('nama');
    const namaValue = namaInput.value.trim();
    let hurufCount = 0;
    try { hurufCount = (namaValue.match(/\p{L}/gu) || []).length; }
    catch(e) { hurufCount = (namaValue.match(/[A-Za-z]/g) || []).length; }
    if (hurufCount < 5) return;
    _timerNama = setTimeout(() => {
        if (!_stepNamaDone) stepNama();
    }, 1000);
}

function autoStepUraian() {
    if (isEditMode || _stepUraianDone || _editBebasMode) return;
    clearTimeout(_timerUraian);
    const uraian = document.getElementById('uraian');
    if (uraian.value.trim().length < 10) return;
    _timerUraian = setTimeout(() => {
        if (!_stepUraianDone) stepUraian();
    }, 1200);
}

function autoStepNomorHp() {
    if (isEditMode || _stepHpDone || _editBebasMode) return;
    clearTimeout(_timerHp);
    const input = document.getElementById('nomorHp');
    const cleaned = input.value.trim();
    const ok = cleaned.startsWith('08') && cleaned.length >= 11 &&
               cleaned.length <= 13 && /^[0-9]+$/.test(cleaned);
    if (!ok) return;
    _timerHp = setTimeout(() => {
        if (!_stepHpDone) stepNomorHp();
    }, 700);
}


async function bukaKamera() {
    step = 1;
    document.getElementById('infoKamera').innerText = "Ambil foto pertama";
    document.getElementById('photoModal').style.display = 'flex';
    await initCamera('user');
}

async function initCamera(facing) {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: facing },
            audio: false
        });
        const video = document.getElementById('video');
        video.srcObject = stream;
        video.onloadedmetadata = () => video.play().catch(e => console.log("play error:", e));
    } catch (err) {
        console.error("Kamera error:", err);
        alert("Tidak dapat mengakses kamera.\nPastikan izin kamera diizinkan dan coba refresh halaman.");
        stopAll();
    }
}

async function capture() {
    const video = document.getElementById('video');
    if (!video.srcObject) return;
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctxCap = canvas.getContext('2d');
    ctxCap.fillStyle = '#ffffff';
    ctxCap.fillRect(0, 0, canvas.width, canvas.height);
    ctxCap.drawImage(video, 0, 0);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
    if (step === 1) {
        fotoDataURLFront = dataUrl;
        document.getElementById('imgFront').src = dataUrl;
        document.getElementById('imgFront').style.display = 'block';
        step = 2;
        document.getElementById('infoKamera').innerText = 'Ambil foto kedua';
        initCamera('environment');
    } else {
        fotoDataURLBack = dataUrl;
        document.getElementById('imgBack').src = dataUrl;
        document.getElementById('imgBack').style.display = 'block';
        hasPhoto = true;
        stopAll();
        if (!isEditMode) {
            // Buka overlay pratinjau (baik mode step maupun edit bebas)
            _editBebasMode = false;  // kembali ke mode normal setelah foto baru
            const banner = document.getElementById('editBannerOverlay');
            if (banner) banner.style.display = 'none';
            bukaOverlay();
        } else {
            alert("Foto berhasil diambil. Lanjut edit lalu simpan perubahan.");
            document.getElementById('photoPreview').scrollIntoView({behavior:'smooth'});
        }
    }
}

function stopAll() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
    document.getElementById('photoModal').style.display = 'none';
    document.getElementById('video').srcObject = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERLAY PRATINJAU DATA LENGKAP TAMU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function bukaOverlay() {
    const overlay = document.getElementById('overlayPratinjau');
    if (!overlay) return;

    // ‚îÄ‚îÄ Isi tabel data ‚îÄ‚îÄ
    const asal = document.getElementById('asal').value;
    const nama = document.getElementById('nama').value.trim();

    const rows = [
        { lbl: 'Nama Lengkap',       val: nama },
        { lbl: 'Asal',               val: asal === 'INSTANSI' ? 'Instansi / Unit Kerja' : 'Masyarakat' },
    ];

    if (asal === 'INSTANSI') {
        rows.push({ lbl: 'Instansi / Unit Kerja', val: document.getElementById('instansi').value || '‚Äî' });
    } else {
        rows.push({ lbl: 'Kecamatan',        val: document.getElementById('kecamatan').value || '‚Äî' });
        rows.push({ lbl: 'Desa / Kelurahan', val: document.getElementById('desa').value || '‚Äî' });
    }

    rows.push(
        { lbl: 'Pihak yang Ditemui', val: document.getElementById('pihakDitemui').value || '‚Äî' },
        { lbl: 'Jenis Layanan',      val: document.getElementById('jenisLayanan').value || '‚Äî' },
        { lbl: 'Uraian Keperluan',   val: document.getElementById('uraian').value.trim() || '‚Äî' },
        { lbl: 'Nomor WhatsApp',     val: document.getElementById('nomorHp').value.trim() || '‚Äî' },
        { lbl: 'Waktu Kunjungan',    val: new Date().toLocaleString('id-ID') }
    );

    const tbl = document.getElementById('opDataTable');
    tbl.innerHTML = '';
    rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'op-row';
        div.innerHTML =
            '<div class="op-rlbl">' + escHtml(r.lbl) + '</div>' +
            '<div class="op-rsep">:</div>' +
            '<div class="op-rval">' + escHtml(r.val) + '</div>';
        tbl.appendChild(div);
    });

    // ‚îÄ‚îÄ Isi timestamp header ‚îÄ‚îÄ
    const ts = document.getElementById('opTimestamp');
    if (ts) {
        const now = new Date();
        ts.innerHTML = now.toLocaleDateString('id-ID', {weekday:'short', day:'numeric', month:'short', year:'numeric'}) +
                       '<br>' + now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
    }

    // ‚îÄ‚îÄ Foto depan ‚îÄ‚îÄ
    const opFront = document.getElementById('opImgFront');
    const opFrontE = document.getElementById('opImgFrontEmpty');
    if (fotoDataURLFront) {
        opFront.src = fotoDataURLFront;
        opFront.style.display = 'block';
        if (opFrontE) opFrontE.style.display = 'none';
    } else {
        opFront.style.display = 'none';
        if (opFrontE) opFrontE.style.display = 'flex';
    }

    // ‚îÄ‚îÄ Foto belakang ‚îÄ‚îÄ
    const opBack = document.getElementById('opImgBack');
    const opBackE = document.getElementById('opImgBackEmpty');
    if (fotoDataURLBack) {
        opBack.src = fotoDataURLBack;
        opBack.style.display = 'block';
        if (opBackE) opBackE.style.display = 'none';
    } else {
        opBack.style.display = 'none';
        if (opBackE) opBackE.style.display = 'flex';
    }

    // ‚îÄ‚îÄ Tanda Tangan ‚îÄ‚îÄ
    const opTTD = document.getElementById('opImgTTD');
    const opTTDE = document.getElementById('opTTDEmpty');
    const opNama = document.getElementById('opNamaTTD');
    const ttdData = hasSignature ? ttdKeJpeg() : null;
    if (ttdData) {
        opTTD.src = ttdData;
        opTTD.style.display = 'block';
        if (opTTDE) opTTDE.style.display = 'none';
    } else {
        opTTD.style.display = 'none';
        if (opTTDE) opTTDE.style.display = 'flex';
    }
    if (opNama) opNama.textContent = nama;

    // ‚îÄ‚îÄ Tampilkan overlay ‚îÄ‚îÄ
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Scroll ke atas panel
    const body = document.getElementById('opBody');
    if (body) body.scrollTop = 0;
}

function tutupOverlay() {
    const overlay = document.getElementById('overlayPratinjau');
    if (!overlay) return;
    const panel = document.getElementById('opPanel');

    // Animasi keluar
    if (panel) {
        panel.style.animation = 'opSlideDown 0.30s cubic-bezier(0.55,0,1,0.45) both';
    }

    setTimeout(() => {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
        if (panel) panel.style.animation = '';
    }, 280);
}

async function simpanDetailDariOverlay() {
    // Tutup overlay dengan animasi
    tutupOverlay();
    setTimeout(async () => {
        // 1. Simpan ke data sementara
        const ok = await simpanDataSementara();
        if (!ok) return;
        // 2. Ambil index terakhir di sementara
        const sIndex = dataTamuSementara.length - 1;
        if (sIndex < 0) return;
        // 3. Pindah ke dataBukuTamu, unduh PDF, tampilkan tabel DATA BUKU TAMU
        await konfirmasiDanSimpanPDF(sIndex);
    }, 320);
}

function editDariOverlay() {
    // ‚îÄ‚îÄ Tutup overlay dengan animasi ‚îÄ‚îÄ
    const overlay = document.getElementById('overlayPratinjau');
    const panel   = document.getElementById('opPanel');
    if (panel) panel.style.animation = 'opSlideDown 0.30s cubic-bezier(0.55,0,1,0.45) both';
    setTimeout(() => {
        if (overlay) { overlay.style.display = 'none'; }
        if (panel)   { panel.style.animation = ''; }
        document.body.style.overflow = '';

        // ‚îÄ‚îÄ Matikan semua auto-advance & timers ‚îÄ‚îÄ
        _stepNamaDone   = true;   // true = tidak auto-advance lagi
        _stepUraianDone = true;
        _stepHpDone     = true;
        clearTimeout(_timerNama);
        clearTimeout(_timerUraian);
        clearTimeout(_timerHp);

        // ‚îÄ‚îÄ Aktifkan mode edit-bebas (bukan isEditMode agar simpan berjalan normal) ‚îÄ‚îÄ
        _editBebasMode = true;

        // ‚îÄ‚îÄ Sembunyikan stepHeader progress bar (tidak relevan di mode edit) ‚îÄ‚îÄ
        const stepHeader = document.getElementById('stepHeader');
        if (stepHeader) stepHeader.style.opacity = '0.5';

        // ‚îÄ‚îÄ Tampilkan banner edit ‚îÄ‚îÄ
        const banner = document.getElementById('editBannerOverlay');
        if (banner) {
            banner.style.display = 'flex';
            banner.style.animation = 'none';
            void banner.offsetWidth;
            banner.style.animation = '';
        }

        // ‚îÄ‚îÄ Tampilkan SEMUA field sekaligus ‚îÄ‚îÄ
        const area = document.getElementById('stepInputArea');
        if (area) {
            Array.from(area.children).forEach(c => {
                c.classList.remove('hidden');
                c.classList.remove('sf-enter');  // hapus animasi step
            });
        }

        // Tampilkan/sembunyikan field kondisional sesuai asal
        const asal = document.getElementById('asal').value;
        if (asal === 'INSTANSI') {
            document.getElementById('daftarMasyarakat').classList.add('hidden');
            document.getElementById('fieldDesa').classList.add('hidden');
        } else if (asal === 'MASYARAKAT') {
            document.getElementById('daftarInstansi').classList.add('hidden');
            // Isi ulang list desa sesuai kecamatan yang sudah dipilih
            const kec = document.getElementById('kecamatan').value;
            if (kec && dataDesa[kec]) {
                const desaEl = document.getElementById('desa');
                const curDesa = desaEl.value;
                desaEl.innerHTML = '<option value="">-- Pilih Desa/Kelurahan --</option>';
                dataDesa[kec].forEach(d => {
                    const o = document.createElement('option');
                    o.value = d; o.textContent = d;
                    desaEl.appendChild(o);
                });
                desaEl.value = curDesa;
            }
            document.getElementById('fieldDesa').classList.remove('hidden');
        } else {
            document.getElementById('daftarInstansi').classList.add('hidden');
            document.getElementById('daftarMasyarakat').classList.add('hidden');
            document.getElementById('fieldDesa').classList.add('hidden');
        }

        // ‚îÄ‚îÄ Resize canvas TTD ‚îÄ‚îÄ
        resizeCanvas();

        // ‚îÄ‚îÄ Scroll ke atas form ‚îÄ‚îÄ
        if (stepHeader) {
            stepHeader.style.opacity = '';
            setTimeout(() => stepHeader.scrollIntoView({ behavior: 'smooth', block: 'start' }), 80);
        }

    }, 290);
}

function selesaiEditBebas() {
    // Pratinjau ulang dari mode edit bebas - tidak perlu foto baru jika sudah ada
    _editBebasMode = false;
    _stepNamaDone   = false;
    _stepUraianDone = false;
    _stepHpDone     = false;
    const banner = document.getElementById('editBannerOverlay');
    if (banner) banner.style.display = 'none';
    // Update foto preview di form
    const imgFront = document.getElementById('imgFront');
    const imgBack  = document.getElementById('imgBack');
    if (fotoDataURLFront && imgFront) { imgFront.src = fotoDataURLFront; imgFront.style.display = 'block'; }
    if (fotoDataURLBack  && imgBack)  { imgBack.src  = fotoDataURLBack;  imgBack.style.display  = 'block'; }
    // Buka overlay dengan data terkini
    bukaOverlay();
}




function forceShowEditFields() {
    const fieldsToShow = [
        'field-asal', 'field-pihakDitemui', 'field-jenisLayanan',
        'field-uraian', 'field-nomorHp', 'field-tandaTangan', 'field-aksi'
    ];
    fieldsToShow.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('hidden');
    });
    asalChanged();
    if (document.getElementById('asal').value === 'MASYARAKAT') {
        document.getElementById('fieldDesa').classList.remove('hidden');
    }
}

// ===== DATA MANAGEMENT =====
async function simpanData() {
    const form = document.getElementById('bukuTamuForm');
    let isValid = true;
    document.getElementById('signatureWarning').style.display = 'none';
    document.getElementById('photoWarning').style.display = 'none';
    if (!form.reportValidity()) isValid = false;
    if (!isEditMode) {
        const uraianValue = document.getElementById('uraian').value.trim();
        if (uraianValue.length < 15) {
            document.getElementById('uraian').classList.add('error');
            isValid = false;
            alert('Uraian minimal 15 karakter saat input baru!');
        }
        const namaInput = document.getElementById('nama');
        let hurufCount = (namaInput.value.trim().match(/[A-Za-z]/g) || []).length;
        if (hurufCount < 5) {
            namaInput.classList.add('error');
            isValid = false;
            alert('Nama minimal 5 huruf saat input baru!');
        }
        const nomorHpInput = document.getElementById('nomorHp');
        const nomorValue = nomorHpInput.value.trim().replace(/[^0-9]/g, '');
        if (nomorValue.length < 11) {
            nomorHpInput.classList.add('error');
            isValid = false;
            alert('Nomor WA minimal 11 digit saat input baru!');
        }
        const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
        if (!hasSignature || strokeLengthCm < MIN_STROKE_LENGTH_CM) {
            document.getElementById('signatureWarning').style.display = 'block';
            isValid = false;
        }
        if (!hasPhoto) {
            document.getElementById('photoWarning').style.display = 'block';
            isValid = false;
        }
    } else {
        const requiredFields = ['nama', 'asal', 'pihakDitemui', 'jenisLayanan'];
        requiredFields.forEach(id => {
            const el = document.getElementById(id);
            if (el && !el.value.trim()) {
                el.classList.add('error');
                isValid = false;
            }
        });
    }
    if (!isValid) return false;
    const asal = document.getElementById('asal').value;
    const formData = {
        nama: document.getElementById('nama').value.trim(),
        asal: asal,
        instansi: asal === 'INSTANSI' ? document.getElementById('instansi').value : '',
        kecamatan: asal === 'MASYARAKAT' ? document.getElementById('kecamatan').value : '',
        desa: asal === 'MASYARAKAT' ? document.getElementById('desa').value : '',
        pihakDitemui: document.getElementById('pihakDitemui').value,
        jenisLayanan: document.getElementById('jenisLayanan').value,
        uraian: document.getElementById('uraian').value.trim(),
        nomorHp: document.getElementById('nomorHp').value.trim(),
        tandaTangan: hasSignature ? ttdKeJpeg() : (editingSementara ? (dataTamuSementara[editingIndex]?.tandaTangan || '') : (dataBukuTamu[editingIndex]?.tandaTangan || '')),
        fotoFront: fotoDataURLFront || (editingSementara ? (dataTamuSementara[editingIndex]?.fotoFront || null) : (dataBukuTamu[editingIndex]?.fotoFront || null)),
        fotoBack: fotoDataURLBack || (editingSementara ? (dataTamuSementara[editingIndex]?.fotoBack || null) : (dataBukuTamu[editingIndex]?.fotoBack || null)),
        timestamp: isEditMode ? (editingSementara ? (dataTamuSementara[editingIndex]?.timestamp || new Date().toLocaleString('id-ID')) : (dataBukuTamu[editingIndex]?.timestamp || new Date().toLocaleString('id-ID'))) : new Date().toLocaleString('id-ID')
    };
    if (editingIndex >= 0) {
        if (editingSementara) {
            formData._sementara = true;
            dataTamuSementara[editingIndex] = formData;
        } else {
            dataBukuTamu[editingIndex] = formData;
        }
    } else {
        dataBukuTamu.push(formData);
    }
    updateDataCounter();
    await lsSave();
    resetFormComplete();
    return true;
}

// Helper: ambil TTD dari canvas dengan latar putih ‚Üí JPEG (bukan PNG transparan)
function ttdKeJpeg() {
    if (!signatureCanvas) return '';
    const cvs = document.createElement('canvas');
    cvs.width  = signatureCanvas.width;
    cvs.height = signatureCanvas.height;
    const c = cvs.getContext('2d');
    c.fillStyle = '#ffffff';
    c.fillRect(0, 0, cvs.width, cvs.height);
    c.drawImage(signatureCanvas, 0, 0);
    return cvs.toDataURL('image/jpeg', 0.95);
}

async function simpanDataSementara() {
    const form = document.getElementById('bukuTamuForm');
    let isValid = true;
    const requiredFields = ['nama', 'asal', 'pihakDitemui', 'jenisLayanan'];
    requiredFields.forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.value.trim()) {
            el.classList.add('error');
            isValid = false;
        }
    });
    if (!isValid) {
        alert('‚ùå Data belum lengkap. Silakan lengkapi form terlebih dahulu.');
        return false;
    }
    const asal = document.getElementById('asal').value;
    const formData = {
        nama: document.getElementById('nama').value.trim(),
        asal: asal,
        instansi: asal === 'INSTANSI' ? document.getElementById('instansi').value : '',
        kecamatan: asal === 'MASYARAKAT' ? document.getElementById('kecamatan').value : '',
        desa: asal === 'MASYARAKAT' ? document.getElementById('desa').value : '',
        pihakDitemui: document.getElementById('pihakDitemui').value,
        jenisLayanan: document.getElementById('jenisLayanan').value,
        uraian: document.getElementById('uraian').value.trim(),
        nomorHp: document.getElementById('nomorHp').value.trim(),
        tandaTangan: ttdKeJpeg(),
        fotoFront: fotoDataURLFront || null,
        fotoBack: fotoDataURLBack || null,
        timestamp: new Date().toLocaleString('id-ID'),
        _sementara: true
    };
    dataTamuSementara.push(formData);
    updateDataCounter();
    await lsSave();
    resetFormComplete();
    return true;
}

function resetFormComplete() {
    document.getElementById('bukuTamuForm').reset();
    hasSignature = false;
    hasPhoto = false;
    fotoDataURLFront = null;
    fotoDataURLBack = null;
    totalStrokeLength = 0;
    if (ctx2) ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    signatureDataURL = null;
    // Reset auto-advance flags & timers
    _stepNamaDone = false; _stepUraianDone = false; _stepHpDone = false;
    clearTimeout(_timerNama); clearTimeout(_timerUraian); clearTimeout(_timerHp);
    // Reset edit bebas mode
    _editBebasMode = false;
    const banner = document.getElementById('editBannerOverlay');
    if (banner) banner.style.display = 'none';
    bersihJawab();
    hideAllFields();
    isEditMode = false;
    editingIndex = -1;
    editingSementara = false;
}

// ===== NAVIGATION =====
function showForm() {
    // Pastikan welcome page tersembunyi dan mainApp terlihat
    sembunyikanWelcome();
    document.getElementById('mainApp').style.display = 'block';
    document.body.classList.add('app-aktif');

    document.getElementById('bukuTamuForm').reset();
    hasSignature = false;
    hasPhoto = false;
    fotoDataURLFront = null;
    fotoDataURLBack = null;
    totalStrokeLength = 0;
    if (ctx2) ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    bersihJawab();
    hideAllFields();
    isEditMode = false;
    editingIndex = -1;
    editingSementara = false;
    // Reset auto-advance flags
    _stepNamaDone = false; _stepUraianDone = false; _stepHpDone = false;
    clearTimeout(_timerNama); clearTimeout(_timerUraian); clearTimeout(_timerHp);
    document.getElementById('formSection').style.display = 'block';
    document.getElementById('dataSection').style.display = 'none';
    document.getElementById('editModeButtons').style.display = 'none';
    const imgFront = document.getElementById('imgFront');
    const imgBack  = document.getElementById('imgBack');
    if (imgFront) { imgFront.src = ''; imgFront.style.display = 'none'; }
    if (imgBack)  { imgBack.src  = ''; imgBack.style.display  = 'none'; }
    document.getElementById('mainNavigation').style.display = 'block';
    document.getElementById('btnForm').style.background = '#28a745';
    document.getElementById('btnData').style.background = '';
}

function showData() {
    document.getElementById('formSection').style.display = 'none';
    document.getElementById('dataSection').style.display = 'block';
    document.getElementById('btnForm').style.background = '#6c757d';
    document.getElementById('btnData').style.background = '#28a745';
    displayData();
}

function displayData() {
    const container = document.getElementById('dataContainer');
    if (dataBukuTamu.length === 0 && dataTamuSementara.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#666;">Belum ada data yang tersimpan</p>';
        return;
    }
    let html = '';
    if (dataTamuSementara.length > 0) {
        html += `<div style="background:#fff8e1;border:2px dashed #ffc107;border-radius:10px;padding:10px 14px;margin-bottom:18px;">
            <b style="color:#b8860b;">‚è≥ Data Menunggu Konfirmasi (${dataTamuSementara.length})</b>
            <p style="margin:4px 0 0;font-size:0.88em;color:#7a5800;">
                Data berikut <u>belum masuk</u> ke Export Tabel Ringkasan.<br>
                Klik <b>üñ®Ô∏è Simpan Detail Lengkap (Per Tamu)</b> ‚Äî data akan <b>otomatis</b> masuk ke tabel ringkasan dan PDF akan langsung diunduh.
            </p>
        </div>`;
        dataTamuSementara.forEach((data, sIndex) => {
            html += buildDetailHTML(data, sIndex, true);
        });
    }
    const tMasy = dataBukuTamu.filter(d => d.asal === 'MASYARAKAT');
    if (tMasy.length > 0) {
        html += `<div style="margin-bottom:28px;"><div style="background:#28a745;color:#fff;font-weight:bold;font-size:1em;padding:10px 16px;border-radius:8px 8px 0 0;letter-spacing:0.04em;">DAFTAR TAMU MASYARAKAT</div><div style="overflow-x:auto;border:1px solid #c3e6cb;border-top:none;border-radius:0 0 8px 8px;"><table style="width:100%;border-collapse:collapse;font-size:0.88em;background:#fff;"><thead><tr style="background:#28a745;color:#fff;text-align:center;"><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">No</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Nama</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Kecamatan</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Desa</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Pihak Ditemui</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Layanan</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Uraian</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">No HP</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Waktu</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">TTD</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Foto Depan</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Foto Belakang</th><th style="padding:10px 8px;border:1px solid #c3e6cb;white-space:nowrap;">Aksi</th></tr></thead><tbody>${tMasy.map((d, i) => { const realIdx = dataBukuTamu.indexOf(d); const rowBg = i % 2 === 0 ? '#fff' : '#f6fdf7'; return `<tr style="background:${rowBg};vertical-align:middle;"><td style="padding:10px 8px;border:1px solid #dee2e6;text-align:center;">${i+1}</td><td style="padding:10px 8px;border:1px solid #dee2e6;">${d.nama||''}</td><td style="padding:10px 8px;border:1px solid #dee2e6;">${d.kecamatan||'-'}</td><td style="padding:10px 8px;border:1px solid #dee2e6;">${d.desa||'-'}</td><td style="padding:10px 8px;border:1px solid #dee2e6;">${d.pihakDitemui||''}</td><td style="padding:10px 8px;border:1px solid #dee2e6;">${d.jenisLayanan||''}</td><td style="padding:10px 8px;border:1px solid #dee2e6;max-width:120px;word-break:break-word;">${d.uraian||'-'}</td><td style="padding:10px 8px;border:1px solid #dee2e6;white-space:nowrap;">${(d.nomorHp||'').replace(/^C\s*/,'')}</td><td style="padding:10px 8px;border:1px solid #dee2e6;white-space:nowrap;font-size:0.82em;">${d.timestamp||''}</td><td style="padding:10px 8px;border:1px solid #dee2e6;text-align:center;">${d.tandaTangan ? `<img src="${d.tandaTangan}" style="height:48px;max-width:80px;object-fit:contain;" alt="TTD">` : '-'}</td><td style="padding:10px 8px;border:1px solid #dee2e6;text-align:center;">${d.fotoFront ? `<img src="${d.fotoFront}" style="height:60px;max-width:70px;object-fit:cover;border-radius:4px;" alt="Depan">` : '-'}</td><td style="padding:10px 8px;border:1px solid #dee2e6;text-align:center;">${d.fotoBack ? `<img src="${d.fotoBack}" style="height:60px;max-width:70px;object-fit:cover;border-radius:4px;" alt="Belakang">` : '-'}</td><td style="padding:8px 6px;border:1px solid #dee2e6;text-align:center;white-space:nowrap;"><button onclick="lihatData(${realIdx})" style="background:#17a2b8;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:0.8em;margin-bottom:4px;display:block;width:100%;">üëÅÔ∏è Lihat</button><button onclick="exportDetailPerTamuPDF(${realIdx})" style="background:#6610f2;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:0.8em;display:block;width:100%;">üñ®Ô∏è PDF</button></td></tr>`; }).join('')}</tbody></table></div></div>`;
    }
    const tInst = dataBukuTamu.filter(d => d.asal === 'INSTANSI');
    if (tInst.length > 0) {
        html += `<div style="margin-bottom:28px;"><div style="background:#0d6efd;color:#fff;font-weight:bold;font-size:1em;padding:10px 16px;border-radius:8px 8px 0 0;letter-spacing:0.04em;">DAFTAR TAMU INSTANSI / UNIT KERJA</div><div style="overflow-x:auto;border:1px solid #b6d0ff;border-top:none;border-radius:0 0 8px 8px;"><table style="width:100%;border-collapse:collapse;font-size:0.88em;background:#fff;"><thead><tr style="background:#0d6efd;color:#fff;text-align:center;"><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">No</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">Nama</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">Instansi</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">Pihak Ditemui</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">Layanan</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">Uraian</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">No HP</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">Waktu</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">TTD</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">Foto Depan</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">Foto Belakang</th><th style="padding:10px 8px;border:1px solid #b6d0ff;white-space:nowrap;">Aksi</th></tr></thead><tbody>${tInst.map((d, i) => { const realIdx = dataBukuTamu.indexOf(d); const rowBg = i % 2 === 0 ? '#fff' : '#f0f5ff'; return `<tr style="background:${rowBg};vertical-align:middle;"><td style="padding:10px 8px;border:1px solid #dee2e6;text-align:center;">${i+1}</td><td style="padding:10px 8px;border:1px solid #dee2e6;">${d.nama||''}</td><td style="padding:10px 8px;border:1px solid #dee2e6;max-width:130px;word-break:break-word;">${d.instansi||'-'}</td><td style="padding:10px 8px;border:1px solid #dee2e6;">${d.pihakDitemui||''}</td><td style="padding:10px 8px;border:1px solid #dee2e6;">${d.jenisLayanan||''}</td><td style="padding:10px 8px;border:1px solid #dee2e6;max-width:120px;word-break:break-word;">${d.uraian||'-'}</td><td style="padding:10px 8px;border:1px solid #dee2e6;white-space:nowrap;">${(d.nomorHp||'').replace(/^C\s*/,'')}</td><td style="padding:10px 8px;border:1px solid #dee2e6;white-space:nowrap;font-size:0.82em;">${d.timestamp||''}</td><td style="padding:10px 8px;border:1px solid #dee2e6;text-align:center;">${d.tandaTangan ? `<img src="${d.tandaTangan}" style="height:48px;max-width:80px;object-fit:contain;" alt="TTD">` : '-'}</td><td style="padding:10px 8px;border:1px solid #dee2e6;text-align:center;">${d.fotoFront ? `<img src="${d.fotoFront}" style="height:60px;max-width:70px;object-fit:cover;border-radius:4px;" alt="Depan">` : '-'}</td><td style="padding:10px 8px;border:1px solid #dee2e6;text-align:center;">${d.fotoBack ? `<img src="${d.fotoBack}" style="height:60px;max-width:70px;object-fit:cover;border-radius:4px;" alt="Belakang">` : '-'}</td><td style="padding:8px 6px;border:1px solid #dee2e6;text-align:center;white-space:nowrap;"><button onclick="lihatData(${realIdx})" style="background:#17a2b8;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:0.8em;margin-bottom:4px;display:block;width:100%;">üëÅÔ∏è Lihat</button><button onclick="exportDetailPerTamuPDF(${realIdx})" style="background:#6610f2;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:0.8em;display:block;width:100%;">üñ®Ô∏è PDF</button></td></tr>`; }).join('')}</tbody></table></div></div>`;
    }
    if (dataBukuTamu.length === 0) {
        html += `<p style="text-align:center;color:#888;margin-top:10px;">Belum ada data terkonfirmasi.</p>`;
    }
    container.innerHTML = html;
}

function buildDetailHTML(data, index, isSementara) {
    const headerBg  = isSementara ? 'background:#fff3cd;border-left:5px solid #ffc107;' : '';
    const badge     = isSementara
        ? `<span style="background:#ffc107;color:#000;font-size:0.8em;padding:3px 8px;border-radius:20px;font-weight:bold;margin-right:8px;">‚è≥ BELUM DIKONFIRMASI</span>`
        : `<span style="background:#28a745;color:#fff;font-size:0.8em;padding:3px 8px;border-radius:20px;font-weight:bold;margin-right:8px;">‚úÖ TERKONFIRMASI</span>`;
    const nomor     = isSementara ? `S-${index + 1}` : `${index + 1}`;
    const editBtn   = isSementara
        ? `<button onclick="editSementara(${index})" style="background:#17a2b8;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin-right:5px;">‚úèÔ∏è Edit</button>
           <button onclick="hapusSementara(${index})" style="background:#dc3545;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin-right:5px;">üóëÔ∏è Hapus</button>`
        : `<button onclick="editData(${index})" style="background:#ffc107;color:black;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin-right:5px;">‚úèÔ∏è Edit</button>`;
    const simpanBtn = isSementara
        ? ''
        : '';

    return `<div class="detail-container" style="${headerBg}"><div class="detail-header"><h3>${badge}Data Tamu #${nomor}</h3><div>${editBtn}${simpanBtn}</div></div><div class="detail-row"><div class="detail-label">Nama Lengkap</div><div class="detail-value">${data.nama}</div></div>${data.asal === 'INSTANSI' ? `<div class="detail-row"><div class="detail-label">Instansi / Unit Kerja</div><div class="detail-value">${data.instansi || '-'}</div></div>` : data.asal === 'MASYARAKAT' ? `<div class="detail-row"><div class="detail-label">Asal</div><div class="detail-value">Masyarakat</div></div><div class="detail-row"><div class="detail-label">Kecamatan</div><div class="detail-value">${data.kecamatan || '-'}</div></div><div class="detail-row"><div class="detail-label">Desa / Kelurahan</div><div class="detail-value">${data.desa || '-'}</div></div>` : `<div class="detail-row"><div class="detail-label">Asal</div><div class="detail-value">${data.asal || '-'}</div></div>`}<div class="detail-row"><div class="detail-label">Pihak Ditemui</div><div class="detail-value">${data.pihakDitemui}</div></div><div class="detail-row"><div class="detail-label">Jenis Layanan</div><div class="detail-value">${data.jenisLayanan}</div></div><div class="detail-row"><div class="detail-label">Uraian Keperluan</div><div class="detail-value">${data.uraian}</div></div><div class="detail-row"><div class="detail-label">Nomor WhatsApp</div><div class="detail-value">${data.nomorHp}</div></div><div class="detail-row"><div class="detail-label">Waktu Kunjungan</div><div class="detail-value">${data.timestamp}</div></div><div class="detail-row"><div class="detail-label">Dokumentasi Foto</div><div class="detail-value">${data.fotoFront ? `<img src="${data.fotoFront}" style="width:150px;margin-right:10px;border:1px solid #ddd;" alt="Foto Depan">` : ''}${data.fotoBack ? `<img src="${data.fotoBack}" style="width:150px;border:1px solid #ddd;" alt="Foto Belakang">` : ''}</div></div><div class="detail-row"><div class="detail-label">Tanda Tangan</div><div class="detail-value"><img src="${data.tandaTangan}" style="max-width:300px;border:1px solid #ddd;" alt="TTD"></div></div></div>`;
}

async function konfirmasiDanSimpanPDF(sIndex) {
    if (sIndex < 0 || sIndex >= dataTamuSementara.length) return;
    const data = dataTamuSementara[sIndex];
    delete data._sementara;
    dataBukuTamu.push(data);
    dataTamuSementara.splice(sIndex, 1);
    updateDataCounter();
    await lsSave();
    // Tampilkan halaman DATA BUKU TAMU (tabel ringkasan)
    showData();
    // Unduh PDF detail per tamu
    const finalIndex = dataBukuTamu.length - 1;
    exportDetailPerTamuPDF(finalIndex);
}

async function hapusSementara(sIndex) {
    if (sIndex < 0 || sIndex >= dataTamuSementara.length) return;
    const data = dataTamuSementara[sIndex];
    if (confirm(`Hapus data sementara "${data.nama}"?\nData yang dihapus tidak dapat dikembalikan.`)) {
        dataTamuSementara.splice(sIndex, 1);
        updateDataCounter();
        await lsSave();
        displayData();
    }
}

function editData(index) {
    if (confirm('Edit data tamu #' + (index + 1) + '?')) {
        const data = dataBukuTamu[index];
        editingIndex = index;
        originalEditData = JSON.parse(JSON.stringify(data));
        isEditMode = true;
        editingSementara = false;
        document.getElementById('nama').value = data.nama || '';
        validateNama();
        document.getElementById('asal').value = data.asal || '';
        asalChanged();
        if (data.asal === 'INSTANSI') {
            document.getElementById('instansi').value = data.instansi || '';
        } else if (data.asal === 'MASYARAKAT') {
            document.getElementById('kecamatan').value = data.kecamatan || '';
            updateDesaList();
            setTimeout(() => { document.getElementById('desa').value = data.desa || ''; }, 50);
        }
        document.getElementById('pihakDitemui').value = data.pihakDitemui || '';
        document.getElementById('jenisLayanan').value = data.jenisLayanan || '';
        document.getElementById('uraian').value = data.uraian || '';
        document.getElementById('nomorHp').value = data.nomorHp || '';
        if (data.tandaTangan) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                ctx2.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                hasSignature = true;
                totalStrokeLength = 100;
            };
            img.src = data.tandaTangan;
        }
        fotoDataURLFront = data.fotoFront || null;
        fotoDataURLBack  = data.fotoBack  || null;
        hasPhoto = !!(data.fotoFront || data.fotoBack);
        if (data.fotoFront) document.getElementById('imgFront').src = data.fotoFront;
        if (data.fotoBack)  document.getElementById('imgBack').src  = data.fotoBack;
        forceShowEditFields();
        document.getElementById('formSection').style.display = 'block';
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('editModeButtons').style.display = 'block';
    }
}

function lihatData(index) {
    const data = dataBukuTamu[index];
    if (!data) return;
    const nomor = index + 1;
    const badge = data.asal === 'INSTANSI'
        ? '<span style="background:#0d6efd;color:#fff;padding:2px 8px;border-radius:10px;font-size:0.8em;margin-right:8px;">INSTANSI</span>'
        : '<span style="background:#28a745;color:#fff;padding:2px 8px;border-radius:10px;font-size:0.8em;margin-right:8px;">MASYARAKAT</span>';
    const headerBg = data.asal === 'INSTANSI'
        ? 'border-left:5px solid #0d6efd;'
        : 'border-left:5px solid #28a745;';

    let asalInfo = '';
    if (data.asal === 'INSTANSI') {
        asalInfo = `<div class="detail-row"><div class="detail-label">Instansi / Unit Kerja</div><div class="detail-value">${data.instansi || '-'}</div></div>`;
    } else if (data.asal === 'MASYARAKAT') {
        asalInfo = `<div class="detail-row"><div class="detail-label">Asal</div><div class="detail-value">Masyarakat</div></div>
        <div class="detail-row"><div class="detail-label">Kecamatan</div><div class="detail-value">${data.kecamatan || '-'}</div></div>
        <div class="detail-row"><div class="detail-label">Desa / Kelurahan</div><div class="detail-value">${data.desa || '-'}</div></div>`;
    }

    const html = `<div class="detail-container" style="${headerBg}">
        <div class="detail-header">
            <h3>${badge}Data Tamu #${nomor}</h3>
            <div>
                <button onclick="document.getElementById('dataSection').style.display='block'; document.getElementById('lihatModal').remove();"
                    style="background:#6c757d;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;">‚úñ Tutup</button>
            </div>
        </div>
        <div class="detail-row"><div class="detail-label">Nama Lengkap</div><div class="detail-value">${data.nama}</div></div>
        ${asalInfo}
        <div class="detail-row"><div class="detail-label">Pihak Ditemui</div><div class="detail-value">${data.pihakDitemui}</div></div>
        <div class="detail-row"><div class="detail-label">Jenis Layanan</div><div class="detail-value">${data.jenisLayanan}</div></div>
        <div class="detail-row"><div class="detail-label">Uraian Keperluan</div><div class="detail-value">${data.uraian}</div></div>
        <div class="detail-row"><div class="detail-label">Nomor WhatsApp</div><div class="detail-value">${data.nomorHp}</div></div>
        <div class="detail-row"><div class="detail-label">Waktu Kunjungan</div><div class="detail-value">${data.timestamp}</div></div>
        <div class="detail-row"><div class="detail-label">Dokumentasi Foto</div><div class="detail-value">
            ${data.fotoFront ? `<img src="${data.fotoFront}" style="width:150px;margin-right:10px;border:1px solid #ddd;" alt="Foto Depan">` : ''}
            ${data.fotoBack ? `<img src="${data.fotoBack}" style="width:150px;border:1px solid #ddd;" alt="Foto Belakang">` : ''}
        </div></div>
        <div class="detail-row"><div class="detail-label">Tanda Tangan</div><div class="detail-value">
            ${data.tandaTangan ? `<img src="${data.tandaTangan}" style="max-width:300px;border:1px solid #ddd;" alt="TTD">` : '-'}
        </div></div>
    </div>`;

    const modal = document.createElement('div');
    modal.id = 'lihatModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;overflow-y:auto;display:flex;align-items:flex-start;justify-content:center;padding:20px;box-sizing:border-box;';
    const box = document.createElement('div');
    box.style.cssText = 'background:#fff;border-radius:10px;max-width:700px;width:100%;margin-top:20px;';
    box.innerHTML = html;
    modal.appendChild(box);
    modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
}

function editSementara(sIndex) {
    if (confirm('Edit data sementara #S-' + (sIndex + 1) + '?')) {
        const data = dataTamuSementara[sIndex];
        editingIndex = sIndex;
        originalEditData = JSON.parse(JSON.stringify(data));
        isEditMode = true;
        editingSementara = true;
        document.getElementById('nama').value = data.nama || '';
        validateNama();
        document.getElementById('asal').value = data.asal || '';
        asalChanged();
        if (data.asal === 'INSTANSI') {
            document.getElementById('instansi').value = data.instansi || '';
        } else if (data.asal === 'MASYARAKAT') {
            document.getElementById('kecamatan').value = data.kecamatan || '';
            updateDesaList();
            setTimeout(() => { document.getElementById('desa').value = data.desa || ''; }, 50);
        }
        document.getElementById('pihakDitemui').value = data.pihakDitemui || '';
        document.getElementById('jenisLayanan').value = data.jenisLayanan || '';
        document.getElementById('uraian').value = data.uraian || '';
        document.getElementById('nomorHp').value = data.nomorHp || '';
        if (data.tandaTangan) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                ctx2.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                ctx2.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                hasSignature = true;
                totalStrokeLength = 100;
            };
            img.src = data.tandaTangan;
        }
        fotoDataURLFront = data.fotoFront || null;
        fotoDataURLBack  = data.fotoBack  || null;
        hasPhoto = !!(data.fotoFront || data.fotoBack);
        if (data.fotoFront) document.getElementById('imgFront').src = data.fotoFront;
        if (data.fotoBack)  document.getElementById('imgBack').src  = data.fotoBack;
        forceShowEditFields();
        document.getElementById('formSection').style.display = 'block';
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('editModeButtons').style.display = 'block';
    }
}

async function saveEditedData() {
    if (await simpanData()) {
        alert("‚úÖ Perubahan berhasil disimpan!");
        editingIndex = -1;
        originalEditData = null;
        isEditMode = false;
        editingSementara = false;
        document.getElementById('mainNavigation').style.display = 'block';
        document.getElementById('editModeButtons').style.display = 'none';
        showData();
    } else {
        alert("‚ùå Data belum lengkap atau tidak valid.");
    }
}

async function cancelEdit() {
    if (originalEditData && editingIndex >= 0) {
        if (editingSementara) {
            dataTamuSementara[editingIndex] = originalEditData;
        } else {
            dataBukuTamu[editingIndex] = originalEditData;
        }
        updateDataCounter();
        await lsSave();
    }
    editingIndex = -1;
    originalEditData = null;
    isEditMode = false;
    editingSementara = false;
    document.getElementById('mainNavigation').style.display = 'block';
    document.getElementById('editModeButtons').style.display = 'none';
    showData();
    alert('Edit dibatalkan. Data asli dikembalikan.');
}

async function deleteData(index) {
    if (confirm('Yakin ingin menghapus data tamu #' + (index + 1) + '?')) {
        dataBukuTamu.splice(index, 1);
        updateDataCounter();
        await lsSave();
        displayData();
        alert('Data berhasil dihapus!');
    }
}

function resetSemuaData() {
    const total = dataBukuTamu.length + dataTamuSementara.length;
    if (total === 0) { alert('Tidak ada data untuk dihapus.'); return; }
    if (!confirm(`‚ö†Ô∏è PERHATIAN!\n\nAnda akan menghapus SEMUA data (${total} tamu).\nData yang sudah dihapus TIDAK bisa dikembalikan.\n\nLanjutkan?`)) return;
    if (!confirm('Konfirmasi sekali lagi: hapus semua data tamu?')) return;
    dataBukuTamu = [];
    dataTamuSementara = [];
    lsClear();
    updateDataCounter();
    displayData();
    alert('‚úÖ Semua data berhasil dihapus.');
}

// ===== EXPORT TABEL RINGKASAN =====
function exportData() {
    lsLoad();
    updateDataCounter();
    if (dataBukuTamu.length === 0) {
        alert('Tidak ada data untuk di-export!\n\nPastikan sudah klik üñ®Ô∏è Simpan Detail Lengkap (Per Tamu) untuk setiap tamu agar data masuk ke ringkasan.');
        return;
    }
    const jmlInstansi   = dataBukuTamu.filter(d => d.asal === 'INSTANSI').length;
    const jmlMasyarakat = dataBukuTamu.filter(d => d.asal === 'MASYARAKAT').length;
    const existing = document.getElementById('_exportModal');
    if (existing) existing.remove();
    const modal = document.createElement('div');
    modal.id = '_exportModal';
    modal.style.cssText = `position:fixed;inset:0;z-index:999999;background:rgba(0,0,0,0.70);display:flex;align-items:center;justify-content:center;padding:20px;`;
    modal.innerHTML = `<div style="background:#fff;border-radius:14px;padding:30px 28px 24px;max-width:380px;width:100%;text-align:center;box-shadow:0 12px 48px rgba(0,0,0,0.45);border-top:5px solid #d4a820;"><div style="font-size:1.5em;margin-bottom:6px;">üìë</div><h3 style="margin:0 0 6px;color:#0d1f45;font-size:1.1em;font-weight:bold;">Export Tabel Ringkasan</h3><p style="margin:0 0 22px;color:#666;font-size:0.88em;">Pilih data yang ingin diunduh:</p><div style="display:flex;flex-direction:column;gap:10px;margin-bottom:18px;"><button onclick="doExport('INSTANSI')" style="padding:13px 18px;border:none;border-radius:8px;cursor:pointer;background:linear-gradient(135deg,#0d1f45,#1a3a6e);color:#f5e07a;font-size:0.95em;font-weight:bold;box-shadow:0 3px 10px rgba(13,31,69,0.35);display:flex;justify-content:space-between;align-items:center;"><span>üè¢ Instansi / Unit Kerja</span><span style="background:rgba(245,224,122,0.2);border-radius:20px;padding:2px 10px;font-size:0.82em;font-weight:normal;">${jmlInstansi} tamu</span></button><button onclick="doExport('MASYARAKAT')" style="padding:13px 18px;border:none;border-radius:8px;cursor:pointer;background:linear-gradient(135deg,#145a32,#1e8449);color:#fff;font-size:0.95em;font-weight:bold;box-shadow:0 3px 10px rgba(20,90,50,0.35);display:flex;justify-content:space-between;align-items:center;"><span>üë• Masyarakat</span><span style="background:rgba(255,255,255,0.2);border-radius:20px;padding:2px 10px;font-size:0.82em;font-weight:normal;">${jmlMasyarakat} tamu</span></button></div><button onclick="document.getElementById('_exportModal').remove()" style="background:none;border:1px solid #ccc;border-radius:6px;padding:8px 24px;cursor:pointer;color:#888;font-size:0.85em;">Batal</button></div>`;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
}


// ===== HELPER: Konversi data URL gambar ‚Üí JPEG berlatar putih (ASYNC) =====
// WAJIB async karena img.onload asinkron ‚Äî img.naturalWidth = 0 sebelum onload
function gambarKeJpeg(url) {
    return new Promise(function(resolve) {
        if (!url || typeof url !== 'string' || !url.startsWith('data:image')) return resolve(null);
        var img = new Image();
        img.onload = function() {
            try {
                var w = img.naturalWidth || 800, h = img.naturalHeight || 600;
                var c = document.createElement('canvas');
                c.width = w; c.height = h;
                var ctx = c.getContext('2d');
                ctx.fillStyle = '#ffffff';   // latar putih ‚Üí hilangkan alpha transparan
                ctx.fillRect(0, 0, w, h);
                ctx.drawImage(img, 0, 0, w, h);
                resolve(c.toDataURL('image/jpeg', 0.92));
            } catch(e) { resolve(url); }
        };
        img.onerror = function() { resolve(null); };
        img.src = url;
    });
}

// ===== GENERATE PDF TABEL RINGKASAN =====
async function doExport(filter) {
    const modal = document.getElementById('_exportModal');
    if (modal) modal.remove();
    const parseTS = s => {
        if (!s) return 0;
        const d = new Date(s); if (!isNaN(d)) return d.getTime();
        const m = s.match(/(\d+)\/(\d+)\/(\d+),?\s*(\d+)[.,:](\d+)[.,:](\d+)?/);
        if (m) return new Date(+m[3],+m[2]-1,+m[1],+m[4],+m[5],+(m[6]||0)).getTime();
        return 0;
    };
    const semuaTamu = dataBukuTamu.filter(d => d.asal === filter)
                                  .sort((a,b) => parseTS(a.timestamp)-parseTS(b.timestamp));
    if (semuaTamu.length === 0) {
        alert(`Tidak ada data tamu dari kategori "${filter==='INSTANSI'?'Instansi / Unit Kerja':'Masyarakat'}"!`);
        return;
    }

    // Konversi SEMUA gambar ke JPEG dulu ‚Äî autoTable sinkron, tidak bisa await di dalamnya
    const hasilJpeg = await Promise.all(
        semuaTamu.flatMap(d => [gambarKeJpeg(d.tandaTangan), gambarKeJpeg(d.fotoFront), gambarKeJpeg(d.fotoBack)])
    );
    const jpegMap = {};
    semuaTamu.forEach((d,i) => { jpegMap[i] = {ttd:hasilJpeg[i*3], front:hasilJpeg[i*3+1], back:hasilJpeg[i*3+2]}; });

    const judulFilter = filter==='INSTANSI' ? 'INSTANSI / UNIT KERJA' : 'MASYARAKAT';
    const namaFile    = filter==='INSTANSI' ? 'Instansi' : 'Masyarakat';
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l','mm','a4');
    const pageWidth = 297, margin = 10;
    let y = margin;

    doc.setFont("helvetica","bold"); doc.setFontSize(14);
    ['BUKU TAMU DIGITAL','INSPEKTORAT DAERAH','KABUPATEN TULANG BAWANG BARAT'].forEach(line => {
        doc.text(line, pageWidth/2, y, {align:'center'}); y += 5;
    });
    doc.setFont("helvetica","normal"); doc.setFontSize(9);
    doc.text(`Tanggal Export: ${new Date().toLocaleString('id-ID')}  ‚Ä¢  Total: ${semuaTamu.length} tamu`, pageWidth/2, y+1, {align:'center'});
    y += 9;
    doc.setFont("helvetica","bold"); doc.setFontSize(11);
    doc.text(`DAFTAR TAMU ‚Äî ${judulFilter}`, margin, y); y += 2;

    let columns, columnStyles;
    if (filter === 'INSTANSI') {
        columns = [
            {header:'No',dataKey:'no'},{header:'Nama',dataKey:'nama'},{header:'Instansi',dataKey:'instansi'},
            {header:'Pihak Ditemui',dataKey:'pihakDitemui'},{header:'Layanan',dataKey:'jenisLayanan'},
            {header:'Uraian',dataKey:'uraian'},{header:'No HP',dataKey:'nomorHp'},
            {header:'Waktu',dataKey:'timestamp'},{header:'TTD',dataKey:'tandaTangan'},
            {header:'Foto Depan',dataKey:'fotoFront'},{header:'Foto Belakang',dataKey:'fotoBack'}
        ];
        columnStyles = {
            no:{cellWidth:10,halign:'center'}, nama:{cellWidth:26}, instansi:{cellWidth:38},
            pihakDitemui:{cellWidth:24}, jenisLayanan:{cellWidth:26}, uraian:{cellWidth:'auto'},
            nomorHp:{cellWidth:26}, timestamp:{cellWidth:22},
            tandaTangan:{cellWidth:28,minCellHeight:30}, fotoFront:{cellWidth:30,minCellHeight:32}, fotoBack:{cellWidth:30,minCellHeight:32}
        };
    } else {
        columns = [
            {header:'No',dataKey:'no'},{header:'Nama',dataKey:'nama'},{header:'Kecamatan',dataKey:'kecamatan'},
            {header:'Desa',dataKey:'desa'},{header:'Pihak Ditemui',dataKey:'pihakDitemui'},
            {header:'Layanan',dataKey:'jenisLayanan'},{header:'Uraian',dataKey:'uraian'},
            {header:'No HP',dataKey:'nomorHp'},{header:'Waktu',dataKey:'timestamp'},
            {header:'TTD',dataKey:'tandaTangan'},{header:'Foto Depan',dataKey:'fotoFront'},{header:'Foto Belakang',dataKey:'fotoBack'}
        ];
        columnStyles = {
            no:{cellWidth:10,halign:'center'}, nama:{cellWidth:26}, kecamatan:{cellWidth:24},
            desa:{cellWidth:22}, pihakDitemui:{cellWidth:22}, jenisLayanan:{cellWidth:24},
            uraian:{cellWidth:'auto'}, nomorHp:{cellWidth:24}, timestamp:{cellWidth:20},
            tandaTangan:{cellWidth:26,minCellHeight:28}, fotoFront:{cellWidth:28,minCellHeight:30}, fotoBack:{cellWidth:28,minCellHeight:30}
        };
    }

    const imgKeys = ['tandaTangan','fotoFront','fotoBack'];
    const rows = semuaTamu.map((d,i) => {
        const r = {
            no:i+1, nama:d.nama||'', pihakDitemui:d.pihakDitemui||'', jenisLayanan:d.jenisLayanan||'',
            uraian:d.uraian||'-', nomorHp:(d.nomorHp||'').replace(/^C\s*/,''), timestamp:d.timestamp||'',
            tandaTangan:i, fotoFront:i, fotoBack:i
        };
        if (filter==='INSTANSI') r.instansi=d.instansi||'-';
        else { r.kecamatan=d.kecamatan||'-'; r.desa=d.desa||'-'; }
        return r;
    });

    const hfc = filter==='INSTANSI' ? [13,31,69] : [20,90,50];
    doc.autoTable({
        columns, body:rows, startY:y, margin:{left:margin,right:margin}, columnStyles,
        styles:{fontSize:8,cellPadding:3,overflow:'linebreak',halign:'left',valign:'middle'},
        headStyles:{fillColor:hfc,textColor:[245,224,122],fontStyle:'bold',halign:'center'},
        willDrawCell(h) {
            if (h.row.section!=='body') return;
            if (imgKeys.includes(h.column.dataKey)) doc.setFillColor(255,255,255);
            else if (filter==='MASYARAKAT') doc.setFillColor(235,250,238);
            else doc.setFillColor(h.row.index%2===0?255:248, h.row.index%2===0?255:246, h.row.index%2===0?255:240);
            doc.rect(h.cell.x, h.cell.y, h.cell.width, h.cell.height, 'F');
        },
        didParseCell(h) {
            if (h.row.section==='body' && imgKeys.includes(h.column.dataKey)) h.cell.text=[];
        },
        didDrawCell(h) {
            if (h.row.section!=='body' || !imgKeys.includes(h.column.dataKey)) return;
            const idx = h.cell.raw;
            if (typeof idx!=='number' || !jpegMap[idx]) return;
            let jpg = h.column.dataKey==='tandaTangan' ? jpegMap[idx].ttd
                    : h.column.dataKey==='fotoFront'   ? jpegMap[idx].front
                    : jpegMap[idx].back;
            if (!jpg) return;
            try {
                doc.setGState(doc.GState({opacity:1.0}));
                const p = 1.5;
                const availW = h.cell.width - p * 2;
                const availH = h.cell.height - p * 2;
                if (availW < 2 || availH < 2) return;
                // Pertahankan rasio gambar
                const sz = Math.min(availW, availH);
                const imgX = h.cell.x + p + (availW - sz) / 2;
                const imgY = h.cell.y + p + (availH - sz) / 2;
                doc.setFillColor(255,255,255);
                doc.rect(h.cell.x, h.cell.y, h.cell.width, h.cell.height, 'F');
                doc.addImage(jpg, 'JPEG', imgX, imgY, sz, sz);
            } catch(e) { console.warn('Gambar gagal render di tabel:', e); }
        }
    });

    const finalY = doc.lastAutoTable.finalY + 5;
    if (finalY < 195) {
        doc.setGState(doc.GState({opacity:1.0}));
        if (filter==='MASYARAKAT') {
            doc.setFillColor(235,250,238); doc.rect(margin,finalY,5,4,'F');
            doc.setFontSize(7.5); doc.setTextColor(60,100,60); doc.text('= Tamu Masyarakat',margin+7,finalY+3);
        } else {
            doc.setFillColor(255,255,255); doc.rect(margin,finalY,5,4,'FD');
            doc.setFontSize(7.5); doc.setTextColor(60); doc.text('= Tamu Instansi / Unit Kerja',margin+7,finalY+3);
        }
    }
    const pageCount = doc.internal.getNumberOfPages();
    for (let pg=1; pg<=pageCount; pg++) {
        doc.setPage(pg); doc.setGState(doc.GState({opacity:1.0}));
        doc.setFontSize(7); doc.setTextColor(120);
        doc.text(`Halaman ${pg} / ${pageCount}  ‚Äî  Dicetak: ${new Date().toLocaleString('id-ID')}`, pageWidth/2, 203, {align:'center'});
    }
    doc.save(`Buku_Tamu_Ringkasan_${namaFile}_${new Date().toISOString().split('T')[0]}.pdf`);
    alert(`‚úÖ PDF ringkasan berhasil diunduh!\nKategori: ${judulFilter}\nTotal: ${semuaTamu.length} tamu.`);
}

// ===== EXPORT DETAIL PER TAMU PDF =====
async function exportDetailPerTamuPDF(index) {
    if (dataBukuTamu.length===0 || index<0 || index>=dataBukuTamu.length) {
        alert('Tidak ada data untuk tamu ini!'); return;
    }
    const data = dataBukuTamu[index];

    // Pre-load semua gambar ke JPEG sebelum PDF dibuat
    const [jpegFront, jpegBack, jpegTTD] = await Promise.all([
        gambarKeJpeg(data.fotoFront), gambarKeJpeg(data.fotoBack), gambarKeJpeg(data.tandaTangan)
    ]);

    // Stempel timestamp pada foto (perlu onload baru karena canvas baru)
    function stampFoto(jpegUrl, labelText, timestamp) {
        return new Promise(function(resolve) {
            if (!jpegUrl) return resolve(null);
            var img = new Image();
            img.onload = function() {
                var cvs = document.createElement('canvas'); cvs.width=480; cvs.height=480;
                var c = cvs.getContext('2d');
                c.fillStyle='#ffffff'; c.fillRect(0,0,480,480); c.drawImage(img,0,0,480,480);
                var bY=480-58;
                var g=c.createLinearGradient(0,bY-10,0,480);
                g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(0.3,'rgba(0,10,40,0.72)'); g.addColorStop(1,'rgba(0,10,40,0.88)');
                c.fillStyle=g; c.fillRect(0,bY-10,480,68);
                c.fillStyle='#f5e07a'; c.font='bold 26px Arial'; c.textAlign='left';
                c.shadowColor='rgba(0,0,0,0.7)'; c.shadowBlur=4; c.fillText(labelText,14,bY+22);
                c.strokeStyle='rgba(212,168,32,0.7)'; c.lineWidth=1.2;
                c.beginPath(); c.moveTo(14,bY+29); c.lineTo(466,bY+29); c.stroke();
                c.fillStyle='rgba(220,235,255,0.92)'; c.font='18px Arial'; c.shadowBlur=3; c.fillText('üïê '+timestamp,14,bY+50);
                c.strokeStyle='rgba(212,168,32,0.85)'; c.lineWidth=3; c.shadowBlur=0; c.strokeRect(2,2,476,476);
                resolve(cvs.toDataURL('image/jpeg', 0.92));
            };
            img.onerror=function(){ resolve(jpegUrl); };
            img.src=jpegUrl;
        });
    }

    const [stampedFront, stampedBack] = await Promise.all([
        stampFoto(jpegFront,'Foto Depan',data.timestamp),
        stampFoto(jpegBack,'Foto Belakang',data.timestamp)
    ]);

    const { jsPDF } = window.jspdf;
    const doc=new jsPDF('p','mm','a4');
    const pageWidth=210, pageHeight=297, margin=15;
    const contentWidth=pageWidth-margin*2;
    let y=12;

    // Gradient latar
    const GR={r1:0xEE,g1:0xF3,b1:0xFB,r2:0xFD,g2:0xF8,b2:0xEC};
    for(let i=0;i<300;i++){
        const t=i/299;
        doc.setFillColor(Math.round(GR.r1+t*(GR.r2-GR.r1)),Math.round(GR.g1+t*(GR.g2-GR.g1)),Math.round(GR.b1+t*(GR.b2-GR.b1)));
        doc.rect(0,i*(pageHeight/300),pageWidth,pageHeight/300+0.15,'F');
    }

    // Pola geometris
    function drawGeometricPattern() {
        doc.setDrawColor(13,31,100); doc.setLineWidth(0.08);
        const WS=[{amp:4.5,freq1:0.038,freq2:0.019,phase:0.0,gap:9},{amp:3.5,freq1:0.052,freq2:0.026,phase:1.1,gap:11},{amp:5.0,freq1:0.028,freq2:0.014,phase:2.3,gap:14},{amp:3.0,freq1:0.065,freq2:0.032,phase:0.7,gap:8},{amp:4.0,freq1:0.045,freq2:0.022,phase:1.8,gap:12}];
        for(const ws of WS){let bY=ws.gap;while(bY<pageHeight){const pts=[];for(let px=0;px<=pageWidth;px+=0.6){pts.push({x:px,y:bY+ws.amp*Math.sin(px*ws.freq1+ws.phase)+(ws.amp*0.4)*Math.sin(px*ws.freq2+ws.phase*1.7)});}for(let pi=0;pi<pts.length-1;pi++)doc.line(pts[pi].x,pts[pi].y,pts[pi+1].x,pts[pi+1].y);bY+=ws.gap*2;}}
        doc.setDrawColor(100,31,13);
        const VW=[{amp:3.5,freq1:0.040,freq2:0.020,phase:0.5,gap:18},{amp:2.5,freq1:0.055,freq2:0.027,phase:1.5,gap:22}];
        for(const ws of VW){let bX=ws.gap;while(bX<pageWidth){const pts=[];for(let py=0;py<=pageHeight;py+=0.6){pts.push({x:bX+ws.amp*Math.sin(py*ws.freq1+ws.phase)+(ws.amp*0.35)*Math.sin(py*ws.freq2+ws.phase*1.9),y:py});}for(let pi=0;pi<pts.length-1;pi++)doc.line(pts[pi].x,pts[pi].y,pts[pi+1].x,pts[pi+1].y);bX+=ws.gap*2;}}
        doc.setDrawColor(13,60,120); doc.setLineWidth(0.07);
        const corners=[{cx:0,cy:0},{cx:pageWidth,cy:0},{cx:0,cy:pageHeight},{cx:pageWidth,cy:pageHeight}];
        for(const cr of corners)for(let s=0;s<28;s++){const th=(cr.cx===0?0:Math.PI)+(cr.cy===0?0:Math.PI)+(s/28)*Math.PI/2-Math.PI/4;doc.line(cr.cx,cr.cy,cr.cx+120*Math.cos(th),cr.cy+120*Math.sin(th));}
        doc.setDrawColor(80,60,20); doc.setLineWidth(0.06);
        for(let d=-pageHeight;d<pageWidth+pageHeight;d+=28){doc.line(d,0,d+pageHeight,pageHeight);doc.line(pageWidth-d,0,pageWidth-d-pageHeight,pageHeight);}
        doc.setDrawColor(13,31,100); doc.setLineWidth(0.07);
        for(let r=8;r<160;r+=14)doc.circle(pageWidth/2,pageHeight/2,r,'S');
        for(const cr of corners)for(let r=5;r<55;r+=10)doc.circle(cr.cx,cr.cy,r,'S');
    }
    doc.setGState(doc.GState({opacity:0.038})); drawGeometricPattern(); doc.setGState(doc.GState({opacity:1.0}));

    function renderKonten(logoDataUrl) {
        if(logoDataUrl){try{doc.setGState(doc.GState({opacity:0.052}));doc.addImage(logoDataUrl,'PNG',(pageWidth-170)/2,(pageHeight-170)/2,170,170);}catch(e){}}
        doc.setGState(doc.GState({opacity:1.0}));
        doc.setDrawColor(180,140,20); doc.setLineWidth(0.65); doc.rect(8,8,pageWidth-16,pageHeight-16,'S');
        doc.setDrawColor(212,168,32); doc.setLineWidth(0.25); doc.rect(11,11,pageWidth-22,pageHeight-22,'S');
        doc.setFillColor(13,31,69); doc.rect(margin,y,contentWidth,32,'F');
        doc.setFillColor(26,58,110); doc.rect(margin+contentWidth*0.4,y,contentWidth*0.6,32,'F');
        doc.setDrawColor(212,168,32); doc.setLineWidth(1.2);
        doc.line(margin,y,margin+contentWidth,y); doc.line(margin,y+32,margin+contentWidth,y+32);
        doc.setFontSize(15); doc.setTextColor(245,224,122); doc.setFont("helvetica","bold");
        doc.text('BUKU TAMU DIGITAL',pageWidth/2,y+11,{align:'center'});
        doc.setFontSize(9.5); doc.setTextColor(220,235,255);
        doc.text('INSPEKTORAT DAERAH KABUPATEN TULANG BAWANG BARAT',pageWidth/2,y+19,{align:'center'});
        doc.setFontSize(7.5); doc.setTextColor(180,200,240);
        doc.text(`Data Tamu #${index+1}  ‚Ä¢  ${data.timestamp}`,pageWidth/2,y+27,{align:'center'});
        y+=40;
        const fields=[{label:"Nama Lengkap",value:data.nama||'-'}];
        if(data.asal==='INSTANSI') fields.push({label:"Instansi / Unit Kerja",value:data.instansi||'-'});
        else if(data.asal==='MASYARAKAT') fields.push({label:"Asal",value:"Masyarakat"},{label:"Kecamatan",value:data.kecamatan||'-'},{label:"Desa / Kelurahan",value:data.desa||'-'});
        else fields.push({label:"Asal",value:data.asal||'-'});
        fields.push({label:"Pihak yang Ditemui",value:data.pihakDitemui||'-'},{label:"Jenis Layanan",value:data.jenisLayanan||'-'},{label:"Uraian Keperluan",value:data.uraian||'-'},{label:"Nomor WhatsApp",value:data.nomorHp||'-'},{label:"Waktu Kunjungan",value:data.timestamp||'-'});
        const lW=55; doc.setFontSize(9.5);
        fields.forEach((field,fi)=>{
            const vL=doc.splitTextToSize(field.value,contentWidth-lW-6);
            const rH=Math.max(8,vL.length*5+3); const ie=fi%2===0;
            doc.setGState(doc.GState({opacity:1.0}));
            doc.setFillColor(ie?232:240,ie?238:245,ie?252:255); doc.rect(margin,y,lW,rH,'F');
            doc.setFillColor(255,255,255); doc.rect(margin+lW,y,contentWidth-lW,rH,'F');
            doc.setDrawColor(200,210,230); doc.setLineWidth(0.25); doc.rect(margin,y,contentWidth,rH,'S'); doc.line(margin+lW,y,margin+lW,y+rH);
            doc.setDrawColor(13,31,69); doc.setLineWidth(1.8); doc.line(margin,y,margin,y+rH); doc.setLineWidth(0.25);
            doc.setFont("helvetica","bold"); doc.setTextColor(13,31,69); doc.text(field.label,margin+4,y+5.5);
            doc.setFont("helvetica","normal"); doc.setTextColor(30,30,50); doc.text(vL,margin+lW+4,y+5.5);
            y+=rH;
        });
        y+=14;
        doc.setGState(doc.GState({opacity:1.0}));
        doc.setFillColor(13,31,69); doc.rect(margin,y,contentWidth,8,'F');
        doc.setFontSize(9); doc.setFont("helvetica","bold"); doc.setTextColor(245,224,122);
        doc.text("DOKUMENTASI FOTO & TANDA TANGAN",margin+4,y+5.5); y+=12;
        const pSz=70,pGap=12; let pX=margin;
        doc.setGState(doc.GState({opacity:1.0}));
        if(stampedFront){try{doc.addImage(stampedFront,'JPEG',pX,y,pSz,pSz);}catch(e){doc.setDrawColor(180,140,20);doc.setLineWidth(0.5);doc.rect(pX,y,pSz,pSz,'S');}}
        pX+=pSz+pGap;
        if(stampedBack){try{doc.setGState(doc.GState({opacity:1.0}));doc.addImage(stampedBack,'JPEG',pX,y,pSz,pSz);}catch(e){doc.setDrawColor(180,140,20);doc.setLineWidth(0.5);doc.rect(pX,y,pSz,pSz,'S');}}
        y+=pSz+16;
        doc.setGState(doc.GState({opacity:1.0}));
        doc.setFontSize(10); doc.setFont("helvetica","bold"); doc.setTextColor(13,31,69);
        doc.text("Tanda Tangan:",margin,y); y+=4;
        const sW=80,sH=28,sX=margin+2,sY=y+2;
        doc.setFillColor(255,255,255); doc.rect(sX-2,sY-2,sW+4,sH+14,'F');
        doc.setDrawColor(180,140,20); doc.setLineWidth(0.5); doc.rect(sX-2,sY-2,sW+4,sH+14,'S');
        if(jpegTTD){try{doc.setGState(doc.GState({opacity:1.0}));doc.addImage(jpegTTD,'JPEG',sX,sY,sW,sH);}catch(e){doc.setFontSize(9);doc.setTextColor(150);doc.text("(Gagal menampilkan tanda tangan)",sX+4,sY+8);}}
        else{doc.setFontSize(9);doc.setTextColor(150);doc.text("(Tidak ada tanda tangan)",sX+4,sY+8);}
        doc.setGState(doc.GState({opacity:1.0})); doc.setFontSize(11); doc.setFont("helvetica","bold"); doc.setTextColor(13,31,69);
        doc.text(data.nama||"________________________",sX+sW/2,sY+sH+10,{align:'center'});
        const fY=280;
        doc.setFillColor(250,248,244); doc.rect(margin-2,fY-1,contentWidth+4,16,'F');
        doc.setDrawColor(180,140,20); doc.setLineWidth(0.55); doc.line(margin,fY,pageWidth-margin,fY);
        doc.setFillColor(212,168,32); doc.circle(margin,fY,0.8,'F'); doc.circle(pageWidth-margin,fY,0.8,'F');
        doc.setFontSize(7.5); doc.setFont("helvetica","normal"); doc.setTextColor(70,70,95);
        doc.text('Dokumen ini dibuat otomatis oleh Sistem Buku Tamu Digital \u2014 Inspektorat Kab. Tulang Bawang Barat',pageWidth/2,fY+6,{align:'center'});
        doc.save(`Detail_Tamu_${index+1}_${data.timestamp.replace(/[\s,:]/g,'-')}.pdf`);
        alert('‚úÖ PDF detail tamu telah diunduh!');
    }

    const logoImg=new Image(); logoImg.crossOrigin="anonymous";
    let logoResolved = false;
    function panggalRenderKonten(dataUrl) {
        if (logoResolved) return;
        logoResolved = true;
        renderKonten(dataUrl);
    }
    logoImg.onload=function(){
        try{
            var cvs=document.createElement('canvas');
            cvs.width=logoImg.naturalWidth||logoImg.width||200;
            cvs.height=logoImg.naturalHeight||logoImg.height||200;
            cvs.getContext('2d').drawImage(logoImg,0,0);
            panggalRenderKonten(cvs.toDataURL('image/png'));
        }catch(e){panggalRenderKonten(null);}
    };
    logoImg.onerror=function(){panggalRenderKonten(null);};
    // Timeout 5 detik ‚Äî jika logo tidak muat, lanjutkan tanpa logo
    setTimeout(function(){ panggalRenderKonten(null); }, 5000);
    logoImg.src="https://upload.wikimedia.org/wikipedia/commons/6/6b/Lambang_Kabupaten_Tulang_Bawang_Barat.png";
}

function updateDataCounter() {
    const totalFinal = dataBukuTamu.length;
    const totalSementara = dataTamuSementara.length;
    const total = totalFinal + totalSementara;
    let label = total;
    if (totalSementara > 0) label = `${totalFinal}+${totalSementara}‚è≥`;
    document.getElementById('dataCount').textContent = label;
}

let signatureDataURL = null;

function recenterSignature() {
    if (!hasSignature) return null;
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = signatureCanvas.width;
    tempCanvas.height = signatureCanvas.height;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.drawImage(signatureCanvas, 0, 0);
    const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
    const data = imageData.data;
    let minX = tempCanvas.width, minY = tempCanvas.height;
    let maxX = 0, maxY = 0;
    for (let y = 0; y < tempCanvas.height; y++) {
        for (let x = 0; x < tempCanvas.width; x++) {
            const i = (y * tempCanvas.width + x) * 4;
            if (data[i + 3] > 10) {
                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x);
                maxY = Math.max(maxY, y);
            }
        }
    }
    if (minX === tempCanvas.width || maxX === 0) return null;
    const width = maxX - minX + 2;
    const height = maxY - minY + 2;
    const finalWidth = 400;
    const finalHeight = 150;
    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = finalWidth;
    finalCanvas.height = finalHeight;
    const finalCtx = finalCanvas.getContext('2d');
    finalCtx.fillStyle = 'white';
    finalCtx.fillRect(0, 0, finalWidth, finalHeight);
    const offsetX = Math.round((finalWidth - width) / 2);
    const offsetY = Math.round((finalHeight - height) / 2);
    finalCtx.drawImage(tempCanvas, minX, minY, width, height, offsetX, offsetY, width, height);
    return finalCanvas.toDataURL('image/png');
}
</script>
<script>
function smoothScrollTo(element) {
    if (!element) return;
    const rect = element.getBoundingClientRect();
    const offset = 80;
    const targetY = rect.top + window.scrollY - offset;
    window.scrollTo({ top: targetY, behavior: 'smooth' });
}

function scrollToFieldWhenFocused(el) {
    setTimeout(() => { smoothScrollTo(el); }, 280);
}

document.addEventListener('DOMContentLoaded', () => {
    const focusable = document.querySelectorAll(
        'input, textarea, select, button:not(.btn-capture):not(.btn-cancel)'
    );
    focusable.forEach(field => {
        field.addEventListener('focus', () => { scrollToFieldWhenFocused(field); });
        if (field.tagName === 'TEXTAREA') {
            field.addEventListener('input', () => { setTimeout(() => scrollToFieldWhenFocused(field), 120); });
        }
    });
    const ttdField = document.getElementById('field-tandaTangan');
    if (ttdField) {
        const observer = new MutationObserver(() => {
            if (!ttdField.classList.contains('hidden')) {
                setTimeout(() => { smoothScrollTo(ttdField); }, 450);
            }
        });
        observer.observe(ttdField, { attributes: true, attributeFilter: ['class'] });
    }
    let prevHeight = window.innerHeight;
    window.addEventListener('resize', () => {
        const currHeight = window.innerHeight;
        if (currHeight < prevHeight * 0.82) {
            const active = document.activeElement;
            if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) {
                scrollToFieldWhenFocused(active);
            }
        }
        prevHeight = currHeight;
    });
});
</script>
</body>
</html>
