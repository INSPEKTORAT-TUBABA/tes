<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <link rel="manifest" href="manifest.json"/>
    <meta name="theme-color" content="#007bff"/>
    <link rel="icon" href="icon-192.png"/>
    <title>Buku Tamu Digital</title>

    <!-- Library untuk Export Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Reset dan Box Model */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: sans-serif;
            max-width: 700px;
            margin: auto;
            padding: 20px 10px;
            min-height: 100vh;
        }

        label {
            font-weight: bold;
        }

        select, input, textarea {
            width: 100%;
            padding: 6px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .hidden {
            display: none;
        }

        .required {
            color: red;
        }

        .error {
            border: 2px solid red !important;
        }

        .success {
            border: 2px solid green !important;
        }

        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        /* Tombol Sticky */
        #btnHome {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ffc107;
            color: black;
            border: none;
            padding: 12px 16px;
            border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            font-size: 16px;
            z-index: 9999;
            cursor: pointer;
        }

        #btnHome:hover {
            background: #e0a800;
        }

        @media (min-width: 768px) {
            #btnHome {
                display: none;
            }
        }

        .data-card {
            border: 1px solid #ddd;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (min-width: 500px) {
            .data-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .data-images {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 15px;
        }

        @media (min-width: 500px) {
            .data-images {
                flex-direction: row;
            }
        }

        .header-gambar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            text-align: center;
            flex-wrap: nowrap;
        }

        .foto-kepala {
            width: 80px;
            height: auto;
        }

        .logo {
            width: 100px;
            height: auto;
        }

        /* Modal Foto */
        #photoModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 10px;
        }

        #modalContent {
            position: relative;
            background-color: #fefefe;
            margin: auto;
            padding: 10px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            text-align: center;
            border-radius: 8px;
        }

        #dualCameraFrame {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            margin: 10px auto;
        }

        .camera-view {
            width: 100%;
            border: 2px solid #007bff;
            aspect-ratio: 4/3;
            overflow: hidden;
            position: relative;
        }

        .camera-view video, .camera-view img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        #modalButtons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        #modalButtons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-camera { background: #ffc107; color: black; }
        .btn-save { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }

        .btn-camera:hover { background: #e0a800; }
        .btn-save:hover { background: #218838; }
        .btn-cancel:hover { background: #c82333; }

        /* Horizontal foto di laptop */
        @media (min-width: 768px) {
            #dualCameraFrame {
                flex-direction: row;
                justify-content: center;
                gap: 30px;
                max-width: 95vw;
                width: auto;
            }
            .camera-view {
                flex: 1;
                min-width: 400px;
                max-width: 600px;
                aspect-ratio: 4/3;
            }
            #modalContent {
                width: auto;
                max-width: 95vw;
                padding: 20px;
            }
            #modalButtons { margin-top: 20px; }
        }
    </style>
</head>
<body>
    <div class="header-gambar">
        <img src="bupati.png" alt="Wakil Bupati" class="foto-kepala">
        <img src="logo-tubaba.png" alt="Logo Tubaba" class="logo">
        <img src="wakil-bupati.png" alt="Bupati" class="foto-kepala">
    </div>

    <h1 style="text-align: center;">BUKU TAMU INSPEKTORAT TUBABA</h1>

    <div id="formSection">
        <form id="bukuTamuForm">
            <div id="field-nama">
                <label>Nama: <span class="required">*</span></label>
                <input id="nama" required type="text" placeholder="Isi Minimal 5 Huruf" oninput="validateNama();"/>
                <br/>
            </div>

            <div id="field-asal" style="display: none;">
                <label>ASAL TAMU: <span class="required">*</span></label>
                <select id="asal" required onchange="handleAsalChange(this.value)">
                    <option value="">-- Pilih Asal Tamu --</option>
                    <option value="INSTANSI">INSTANSI/UNIT KERJA (Pegawai dari Instansi Lain)</option>
                    <option value="MASYARAKAT">MASYARAKAT UMUM</option>
                    <option value="INTERNAL">PEGAWAI INTERNAL INSPEKTORAT TUBABA</option>
                </select><br/><br/>
            </div>

            <div class="hidden" id="daftarInstansi">
                <label>DAFTAR INSTANSI/UNIT KERJA: <span class="required">*</span></label>
                <select id="instansi" onchange="checkAndShowNext('instansi', 'field-pihakDitemui')">
                    <option value="">-- Pilih Instansi --</option>
                    <option>SEKRETARIAT DAERAH</option>
                    <option>SEKRETARIAT DPRD</option>
                    <option>BADAN PERENCANAAN PEMBANGUNAN DAERAH</option>
                    <option>BADAN PENGELOLAAN KEUANGAN DAN ASET DAERAH</option>
                    <option>BADAN PENGELOLAAN PAJAK DAN RETRIBUSI DAERAH</option>
                    <option>BADAN KEPEGAWAIAN DAN PENGEMBANGAN SUMBER DAYA MANUSIA</option>
                    <option>BADAN KESATUAN BANGSA DAN POLITIK DAERAH</option>
                    <option>BADAN PENANGGULANGAN BENCANA DAERAH</option>
                    <option>DINAS LINGKUNGAN HIDUP</option>
                    <option>DINAS KESEHATAN</option>
                    <option>DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                    <option>DINAS KOPERASI, UMKM, PERINDUSTRIAN DAN PERDAGANGAN</option>
                    <option>DINAS SOSIAL</option>
                    <option>DINAS PEMUDA, OLAHRAGA DAN PARIWISATA</option>
                    <option>DINAS KOMUNIKASI DAN INFORMATIKA</option>
                    <option>DINAS PERUMAHAN, KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                    <option>DINAS PENANAMAN MODAL DAN PELAYANAN PERIZINAN TERPADU SATU PINTU</option>
                    <option>DINAS PENDIDIKAN DAN KEBUDAYAAN</option>
                    <option>DINAS KETAHANAN PANGAN</option>
                    <option>DINAS PEMBERDAYAAN MASYARAKAT DAN TIYUH</option>
                    <option>DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                    <option>DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                    <option>DINAS PERHUBUNGAN</option>
                    <option>DINAS PERTANIAN</option>
                    <option>DINAS PETERNAKAN DAN KESEHATAN HEWAN</option>
                    <option>DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                    <option>DINAS TENAGA KERJA DAN TRANSMIGRASI</option>
                    <option>DINAS PERIKANAN</option>
                    <option>DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                    <option>DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</option>
                    <option>SATUAN POLISI PAMONG PRAJA</option>
                    <option>BADAN PENGAWASAN KEUANGAN DAN PEMBANGUNAN (BPKP)</option>
                    <option>LAINNYA</option>
                </select><br/><br/>
            </div>

            <div class="hidden" id="daftarMasyarakat">
                <label>Kecamatan: <span class="required">*</span></label>
                <select id="kecamatan" onchange="updateDesaList()">
                    <option value="">-- Pilih Kecamatan --</option>
                    <option value="Tulang Bawang Tengah">Tulang Bawang Tengah</option>
                    <option value="Tulang Bawang Udik">Tulang Bawang Udik</option>
                    <option value="Gunung Terang">Gunung Terang</option>
                    <option value="Gunung Agung">Gunung Agung</option>
                    <option value="Lambu Kibang">Lambu Kibang</option>
                    <option value="Way Kenanga">Way Kenanga</option>
                    <option value="Tumijajar">Tumijajar</option>
                    <option value="Pagar Dewa">Pagar Dewa</option>
                    <option value="Batu Putih">Batu Putih</option>
                </select><br/><br/>

                <div class="hidden" id="field-desa">
                    <label>Desa/Tiyuh: <span class="required">*</span></label>
                    <select id="desa" onchange="checkAndShowNext('desa', 'field-pihakDitemui')">
                        <option value="">-- Pilih Desa --</option>
                    </select><br/><br/>
                </div>
            </div>

            <div id="field-pihakDitemui" style="display: none;">
                <label>PIHAK YANG DITEMUI: <span class="required">*</span></label>
                <select id="pihakDitemui" required onchange="checkAndShowNext('pihakDitemui', 'field-jenisLayanan')">
                    <option value="">-- Pilih Pihak yang Ditemui --</option>
                    <option>INSPEKTUR</option>
                    <option>SEKRETARIS</option>
                    <option>IRBANSUS</option>
                    <option>IRBAN 1</option>
                    <option>IRBAN 2</option>
                    <option>IRBAN 3</option>
                    <option>IRBAN 4</option>
                </select><br/><br/>
            </div>

            <div id="field-jenisLayanan" style="display: none;">
                <label>JENIS LAYANAN: <span class="required">*</span></label>
                <select id="jenisLayanan" required onchange="checkAndShowNext('jenisLayanan', 'field-uraian')">
                    <option value="">-- Pilih Jenis Layanan --</option>
                    <option>Permintaan Audit/Klarifikasi Khusus</option>
                    <option>Penanganan Pengaduan</option>
                    <option>Layanan Informasi Publik</option>
                    <option>Pembinaan & Konsultasi</option>
                    <option>Audit</option>
                    <option>Review</option>
                    <option>Evaluasi/Monitoring</option>
                    <option>Tindak Lanjut Temuan</option>
                </select><br/><br/>
            </div>

            <div id="field-uraian" style="display: none;">
                <label>URAIAN: <span class="required">*</span></label>
                <textarea id="uraian" required oninput="autoResize(this); validateUraian();" style="overflow:hidden; resize:none; width:100%; min-height:60px;"></textarea><br/><br/>
            </div>

            <div id="field-nomorHp" style="display: none;">
                <label>NOMOR HP: <span class="required">*</span></label>
                <input id="nomorHp" inputmode="numeric" required type="text" placeholder="Contoh: 081234567890" maxlength="16" oninput="formatAndValidateNomorHp(this)" style="font-family: monospace; letter-spacing: 1px;"/><br/>
                <div class="warning" id="hpWarning" style="display:none; margin-top:5px;">‚ö†Ô∏è Nomor HP harus diawali 08 dan berisi 11-13 angka!</div><br/>
            </div>

            <div id="field-tandaTangan" style="display: none;">
                <label>Tanda Tangan: <span class="required">*</span></label>
                <div class="warning" id="signatureWarning" style="display:none;">‚ö†Ô∏è Tanda tangan wajib diisi dengan goresan minimal 2 cm!</div>
                <canvas height="200" id="signature-pad" style="border:1px solid #ccc; width: 100%;" width="700"></canvas><br/>
                <button onclick="clearSignature()" type="button" style="background: #e9ecef; color: black; border: 1px solid #ccc; padding: 8px 15px; border-radius: 5px; cursor: pointer;">üßπ Bersihkan Tanda Tangan</button><br/><br/>
            </div>

            <div id="field-aksi" style="display: none;">
                <label>Foto: <span class="required">*</span></label>
                <div class="warning" id="photoWarning" style="display:none;">‚ö†Ô∏è Foto wajib diambil!</div>
                <button type="button" onclick="bukaKamera()" style="font-size: 16px; background: #ffc107; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üì∏ Ambil Foto</button>
                <br/><br/>
                <button type="button" onclick="simpanDataDanTutupForm()" style="font-size: 18px; background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer;">üíæ Simpan Data</button>
            </div>
        </form>
    </div>

    <div style="margin-bottom: 20px;">
        <button type="button" onclick="showForm()" id="btnForm" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">üìù Form Input</button>
        <button type="button" onclick="showData()" id="btnData" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">üìä Lihat Data (<span id="dataCount">0</span>)</button>
        <button type="button" onclick="exportData()" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#138496'" onmouseout="this.style.background='#17a2b8'">üíæ Export Data</button>
    </div>

    <div id="dataSection" style="display: none;">
        <h2>üìä DATA BUKU TAMU</h2>
        <div style="margin-bottom: 20px;">
            <button type="button" onclick="clearAllData()" style="background: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Hapus Semua Data</button>
        </div>
        <div id="dataContainer">
            <p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>
        </div>
    </div>

    <div id="photoModal">
        <div id="modalContent">
            <h3 style="color: black;">Bingkai Pengambilan Foto</h3>
            <div id="dualCameraFrame">
                <div class="camera-view">
                    <h4 style="margin: 0; text-align: center;">Kamera Depan (Selfie)</h4>
                    <video id="videoFront" autoplay muted playsinline></video>
                    <img id="capturedFrontPhoto" alt="Foto Selfie" style="display:none;">
                </div>
                <div class="camera-view">
                    <h4 style="margin: 0; text-align: center;">Kamera Belakang</h4>
                    <video id="videoBack" autoplay muted playsinline></video>
                    <img id="capturedBackPhoto" alt="Foto Belakang" style="display:none;">
                </div>
            </div>
            <canvas id="canvasFront" style="display:none;"></canvas>
            <canvas id="canvasBack" style="display:none;"></canvas>
            <div id="modalButtons">
                <button type="button" class="btn-camera" onclick="ambilFoto()">üì∏ Ambil Foto</button>
                <button type="button" class="btn-save" onclick="simpanFotoLangsung()">‚úÖ Simpan & Lihat Data</button>
                <button type="button" class="btn-cancel" onclick="tutupModal()">‚ùå Tutup</button>
            </div>
        </div>
    </div>

    <script>
        // === Element References ===
        const signatureCanvas = document.getElementById('signature-pad');
        const ctx = signatureCanvas.getContext('2d');
        const signatureWarning = document.getElementById('signatureWarning');
        const photoWarning = document.getElementById('photoWarning');
        const asal = document.getElementById("asal");
        const daftarInstansi = document.getElementById("daftarInstansi");
        const daftarMasyarakat = document.getElementById("daftarMasyarakat");
        const kecamatan = document.getElementById("kecamatan");
        const desa = document.getElementById("desa");
        const instansi = document.getElementById("instansi");
        const fieldDesa = document.getElementById("field-desa");
        const photoModal = document.getElementById('photoModal');
        const videoFront = document.getElementById('videoFront');
        const videoBack = document.getElementById('videoBack');
        const canvasFront = document.getElementById('canvasFront');
        const canvasBack = document.getElementById('canvasBack');
        const capturedFrontPhoto = document.getElementById('capturedFrontPhoto');
        const capturedBackPhoto = document.getElementById('capturedBackPhoto');

        let streamFront = null;
        let streamBack = null;
        let fotoDataURLFront = null;
        let fotoDataURLBack = null;
        let hasPhoto = false;
        let drawing = false;
        let hasSignature = false;
        let dataBukuTamu = [];
        let lastX = 0;
        let lastY = 0;
        let totalStrokeLength = 0;
        const MIN_STROKE_LENGTH_CM = 2;
        const PIXELS_PER_CM = 37.8;

        // === Canvas Signature ===
        function resizeCanvas() {
            const originalWidth = 700;
            const originalHeight = 200;
            const newWidth = Math.min(window.innerWidth - 40, originalWidth);
            const tempData = signatureCanvas.toDataURL();
            signatureCanvas.width = newWidth;
            signatureCanvas.height = Math.round(originalHeight * (newWidth / originalWidth));
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
            img.src = tempData;
            ctx.strokeStyle = '#0000FF';
            ctx.globalAlpha = 0.85;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        ctx.strokeStyle = '#0000FF';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.globalAlpha = 0.85;
        let lastVelocity = 0;
        let lastTime = Date.now();

        function getCanvasPos(e) {
            const rect = signatureCanvas.getBoundingClientRect();
            if (e.touches && e.touches[0]) {
                return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
            }
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function startDrawing(e) {
            e.preventDefault();
            drawing = true;
            hasSignature = true;
            totalStrokeLength = 0;
            ctx.beginPath();
            const pos = getCanvasPos(e);
            lastX = pos.x;
            lastY = pos.y;
            ctx.moveTo(lastX, lastY);
            lastTime = Date.now();
        }

        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const pos = getCanvasPos(e);
            const currentTime = Date.now();
            const deltaTime = (currentTime - lastTime) / 1000;
            const distance = Math.sqrt((pos.x - lastX) ** 2 + (pos.y - lastY) ** 2);
            totalStrokeLength += distance;
            const velocity = distance / (deltaTime || 1);
            const smoothedVelocity = lastVelocity * 0.7 + velocity * 0.3;
            ctx.lineWidth = Math.max(1.5, Math.min(3.5, 2 - smoothedVelocity / 100));
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastX = pos.x;
            lastY = pos.y;
            lastVelocity = smoothedVelocity;
            lastTime = currentTime;
        }

        function stopDrawing(e) {
            if (!drawing) return;
            e.preventDefault();
            drawing = false;
            const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
            if (strokeLengthCm < MIN_STROKE_LENGTH_CM) {
                hasSignature = false;
                signatureWarning.style.display = 'block';
                signatureWarning.textContent = '‚ö†Ô∏è Tanda Tangan Terlalu Pendek';
                signatureCanvas.classList.add('error');
                signatureCanvas.classList.remove('success');
                document.getElementById('field-aksi').style.display = 'none';
            } else {
                signatureWarning.style.display = 'none';
                signatureCanvas.classList.remove('error');
                signatureCanvas.classList.add('success');
                checkAndShowNext('signature-pad', 'field-aksi');
            }
        }

        signatureCanvas.addEventListener('mousedown', startDrawing);
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('mouseup', stopDrawing);
        signatureCanvas.addEventListener('mouseout', stopDrawing);
        signatureCanvas.addEventListener('touchstart', startDrawing, { passive: false });
        signatureCanvas.addEventListener('touchmove', draw, { passive: false });
        signatureCanvas.addEventListener('touchend', stopDrawing, { passive: false });

        function clearSignature() {
            ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            hasSignature = false;
            totalStrokeLength = 0;
            signatureCanvas.classList.remove('error', 'success');
            signatureWarning.style.display = 'none';
            signatureWarning.textContent = '‚ö†Ô∏è Tanda tangan wajib diisi dengan goresan minimal 2 cm!';
            document.getElementById('field-aksi').style.display = 'none';
        }

        // === Dropdown Desa ===
        const dataDesa = {
            "Lambu Kibang": ["Kibang Budi Jaya", "Lesung Bhakti Jaya", "Mekar Sari Jaya", "Pagar Jaya", "Gunung Sari", "Sumber Rejo", "Kibang Yekti Jaya", "Kibang Tri Jaya", "Gilang Tunggal Makarta", "Kibang Mulya Jaya"],
            "Tulang Bawang Tengah": ["Penumangan", "Penumangan Baru", "Menggala Mas", "Bandar Dewa", "Panaragan", "Panaragan Jaya Indah", "Panaragan Jaya Utama", "Tirta Kencana", "Tirta Makmur", "Pulung Kencana", "Mulya Jaya", "Mulya Kencana", "Candra Mukti", "Candra Kencana", "Candra Jaya", "Tunas Asri", "Wonokerto", "Mekar Asri", "Marga Asri"],
            "Gunung Agung": ["Tunas Jaya", "Mulya Jaya", "Mulya Sari", "Mekar Jaya", "Bangun Jaya", "Dwikora Jaya", "Marga Jaya", "Sumber Jaya", "Sumber Rejeki", "Jaya Murni", "Wonorejo", "Suka Jaya", "Tri Jaya Tunggal"],
            "Tumijajar": ["Murni Jaya", "Daya Asri", "Daya Sakti", "Makarti", "Sumber Rejo", "Margodadi", "Gunung Menanti", "Gunung Timbul", "Margo Mulyo"],
            "Way Kenanga": ["Agung Jaya", "Mercubuana", "Balam Jaya", "Pagar Buana", "Indraloka I", "Indraloka II", "Balam Asri", "Indraloka Jaya", "Indraloka Mukti", "Sido Agung"],
            "Batu Putih": ["Toto Katon", "Sakti Jaya", "Margo Mulya", "Margo Dadi", "Marga Sari", "Mulyo Sari", "Toto Makmur", "Panca Marga", "Sido Makmur", "Toto Wonodadi"],
            "Gunung Terang": ["Setia Bumi", "Setia Agung", "Mulya Jadi", "Gunung Agung", "Gunung Terang", "Toto Mulyo", "Kagungan Jaya", "Terang Mulya", "Terang Makmur", "Rerang Bumi Agung"],
            "Tulang Bawang Udik": ["Kagungan Ratu", "Kartaraharja", "Kartasari", "Marga Kencana", "Waysido", "Kagungan Ratu Agung", "Gunung Katun Tanjungan", "Gedung Ratu", "Gunung Katun Malay", "Karta", "Karta Tanjung Selamat", "Karta Raya", "Way Sido"],
            "Pagar Dewa": ["Bujung Dewa", "Bujungsari Marga", "Marga Jaya Indah", "Pagar Dewa", "Cahyo Randu", "Pagar Dewa Suka Mulya"]
        };

        function updateDesaList() {
            const desaList = dataDesa[kecamatan.value] || [];
            desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
            desaList.forEach(nama => {
                const opt = document.createElement("option");
                opt.value = nama;
                opt.textContent = nama;
                desa.appendChild(opt);
            });
            if (kecamatan.value) {
                fieldDesa.classList.remove("hidden");
                desa.setAttribute('required', '');
            } else {
                fieldDesa.classList.add("hidden");
                desa.removeAttribute('required');
            }
            checkAndShowNext('kecamatan', 'field-pihakDitemui');
        }

        // === Validasi Nama ===
        function validateNama() {
            const input = document.getElementById('nama');
            input.value = input.value.replace(/\d+/g, '');
            let hurufCount = 0;
            try {
                hurufCount = (input.value.match(new RegExp("\\p{L}", "gu")) || []).length;
            } catch (e) {
                hurufCount = (input.value.match(/[A-Za-z]/g) || []).length;
            }
            const isValid = hurufCount >= 5;

            if (isValid) {
                input.classList.remove('error');
                input.classList.add('success');
                document.getElementById('field-asal').style.display = 'block';
            } else {
                input.classList.remove('success');
                input.classList.add('error');
                document.querySelectorAll('#formSection > form > div[id^="field-"]:not(#field-nama)').forEach(div => {
                    div.style.display = 'none';
                    const el = div.querySelector('input, select, textarea');
                    if (el) el.value = '';
                });
                clearSignature();
                asal.value = '';
                handleAsalChange('');
            }
        }

        // === Validasi & Format Nomor HP ===
        function formatAndValidateNomorHp(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 13) value = value.substring(0, 13);
            if (value.startsWith('8') && value.length >= 10) value = '0' + value;

            if (value.length > 8) {
                value = value.substring(0, 4) + '-' + value.substring(4, 8) + '-' + value.substring(8);
            } else if (value.length > 4) {
                value = value.substring(0, 4) + '-' + value.substring(4);
            }

            input.value = value;

            const cleanValue = value.replace(/-/g, '');
            const isValid = /^08[0-9]{9,11}$/.test(cleanValue);
            const warning = document.getElementById('hpWarning');

            if (isValid) {
                input.classList.remove('error');
                input.classList.add('success');
                warning.style.display = 'none';
                document.getElementById('field-tandaTangan').style.display = 'block';
            } else {
                input.classList.remove('success');
                input.classList.add('error');
                if (cleanValue.length >= 2) warning.style.display = 'block';
                else warning.style.display = 'none';
                hideFieldsAfter('field-nomorHp');
            }
        }

        function validateUraian() {
            const uraian = document.getElementById('uraian');
            const isValid = uraian.value.trim().length >= 15;
            if (isValid) {
                uraian.classList.remove('error');
                uraian.classList.add('success');
                document.getElementById('field-nomorHp').style.display = 'block';
            } else {
                uraian.classList.remove('success');
                uraian.classList.add('error');
                hideFieldsAfter('field-uraian');
            }
        }

        // === Handle Asal Tamu (Internal vs Eksternal) ===
        function handleAsalChange(value) {
            daftarInstansi.classList.add("hidden");
            daftarMasyarakat.classList.add("hidden");
            fieldDesa.classList.add("hidden");
            instansi.removeAttribute('required');
            kecamatan.removeAttribute('required');
            desa.removeAttribute('required');

            // Sembunyikan semua field lanjutan
            ['field-pihakDitemui','field-jenisLayanan','field-uraian','field-nomorHp','field-tandaTangan','field-aksi'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });

            if (value === "INTERNAL") {
                alert('‚ö†Ô∏è Maaf, buku tamu digital ini KHUSUS UNTUK TAMU EKSTERNAL.\n\nPegawai internal Inspektorat Tubaba TIDAK diperkenankan mengisi buku tamu ini.\n\nTerima kasih atas pengertiannya.');
                return;
            } else if (value === "INSTANSI" || value === "MASYARAKAT") {
                const confirmMsg = "DENGAN INI SAYA MENYATAKAN BAHWA SAYA ADALAH TAMU EKSTERNAL\n(bukan pegawai internal Inspektorat Tubaba).\n\n" +
                                  "Pengisian buku tamu oleh pegawai internal dilarang dan dapat berakibat sanksi.\n\nApakah Anda yakin data yang diisi benar?";
                if (!confirm(confirmMsg)) {
                    asal.value = "";
                    return;
                }

                if (value === "INSTANSI") {
                    daftarInstansi.classList.remove("hidden");
                    instansi.setAttribute('required', '');
                } else if (value === "MASYARAKAT") {
                    daftarMasyarakat.classList.remove("hidden");
                    kecamatan.setAttribute('required', '');
                }
                checkAndShowNext('asal', 'field-pihakDitemui');
            }
        }

        // === Kamera ===
        async function bukaKamera() {
            photoModal.style.display = 'flex';
            try { streamFront = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }); videoFront.srcObject = streamFront; videoFront.play(); } catch (e) { videoFront.style.display = 'none'; }
            try { streamBack = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); videoBack.srcObject = streamBack; videoBack.play(); } catch (e) { videoBack.style.display = 'none'; }
            if (!streamFront && !streamBack) {
                alert("‚ùå Gagal mengakses kamera! Pastikan izin kamera diberikan.");
                tutupModal();
            }
        }

        function ambilFoto() {
            if (streamFront) {
                canvasFront.width = videoFront.videoWidth || 480;
                canvasFront.height = videoFront.videoHeight || 360;
                canvasFront.getContext('2d').drawImage(videoFront, 0, 0, canvasFront.width, canvasFront.height);
                fotoDataURLFront = canvasFront.toDataURL('image/png');
                capturedFrontPhoto.src = fotoDataURLFront;
                capturedFrontPhoto.style.display = 'block';
                videoFront.style.display = 'none';
            }
            if (streamBack) {
                canvasBack.width = videoBack.videoWidth || 480;
                canvasBack.height = videoBack.videoHeight || 360;
                canvasBack.getContext('2d').drawImage(videoBack, 0, 0, canvasBack.width, canvasBack.height);
                fotoDataURLBack = canvasBack.toDataURL('image/png');
                capturedBackPhoto.src = fotoDataURLBack;
                capturedBackPhoto.style.display = 'block';
                videoBack.style.display = 'none';
            }
            hasPhoto = true;
        }

        function tutupModal() {
            photoModal.style.display = 'none';
            if (streamFront) { streamFront.getTracks().forEach(t => t.stop()); }
            if (streamBack) { streamBack.getTracks().forEach(t => t.stop()); }
            capturedFrontPhoto.style.display = 'none';
            capturedBackPhoto.style.display = 'none';
            videoFront.style.display = 'block';
            videoBack.style.display = 'block';
            fotoDataURLFront = null;
            fotoDataURLBack = null;
            hasPhoto = false;
        }

        function simpanFotoLangsung() {
            if (!hasPhoto) { alert("‚ùå Ambil foto dulu!"); return; }
            if (simpanData()) {
                alert("‚úÖ Data berhasil disimpan! Total: " + dataBukuTamu.length);
                tutupModal();
                showData();
            }
        }

        // === Simpan Data (dengan anti-duplikat harian & blokir internal) ===
        function simpanData() {
            // Blokir jika internal
            if (asal.value === "INTERNAL") {
                alert('‚ùå Pengisian dibatalkan: Pegawai internal tidak diperbolehkan.');
                return false;
            }

            let isValid = true;
            signatureWarning.style.display = 'none';
            photoWarning.style.display = 'none';

            const namaInput = document.getElementById('nama');
            let hurufCount = (namaInput.value.match(/\p{L}/gu) || []).length || (namaInput.value.match(/[A-Za-z]/g) || []).length;
            if (hurufCount < 5) { namaInput.classList.add('error'); isValid = false; }

            const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
            if (!hasSignature || strokeLengthCm < MIN_STROKE_LENGTH_CM) {
                signatureWarning.style.display = 'block';
                signatureCanvas.classList.add('error');
                isValid = false;
            }

            if (!hasPhoto) {
                photoWarning.style.display = 'block';
                isValid = false;
            }

            // Anti-duplikat berdasarkan nomor HP hari ini
            const nomorHp = document.getElementById('nomorHp').value.replace(/-/g, '');
            const today = new Date().toLocaleDateString('id-ID');
            const sudahAda = dataBukuTamu.some(entry => {
                const entryDate = entry.timestamp.split(', ')[0];
                return entry.nomorHp === nomorHp && entryDate === today;
            });

            if (sudahAda) {
                alert(`‚ö†Ô∏è Nomor HP ${document.getElementById('nomorHp').value} sudah mengisi buku tamu hari ini (${today}).\nSatu orang hanya boleh mengisi sekali per hari.`);
                isValid = false;
            }

            if (isValid) {
                const formData = {
                    nama: namaInput.value.trim(),
                    asal: asal.value,
                    instansi: asal.value === 'INSTANSI' ? instansi.value : '',
                    kecamatan: asal.value === 'MASYARAKAT' ? kecamatan.value : '',
                    desa: asal.value === 'MASYARAKAT' ? desa.value : '',
                    pihakDitemui: document.getElementById('pihakDitemui').value,
                    jenisLayanan: document.getElementById('jenisLayanan').value,
                    uraian: document.getElementById('uraian').value.trim(),
                    nomorHp: nomorHp,
                    tandaTangan: signatureCanvas.toDataURL('image/png'),
                    fotoFront: fotoDataURLFront,
                    fotoBack: fotoDataURLBack,
                    timestamp: new Date().toLocaleString('id-ID')
                };
                dataBukuTamu.push(formData);
                updateDataCounter();
                resetFormComplete();
                return true;
            }
            return false;
        }

        function simpanDataDanTutupForm() {
            if (simpanData()) {
                alert("‚úÖ Data berhasil disimpan!");
                showData();
            } else {
                alert("‚ùå Lengkapi semua data dengan benar!");
            }
        }

        function resetFormComplete() {
            document.getElementById('bukuTamuForm').reset();
            clearSignature();
            hasSignature = false;
            hasPhoto = false;
            fotoDataURLFront = null;
            fotoDataURLBack = null;
            asal.value = '';
            handleAsalChange('');
            document.querySelectorAll('.success, .error').forEach(el => el.classList.remove('success', 'error'));
            document.getElementById('nama').focus();
        }

        function hideFieldsAfter(startId) {
            let hide = false;
            document.querySelectorAll('#formSection > form > div[id^="field-"]').forEach(div => {
                if (div.id === startId) hide = true;
                else if (hide) div.style.display = 'none';
            });
        }

        function checkAndShowNext(currentId, nextId) {
            const current = document.getElementById(currentId);
            const next = document.getElementById(nextId);
            let valid = current && current.value.trim() !== '';
            if (valid && next) next.style.display = 'block';
        }

        // === Tampilan Data ===
        function showForm() {
            document.getElementById('formSection').style.display = 'block';
            document.getElementById('dataSection').style.display = 'none';
            document.getElementById('btnForm').style.background = '#007bff';
            document.getElementById('btnData').style.background = '#6c757d';
        }

        function showData() {
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('dataSection').style.display = 'block';
            document.getElementById('btnForm').style.background = '#6c757d';
            document.getElementById('btnData').style.background = '#28a745';
            displayData();
        }

        function updateDataCounter() {
            document.getElementById('dataCount').textContent = dataBukuTamu.length;
        }

        function displayData() {
            const container = document.getElementById('dataContainer');
            if (dataBukuTamu.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>';
                return;
            }
            let html = '';
            dataBukuTamu.forEach((data, i) => {
                html += `<div class="data-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <h3 style="margin:0;color:#333;">Tamu #${i+1}</h3>
                        <button onclick="deleteData(${i})" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;">üóëÔ∏è Hapus</button>
                    </div>
                    <div class="data-grid">
                        <div><strong>Nama:</strong> ${data.nama}</div>
                        <div><strong>Asal:</strong> ${data.asal}</div>
                        ${data.instansi ? `<div><strong>Instansi:</strong> ${data.instansi}</div>` : ''}
                        ${data.kecamatan ? `<div><strong>Kecamatan:</strong> ${data.kecamatan}</div>` : ''}
                        ${data.desa ? `<div><strong>Desa:</strong> ${data.desa}</div>` : ''}
                        <div><strong>Pihak Ditemui:</strong> ${data.pihakDitemui}</div>
                        <div><strong>Jenis Layanan:</strong> ${data.jenisLayanan}</div>
                        <div><strong>Nomor HP:</strong> ${data.nomorHp}</div>
                        <div><strong>Waktu:</strong> ${data.timestamp}</div>
                    </div>
                    <div><strong>Uraian:</strong> ${data.uraian}</div>
                    <div class="data-images">
                        <div><strong>Tanda Tangan:</strong><br><img src="${data.tandaTangan}" style="border:1px solid #ccc;max-width:200px;"></div>
                        ${data.fotoFront ? `<div><strong>Foto Depan:</strong><br><img src="${data.fotoFront}" style="border:1px solid #ccc;max-width:200px;"></div>` : ''}
                        ${data.fotoBack ? `<div><strong>Foto Belakang:</strong><br><img src="${data.fotoBack}" style="border:1px solid #ccc;max-width:200px;"></div>` : ''}
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function deleteData(i) {
            if (confirm('Yakin hapus data tamu ini?')) {
                dataBukuTamu.splice(i, 1);
                updateDataCounter();
                displayData();
            }
        }

        function clearAllData() {
            if (confirm('Hapus SEMUA data?')) {
                dataBukuTamu = [];
                updateDataCounter();
                displayData();
            }
        }

        // === Export Excel ===
        function exportData() {
            if (dataBukuTamu.length === 0) {
                alert('‚ö†Ô∏è Tidak ada data untuk di-export!');
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                const dataExport = dataBukuTamu.map((item, i) => ({
                    "No": i + 1,
                    "Nama": item.nama,
                    "Asal": item.asal,
                    "Instansi": item.instansi || "-",
                    "Kecamatan": item.kecamatan || "-",
                    "Desa/Tiyuh": item.desa || "-",
                    "Pihak yang Ditemui": item.pihakDitemui,
                    "Jenis Layanan": item.jenisLayanan,
                    "Uraian": item.uraian,
                    "Nomor HP": item.nomorHp,
                    "Waktu Kunjungan": item.timestamp
                }));
                const ws = XLSX.utils.json_to_sheet(dataExport);
                ws['!cols'] = [{wch:6},{wch:25},{wch:20},{wch:35},{wch:25},{wch:25},{wch:22},{wch:30},{wch:60},{wch:15},{wch:22}];
                XLSX.utils.book_append_sheet(wb, ws, "Data Buku Tamu");
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
                function s2ab(s) {
                    const buf = new ArrayBuffer(s.length);
                    const view = new Uint8Array(buf);
                    for (let i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                    return buf;
                }
                const blob = new Blob([s2ab(wbout)], {type: "application/octet-stream"});
                const today = new Date().toISOString().slice(0,10);
                saveAs(blob, `Buku_Tamu_Inspektorat_Tubaba_${today}.xlsx`);
                alert(`‚úÖ Export berhasil! File: Buku_Tamu_Inspektorat_Tubaba_${today}.xlsx`);
            } catch (e) {
                alert('‚ùå Gagal export. Cek console (F12).');
                console.error(e);
            }
        }

        function autoResize(t) {
            t.style.height = 'auto';
            t.style.height = t.scrollHeight + 'px';
        }

        document.addEventListener('DOMContentLoaded', () => {
            resizeCanvas();
            showForm();
        });
    </script>
</body>
</html>
