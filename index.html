<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Buku Tamu Digital Inspektorat Tubaba</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 15px; max-width: 800px; margin: auto; }
        .hidden { display: none; }
        .required { color: red; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { margin: 10px 5px 0 0; padding: 10px 16px; cursor: pointer; }
        #dataContainer { margin-top: 20px; }
        .data-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 6px; background: #f9f9f9; }
        .data-images img { max-width: 180px; margin: 8px 12px 0 0; border: 1px solid #aaa; border-radius: 4px; }
        .error { border-color: red !important; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<h2 style="text-align:center; color:#004080;">BUKU TAMU DIGITAL INSPEKTORAT KABUPATEN TULANG BAWANG BARAT</h2>

<!-- Form input (disingkat, sesuaikan dengan form lengkapmu jika perlu) -->
<div>
    <label>Nama <span class="required">*</span></label>
    <input id="nama" required>

    <!-- ... Tambahkan field lain sesuai kebutuhan (asal, instansi, kecamatan, dll) ... -->

    <label>Tanda Tangan</label>
    <canvas id="signature-pad" width="400" height="200" style="border:1px solid #ccc; background:white;"></canvas>
    <button onclick="clearSignature()">Hapus Tanda Tangan</button>

    <label>Foto Depan & Belakang</label>
    <button onclick="bukaKamera()">Ambil Foto</button>

    <br><br>
    <button onclick="simpanDataDanTutupForm()" style="background:#28a745; color:white;">ðŸ’¾ Simpan Data</button>
</div>

<div style="margin:20px 0;">
    <button onclick="exportData()" style="background:#17a2b8; color:white; padding:12px 20px;">Export Semua ke PDF</button>
    <button onclick="clearAllData()" style="background:#dc3545; color:white;">Hapus Semua Data</button>
</div>

<div id="dataContainer"></div>

<script>
// =============================================
// VARIABEL GLOBAL & STORAGE
// =============================================
let dataBukuTamu = [];
const STORAGE_KEY = 'dataBukuTamuInspektorat';

// Load data saat halaman dibuka
window.addEventListener('load', () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        dataBukuTamu = JSON.parse(saved);
        displayData();
    }
});

// Simpan ke localStorage setiap kali ada perubahan data
function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataBukuTamu));
}

// =============================================
// FUNGSI SIMPAN DATA (tambahkan validasi sesuai kebutuhan)
// =============================================
function simpanDataDanTutupForm() {
    // Ambil nilai dari form (sesuaikan id field dengan HTML-mu)
    const formData = {
        nama: document.getElementById('nama')?.value.trim() || 'Nama Tamu',
        // ... tambahkan field lain: asal, instansi, kecamatan, uraian, nomorHp, dll ...
        timestamp: new Date().toLocaleString('id-ID'),
        tandaTangan: signatureCanvas?.toDataURL('image/png') || null,
        fotoFront: fotoDataURLFront || null,
        fotoBack: fotoDataURLBack || null
    };

    // Validasi minimal (tambahkan sesuai kebutuhan)
    if (!formData.nama) {
        alert("Minimal isi Nama!");
        return;
    }

    dataBukuTamu.push(formData);
    saveToStorage();
    displayData();

    alert("Data berhasil disimpan!\nTotal data saat ini: " + dataBukuTamu.length);
    // Reset form jika perlu
    document.getElementById('nama').value = '';
    clearSignature();
    // Reset foto jika perlu
}

// =============================================
// EXPORT PDF â€“ SEMUA DATA AKAN MUNCUL & FOTO TIDAK TERPOTONG
// =============================================
function exportData() {
    if (dataBukuTamu.length === 0) {
        alert("Belum ada data untuk diekspor!");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

    doc.setFontSize(14);
    doc.text("BUKU TAMU DIGITAL INSPEKTORAT KABUPATEN TULANG BAWANG BARAT", 148, 15, { align: "center" });
    doc.setFontSize(10);
    doc.text("Tanggal Export: " + new Date().toLocaleDateString('id-ID'), 148, 22, { align: "center" });

    const head = [["No", "Nama", "Instansi/Kecamatan", "Desa", "Pihak Ditemui", "Jenis Layanan", "Uraian", "No HP", "Waktu", "Tanda Tangan", "Foto Depan", "Foto Belakang"]];

    const body = dataBukuTamu.map((d, i) => [
        i + 1,
        d.nama || '-',
        d.instansi || d.kecamatan || '-',
        d.desa || '-',
        d.pihakDitemui || '-',
        d.jenisLayanan || '-',
        d.uraian ? (d.uraian.length > 80 ? d.uraian.substring(0,77)+'...' : d.uraian) : '-',
        d.nomorHp || '-',
        d.timestamp || '-',
        '', '', ''   // placeholder gambar
    ]);

    doc.autoTable({
        head: head,
        body: body,
        startY: 28,
        theme: 'grid',
        headStyles: { fillColor: [0, 102, 204], textColor: 255, fontSize: 9, halign: 'center' },
        bodyStyles: { fontSize: 8, cellPadding: 3, valign: 'middle', overflow: 'linebreak' },
        alternateRowStyles: { fillColor: [240, 248, 255] },
        columnStyles: {
            0: { cellWidth: 10, halign: 'center' },
            1: { cellWidth: 32 },
            2: { cellWidth: 34 },
            3: { cellWidth: 26 },
            4: { cellWidth: 26 },
            5: { cellWidth: 28 },
            6: { cellWidth: 45 }, // Uraian paling lebar
            7: { cellWidth: 22 },
            8: { cellWidth: 22 },
            9: { cellWidth: 22 },
            10: { cellWidth: 22 },
            11: { cellWidth: 22 }
        },
        didDrawCell: function(data) {
            if (data.section === 'body' && data.column.index >= 9 && data.column.index <= 11) {
                const rowIndex = data.row.index;
                const item = dataBukuTamu[rowIndex];
                let img = null;

                if (data.column.index === 9) img = item.tandaTangan;
                if (data.column.index === 10) img = item.fotoFront;
                if (data.column.index === 11) img = item.fotoBack;

                if (img) {
                    const cell = data.cell;
                    const imgWidth = 18;
                    const imgHeight = 13;
                    const x = cell.x + (cell.width - imgWidth) / 2;
                    const y = cell.y + (cell.height - imgHeight) / 2;
                    doc.addImage(img, 'PNG', x, y, imgWidth, imgHeight);
                }
            }
        },
        margin: { top: 28, left: 6, right: 6 }
    });

    const filename = 'Buku_Tamu_Inspektorat_Tubaba_' + new Date().toISOString().slice(0,10) + '.pdf';
    doc.save(filename);
    alert('PDF berhasil dibuat!\nSemua data tersimpan muncul lengkap.\nFile: ' + filename);
}

// =============================================
// Fungsi bantu lainnya (clear, display, dll)
// =============================================
function clearAllData() {
    if (confirm("Yakin hapus SEMUA data?")) {
        dataBukuTamu = [];
        saveToStorage();
        displayData();
    }
}

function displayData() {
    const container = document.getElementById('dataContainer');
    container.innerHTML = dataBukuTamu.length === 0 
        ? '<p style="text-align:center;color:#777;">Belum ada data tersimpan</p>'
        : dataBukuTamu.map((d, i) => `
            <div class="data-card">
                <strong>#${i+1} - ${d.nama || 'Tamu'}</strong> (${d.timestamp})<br>
                <small>Uraian: ${d.uraian || '-'}</small>
                <div class="data-images">
                    ${d.tandaTangan ? `<img src="${d.tandaTangan}" alt="Tanda Tangan">` : ''}
                    ${d.fotoFront ? `<img src="${d.fotoFront}" alt="Foto Depan">` : ''}
                    ${d.fotoBack ? `<img src="${d.fotoBack}" alt="Foto Belakang">` : ''}
                </div>
            </div>
        `).join('');
}

// Inisialisasi tampilan data saat load
displayData();
    </script>
</body>
</html>
