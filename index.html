<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#007bff" />
<link rel="icon" href="icon-192.png" />

<title>Buku Tamu Digital</title>
<style>
    /* Mengatur Box Model untuk Tata Letak Responsif */
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
    }
    body { 
      font-family: sans-serif; 
      max-width: 700px; 
      margin: auto; 
      padding: 20px 10px;
      min-height: 100vh;
    }
    
    label { font-weight: bold; }
    select, input, textarea { 
      width: 100%; 
      padding: 6px; 
      margin-top: 5px; 
    }
    .hidden { display: none; }
    .required { color: red; }
    .error { border: 2px solid red !important; }
    .success { border: 2px solid green !important; }
    .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px; }
    
    /* Tombol Sticky: Kembali ke Layar Utama */
    #btnHome {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ffc107;
      color: black;
      border: none;
      padding: 12px 16px;
      border-radius: 50px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      font-size: 16px;
      z-index: 9999;
    }
    #btnHome:hover { background: #e0a800; }
    @media (min-width: 768px) { #btnHome { display: none; } }
    
    /* Penyesuaian untuk tampilan data agar responsif */
    .data-card {
      border: 1px solid #ddd;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .data-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    @media (min-width: 500px) { .data-grid { grid-template-columns: 1fr 1fr; } }
    .data-images {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 15px;
    }
    @media (min-width: 500px) { .data-images { flex-direction: row; } }
    
    #signature-pad, #capturedPhoto {
      max-width: 100%;
      height: auto;
      width: 100%;
    }
   .header-gambar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
      text-align: center;
      flex-wrap: nowrap;
    }
    .foto-kepala {
      width: 80px;
      height: auto;
    }
    .logo {
      width: 100px;
      height: auto;
    }
    
    /* ---- STYLE UNTUK MODAL FOTO BARU ---- */
    #photoModal {
      display: none; /* Awalnya sembunyi */
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 10px;
    }
    #modalContent {
      position: relative;
      background-color: #fefefe;
      margin: auto;
      padding: 10px;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
      text-align: center;
      border-radius: 8px;
    }
    #cameraFrame {
      position: relative;
      width: 100%;
      max-width: 480px; /* Lebar maksimal bingkai */
      height: auto;
      aspect-ratio: 4/3; /* Rasio standar 4:3 */
      border: 5px solid #007bff; /* Bingkai biru */
      margin: 10px auto;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #videoElement, #capturedPhoto {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #modalButtons {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    #modalButtons button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    .btn-camera { background: #ffc107; color: black; }
    .btn-save { background: #28a745; color: white; }
    .btn-cancel { background: #dc3545; color: white; }
    .btn-camera:hover { background: #e0a800; }
    .btn-save:hover { background: #218838; }
    .btn-cancel:hover { background: #c82333; }
</style>
</head>
<body>

<div class="header-gambar">
  <img src="bupati.png" alt="Wakil Bupati" class="foto-kepala">
  <img src="logo-tubaba.png" alt="Logo Tubaba" class="logo">
  <img src="wakil-bupati.png" alt="Bupati" class="foto-kepala">
</div>

<h1 style="text-align: center;">BUKU TAMU INSPEKTORAT TUBABA</h1>

<div id="formSection">
    <form id="bukuTamuForm">
        <div id="field-nama">
            <label>Nama: <span class="required">*</span></label>
            <input id="nama" required type="text" oninput="validateNama(); checkAndShowNext('nama', 'field-asal')" />
            <div id="namaWarning" style="color: red; font-size: 0.9em; margin-top: 5px; display: none;">Mohon isi nama minimal 5 huruf.</div>
            <br/>
        </div>
        
        <div id="field-asal" style="display: none;">
            <label>INSTANSI/ASAL: <span class="required">*</span></label>
            <select id="asal" required onchange="checkAndShowNext('asal', 'field-pihakDitemui')">
                <option value="">-- Pilih Asal --</option>
                <option value="INSTANSI">INSTANSI/UNIT KERJA</option>
                <option value="MASYARAKAT">MASYARAKAT</option>
            </select><br/><br/>
        </div>

        <div class="hidden" id="daftarInstansi">
            <label>DAFTAR INSTANSI/UNIT KERJA: <span class="required">*</span></label>
            <select id="instansi">
                <option value="">-- Pilih Instansi --</option>
                <option>SEKRETARIAT DAERAH</option>
                <option>SEKRETARIAT DPRD</option>
                <option>BADAN PERENCANAAN PEMBANGUNAN DAERAH</option>
                <option>BADAN PENGELOLAAN KEUANGAN DAN ASET DAERAH</option>
                <option>BADAN PENGELOLAAN PAJAK DAN RETRIBUSI DAERAH</option>
                <option>BADAN KEPEGAWAIAN DAN PENGEMBANGAN SUMBER DAYA MANUSIA</option>
                <option>BADAN KESATUAN BANGSA DAN POLITIK DAERAH</option>
                <option>BADAN PENANGGULANGAN BENCANA DAERAH</option>
                <option>DINAS LINGKUNGAN HIDUP</option>
                <option>DINAS KESEHATAN</option>
                <option>DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                <option>DINAS KOPERASI, UMKM, PERINDUSTRIAN DAN PERDAGANGAN</option>
                <option>DINAS SOSIAL</option>
                <option>DINAS PEMUDA, OLAHRAGA DAN PARIWISATA</option>
                <option>DINAS KOMUNIKASI DAN INFORMATIKA</option>
                <option>DINAS PERUMAHAN, KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                <option>DINAS PENANAMAN MODAL DAN PELAYANAN PERIZINAN TERPADU SATU PINTU</option>
                <option>DINAS PENDIDIKAN DAN KEBUDAYAAN</option>
                <option>DINAS KETAHANAN PANGAN</option>
                <option>DINAS PEMBERDAYAAN MASYARAKAT DAN TIYUH</option>
                <option>DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                <option>DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                <option>DINAS PERHUBUNGAN</option>
                <option>DINAS PERTANIAN</option>
                <option>DINAS PETERNAKAN DAN KESEHATAN HEWAN</option>
                <option>DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                <option>DINAS TENAGA KERJA DAN TRANSMIGRASI</option>
                <option>DINAS PERIKANAN</option>
                <option>DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                <option>DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</option>
                <option>SATUAN POLISI PAMONG PRAJA</option>
                <option>BADAN PENGAWASAN KEUANGAN DAN PEMBANGUNAN (BPKP)</option>
                <option>LAINNYA</option>
            </select><br/><br/>
        </div>

        <div class="hidden" id="daftarMasyarakat">
            <label>Kecamatan: <span class="required">*</span></label>
            <select id="kecamatan">
                <option value="">-- Pilih Kecamatan --</option>
                <option value="Tulang Bawang Tengah">Tulang Bawang Tengah</option>
                <option value="Tulang Bawang Udik">Tulang Bawang Udik</option>
                <option value="Gunung Terang">Gunung Terang</option>
                <option value="Gunung Agung">Gunung Agung</option>
                <option value="Lambu Kibang">Lambu Kibang</option>
                <option value="Way Kenanga">Way Kenanga</option>
                <option value="Tumijajar">Tumijajar</option>
                <option value="Pagar Dewa">Pagar Dewa</option>
                <option value="Batu Putih">Batu Putih</option>
            </select><br/><br/>

            <label>Desa/Tiyuh: <span class="required">*</span></label>
            <select id="desa">
                <option value="">-- Pilih Desa --</option>
            </select><br/><br/>
        </div>
        
        <div id="field-pihakDitemui" style="display: none;">
            <label>PIHAK YANG DITEMUI: <span class="required">*</span></label>
            <select id="pihakDitemui" required onchange="checkAndShowNext('pihakDitemui', 'field-jenisLayanan')">
                <option value="">-- Pilih Pihak yang Ditemui --</option>
                <option>INSPEKTUR</option>
                <option>SEKRETARIS</option>
                <option>IRBANSUS</option>
                <option>IRBAN 1</option>
                <option>IRBAN 2</option>
                <option>IRBAN 3</option>
                <option>IRBAN 4</option>
            </select><br/><br/>
        </div>
        
        <div id="field-jenisLayanan" style="display: none;">
            <label>JENIS LAYANAN: <span class="required">*</span></label>
            <select id="jenisLayanan" required onchange="checkAndShowNext('jenisLayanan', 'field-uraian')">
                <option value="">-- Pilih Jenis Layanan --</option>
                <option>Permintaan Audit/Klarifikasi Khusus</option>
                <option>Penanganan Pengaduan</option>
                <option>Layanan Informasi Publik</option>
                <option>Pembinaan & Konsultasi</option>
                <option>Audit</option>
                <option>Review</option>
                <option>Evaluasi/Monitoring</option>
                <option>Tindak Lanjut Temuan</option>
            </select><br/><br/>
        </div>
        
        <div id="field-uraian" style="display: none;">
            <label>URAIAN: <span class="required">*</span></label>
            <textarea id="uraian" required oninput="autoResize(this); checkAndShowNext('uraian', 'field-nomorHp')" style="overflow:hidden; resize:none; width:100%; min-height:60px;"></textarea><br/><br/>
        </div>
        
        <div id="field-nomorHp" style="display: none;">
            <label>NOMOR HP: <span class="required">*</span></label>
            <input id="nomorHp" inputmode="numeric" pattern="\d*" required type="text" oninput="checkAndShowNext('nomorHp', 'field-tandaTangan')"/><br/><br/>
        </div>
        
        <div id="field-tandaTangan" style="display: none;">
            <label>Tanda Tangan: <span class="required">*</span></label>
            <div class="warning" id="signatureWarning" style="display:none;">⚠️ Tanda tangan wajib diisi!</div>
            <canvas height="200" id="signature-pad" style="border:1px solid #ccc; width: 100%;" width="700"></canvas><br/>
            <button onclick="clearSignature()" type="button">🧹 Bersihkan Tanda Tangan</button><br/><br/>
        </div>
        
        <div id="field-aksi" style="display: none;">
            <label>Foto: <span class="required">*</span></label>
            <div class="warning" id="photoWarning" style="display:none;">⚠️ Foto wajib diambil!</div>
            <button type="button" onclick="bukaKamera()" style="font-size: 16px;">📸 Ambil Foto</button>
            <br/><br/>
            <button type="button" onclick="simpanDataDanTutupForm()" style="font-size: 18px;">💾 Simpan Data</button>
        </div>
    </form>
</div>
<div style="margin-bottom: 20px;">
<button type="button" onclick="showForm()" id="btnForm" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">📝 Form Input</button>
<button type="button" onclick="showData()" id="btnData" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">📊 Lihat Data (<span id="dataCount">0</span>)</button>
<button type="button" onclick="exportData()" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px;">💾 Export Data</button>
</div>

<div id="dataSection" style="display: none;">
<h2>📊 DATA BUKU TAMU</h2>
<div style="margin-bottom: 20px;">
<button type="button" onclick="clearAllData()" style="background: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 5px;">🗑️ Hapus Semua Data</button>
</div>
<div id="dataContainer">
<p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>
</div>
</div>

<div id="photoModal">
    <div id="modalContent">
        <h3 style="color: black;">Bingkai Pengambilan Foto</h3>
        <div id="cameraFrame">
            <video id="videoElement" autoplay muted playsinline style="display:block;"></video>
            <img id="capturedPhoto" alt="Hasil Foto" style="display:none;">
        </div>
        <canvas id="canvasFoto" style="display:none;"></canvas>
        <div id="modalButtons">
            <button type="button" id="btnSimpanLihatData" class="btn-save" onclick="simpanFotoLangsung()">✅ Simpan & Lihat Data</button>
            <button type="button" id="btnTutupModal" class="btn-cancel" onclick="tutupModal()">❌ Tutup</button>
        </div>
    </div>
</div>

<script>
    // === Element refs (pastikan id cocok dengan HTML) ===
    const signatureCanvas = document.getElementById('signature-pad');
    const canvas = signatureCanvas;
    const ctx = canvas.getContext('2d');

    const namaWarning = document.getElementById('namaWarning');
    const signatureWarning = document.getElementById('signatureWarning');
    const photoWarning = document.getElementById('photoWarning');

    // Inisialisasi canvas ukuran dan style
    function resizeCanvas() {
        const originalWidth = 700;
        const originalHeight = 200;
        const newWidth = Math.min(window.innerWidth - 40, originalWidth);
        // Simpan gambar sementara
        const tempData = canvas.toDataURL();
        canvas.width = newWidth;
        // jaga rasio tinggi proporsional
        canvas.height = Math.round(originalHeight * (newWidth / originalWidth));
        const img = new Image();
        img.onload = function () {
            // gambar kembali sesuai ukuran baru
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };
        img.src = tempData;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Konfigurasi gambar tanda tangan
    ctx.strokeStyle = '#0000FF';
    ctx.lineWidth = 2.8;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    let drawing = false;
    let hasSignature = false;

    function getCanvasPos(e) {
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches[0]) {
            return {
                x: e.touches[0].clientX - rect.left,
                y: e.touches[0].clientY - rect.top
            };
        }
        // fallback untuk mouse
        return {
            x: (e.clientX !== undefined ? e.clientX : e.offsetX) - rect.left,
            y: (e.clientY !== undefined ? e.clientY : e.offsetY) - rect.top
        };
    }

    function startDrawing(e) {
        drawing = true;
        hasSignature = true;
        ctx.beginPath();
        const pos = getCanvasPos(e);
        ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
        if (!drawing) return;
        const pos = getCanvasPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    function stopDrawing() {
        if (!drawing) return;
        drawing = false;
        checkAndShowNext('signature-pad', 'field-aksi');
    }

    // Mouse events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Touch events
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        startDrawing(e);
    }, {passive:false});
    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        draw(e);
    }, {passive:false});
    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        stopDrawing(e);
    }, {passive:false});

    function clearSignature() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        hasSignature = false;
        canvas.classList.remove('error', 'success');
        document.getElementById('field-aksi').style.display = 'none';
    }

    // ---- Daftar & logika asal / desa ----
    const asal = document.getElementById("asal");
    const daftarInstansi = document.getElementById("daftarInstansi");
    const daftarMasyarakat = document.getElementById("daftarMasyarakat");
    const kecamatan = document.getElementById("kecamatan");
    const desa = document.getElementById("desa");
    const instansi = document.getElementById("instansi");

    const dataDesa = {
      "Lambu Kibang": ["Kibang Budi Jaya", "Lesung Bhakti Jaya", "Mekar Sari Jaya", "Pagar Jaya", "Gunung Sari", "Sumber Rejo", "Kibang Yekti Jaya", "Kibang Tri Jaya", "Gilang Tunggal Makarta", "Kibang Mulya Jaya"],
      "Tulang Bawang Tengah": ["Penumangan", "Penumangan Baru", "Menggala Mas", "Bandar Dewa", "Panaragan", "Panaragan Jaya Indah", "Panaragan Jaya Utama", "Tirta Kencana", "Tirta Makmur", "Pulung Kencana", "Mulya Jaya", "Mulya Kencana", "Candra Mukti", "Candra Kencana", "Candra Jaya", "Tunas Asri", "Wonokerto", "Mekar Asri", "Marga Asri"],
      "Gunung Agung": ["Tunas Jaya", "Mulya Jaya", "Mulya Sari", "Mekar Jaya", "Bangun Jaya", "Dwikora Jaya", "Marga Jaya", "Sumber Jaya", "Sumber Rejeki", "Jaya Murni", "Wonorejo", "Suka Jaya", "Tri Jaya Tunggal"],
      "Tumijajar": ["Murni Jaya", "Daya Asri", "Daya Sakti", "Makarti", "Sumber Rejo", "Margodadi", "Gunung Menanti", "Gunung Timbul", "Margo Mulyo"],
      "Way Kenanga": ["Agung Jaya", "Mercubuana", "Balam Jaya", "Pagar Buana", "Indraloka I", "Indraloka II", "Balam Asri", "Indraloka Jaya", "Indraloka Mukti", "Sido Agung"],
      "Batu Putih": ["Toto Katon", "Sakti Jaya", "Margo Mulya", "Margo Dadi", "Marga Sari", "Mulyo Sari", "Toto Makmur", "Panca Marga", "Sido Makmur", "Toto Wonodadi"],
      "Gunung Terang": ["Setia Bumi", "Setia Agung", "Mulya Jadi", "Gunung Agung", "Gunung Terang", "Toto Mulyo", "Kagungan Jaya", "Terang Mulya", "Terang Makmur", "Rerang Bumi Agung"],
      "Tulang Bawang Udik": ["Kagungan Ratu", "Kartaraharja", "Kartasari", "Marga Kencana", "Waysido", "Kagungan Ratu Agung", "Gunung Katun Tanjungan", "Gedung Ratu", "Gunung Katun Malay", "Karta", "Karta Tanjung Selamat", "Karta Raya", "Way Sido"],
      "Pagar Dewa": ["Bujung Dewa", "Bujungsari Marga", "Marga Jaya Indah", "Pagar Dewa", "Cahyo Randu", "Pagar Dewa Suka Mulya"]
    };

    asal.addEventListener("change", function () {
        daftarInstansi.classList.add("hidden");
        daftarMasyarakat.classList.add("hidden");
        instansi.removeAttribute('required');
        kecamatan.removeAttribute('required');
        desa.removeAttribute('required');
        if (this.value === "INSTANSI") {
            daftarInstansi.classList.remove("hidden");
            instansi.setAttribute('required', '');
        } else if (this.value === "MASYARAKAT") {
            daftarMasyarakat.classList.remove("hidden");
            kecamatan.setAttribute('required', '');
            desa.setAttribute('required', '');
        }
        checkAndShowNext('asal', 'field-pihakDitemui');
    });

    kecamatan.addEventListener("change", function () {
        const desaList = dataDesa[this.value] || [];
        desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
        desaList.forEach(nama => {
            const opt = document.createElement("option");
            opt.value = nama;
            opt.textContent = nama;
            desa.appendChild(opt);
        });
    });


    // === Validasi Nama: hapus angka, minimal 5 huruf, tidak boleh hanya karakter non-huruf ===
    function validateNama() {
    const input = document.getElementById('nama');

    // Hapus semua digit
    input.value = input.value.replace(/\d+/g, '');

    // Hitung huruf Unicode (gunakan fallback bila browser lama)
    let hurufCount;
    try {
        hurufCount = (input.value.match(/\p{L}/gu) || []).length;
    } catch (e) {
        // fallback: hanya huruf latin
        hurufCount = (input.value.match(/[A-Za-z]/g) || []).length;
    }

    // Kalau kurang dari 5 huruf, atau tidak ada huruf sama sekali -> invalid
        return true;
    }
}    // Nomor HP: hanya angka
    const nomorHp = document.getElementById('nomorHp');
    nomorHp.addEventListener('keypress', function (e) {
        const char = String.fromCharCode(e.which || e.keyCode);
        if (!/[0-9]/.test(char)) {
            e.preventDefault();
        }
    });
    nomorHp.addEventListener('input', function () {
        this.value = this.value.replace(/\D/g, '');
        checkAndShowNext('nomorHp', 'field-tandaTangan');
    });

    // ---- KAMERA & FOTO ----
    const photoModal = document.getElementById('photoModal');
    const videoElement = document.getElementById('videoElement');
    const capturedPhoto = document.getElementById('capturedPhoto');
    const canvasFoto = document.getElementById('canvasFoto');

    let streamAktif = null;
    let fotoDataURL = null;
    let hasPhoto = false;

    async function bukaKamera() {
        photoModal.style.display = 'flex';
        capturedPhoto.style.display = 'none';
        try {
            streamAktif = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "user" }
            });
            videoElement.srcObject = streamAktif;
            videoElement.style.display = 'block';
            videoElement.play();
        } catch (error) {
            console.error("Gagal mengakses kamera:", error);
            alert("❌ Gagal mengakses kamera!\n\nPastikan izin kamera sudah diberikan di pengaturan browser.");
            tutupModal();
        }
    }

    function tutupModal() {
        photoModal.style.display = 'none';
        if (streamAktif) {
            streamAktif.getTracks().forEach(track => track.stop());
            streamAktif = null;
        }
    }

    function simpanFotoLangsung() {
        if (!streamAktif && !videoElement) {
            alert("Kamera belum aktif!");
            return;
        }

        const context = canvasFoto.getContext('2d');
        canvasFoto.width = videoElement.videoWidth || 480;
        canvasFoto.height = videoElement.videoHeight || Math.round(canvasFoto.width * 3 / 4);
        context.drawImage(videoElement, 0, 0, canvasFoto.width, canvasFoto.height);
        
        fotoDataURL = canvasFoto.toDataURL('image/png');
        hasPhoto = true;

        // Simpan data (akan memeriksa tanda tangan & foto)
        if (simpanData()) {
            alert("✅ Data berhasil disimpan!\n\nTotal data: " + dataBukuTamu.length);
            tutupModal();
            showData();
        } else {
            alert("❌ Mohon lengkapi semua data yang diperlukan:\n- Isi semua field yang bertanda (*)\n- Buat tanda tangan");
        }
    }

    // === Data handling ===
    let dataBukuTamu = [];

    // Fungsi pembantu untuk menyembunyikan field setelah tertentu
    function hideFieldsAfter(startFieldId) {
        let hide = false;
        document.querySelectorAll('#formSection > form > div[id^="field-"]').forEach(div => {
            if (div.id === startFieldId) {
                hide = true;
            } else if (hide) {
                div.style.display = 'none';
                const input = div.querySelector('input, select, textarea');
                if (input) {
                    input.classList.remove('error', 'success');
                }
            }
        });
    }

    // Fungsi untuk menampilkan bidang berikutnya
    function checkAndShowNext(currentElementId, nextElementId) {
        const currentElement = document.getElementById(currentElementId);
        const nextElement = document.getElementById(nextElementId);
        let isValid = true;

        if (currentElementId === 'nama') {
            if (!validateNama()) {
                isValid = false;
                hideFieldsAfter('field-nama');
            }
        } else if (currentElementId === 'signature-pad') {
            if (!hasSignature) {
                signatureWarning.style.display = 'block';
                canvas.classList.add('error');
                isValid = false;
            } else {
                signatureWarning.style.display = 'none';
                canvas.classList.remove('error');
                canvas.classList.add('success');
            }
        } else if (currentElement) {
            // elemen input/select/textarea biasa
            if ((currentElement.tagName === 'INPUT' || currentElement.tagName === 'TEXTAREA' || currentElement.tagName === 'SELECT')) {
                if (!currentElement.checkValidity()) {
                    currentElement.classList.add('error');
                    currentElement.classList.remove('success');
                    isValid = false;
                } else {
                    currentElement.classList.remove('error');
                    currentElement.classList.add('success');
                }
            }
        }

        if (isValid && nextElement) {
            nextElement.style.display = 'block';
            const nextInput = nextElement.querySelector('input, select, textarea, canvas');
            if (nextInput) nextInput.focus && nextInput.focus();
        }
    }

    // Fungsi utama untuk validasi dan menyimpan data
    function simpanData() {
        const form = document.getElementById('bukuTamuForm');
        let isValid = true;
        
        // Reset warnings
        namaWarning.style.display = 'none';
        signatureWarning.style.display = 'none';
        photoWarning.style.display = 'none';
        
        // Validasi form standar HTML5
        if (!form.reportValidity()) {
            isValid = false;
        }

        // Validasi tanda tangan
        if (!hasSignature) {
            signatureWarning.style.display = 'block';
            canvas.classList.add('error');
            isValid = false;
        } else {
            canvas.classList.remove('error');
            canvas.classList.add('success');
        }

        // Validasi foto (harus ada foto yang diambil)
        if (!hasPhoto && !fotoDataURL) {
            photoWarning.style.display = 'block';
            isValid = false;
        }

        if (isValid) {
            const formData = {
                nama: document.getElementById('nama').value.trim(),
                asal: asal.value,
                instansi: instansi.value,
                kecamatan: kecamatan.value,
                desa: desa.value,
                pihakDitemui: document.getElementById('pihakDitemui').value,
                jenisLayanan: document.getElementById('jenisLayanan').value,
                uraian: document.getElementById('uraian').value.trim(),
                nomorHp: nomorHp.value.trim(),
                tandaTangan: canvas.toDataURL('image/png'),
                foto: fotoDataURL,
                timestamp: new Date().toLocaleString('id-ID')
            };
            
            dataBukuTamu.push(formData);
            updateDataCounter();
            resetFormComplete();
            return true;
        } else {
            return false;
        }
    }
    
    // Fungsi untuk tombol Simpan Data di halaman utama
    function simpanDataDanTutupForm() {
        if(simpanData()) {
            alert("✅ Data berhasil disimpan!\n\nTotal data: " + dataBukuTamu.length);
            showData();
        } else {
            alert("❌ Mohon lengkapi semua data yang diperlukan:\n- Isi semua field yang bertanda (*)\n- Buat tanda tangan\n- Ambil foto");
        }
    }

    function resetFormComplete() {
        document.getElementById('bukuTamuForm').reset();
        hasSignature = false;
        hasPhoto = false;
        fotoDataURL = null;
        clearSignature();
        daftarInstansi.classList.add("hidden");
        daftarMasyarakat.classList.add("hidden");
        desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
        instansi.removeAttribute('required');
        kecamatan.removeAttribute('required');
        desa.removeAttribute('required');
        
        // Sembunyikan semua bidang kecuali nama
        document.querySelectorAll('#formSection > form > div:not(#field-nama)').forEach(el => el.style.display = 'none');

        const elements = [
            canvas, document.getElementById('nama'), asal,
            document.getElementById('pihakDitemui'), document.getElementById('jenisLayanan'), 
            document.getElementById('uraian'), nomorHp
        ];
        elements.forEach(el => { if(el) el.classList.remove('error', 'success'); });

        namaWarning.style.display = 'none';
        signatureWarning.style.display = 'none';
        photoWarning.style.display = 'none';
        document.getElementById('nama').focus();
    }

    function showForm() {
        document.getElementById('formSection').style.display = 'block';
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('btnForm').style.background = '#007bff';
        document.getElementById('btnData').style.background = '#6c757d';
    }

    function showData() {
        document.getElementById('formSection').style.display = 'none';
        document.getElementById('dataSection').style.display = 'block';
        document.getElementById('btnForm').style.background = '#6c757d';
        document.getElementById('btnData').style.background = '#28a745';
        displayData();
    }

    function updateDataCounter() {
        document.getElementById('dataCount').textContent = dataBukuTamu.length;
    }

    function displayData() {
        const container = document.getElementById('dataContainer');
        if (dataBukuTamu.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>';
            return;
        }
        let html = '';
        dataBukuTamu.forEach((data, index) => {
            html += `<div class="data-card"><div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;"><h3 style="margin: 0; color: #333;">Tamu #${index + 1}</h3><button onclick="deleteData(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">🗑️ Hapus</button></div><div class="data-grid"><div><strong>Nama:</strong> ${data.nama}</div><div><strong>Asal:</strong> ${data.asal}</div>${data.instansi ? `<div><strong>Instansi:</strong> ${data.instansi}</div>` : ''}${data.kecamatan ? `<div><strong>Kecamatan:</strong> ${data.kecamatan}</div>` : ''}${data.desa ? `<div><strong>Desa:</strong> ${data.desa}</div>` : ''}<div><strong>Pihak Ditemui:</strong> ${data.pihakDitemui}</div><div><strong>Jenis Layanan:</strong> ${data.jenisLayanan}</div><div><strong>Nomor HP:</strong> ${data.nomorHp}</div><div><strong>Waktu:</strong> ${data.timestamp}</div></div><div><strong>Uraian:</strong> ${data.uraian}</div><div class="data-images"><div><strong>Tanda Tangan:</strong><br><img src="${data.tandaTangan}" style="border: 1px solid #ccc; max-width: 200px; height: auto;"></div><div><strong>Foto:</strong><br><img src="${data.foto}" style="border: 1px #ccc; max-width: 200px; height: auto;"></div></div></div>`;
        });
        container.innerHTML = html;
    }

    function deleteData(index) {
        if (confirm('Yakin ingin menghapus data tamu #' + (index + 1) + '?')) {
            dataBukuTamu.splice(index, 1);
            updateDataCounter();
            displayData();
            alert('Data berhasil dihapus!');
        }
    }

    function clearAllData() {
        if (confirm('Yakin ingin menghapus SEMUA data buku tamu?')) {
            dataBukuTamu = [];
            updateDataCounter();
            displayData();
            alert('Semua data berhasil dihapus!');
        }
    }

    function exportData() {
        if (dataBukuTamu.length === 0) {
            alert('Tidak ada data untuk di-export!');
            return;
        }
        let csvContent = "No,Nama,Asal,Instansi,Kecamatan,Desa,Pihak Ditemui,Jenis Layanan,Uraian,Nomor HP,Waktu\n";
        dataBukuTamu.forEach((data, index) => {
            csvContent += `${index + 1},"${data.nama}","${data.asal}","${data.instansi || ''}","${data.kecamatan || ''}","${data.desa || ''}","${data.pihakDitemui}","${data.jenisLayanan}","${data.uraian}","${data.nomorHp}","${data.timestamp}"\n`;
        });
        const blob = new Blob([csvContent], {
            type: 'text/csv;charset=utf-8;'
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `buku_tamu_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert('Data berhasil di-export ke file CSV!');
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

</script>

</body>
</html>
