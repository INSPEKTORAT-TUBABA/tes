<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <link rel="manifest" href="manifest.json"/>
    <meta name="theme-color" content="#007bff"/>
    <link rel="icon" href="icon-192.png"/>
    <title>Buku Tamu Digital</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
        body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 20px 10px; min-height: 100vh; }
        label { font-weight: bold; }
        select, input, textarea { width: 100%; padding: 6px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .hidden { display: none; }
        .required { color: red; }
        .error { border: 2px solid red !important; }
        .success { border: 2px solid green !important; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .header-gambar { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px; flex-wrap: nowrap; }
        .foto-kepala { width: 80px; height: auto; }
        .logo { width: 100px; height: auto; }

        /* Modal Foto */
        #photoModal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; padding: 10px; }
        #modalContent { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 95%; max-width: 1300px; text-align: center; border-radius: 8px; }
        #dualCameraFrame { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 900px; margin: 20px auto; }
        .camera-view { width: 100%; border: 3px solid #007bff; aspect-ratio: 4/3; overflow: hidden; position: relative; border-radius: 10px; background: #000; }
        .camera-view h4 { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 8px 16px; border-radius: 20px; margin: 0; font-size: 16px; z-index: 10; white-space: nowrap; }
        .camera-view video, .camera-view img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        @media (min-width: 768px) {
            #dualCameraFrame { flex-direction: row; gap: 30px; max-width: 1200px; }
            .camera-view { flex: 1; aspect-ratio: 16/9; max-width: 600px; }
            .camera-view h4 { font-size: 18px; padding: 10px 20px; }
        }
        #modalButtons { margin-top: 10px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        #modalButtons button { padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        .btn-camera { background: #ffc107; color: black; }
        .btn-save { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
        .btn-camera:hover { background: #e0a800; }
        .btn-save:hover { background: #218838; }
        .btn-cancel:hover { background: #c82333; }
        .data-card { border: 1px solid #ddd; margin-bottom: 15px; padding: 15px; border-radius: 8px; background: #f9f9f9; }
        .data-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; }
        @media (min-width: 500px) { .data-grid { grid-template-columns: 1fr 1fr; } }
        .data-images { display: flex; flex-direction: column; gap: 20px; margin-top: 15px; }
        @media (min-width: 500px) { .data-images { flex-direction: row; flex-wrap: wrap; } }
        
        /* Detail View Styles */
        .detail-container {
            max-width: 900px;
            margin: 20px auto;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .detail-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .detail-header h3 {
            margin: 0;
            font-size: 18px;
        }
        .detail-row {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            min-height: 50px;
            transition: background-color 0.2s;
        }
        .detail-row:hover {
            background-color: #f8f9fa;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            width: 200px;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 14px;
            color: #495057;
            display: flex;
            align-items: center;
        }
        .detail-value {
            flex: 1;
            padding: 15px 20px;
            font-size: 14px;
            color: #212529;
            display: flex;
            align-items: center;
            word-wrap: break-word;
        }
        .detail-signature-box {
            padding: 10px 0;
        }
        .detail-signature-box img {
            max-width: 200px;
            max-height: 100px;
            border: 2px solid #dee2e6;
            background-color: white;
            border-radius: 5px;
            padding: 5px;
        }
        .detail-photo-container {
            display: flex;
            gap: 15px;
            padding: 10px 0;
            flex-wrap: wrap;
        }
        .detail-photo-box {
            width: 200px;
            height: 150px;
            border: 2px solid #dee2e6;
            overflow: hidden;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .detail-photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        @media (max-width: 768px) {
            .detail-row {
                flex-direction: column;
            }
            .detail-label {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                background-color: #e9ecef;
            }
            .detail-photo-container {
                flex-direction: column;
                align-items: center;
            }
            .detail-photo-box {
                width: 100%;
                max-width: 300px;
            }
        }
        
        /* Button Hover Effects */
        button {
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
        }
        button:active {
            transform: translateY(0);
        }
        
            .detail-photo-container {
                flex-direction: column;
                align-items: center;
            }
            .detail-photo-box {
                width: 100%;
                max-width: 300px;
            }
        }
        
        /* CANVAS SIGNATURE - PERBAIKAN LENGKAP */
        #signature-pad { 
            background: white; 
            border: 3px solid #007bff;
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            display: block;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .signature-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .signature-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="header-gambar">
        <img src="bupati.png" alt="Wakil Bupati" class="foto-kepala" onerror="this.style.display='none'">
        <img src="logo-tubaba.png" alt="Logo Tubaba" class="logo" onerror="this.style.display='none'">
        <img src="wakil-bupati.png" alt="Bupati" class="foto-kepala" onerror="this.style.display='none'">
    </div>

    <h1 style="text-align: center;">BUKU TAMU INSPEKTORAT TUBABA</h1>

    <div id="formSection">
        <form id="bukuTamuForm">
            <div id="field-nama">
                <label>Nama: <span class="required">*</span></label>
                <input id="nama" required type="text" placeholder="Isi Minimal 5 Huruf" oninput="validateNama();"/>
            </div>

            <div id="field-asal" style="display: none;">
                <label>INSTANSI/ASAL: <span class="required">*</span></label>
                <select id="asal" required onchange="asalChanged();">
                    <option value="">-- Pilih Asal --</option>
                    <option value="INSTANSI">INSTANSI/UNIT KERJA</option>
                    <option value="MASYARAKAT">MASYARAKAT</option>
                </select>
            </div>

            <div class="hidden" id="daftarInstansi">
                <label>DAFTAR INSTANSI/UNIT KERJA: <span class="required">*</span></label>
                <select id="instansi" onchange="checkAndShowNext('instansi', 'field-pihakDitemui');">
                    <option value="">-- Pilih Instansi --</option>
                    <option>SEKRETARIAT DAERAH</option>
                    <option>SEKRETARIAT DPRD</option>
                    <option>BADAN PERENCANAAN PEMBANGUNAN DAERAH</option>
                    <option>BADAN PENGELOLAAN KEUANGAN DAN ASET DAERAH</option>
                    <option>BADAN PENGELOLAAN PAJAK DAN RETRIBUSI DAERAH</option>
                    <option>BADAN KEPEGAWAIAN DAN PENGEMBANGAN SUMBER DAYA MANUSIA</option>
                    <option>BADAN KESATUAN BANGSA DAN POLITIK DAERAH</option>
                    <option>BADAN PENANGGULANGAN BENCANA DAERAH</option>
                    <option>DINAS LINGKUNGAN HIDUP</option>
                    <option>DINAS KESEHATAN</option>
                    <option>DINAS KEPENDUDUKAN DAN PENCATATAN SIPIL</option>
                    <option>DINAS KOPERASI, UMKM, PERINDUSTRIAN DAN PERDAGANGAN</option>
                    <option>DINAS SOSIAL</option>
                    <option>DINAS PEMUDA, OLAHRAGA DAN PARIWISATA</option>
                    <option>DINAS KOMUNIKASI DAN INFORMATIKA</option>
                    <option>DINAS PERUMAHAN, KAWASAN PERMUKIMAN DAN PERTANAHAN</option>
                    <option>DINAS PENANAMAN MODAL DAN PELAYANAN PERIZINAN TERPADU SATU PINTU</option>
                    <option>DINAS PENDIDIKAN DAN KEBUDAYAAN</option>
                    <option>DINAS KETAHANAN PANGAN</option>
                    <option>DINAS PEMBERDAYAAN MASYARAKAT DAN TIYUH</option>
                    <option>DINAS PEMBERDAYAAN PEREMPUAN DAN PERLINDUNGAN ANAK</option>
                    <option>DINAS PENGENDALIAN PENDUDUK DAN KELUARGA BERENCANA</option>
                    <option>DINAS PERHUBUNGAN</option>
                    <option>DINAS PERTANIAN</option>
                    <option>DINAS PETERNAKAN DAN KESEHATAN HEWAN</option>
                    <option>DINAS PEKERJAAN UMUM DAN PENATAAN RUANG</option>
                    <option>DINAS TENAGA KERJA DAN TRANSMIGRASI</option>
                    <option>DINAS PERIKANAN</option>
                    <option>DINAS PERPUSTAKAAN DAN KEARSIPAN</option>
                    <option>DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</option>
                    <option>SATUAN POLISI PAMONG PRAJA</option>
                    <option>BADAN PENGAWASAN KEUANGAN DAN PEMBANGUNAN (BPKP)</option>
                    <option>LAINNYA</option>
                </select>
            </div>

            <div class="hidden" id="daftarMasyarakat">
                <label>Kecamatan: <span class="required">*</span></label>
                <select id="kecamatan" onchange="updateDesaList();">
                    <option value="">-- Pilih Kecamatan --</option>
                    <option value="Tulang Bawang Tengah">Tulang Bawang Tengah</option>
                    <option value="Tulang Bawang Udik">Tulang Bawang Udik</option>
                    <option value="Gunung Terang">Gunung Terang</option>
                    <option value="Gunung Agung">Gunung Agung</option>
                    <option value="Lambu Kibang">Lambu Kibang</option>
                    <option value="Way Kenanga">Way Kenanga</option>
                    <option value="Tumijajar">Tumijajar</option>
                    <option value="Pagar Dewa">Pagar Dewa</option>
                    <option value="Batu Putih">Batu Putih</option>
                </select>

                <div class="hidden" id="field-desa">
                    <label>Desa/Tiyuh: <span class="required">*</span></label>
                    <select id="desa" onchange="checkAndShowNext('desa', 'field-pihakDitemui');">
                        <option value="">-- Pilih Desa --</option>
                    </select>
                </div>
            </div>

            <div id="field-pihakDitemui" style="display: none;">
                <label>PIHAK YANG DITEMUI: <span class="required">*</span></label>
                <select id="pihakDitemui" required onchange="checkAndShowNext('pihakDitemui', 'field-jenisLayanan');">
                    <option value="">-- Pilih Pihak yang Ditemui --</option>
                    <option>INSPEKTUR</option>
                    <option>SEKRETARIS</option>
                    <option>IRBANSUS</option>
                    <option>IRBAN 1</option>
                    <option>IRBAN 2</option>
                    <option>IRBAN 3</option>
                    <option>IRBAN 4</option>
                </select>
            </div>

            <div id="field-jenisLayanan" style="display: none;">
                <label>JENIS LAYANAN: <span class="required">*</span></label>
                <select id="jenisLayanan" required onchange="checkAndShowNext('jenisLayanan', 'field-uraian');">
                    <option value="">-- Pilih Jenis Layanan --</option>
                    <option>Permintaan Audit/Klarifikasi Khusus</option>
                    <option>Penanganan Pengaduan</option>
                    <option>Layanan Informasi Publik</option>
                    <option>Pembinaan & Konsultasi</option>
                    <option>Audit</option>
                    <option>Review</option>
                    <option>Evaluasi / Monitoring</option>
                    <option>Tindak Lanjut Temuan</option>
                </select>
            </div>

            <div id="field-uraian" style="display: none;">
                <label>URAIAN: <span class="required">*</span></label>
                <textarea id="uraian" required oninput="autoResize(this); validateUraian();" style="overflow:hidden; resize:none; width:100%; min-height:60px;" placeholder="Minimal 15 karakter"></textarea>
            </div>

            <div id="field-nomorHp" style="display: none;">
                <label>NOMOR HP: <span class="required">*</span></label>
                <input id="nomorHp" inputmode="numeric" pattern="\d*" required type="text" placeholder="Minimal 11 digit" oninput="validateNomorHp();"/>
            </div>

            <div id="field-tandaTangan" style="display: none;">
                <label>Tanda Tangan: <span class="required">*</span></label>
                <div class="warning" id="signatureWarning" style="display:none;">‚ö†Ô∏è Tanda tangan wajib diisi dengan goresan minimal 2 cm!</div>
                <canvas height="200" id="signature-pad" style="border:1px solid #ccc; width: 100%;" width="700"></canvas>
                <button onclick="clearSignature()" type="button" style="background: #e9ecef; color: black; border: 1px solid #ccc; padding: 8px 15px; border-radius: 5px; cursor: pointer;">üßπ Bersihkan Tanda Tangan</button>
            </div>

            <div id="field-aksi" style="display: none;">
                <label>Foto: <span class="required">*</span></label>
                <div class="warning" id="photoWarning" style="display:none;">‚ö†Ô∏è Foto wajib diambil!</div>
                <button type="button" onclick="bukaKamera()" style="font-size: 16px; background: #ffc107; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üì∏ Ambil Foto</button>
                <br/><br/>
                <button type="button" onclick="simpanDataDanTutupForm()" style="font-size: 18px; background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer;">üíæ Simpan Data</button>
            </div>
        </form>
    </div>

    <div style="margin-bottom: 80px;">
        <button type="button" onclick="showForm()" id="btnForm" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">üìù Form Input</button>
        <button type="button" onclick="showData()" id="btnData" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">üìä Lihat Data (<span id="dataCount">0</span>)</button>
        <button type="button" onclick="exportData()" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üíæ Export PDF</button>
    </div>

    <div id="dataSection" style="display: none;">
        <h2>üìä DATA BUKU TAMU</h2>
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="button" onclick="exportData()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üíæ Simpan / Export PDF</button>
        </div>
        <div id="dataContainer">
            <p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>
        </div>
    </div>

    <div id="photoModal">
        <div id="modalContent">
            <h3 style="color: black;">Bingkai Pengambilan Foto</h3>
            <div id="dualCameraFrame">
                <div class="camera-view">
                    <h4>Kamera Depan (Selfie)</h4>
                    <video id="videoFront" autoplay muted playsinline></video>
                    <img id="capturedFrontPhoto" alt="Foto Selfie" style="display:none;">
                </div>
                <div class="camera-view">
                    <h4>Kamera Belakang</h4>
                    <video id="videoBack" autoplay muted playsinline></video>
                    <img id="capturedBackPhoto" alt="Foto Belakang" style="display:none;">
                </div>
            </div>
            <canvas id="canvasFront" style="display:none;"></canvas>
            <canvas id="canvasBack" style="display:none;"></canvas>
            <div id="modalButtons">
                <button type="button" class="btn-camera" onclick="ambilFoto()">üì∏ Ambil Foto</button>
                <button type="button" id="btnSimpanLihatData" class="btn-save" onclick="simpanFotoLangsung()">‚úÖ Simpan & Lihat Data</button>
                <button type="button" id="btnTutupModal" class="btn-cancel" onclick="tutupModal()">‚ùå Tutup</button>
            </div>
        </div>
    </div>

    <script>
        // === Element References ===
        const signatureCanvas = document.getElementById('signature-pad');
        const ctx = signatureCanvas.getContext('2d');
        const signatureWarning = document.getElementById('signatureWarning');
        const photoWarning = document.getElementById('photoWarning');
        const asal = document.getElementById("asal");
        const daftarInstansi = document.getElementById("daftarInstansi");
        const daftarMasyarakat = document.getElementById("daftarMasyarakat");
        const kecamatan = document.getElementById("kecamatan");
        const desa = document.getElementById("desa");
        const instansi = document.getElementById("instansi");
        const fieldDesa = document.getElementById("field-desa");
        const photoModal = document.getElementById('photoModal');
        const videoFront = document.getElementById('videoFront');
        const videoBack = document.getElementById('videoBack');
        const canvasFront = document.getElementById('canvasFront');
        const canvasBack = document.getElementById('canvasBack');
        const capturedFrontPhoto = document.getElementById('capturedFrontPhoto');
        const capturedBackPhoto = document.getElementById('capturedBackPhoto');

        let streamFront = null;
        let streamBack = null;
        let fotoDataURLFront = null;
        let fotoDataURLBack = null;
        let hasPhoto = false;
        let drawing = false;
        let hasSignature = false;
        let dataBukuTamu = [];
        let lastX = 0;
        let lastY = 0;
        let totalStrokeLength = 0; // Total panjang goresan dalam piksel
        const MIN_STROKE_LENGTH_CM = 2; // Panjang minimal goresan dalam cm
        const PIXELS_PER_CM = 37.8; // Asumsi 96 DPI (1 cm ‚âà 37.8 piksel)

        // === Canvas Signature Setup ===
        function resizeCanvas() {
            const originalWidth = 700;
            const originalHeight = 200;
            const newWidth = Math.min(window.innerWidth - 40, originalWidth);
            const tempData = signatureCanvas.toDataURL();
            signatureCanvas.width = newWidth;
            signatureCanvas.height = Math.round(originalHeight * (newWidth / originalWidth));
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
            img.src = tempData;
            // Atur ulang properti canvas untuk memastikan warna biru
            ctx.strokeStyle = '#0000FF';
            ctx.globalAlpha = 0.85;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = 'source-over';
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Pengaturan tanda tangan dengan warna biru cerah dan efek pena realistis
        ctx.strokeStyle = '#0000FF'; // Warna biru cerah
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.globalAlpha = 0.85; // Transparansi untuk efek tinta pena
        ctx.globalCompositeOperation = 'source-over'; // Pastikan warna tidak ditimpa
        let lastVelocity = 0;
        let lastTime = Date.now();

        function getCanvasPos(e) {
            const rect = signatureCanvas.getBoundingClientRect();
            if (e.touches && e.touches[0]) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function startDrawing(e) {
            e.preventDefault();
            drawing = true;
            hasSignature = true;
            totalStrokeLength = 0; // Reset panjang goresan
            ctx.beginPath();
            ctx.strokeStyle = '#0000FF'; // Pastikan warna biru
            const pos = getCanvasPos(e);
            lastX = pos.x;
            lastY = pos.y;
            ctx.moveTo(lastX, lastY);
            lastTime = Date.now();
        }

        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const pos = getCanvasPos(e);
            const currentTime = Date.now();
            const deltaTime = (currentTime - lastTime) / 1000;
            const distance = Math.sqrt((pos.x - lastX) ** 2 + (pos.y - lastY) ** 2);
            totalStrokeLength += distance; // Tambahkan panjang goresan
            const velocity = distance / (deltaTime || 1);
            const smoothedVelocity = lastVelocity * 0.7 + velocity * 0.3;
            ctx.lineWidth = Math.max(1.5, Math.min(3.5, 2 - smoothedVelocity / 100)); // Variasi ketebalan
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastX = pos.x;
            lastY = pos.y;
            lastVelocity = smoothedVelocity;
            lastTime = currentTime;
        }

        function stopDrawing(e) {
            if (!drawing) return;
            e.preventDefault();
            drawing = false;
            // Validasi panjang goresan (2 cm ‚âà 75.6 piksel)
            const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
            if (strokeLengthCm < MIN_STROKE_LENGTH_CM) {
                hasSignature = false;
                signatureWarning.style.display = 'block';
                signatureWarning.textContent = '‚ö†Ô∏è Tanda Tangan Terlalu Pendek';
                signatureCanvas.classList.add('error');
                signatureCanvas.classList.remove('success');
                document.getElementById('field-aksi').style.display = 'none';
            } else {
                signatureWarning.style.display = 'none';
                signatureCanvas.classList.remove('error');
                signatureCanvas.classList.add('success');
                checkAndShowNext('signature-pad', 'field-aksi');
            }
        }

        signatureCanvas.addEventListener('mousedown', startDrawing);
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('mouseup', stopDrawing);
        signatureCanvas.addEventListener('mouseout', stopDrawing);
        signatureCanvas.addEventListener('touchstart', startDrawing, { passive: false });
        signatureCanvas.addEventListener('touchmove', draw, { passive: false });
        signatureCanvas.addEventListener('touchend', stopDrawing, { passive: false });

        function clearSignature() {
            ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            hasSignature = false;
            totalStrokeLength = 0; // Reset panjang goresan
            signatureCanvas.classList.remove('error', 'success');
            signatureWarning.style.display = 'none';
            signatureWarning.textContent = '‚ö†Ô∏è Tanda tangan wajib diisi dengan goresan minimal 2 cm!';
            // Atur ulang properti canvas
            ctx.strokeStyle = '#0000FF';
            ctx.globalAlpha = 0.85;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = 'source-over';
            document.getElementById('field-aksi').style.display = 'none';
        }

        // === Dropdown Data ===
        const dataDesa = {
            "Lambu Kibang": ["Kibang Budi Jaya Jaya", "Lesung Bhakti Jaya", "Mekar Sari Jaya", "Pagar Jaya", "Gunung Sari", "Sumber Rejo", "Kibang Yekti Jaya", "Kibang Tri Jaya", "Gilang Tunggal Makarta", "Kibang Mulya Jaya"],
            "Tulang Bawang Tengah": ["Penumangan", "Penumangan Baru", "Menggala Mas", "Bandar Dewa", "Panaragan", "Panaragan Jaya Indah", "Panaragan Jaya Utama", "Tirta Kencana", "Tirta Makmur", "Pulung Kencana", "Mulya Jaya", "Mulya Kencana", "Candra Mukti", "Candra Kencana", "Candra Jaya", "Tunas Asri", "Wonokerto", "Mekar Asri", "Marga Asri"],
            "Gunung Agung": ["Tunas Jaya", "Mulya Jaya", "Mulya Sari", "Mekar Jaya", "Bangun Jaya", "Dwikora Jaya", "Marga Jaya", "Sumber Jaya", "Sumber Rejeki", "Jaya Murni", "Wonorejo", "Suka Jaya", "Tri Jaya Tunggal"],
            "Tumijajar": ["Murni Jaya", "Daya Asri", "Daya Sakti", "Makarti", "Sumber Rejo", "Margodadi", "Gunung Mulya", "Daya Murni", "Gedung Jaya", "Daya Mulya", "Sido Mulyo", "Sumber Sari"],
            "Pagar Dewa": ["Pagar Dewa", "Sido Mukti", "Sido Mulyo", "Sido Rejo", "Sido Makmur", "Pagar Gading", "Mekar Wangi", "Mekar Mulya", "Mekar Asri", "Mekar Jaya", "Mekar Karya", "Mekar Sari"],
            "Gunung Terang": ["Gunung Terang", "Sumber Jaya", "Sumber Rejo", "Sumber Mulya", "Sumber Asri", "Sumber Makmur", "Sumber Sari", "Sumber Agung", "Sumber Karya", "Sumber Baru"],
            "Way Kenanga": ["Way Kenanga", "Karya Makmur", "Karya Jaya", "Karya Mulya", "Karya Sari", "Karya Asri", "Karya Baru", "Karya Maju", "Karya Bhakti", "Karya Mukti"],
            "Batu Putih": ["Batu Putih", "Batu Badak", "Batu Keramat", "Batu Gede", "Batu Kuning", "Batu Hijau", "Batu Merah", "Batu Hitam", "Batu Putih Baru"],
            "Tulang Bawang Udik": ["Tulang Bawang Udik", "Tulang Bawang Baru", "Tulang Bawang Lama", "Tulang Bawang Indah", "Tulang Bawang Makmur", "Tulang Bawang Asri", "Tulang Bawang Jaya", "Tulang Bawang Mulya", "Tulang Bawang Sari"]
        };

        function updateDesaList() {
            const selectedKecamatan = kecamatan.value;
            desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
            if (selectedKecamatan && dataDesa[selectedKecamatan]) {
                dataDesa[selectedKecamatan].forEach(d => {
                    desa.innerHTML += `<option>${d}</option>`;
                });
                fieldDesa.style.display = 'block';
                checkAndShowNext('kecamatan', 'field-desa');
            } else {
                fieldDesa.style.display = 'none';
            }
        }

        function asalChanged() {
            daftarInstansi.classList.add("hidden");
            daftarMasyarakat.classList.add("hidden");
            fieldDesa.classList.add("hidden");
            desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
            instansi.removeAttribute('required');
            kecamatan.removeAttribute('required');
            desa.removeAttribute('required');
            if (asal.value === 'INSTANSI') {
                daftarInstansi.classList.remove("hidden");
                instansi.setAttribute('required', 'required');
                checkAndShowNext('asal', 'daftarInstansi');
            } else if (asal.value === 'MASYARAKAT') {
                daftarMasyarakat.classList.remove("hidden");
                kecamatan.setAttribute('required', 'required');
                desa.setAttribute('required', 'required');
                checkAndShowNext('asal', 'daftarMasyarakat');
            } else {
                hideFieldsAfter('field-asal');
            }
        }

        function validateNama() {
            const nama = document.getElementById('nama');
            let hurufCount = 0;
            try {
                hurufCount = (nama.value.match(/\p{L}/gu) || []).length;
            } catch (e) {
                hurufCount = (nama.value.match(/[A-Za-z]/g) || []).length;
            }
            if (hurufCount >= 5) {
                nama.classList.remove('error');
                nama.classList.add('success');
                document.getElementById('field-asal').style.display = 'block';
            } else {
                nama.classList.remove('success');
                nama.classList.add('error');
                hideFieldsAfter('field-nama');
            }
        }

        function validateUraian() {
            const uraian = document.getElementById('uraian');
            if (uraian.value.trim().length >= 15) {
                uraian.classList.remove('error');
                uraian.classList.add('success');
                document.getElementById('field-nomorHp').style.display = 'block';
            } else {
                uraian.classList.remove('success');
                uraian.classList.add('error');
                hideFieldsAfter('field-uraian');
            }
        }

        function validateNomorHp() {
            const nomorHp = document.getElementById('nomorHp');
            nomorHp.value = nomorHp.value.replace(/\D/g, '');
            if (nomorHp.value.length >= 11) {
                nomorHp.classList.remove('error');
                nomorHp.classList.add('success');
                document.getElementById('field-tandaTangan').style.display = 'block';
            } else {
                nomorHp.classList.remove('success');
                nomorHp.classList.add('error');
                hideFieldsAfter('field-nomorHp');
            }
        }

        // === Camera Functions ===
        async function bukaKamera() {
            photoModal.style.display = 'flex';
            try {
                streamFront = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                videoFront.srcObject = streamFront;
                videoFront.play();
            } catch (error) {
                console.error("Gagal mengakses kamera depan:", error);
                videoFront.style.display = 'none';
            }

            try {
                streamBack = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                videoBack.srcObject = streamBack;
                videoBack.play();
            } catch (error) {
                console.error("Gagal mengakses kamera belakang:", error);
                videoBack.style.display = 'none';
            }

            if (!streamFront && !streamBack) {
                alert("‚ùå Gagal mengakses kamera!\n\nPastikan izin kamera sudah diberikan di pengaturan browser.");
                tutupModal();
            }
        }

        function ambilFoto() {
            if (!streamFront && !streamBack) {
                alert("Kamera belum aktif!");
                return;
            }

            if (streamFront) {
                const contextFront = canvasFront.getContext('2d');
                canvasFront.width = videoFront.videoWidth || 480;
                canvasFront.height = videoFront.videoHeight || Math.round(canvasFront.width * 3 / 4);
                contextFront.drawImage(videoFront, 0, 0, canvasFront.width, canvasFront.height);
                fotoDataURLFront = canvasFront.toDataURL('image/png');
                capturedFrontPhoto.src = fotoDataURLFront;
                capturedFrontPhoto.style.display = 'block';
                videoFront.style.display = 'none';
            }

            if (streamBack) {
                const contextBack = canvasBack.getContext('2d');
                canvasBack.width = videoBack.videoWidth || 480;
                canvasBack.height = videoBack.videoHeight || Math.round(canvasBack.width * 3 / 4);
                contextBack.drawImage(videoBack, 0, 0, canvasBack.width, canvasBack.height);
                fotoDataURLBack = canvasBack.toDataURL('image/png');
                capturedBackPhoto.src = fotoDataURLBack;
                capturedBackPhoto.style.display = 'block';
                videoBack.style.display = 'none';
            }

            hasPhoto = !!(fotoDataURLFront || fotoDataURLBack);
        }

        function tutupModal() {
            photoModal.style.display = 'none';
            if (streamFront) {
                streamFront.getTracks().forEach(track => track.stop());
                streamFront = null;
            }
            if (streamBack) {
                streamBack.getTracks().forEach(track => track.stop());
                streamBack = null;
            }
            capturedFrontPhoto.style.display = 'none';
            capturedBackPhoto.style.display = 'none';
            videoFront.style.display = 'block';
            videoBack.style.display = 'block';
            fotoDataURLFront = null;
            fotoDataURLBack = null;
            hasPhoto = false;
        }

        function simpanFotoLangsung() {
            if (!hasPhoto) {
                alert("‚ùå Harap ambil foto terlebih dahulu!");
                return;
            }
            if (simpanData()) {
                alert("‚úÖ Data berhasil disimpan!\n\nTotal data: " + dataBukuTamu.length);
                tutupModal();
                showData();
            } else {
                alert("‚ùå Mohon lengkapi semua data yang diperlukan:\n- Isi semua field yang bertanda (*)\n- Buat tanda tangan dengan goresan minimal 2 cm\n- Ambil foto");
            }
        }

        // === Data Handling ===
        function hideFieldsAfter(startFieldId) {
            let hide = false;
            document.querySelectorAll('#formSection > form > div[id^="field-"]').forEach(div => {
                if (div.id === startFieldId) {
                    hide = true;
                } else if (hide) {
                    div.style.display = 'none';
                    const input = div.querySelector('input, select, textarea');
                    if (input) {
                        input.classList.remove('error', 'success');
                    }
                }
            });
        }

        function checkAndShowNext(currentElementId, nextElementId) {
            const currentElement = document.getElementById(currentElementId);
            const nextElement = document.getElementById(nextElementId);
            let isValid = true;

            if (currentElementId === 'signature-pad') {
                const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
                if (!hasSignature || strokeLengthCm < MIN_STROKE_LENGTH_CM) {
                    signatureWarning.style.display = 'block';
                    signatureWarning.textContent = '‚ö†Ô∏è Tanda Tangan Terlalu Pendek';
                    signatureCanvas.classList.add('error');
                    signatureCanvas.classList.remove('success');
                    isValid = false;
                } else {
                    signatureWarning.style.display = 'none';
                    signatureCanvas.classList.remove('error');
                    signatureCanvas.classList.add('success');
                }
            } else if (currentElementId === 'asal') {
                if (asal.value === 'INSTANSI') {
                    if (!instansi.value || instansi.value.trim() === '') isValid = false;
                } else if (asal.value === 'MASYARAKAT') {
                    if (!kecamatan.value || kecamatan.value.trim() === '' || !desa.value || desa.value.trim() === '') isValid = false;
                } else {
                    isValid = false;
                }
            } else if (currentElementId === 'kecamatan') {
                if (!kecamatan.value || kecamatan.value.trim() === '' || !desa.value || desa.value.trim() === '') isValid = false;
            } else if (currentElementId === 'desa') {
                if (!desa.value || desa.value.trim() === '') isValid = false;
            } else if (currentElementId === 'instansi') {
                if (!instansi.value || instansi.value.trim() === '') isValid = false;
            } else if (currentElementId === 'uraian') {
                isValid = currentElement.value.trim().length >= 15;
            } else if (currentElementId === 'nomorHp') {
                isValid = currentElement.value.length >= 11;
            } else if (currentElement) {
                if ((currentElement.tagName === 'INPUT' || currentElement.tagName === 'TEXTAREA' || currentElement.tagName === 'SELECT')) {
                    if (currentElement.value === undefined || currentElement.value.trim() === '') {
                        isValid = false;
                    }
                }
            }

            if (currentElement && (currentElement.tagName === 'INPUT' || currentElement.tagName === 'SELECT' || currentElement.tagName === 'TEXTAREA')) {
                if (isValid) {
                    currentElement.classList.remove('error');
                    currentElement.classList.add('success');
                } else {
                    currentElement.classList.add('error');
                    currentElement.classList.remove('success');
                }
            }

            if (isValid && nextElement) {
                nextElement.style.display = 'block';
                const nextInput = nextElement.querySelector('input, select, textarea, canvas');
                if (nextInput && typeof nextInput.focus === 'function') nextInput.focus();
            } else {
                const mapToFieldStart = {
                    'nama': 'field-nama',
                    'asal': 'field-asal',
                    'instansi': 'field-asal',
                    'kecamatan': 'field-asal',
                    'desa': 'field-asal',
                    'pihakDitemui': 'field-pihakDitemui',
                    'jenisLayanan': 'field-jenisLayanan',
                    'uraian': 'field-uraian',
                    'nomorHp': 'field-nomorHp',
                    'signature-pad': 'field-tandaTangan'
                };
                const startId = mapToFieldStart[currentElementId] || currentElementId;
                hideFieldsAfter(startId);
            }
        }

        function simpanData() {
            const form = document.getElementById('bukuTamuForm');
            let isValid = true;

            signatureWarning.style.display = 'none';
            photoWarning.style.display = 'none';

            if (!form.reportValidity()) {
                isValid = false;
            }

            const namaInput = document.getElementById('nama');
            let hurufCount = 0;
            try {
                hurufCount = (namaInput.value.match(/\p{L}/gu) || []).length;
            } catch (e) {
                hurufCount = (namaInput.value.match(/[A-Za-z]/g) || []).length;
            }
            if (hurufCount < 5 || namaInput.value.trim() === '') {
                namaInput.classList.add('error');
                isValid = false;
            } else {
                namaInput.classList.remove('error');
                namaInput.classList.add('success');
            }

            const strokeLengthCm = totalStrokeLength / PIXELS_PER_CM;
            if (!hasSignature || strokeLengthCm < MIN_STROKE_LENGTH_CM) {
                signatureWarning.style.display = 'block';
                signatureWarning.textContent = '‚ö†Ô∏è Tanda Tangan Terlalu Pendek';
                signatureCanvas.classList.add('error');
                isValid = false;
            } else {
                signatureCanvas.classList.remove('error');
                signatureCanvas.classList.add('success');
            }

            if (!hasPhoto) {
                photoWarning.style.display = 'block';
                isValid = false;
            }

            if (isValid) {
                const formData = {
                    nama: namaInput.value.trim(),
                    asal: asal.value,
                    instansi: asal.value === 'INSTANSI' ? instansi.value : '',
                    kecamatan: asal.value === 'MASYARAKAT' ? kecamatan.value : '',
                    desa: asal.value === 'MASYARAKAT' ? desa.value : '',
                    pihakDitemui: document.getElementById('pihakDitemui').value,
                    jenisLayanan: document.getElementById('jenisLayanan').value,
                    uraian: document.getElementById('uraian').value.trim(),
                    nomorHp: document.getElementById('nomorHp').value.trim(),
                    tandaTangan: signatureCanvas.toDataURL('image/png'),
                    fotoFront: fotoDataURLFront,
                    fotoBack: fotoDataURLBack,
                    timestamp: new Date().toLocaleString('id-ID')
                };
                dataBukuTamu.push(formData);
                updateDataCounter();
                resetFormComplete();
                return true;
            }
            return false;
        }

        function simpanDataDanTutupForm() {
            if (simpanData()) {
                alert("‚úÖ Data berhasil disimpan!\n\nTotal data: " + dataBukuTamu.length);
                showData();
            } else {
                alert("‚ùå Mohon lengkapi semua data yang diperlukan:\n- Isi semua field yang bertanda (*)\n- Buat tanda tangan dengan goresan minimal 2 cm\n- Ambil foto");
            }
        }

        function resetFormComplete() {
            document.getElementById('bukuTamuForm').reset();
            hasSignature = false;
            hasPhoto = false;
            fotoDataURLFront = null;
            fotoDataURLBack = null;
            clearSignature();
            daftarInstansi.classList.add("hidden");
            daftarMasyarakat.classList.add("hidden");
            fieldDesa.classList.add("hidden");
            desa.innerHTML = '<option value="">-- Pilih Desa --</option>';
            instansi.removeAttribute('required');
            kecamatan.removeAttribute('required');
            desa.removeAttribute('required');
            document.querySelectorAll('#formSection > form > div:not(#field-nama)').forEach(el => el.style.display = 'none');
            const elements = [signatureCanvas, document.getElementById('nama'), asal, document.getElementById('pihakDitemui'), document.getElementById('jenisLayanan'), document.getElementById('uraian'), document.getElementById('nomorHp')];
            elements.forEach(el => { if (el) el.classList.remove('error', 'success'); });
            signatureWarning.style.display = 'none';
            photoWarning.style.display = 'none';
            document.getElementById('nama').focus();
        }

        function showForm() {
            // Refresh halaman untuk reset form
            location.reload();
        }

        function showData() {
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('dataSection').style.display = 'block';
            document.getElementById('btnForm').style.background = '#6c757d';
            document.getElementById('btnData').style.background = '#28a745';
            displayData();
        }

        function updateDataCounter() {
            document.getElementById('dataCount').textContent = dataBukuTamu.length;
        }

        function displayData() {
            const container = document.getElementById('dataContainer');
            if (dataBukuTamu.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Belum ada data yang tersimpan</p>';
                return;
            }
            let html = '';
            dataBukuTamu.forEach((data, index) => {
                html += `
                <div class="detail-container">
                    <div class="detail-header">
                        <h3>Data Tamu #${index + 1}</h3>
                        <button onclick="editData(${index})" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">‚úèÔ∏è Edit</button>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">Nama Lengkap</div>
                        <div class="detail-value">${data.nama}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Asal / Instansi</div>
                        <div class="detail-value">${data.instansi || (data.kecamatan ? `${data.kecamatan}${data.desa ? ', ' + data.desa : ''}` : data.asal)}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Pihak Ditemui</div>
                        <div class="detail-value">${data.pihakDitemui}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Jenis Layanan</div>
                        <div class="detail-value">${data.jenisLayanan}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Uraian Keperluan</div>
                        <div class="detail-value">${data.uraian}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Nomor WhatsApp</div>
                        <div class="detail-value">${data.nomorHp}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Waktu Kunjungan</div>
                        <div class="detail-value">${data.timestamp}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Tanda Tangan</div>
                        <div class="detail-value">
                            <div class="detail-signature-box">
                                <img src="${data.tandaTangan}" alt="Tanda Tangan">
                            </div>
                        </div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Dokumentasi Foto</div>
                        <div class="detail-value">
                            <div class="detail-photo-container">
                                ${data.fotoFront ? `
                                <div class="detail-photo-box">
                                    <img src="${data.fotoFront}" alt="Foto Depan">
                                </div>
                                ` : ''}
                                ${data.fotoBack ? `
                                <div class="detail-photo-box">
                                    <img src="${data.fotoBack}" alt="Foto Belakang">
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        function editData(index) {
            if (confirm('Edit data tamu #' + (index + 1) + '?')) {
                const data = dataBukuTamu[index];
                
                // Isi form dengan data yang akan diedit
                document.getElementById('nama').value = data.nama;
                document.getElementById('asal').value = data.asal;
                
                // Tampilkan field yang sesuai
                if (data.asal === 'INSTANSI') {
                    daftarInstansi.classList.remove('hidden');
                    document.getElementById('instansi').value = data.instansi;
                    daftarMasyarakat.classList.add('hidden');
                } else if (data.asal === 'MASYARAKAT') {
                    daftarMasyarakat.classList.remove('hidden');
                    document.getElementById('kecamatan').value = data.kecamatan;
                    updateDesaList();
                    setTimeout(() => {
                        document.getElementById('desa').value = data.desa;
                    }, 100);
                    daftarInstansi.classList.add('hidden');
                }
                
                document.getElementById('pihakDitemui').value = data.pihakDitemui;
                document.getElementById('jenisLayanan').value = data.jenisLayanan;
                document.getElementById('uraian').value = data.uraian;
                document.getElementById('nomorHp').value = data.nomorHp;
                
                // Load tanda tangan
                if (data.tandaTangan) {
                    const img = new Image();
                    img.onload = function() {
                        const ctx = signatureCanvas.getContext('2d');
                        ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                        ctx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
                        hasSignature = true;
                    };
                    img.src = data.tandaTangan;
                }
                
                // Load foto
                fotoDataURLFront = data.fotoFront;
                fotoDataURLBack = data.fotoBack;
                hasPhoto = true;
                
                // Hapus data lama
                dataBukuTamu.splice(index, 1);
                updateDataCounter();
                
                // Tampilkan semua field untuk edit
                document.getElementById('field-nama').style.display = 'block';
                document.getElementById('field-asal').style.display = 'block';
                document.getElementById('field-pihakDitemui').style.display = 'block';
                document.getElementById('field-jenisLayanan').style.display = 'block';
                document.getElementById('field-uraian').style.display = 'block';
                document.getElementById('field-nomorHp').style.display = 'block';
                document.getElementById('field-tandaTangan').style.display = 'block';
                
                // Pindah ke form
                showForm();
                alert('Data dimuat ke form. Silakan edit dan simpan kembali.');
            }
        }

        function exportData() {
    if (dataBukuTamu.length === 0) {
        alert('Tidak ada data untuk di-export!');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4

    // Header dokumen
    doc.setFontSize(14);
    doc.setTextColor(0, 51, 153);
    doc.text('BUKU TAMU DIGITAL INSPEKTORAT KABUPATEN TULANG BAWANG BARAT', 148.5, 12, { align: 'center' });
    
    doc.setFontSize(9);
    doc.setTextColor(80);
    doc.text('Tanggal Export: ' + new Date().toLocaleString('id-ID'), 148.5, 18, { align: 'center' });

    let yPosition = 28;

    const dataInstansi = dataBukuTamu.filter(d => d.asal === 'INSTANSI');
    const dataMasyarakat = dataBukuTamu.filter(d => d.asal === 'MASYARAKAT');

    const tableCommonOptions = {
        theme: 'grid',
        margin: { left: 10, right: 10 },
        styles: {
            fontSize: 7,
            cellPadding: 2,
            overflow: 'linebreak',
            valign: 'middle',
            lineWidth: 0.1
        },
        headStyles: {
            fillColor: [0, 102, 204],
            textColor: 255,
            halign: 'center',
            fontSize: 7
        },
        bodyStyles: {
            minCellHeight: 20 // Memberikan ruang cukup untuk gambar agar tidak terlalu kecil
        }
    };

    // Fungsi helper untuk menggambar gambar secara proporsional di tengah cell
    const drawImageInCell = (data, imgData) => {
        if (!imgData) return;
        try {
            const padding = 2;
            const cellW = data.cell.width - (padding * 2);
            const cellH = data.cell.height - (padding * 2);
            
            // Membuat objek image sementara untuk mendapatkan dimensi asli
            const img = new Image();
            img.src = imgData;
            
            let displayW = cellW;
            let displayH = cellH;
            const ratio = img.width / img.height;

            // Kalkulasi rasio agar tetap proporsional
            if (cellW / cellH > ratio) {
                displayW = cellH * ratio;
            } else {
                displayH = cellW / ratio;
            }

            // Posisi Center (Tengah)
            const xPos = data.cell.x + (data.cell.width - displayW) / 2;
            const yPos = data.cell.y + (data.cell.height - displayH) / 2;

            doc.addImage(imgData, 'PNG', xPos, yPos, displayW, displayH, undefined, 'FAST');
        } catch (e) {
            console.error("Gagal memuat gambar ke PDF", e);
        }
    };

// 1. TABEL INSTANSI
    if (dataInstansi.length > 0) {
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.text('DAFTAR TAMU INSTANSI / UNIT KERJA', 10, yPosition);
        
        doc.autoTable({
            ...tableCommonOptions,
            startY: yPosition + 4,
            head: [['No', 'Nama', 'Instansi', 'Pihak Ditemui', 'Layanan', 'Uraian', 'No HP', 'Waktu', 'TTD', 'Foto Depan', 'Foto Belakang']],
            body: dataInstansi.map((d, i) => [
                i + 1, d.nama, d.instansi, d.pihakDitemui, d.jenisLayanan, d.uraian, d.nomorHp, d.timestamp, '', '', ''
            ]),
            columnStyles: {
                0: { cellWidth: 7 },   // No
                1: { cellWidth: 25 },  // Nama
                2: { cellWidth: 35 },  // Instansi
                5: { cellWidth: 55 },  // Uraian (Diperlebar karena No.HP/Waktu dikurangi)
                6: { cellWidth: 20 },  // No HP (Dikurangi dari 22 ke 18)
                7: { cellWidth: 18 },  // Waktu (Dikurangi dari 24 ke 18)
                8: { cellWidth: 20 },  // TTD
                9: { cellWidth: 22 },  // Foto 1
                10: { cellWidth: 22 }  // Foto 2
            },
            didDrawCell: (data) => {
                if (data.section === 'body') {
                    const rowData = dataInstansi[data.row.index];
                    if (data.column.index === 8) drawImageInCell(data, rowData.tandaTangan);
                    if (data.column.index === 9) drawImageInCell(data, rowData.fotoFront);
                    if (data.column.index === 10) drawImageInCell(data, rowData.fotoBack);
                }
            }
        });
        yPosition = doc.lastAutoTable.finalY + 15;
    }

   // 2. TABEL MASYARAKAT
    if (dataMasyarakat.length > 0) {
        if (yPosition > 170) { doc.addPage(); yPosition = 20; }
        
        doc.setFontSize(10);
        doc.text('DAFTAR TAMU MASYARAKAT', 10, yPosition);

        doc.autoTable({
            ...tableCommonOptions,
            startY: yPosition + 4,
            headStyles: { ...tableCommonOptions.headStyles, fillColor: [39, 174, 96] },
            head: [['No', 'Nama', 'Kecamatan', 'Desa', 'Pihak Ditemui', 'Layanan', 'Uraian', 'No HP', 'Waktu', 'TTD', 'Foto Depan', 'Foto Belakang']],
            body: dataMasyarakat.map((d, i) => [
                i + 1, d.nama, d.kecamatan, d.desa, d.pihakDitemui, d.jenisLayanan, d.uraian, d.nomorHp, d.timestamp, '', '', ''
            ]),
            columnStyles: {
                0: { cellWidth: 7 },
                1: { cellWidth: 25 },
                6: { cellWidth: 55 },  // Uraian (Diperlebar)
                7: { cellWidth: 20 },  // No HP (Dikurangi ke 18)
                8: { cellWidth: 18 },  // Waktu (Dikurangi ke 18)
                9: { cellWidth: 20 },
                10: { cellWidth: 22 },
                11: { cellWidth: 22 }
            },
            didDrawCell: (data) => {
                if (data.section === 'body') {
                    const rowData = dataMasyarakat[data.row.index];
                    if (data.column.index === 9) drawImageInCell(data, rowData.tandaTangan);
                    if (data.column.index === 10) drawImageInCell(data, rowData.fotoFront);
                    if (data.column.index === 11) drawImageInCell(data, rowData.fotoBack);
                }
            }
        });
    }

    const filename = `Buku_Tamu_Tubaba_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(filename);
    
    // Tunggu sebentar untuk memastikan download dimulai, lalu hapus semua data
    setTimeout(() => {
        if (confirm('PDF berhasil di-download!\n\nHapus semua data dan kembali ke form input?')) {
            dataBukuTamu = [];
            updateDataCounter();
            showForm();
            alert('‚úÖ Semua data telah dihapus!\n\nSilakan input data tamu baru.');
        }
    }, 500);
}

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        document.addEventListener('DOMContentLoaded', () => {
            resizeCanvas();
            showForm();
        });
    </script>
</body>
</html>
